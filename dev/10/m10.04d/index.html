<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>m10.04d · DynamicHMCModels.jl</title><link href="https://cdnjs.cloudflare.com/ajax/libs/normalize/4.2.0/normalize.min.css" rel="stylesheet" type="text/css"/><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.2.0/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link href="../../assets/documenter.css" rel="stylesheet" type="text/css"/></head><body><nav class="toc"><h1>DynamicHMCModels.jl</h1><select id="version-selector" onChange="window.location.href=this.value" style="visibility: hidden"></select><form class="search" id="search-form" action="../../search/"><input id="search-query" name="q" type="text" placeholder="Search docs"/></form><ul><li><a class="toctext" href="../../intro/">Home</a></li><li><span class="toctext">Chapter 02</span><ul><li><a class="toctext" href="../../02/m2.1d/">m2.1d</a></li></ul></li><li><span class="toctext">Chapter 04</span><ul><li><a class="toctext" href="../../04/m4.1d/">m4.1d</a></li><li><a class="toctext" href="../../04/m4.2d/">m4.2d</a></li><li><a class="toctext" href="../../04/m4.5d/">m4.5d</a></li></ul></li><li><span class="toctext">Chapter 05</span><ul><li><a class="toctext" href="../../05/m5.1d/">m5.1d</a></li><li><a class="toctext" href="../../05/m5.1d1/">m5.1d1</a></li><li><a class="toctext" href="../../05/m5.3d/">m5.3d</a></li><li><a class="toctext" href="../../05/m5.6d/">m5.6d</a></li></ul></li><li><span class="toctext">Chapter 08</span><ul><li><a class="toctext" href="../../08/m8.1d/">m8.1d</a></li></ul></li><li><span class="toctext">Chapter 10</span><ul><li><a class="toctext" href="../m10.02d/">m10.02d</a></li><li><a class="toctext" href="../m10.02d1/">m10.02d1</a></li><li class="current"><a class="toctext" href>m10.04d</a><ul class="internal"></ul></li><li><a class="toctext" href="../m10.04d1/">m10.04d1</a></li><li><a class="toctext" href="../m10.04d2/">m10.04d2</a></li></ul></li><li><span class="toctext">Chapter 12</span><ul><li><a class="toctext" href="../../12/m12.6d/">m12.6d</a></li><li><a class="toctext" href="../../12/m12.6d1/">m12.6d1</a></li><li><a class="toctext" href="../../12/m12.6d2/">m12.6d2</a></li></ul></li><li><a class="toctext" href="../../">Functions</a></li></ul></nav><article id="docs"><header><nav><ul><li>Chapter 10</li><li><a href>m10.04d</a></li></ul><a class="edit-page" href="https://github.com/StatisticalRethinkingJulia/DynamicHMCModels.jl/blob/master/scripts/10/m10.04d.jl"><span class="fa"></span> Edit on GitHub</a></nav><hr/><div id="topbar"><span>m10.04d</span><a class="fa fa-bars" href="#"></a></div></header><p>Load Julia packages (libraries) needed  for the snippets in chapter 0</p><div><pre><code class="language-julia">using DynamicHMCModels</code></pre></div><p>CmdStan uses a tmp directory to store the output of cmdstan</p><div><pre><code class="language-julia">ProjDir = rel_path_d(&quot;..&quot;, &quot;scripts&quot;, &quot;10&quot;)
cd(ProjDir)</code></pre></div><h3><a class="nav-anchor" id="snippet-10.4-1" href="#snippet-10.4-1">snippet 10.4</a></h3><div><pre><code class="language-julia">d = CSV.read(rel_path(&quot;..&quot;, &quot;data&quot;, &quot;chimpanzees.csv&quot;), delim=&#39;;&#39;);
df = convert(DataFrame, d);
df[:pulled_left] = convert(Array{Int64}, df[:pulled_left])
df[:prosoc_left] = convert(Array{Int64}, df[:prosoc_left])
df[:condition] = convert(Array{Int64}, df[:condition])
df[:actor] = convert(Array{Int64}, df[:actor])
first(df, 5)

struct m_10_04d_model{TY &lt;: AbstractVector, TX &lt;: AbstractMatrix,
  TA &lt;: AbstractVector}
    &quot;Observations.&quot;
    y::TY
    &quot;Covariates&quot;
    X::TX
    &quot;Actors&quot;
    A::TA
    &quot;Number of observations&quot;
    N::Int
    &quot;Number of unique actors&quot;
    N_actors::Int
end</code></pre></div><p>Make the type callable with the parameters <em>as a single argument</em>.</p><div><pre><code class="language-julia">function (problem::m_10_04d_model)(θ)
    @unpack y, X, A, N, N_actors = problem   # extract the data
    @unpack β, α = θ  # works on the named tuple too
    ll = 0.0
    ll += sum(logpdf.(Normal(0, 10), β)) # bp &amp; bpC
    ll += sum(logpdf.(Normal(0, 10), α)) # alpha[1:7]
    ll += sum(
      [loglikelihood(Binomial(1, logistic(α[A[i]] + dot(X[i, :], β))), [y[i]]) for i in 1:N]
    )
    ll
end</code></pre></div><p>Instantiate the model with data and inits.</p><div><pre><code class="language-julia">N = size(df, 1)
N_actors = length(unique(df[:actor]))
X = hcat(ones(Int64, N), df[:prosoc_left] .* df[:condition]);
A = df[:actor]
y = df[:pulled_left]
p = m_10_04d_model(y, X, A, N, N_actors);
θ = (β = [1.0, 0.0], α = [-1.0, 10.0, -1.0, -1.0, -1.0, 0.0, 2.0])
p(θ)</code></pre><pre><code class="language-none">-305.21943396408915</code></pre></div><p>Write a function to return properly dimensioned transformation.</p><div><pre><code class="language-julia">problem_transformation(p::m_10_04d_model) =
    as( (β = as(Array, size(p.X, 2)), α = as(Array, p.N_actors), ) )</code></pre></div><p>Wrap the problem with a transformation, then use Flux for the gradient.</p><div><pre><code class="language-julia">P = TransformedLogDensity(problem_transformation(p), p)
∇P = LogDensityRejectErrors(ADgradient(:ForwardDiff, P));</code></pre><pre><code class="language-none">LogDensityRejectErrors{InvalidLogDensityException,LogDensityProblems.ForwardDiffLogDensity{TransformedLogDensity{TransformVariables.TransformNamedTuple{(:β, :α),Tuple{TransformVariables.ArrayTransform{TransformVariables.Identity,1},TransformVariables.ArrayTransform{TransformVariables.Identity,1}}},Main.ex-m10.04d.m_10_04d_model{Array{Int64,1},Array{Int64,2},Array{Int64,1}}},ForwardDiff.GradientConfig{ForwardDiff.Tag{getfield(LogDensityProblems, Symbol(&quot;##1#2&quot;)){TransformedLogDensity{TransformVariables.TransformNamedTuple{(:β, :α),Tuple{TransformVariables.ArrayTransform{TransformVariables.Identity,1},TransformVariables.ArrayTransform{TransformVariables.Identity,1}}},Main.ex-m10.04d.m_10_04d_model{Array{Int64,1},Array{Int64,2},Array{Int64,1}}}},Float64},Float64,9,Array{ForwardDiff.Dual{ForwardDiff.Tag{getfield(LogDensityProblems, Symbol(&quot;##1#2&quot;)){TransformedLogDensity{TransformVariables.TransformNamedTuple{(:β, :α),Tuple{TransformVariables.ArrayTransform{TransformVariables.Identity,1},TransformVariables.ArrayTransform{TransformVariables.Identity,1}}},Main.ex-m10.04d.m_10_04d_model{Array{Int64,1},Array{Int64,2},Array{Int64,1}}}},Float64},Float64,9},1}}}}(ForwardDiff AD wrapper for TransformedLogDensity of dimension 9, w/ chunk size 9)</code></pre></div><p>Tune and sample.</p><div><pre><code class="language-julia">chain, NUTS_tuned = NUTS_init_tune_mcmc(∇P, 1000);</code></pre><pre><code class="language-none">MCMC, adapting ϵ (75 steps)
0.016 s/step ...done
MCMC, adapting ϵ (25 steps)
0.018 s/step ...done
MCMC, adapting ϵ (50 steps)
0.01 s/step ...done
MCMC, adapting ϵ (100 steps)
0.0086 s/step ...done
MCMC, adapting ϵ (200 steps)
step 166 (of 200), 0.006 s/step
0.006 s/step ...done
MCMC, adapting ϵ (400 steps)
step 182 (of 400), 0.0055 s/step
0.0048 s/step ...done
MCMC, adapting ϵ (50 steps)
0.0048 s/step ...done
MCMC (1000 steps)
step 326 (of 1000), 0.0031 s/step
step 658 (of 1000), 0.003 s/step
0.003 s/step ...done
(NUTS_Transition{Array{Float64,1},Float64}[NUTS_Transition{Array{Float64,1},Float64}([2.8733758671822915, 0.6274916282058423, -3.3541196774573057, 9.63914656893609, -3.737115487013561, -3.7637935194949925, -3.7568058018740804, -2.5911883430053018, -0.5271440843732793], -298.9543691775447, 3, DynamicHMC.DoubledTurn, 0.900597174468536, 7), NUTS_Transition{Array{Float64,1},Float64}([1.439071343773101, 0.6937439046978235, -1.8556754777412106, 10.682476427281806, -2.1574863936890933, -2.416376008139089, -2.2380437080427784, -0.9081939185295986, 1.0804851413384151], -297.0991537014821, 3, DynamicHMC.AdjacentTurn, 0.9716889551278842, 15), NUTS_Transition{Array{Float64,1},Float64}([0.19467805453864906, 0.33651774902253245, -0.691114696426151, 14.84000701788259, -1.1705220256620557, -0.7770810923062523, -0.2964305511033325, 0.3088486638202309, 1.7087587825102348], -297.8897683654542, 3, DynamicHMC.DoubledTurn, 0.7508914424688312, 7), NUTS_Transition{Array{Float64,1},Float64}([-0.857708001654235, 0.42835657827891427, 0.5622420133745645, 24.982964417119277, 0.320852605207592, 0.13173688271755554, 0.20816818639163573, 1.3598562812851638, 2.763537648696642], -297.9857629670504, 3, DynamicHMC.DoubledTurn, 0.9225306977862202, 7), NUTS_Transition{Array{Float64,1},Float64}([-9.259349527759712, 0.41231279601633486, 8.607622593124542, 32.313844054998775, 8.2708591091368, 8.601669733864036, 8.97212712934204, 9.781617953378031, 11.507298472412732], -302.59510760218564, 3, DynamicHMC.DoubledTurn, 0.7210306559814973, 7), NUTS_Transition{Array{Float64,1},Float64}([-9.587648994198368, 0.31484728967124703, 8.900672739524662, 29.4528359434748, 8.779326948447844, 9.04194605033274, 9.557509214594846, 9.934229080828828, 11.925754631740702], -305.33274091584934, 3, DynamicHMC.DoubledTurn, 0.891750381240927, 7), NUTS_Transition{Array{Float64,1},Float64}([-2.062058033100935, 0.24716366468817497, 1.7779659115014432, 23.75679739495493, 1.1600091357830244, 1.077560321289437, 1.6386874533803355, 2.577480241894294, 3.995106078723611], -304.2195261678259, 3, DynamicHMC.DoubledTurn, 0.918881041437745, 7), NUTS_Transition{Array{Float64,1},Float64}([-7.336637815057575, 0.5333810634146626, 6.835564215189457, 11.199518522537534, 6.437083497141641, 6.874830326633753, 6.813070714197201, 7.838502012027998, 8.821297965979559], -298.8390362824665, 3, DynamicHMC.DoubledTurn, 0.9831792803896675, 7), NUTS_Transition{Array{Float64,1},Float64}([-5.3773803283560735, 0.39601231511045754, 4.893173483889786, 12.409914641071389, 4.772054497834388, 4.954558178977457, 4.817156207740304, 5.723019645537663, 6.970068272698912], -300.2678248303086, 3, DynamicHMC.AdjacentTurn, 0.9108338822279365, 15), NUTS_Transition{Array{Float64,1},Float64}([-8.378771843149249, 0.3969198162004227, 8.076154094240207, 13.720334979772277, 7.730511846812063, 7.7056733025936515, 7.781394988645205, 9.188166579732075, 10.405923532599521], -298.94237118827994, 3, DynamicHMC.DoubledTurn, 0.7448073190112562, 7)  …  NUTS_Transition{Array{Float64,1},Float64}([0.7575870028222801, 0.3416574373487999, -1.004711796156165, 4.176609711808025, -1.441820702647356, -1.8451067779714478, -1.121888057695432, 0.39603871400066604, 1.7508899610848567], -302.52036807238596, 3, DynamicHMC.DoubledTurn, 0.9774434759847024, 7), NUTS_Transition{Array{Float64,1},Float64}([4.6671042839257915, 0.32560806786002083, -5.133431966104274, 5.486273097730861, -5.0001479480108415, -4.881170934703231, -5.28698129829079, -4.375287855848459, -2.8810222823119354], -299.8342082033322, 3, DynamicHMC.DoubledTurn, 1.0, 7), NUTS_Transition{Array{Float64,1},Float64}([-1.0090950000899441, 0.34292892918572326, 0.707849408026509, 12.989847264749255, 0.15916313317163233, 0.03567162425064763, 1.1416203111672492, 1.4096149407212786, 4.208827977031049], -303.7134733953065, 3, DynamicHMC.DoubledTurn, 0.9049533461359083, 7), NUTS_Transition{Array{Float64,1},Float64}([-0.4238659412365359, 0.11624500556442123, 0.1574863152734513, 13.359257891815552, -0.4763913130655173, -0.08409735377067606, -0.13106948509156746, 0.3520051590050365, 3.2298691041982672], -304.5996263583603, 3, DynamicHMC.DoubledTurn, 0.9388229244787143, 7), NUTS_Transition{Array{Float64,1},Float64}([-7.337361420328498, 0.7248514268956158, 6.43828808690726, 12.224974694229262, 6.52818754432303, 6.151464505007445, 6.77894497875833, 8.100974250795385, 8.572999851816078], -302.47476912204536, 3, DynamicHMC.DoubledTurn, 0.9954859701996652, 7), NUTS_Transition{Array{Float64,1},Float64}([-5.440438662051958, 0.4276244226832102, 4.5975547668895045, 12.854790238560133, 4.459472365842993, 4.5575072864820765, 5.393246710926714, 6.368180274917288, 7.323462825377124], -304.9117051044351, 3, DynamicHMC.DoubledTurn, 0.685304912389437, 7), NUTS_Transition{Array{Float64,1},Float64}([-9.118625675503129, 0.2925250826975466, 8.356545839211137, 17.67054419179018, 8.02082274335743, 8.300692656859523, 8.821917170093796, 9.917799782686187, 11.23770201152027], -302.5478755753251, 3, DynamicHMC.DoubledTurn, 0.9708805531259593, 7), NUTS_Transition{Array{Float64,1},Float64}([6.280110093974789, 0.17535253960336578, -6.70372421697975, 15.699944086313739, -6.503991117120565, -6.906450919863171, -6.730079893426538, -5.936007705178464, -4.474189945682211], -306.47354198882624, 3, DynamicHMC.AdjacentTurn, 0.8546843645083951, 15), NUTS_Transition{Array{Float64,1},Float64}([6.807866722213883, 0.5087885312275141, -7.485583324919247, 3.010387675145224, -7.692210301337406, -7.470195568605069, -7.657750510323199, -6.216615520906279, -4.613112283416349], -300.3343426519028, 2, DynamicHMC.AdjacentTurn, 0.7780324294129963, 5), NUTS_Transition{Array{Float64,1},Float64}([5.693010087661556, 0.46754463121987255, -6.095864069686765, 1.4057425385910407, -6.504882142828684, -6.192442111822258, -5.9564083988870316, -5.066810131241595, -4.170770662075861], -298.27732492984427, 3, DynamicHMC.DoubledTurn, 0.9324664781976529, 7)], NUTS sampler in 9 dimensions
  stepsize (ϵ) ≈ 0.317
  maximum depth = 10
  Gaussian kinetic energy, √diag(M⁻¹): [3.134983296824429, 0.4303659925582396, 3.133026897982826, 5.95446377054667, 3.1356672585316034, 3.1519924204475434, 3.1384367405801328, 3.135618421747939, 3.188310622904118]
)</code></pre></div><p>We use the transformation to obtain the posterior from the chain.</p><div><pre><code class="language-julia">posterior = TransformVariables.transform.(Ref(problem_transformation(p)), get_position.(chain));
posterior[1:5]</code></pre><pre><code class="language-none">5-element Array{NamedTuple{(:β, :α),Tuple{Array{Float64,1},Array{Float64,1}}},1}:
 (β = [2.8733758671822915, 0.6274916282058423], α = [-3.3541196774573057, 9.63914656893609, -3.737115487013561, -3.7637935194949925, -3.7568058018740804, -2.5911883430053018, -0.5271440843732793])
 (β = [1.439071343773101, 0.6937439046978235], α = [-1.8556754777412106, 10.682476427281806, -2.1574863936890933, -2.416376008139089, -2.2380437080427784, -0.9081939185295986, 1.0804851413384151])
 (β = [0.19467805453864906, 0.33651774902253245], α = [-0.691114696426151, 14.84000701788259, -1.1705220256620557, -0.7770810923062523, -0.2964305511033325, 0.3088486638202309, 1.7087587825102348])
 (β = [-0.857708001654235, 0.42835657827891427], α = [0.5622420133745645, 24.982964417119277, 0.320852605207592, 0.13173688271755554, 0.20816818639163573, 1.3598562812851638, 2.763537648696642])
 (β = [-9.259349527759712, 0.41231279601633486], α = [8.607622593124542, 32.313844054998775, 8.2708591091368, 8.601669733864036, 8.97212712934204, 9.781617953378031, 11.507298472412732])</code></pre></div><p>Extract the parameter posterior means: <code>β</code>,</p><div><pre><code class="language-julia">posterior_β = mean(first, posterior)</code></pre><pre><code class="language-none">2-element Array{Float64,1}:
 1.323376434903972
 0.4119938865914121</code></pre></div><p>Extract the parameter posterior means: <code>β</code>,</p><div><pre><code class="language-julia">posterior_α = mean(last, posterior)</code></pre><pre><code class="language-none">7-element Array{Float64,1}:
 -1.7745937277124877
 10.413823450508163
 -2.0733402781336494
 -2.085875299217163
 -1.773576574683753
 -0.8497195220334659
  0.7352040430267662</code></pre></div><p>Effective sample sizes (of untransformed draws)</p><div><pre><code class="language-julia">ess = mapslices(effective_sample_size, get_position_matrix(chain); dims = 1)
ess</code></pre><pre><code class="language-none">1×9 Array{Float64,2}:
 293.229  1000.0  290.993  294.758  294.609  291.018  291.9  294.382  296.927</code></pre></div><p>NUTS-specific statistics</p><div><pre><code class="language-julia">NUTS_statistics(chain)</code></pre><pre><code class="language-none">Hamiltonian Monte Carlo sample of length 1000
  acceptance rate mean: 0.8, min/25%/median/75%/max: 0.0 0.73 0.88 0.97 1.0
  termination: AdjacentDivergent =&gt; 4% AdjacentTurn =&gt; 15% DoubledTurn =&gt; 80%
  depth: 1 =&gt; 1% 2 =&gt; 10% 3 =&gt; 88% 4 =&gt; 1%</code></pre></div><p>Result rethinking</p><div><pre><code class="language-julia">rethinking = &quot;
Iterations = 1:1000
Thinning interval = 1
Chains = 1,2,3,4
Samples per chain = 1000

Empirical Posterior Estimates:
        Mean        SD       Naive SE       MCSE      ESS
a.1 -0.74503184 0.26613979 0.0042080396 0.0060183398 1000
a.2 10.77955494 5.32538998 0.0842018089 0.1269148045 1000
a.3 -1.04982353 0.28535997 0.0045119373 0.0049074219 1000
a.4 -1.04898135 0.28129307 0.0044476339 0.0056325117 1000
a.5 -0.74390933 0.26949936 0.0042611590 0.0052178124 1000
a.6  0.21599365 0.26307574 0.0041595927 0.0045153523 1000
a.7  1.81090866 0.39318577 0.0062168129 0.0071483527 1000
 bp  0.83979926 0.26284676 0.0041559722 0.0059795826 1000
bpC -0.12913322 0.29935741 0.0047332562 0.0049519863 1000
&quot;;</code></pre><pre><code class="language-none">&quot;\nIterations = 1:1000\nThinning interval = 1\nChains = 1,2,3,4\nSamples per chain = 1000\n\nEmpirical Posterior Estimates:\n        Mean        SD       Naive SE       MCSE      ESS\na.1 -0.74503184 0.26613979 0.0042080396 0.0060183398 1000\na.2 10.77955494 5.32538998 0.0842018089 0.1269148045 1000\na.3 -1.04982353 0.28535997 0.0045119373 0.0049074219 1000\na.4 -1.04898135 0.28129307 0.0044476339 0.0056325117 1000\na.5 -0.74390933 0.26949936 0.0042611590 0.0052178124 1000\na.6  0.21599365 0.26307574 0.0041595927 0.0045153523 1000\na.7  1.81090866 0.39318577 0.0062168129 0.0071483527 1000\n bp  0.83979926 0.26284676 0.0041559722 0.0059795826 1000\nbpC -0.12913322 0.29935741 0.0047332562 0.0049519863 1000\n&quot;</code></pre></div><p>Means of draws</p><div><pre><code class="language-julia">[posterior_β, posterior_α]</code></pre><pre><code class="language-none">2-element Array{Array{Float64,1},1}:
 [1.323376434903972, 0.4119938865914121]
 [-1.7745937277124877, 10.413823450508163, -2.0733402781336494, -2.085875299217163, -1.773576574683753, -0.8497195220334659, 0.7352040430267662]</code></pre></div><p>End of <code>10/m10.04d.jl</code></p><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p><footer><hr/><a class="previous" href="../m10.02d1/"><span class="direction">Previous</span><span class="title">m10.02d1</span></a><a class="next" href="../m10.04d1/"><span class="direction">Next</span><span class="title">m10.04d1</span></a></footer></article></body></html>
