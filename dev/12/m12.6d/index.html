<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>m12.6d · DynamicHMCModels.jl</title><link href="https://cdnjs.cloudflare.com/ajax/libs/normalize/4.2.0/normalize.min.css" rel="stylesheet" type="text/css"/><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.2.0/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link href="../../assets/documenter.css" rel="stylesheet" type="text/css"/></head><body><nav class="toc"><h1>DynamicHMCModels.jl</h1><select id="version-selector" onChange="window.location.href=this.value" style="visibility: hidden"></select><form class="search" id="search-form" action="../../search/"><input id="search-query" name="q" type="text" placeholder="Search docs"/></form><ul><li><a class="toctext" href="../../intro/">Home</a></li><li><span class="toctext">Chapter 02</span><ul><li><a class="toctext" href="../../02/m2.1d/">m2.1d</a></li></ul></li><li><span class="toctext">Chapter 04</span><ul><li><a class="toctext" href="../../04/m4.1d/">m4.1d</a></li><li><a class="toctext" href="../../04/m4.2d/">m4.2d</a></li><li><a class="toctext" href="../../04/m4.5d/">m4.5d</a></li></ul></li><li><span class="toctext">Chapter 05</span><ul><li><a class="toctext" href="../../05/m5.1d/">m5.1d</a></li><li><a class="toctext" href="../../05/m5.1d1/">m5.1d1</a></li><li><a class="toctext" href="../../05/m5.3d/">m5.3d</a></li><li><a class="toctext" href="../../05/m5.6d/">m5.6d</a></li></ul></li><li><span class="toctext">Chapter 08</span><ul><li><a class="toctext" href="../../08/m8.1d/">m8.1d</a></li></ul></li><li><span class="toctext">Chapter 10</span><ul><li><a class="toctext" href="../../10/m10.02d/">m10.02d</a></li><li><a class="toctext" href="../../10/m10.02d1/">m10.02d1</a></li><li><a class="toctext" href="../../10/m10.04d/">m10.04d</a></li><li><a class="toctext" href="../../10/m10.04d1/">m10.04d1</a></li><li><a class="toctext" href="../../10/m10.04d2/">m10.04d2</a></li></ul></li><li><span class="toctext">Chapter 12</span><ul><li class="current"><a class="toctext" href>m12.6d</a><ul class="internal"></ul></li><li><a class="toctext" href="../m12.6d1/">m12.6d1</a></li><li><a class="toctext" href="../m12.6d2/">m12.6d2</a></li></ul></li><li><a class="toctext" href="../../">Functions</a></li></ul></nav><article id="docs"><header><nav><ul><li>Chapter 12</li><li><a href>m12.6d</a></li></ul><a class="edit-page" href="https://github.com/StatisticalRethinkingJulia/DynamicHMCModels.jl/blob/master/scripts/12/m12.6d.jl"><span class="fa"></span> Edit on GitHub</a></nav><hr/><div id="topbar"><span>m12.6d</span><a class="fa fa-bars" href="#"></a></div></header><pre><code class="language-julia">using DynamicHMCModels

ProjDir = rel_path_d(&quot;..&quot;, &quot;scripts&quot;, &quot;12&quot;)

df = CSV.read(rel_path( &quot;..&quot;, &quot;data&quot;,  &quot;Kline.csv&quot;), delim=&#39;;&#39;);
size(df) # Should be 10x5</code></pre><pre><code class="language-none">(10, 5)</code></pre><p>New col logpop, set log() for population data</p><pre><code class="language-julia">df[:logpop] = map((x) -&gt; log(x), df[:population]);
df[:society] = 1:10;

first(df[[:total_tools, :logpop, :society]], 5)

struct m_12_06d_model{TY &lt;: AbstractVector, TX &lt;: AbstractMatrix,
  TS &lt;: AbstractVector}
    &quot;Observations (total_tools).&quot;
    y::TY
    &quot;Covariates (logpop)&quot;
    X::TX
    &quot;Society&quot;
    S::TS
    &quot;Number of observations (10)&quot;
    N::Int
    &quot;Number of societies (also 10)&quot;
    N_societies::Int
end</code></pre><p>Make the type callable with the parameters <em>as a single argument</em>.</p><pre><code class="language-julia">function (problem::m_12_06d_model)(θ)
    @unpack y, X, S, N, N_societies = problem   # extract the data
    @unpack β, α, σ = θ  # β : a, bp, α : a_society
    ll = 0.0
    ll += logpdf(Cauchy(0, 1), σ)
    ll += sum(logpdf.(Normal(0, σ), α)) # α[1:10]
    ll += logpdf.(Normal(0, 10), β[1]) # a
    ll += logpdf.(Normal(0, 1), β[2]) # a
    ll += sum(
      [loglikelihood(Poisson(exp(α[S[i]] + dot(X[i, :], β))), [y[i]]) for i in 1:N]
    )
    ll
end</code></pre><p>Instantiate the model with data and inits.</p><pre><code class="language-julia">N = size(df, 1)
N_societies = length(unique(df[:society]))
X = hcat(ones(Int64, N), df[:logpop]);
S = df[:society]
y = df[:total_tools]
p = m_12_06d_model(y, X, S, N, N_societies);
θ = (β = [1.0, 0.25], α = rand(Normal(0, 1), N_societies), σ = 0.2)
p(θ)</code></pre><pre><code class="language-none">-725.953784637201</code></pre><p>Write a function to return properly dimensioned transformation.</p><pre><code class="language-julia">problem_transformation(p::m_12_06d_model) =
    as( (β = as(Array, size(p.X, 2)), α = as(Array, p.N_societies), σ = asℝ₊) )</code></pre><p>Wrap the problem with a transformation, then use Flux for the gradient.</p><pre><code class="language-julia">P = TransformedLogDensity(problem_transformation(p), p)
∇P = LogDensityRejectErrors(ADgradient(:ForwardDiff, P));
#∇P = ADgradient(:ForwardDiff, P);</code></pre><p>Tune and sample.</p><pre><code class="language-julia">chain, NUTS_tuned = NUTS_init_tune_mcmc(∇P, 1000);</code></pre><pre><code class="language-none">(NUTS_Transition{Array{Float64,1},Float64}[NUTS_Transition{Array{Float64,1},Float64}([-0.11788603949228967, 0.4257208547214962, -0.3392764838569714, -0.22371618594398138, -0.05048477204892204, 0.04685167059783417, -0.28150871283522255, -0.5192136226109729, 0.0174614568758915, -0.36143155606157346, -0.25229126720517864, -1.0564180406431138, -0.9816513714792242], -53.60108612144167, 4, DynamicHMC.DoubledTurn, 0.9476011320201315, 15), NUTS_Transition{Array{Float64,1},Float64}([0.9360024013626295, 0.2946320033722148, -0.40417970152763233, -0.23334805588898727, -0.06879390182288812, 0.1492087174805622, -0.24602692907868265, -0.2975571508064968, -0.17653942721786026, -0.40839375320920507, 0.07378936235212732, -0.37202135573500683, -0.300987915563168], -50.862994252633584, 4, DynamicHMC.DoubledTurn, 0.9644518548855074, 15), NUTS_Transition{Array{Float64,1},Float64}([0.9710498556820245, 0.2737026672437515, 0.2105928564260616, -0.05988040536665559, 0.08598523835902319, 0.44195580969783654, 0.1625629239642345, -0.18347691095310836, -0.06972050194830592, -0.16522175712505496, 0.10704100815187687, -0.2622128990410008, -1.6566251418474829], -48.610914063755594, 4, DynamicHMC.DoubledTurn, 0.997692969263597, 15), NUTS_Transition{Array{Float64,1},Float64}([0.7067342002196666, 0.2956116923776072, -0.21072440192487046, -0.0504773337597043, -0.16212075128998113, 0.1886590079487413, 0.2335834200851771, -0.17795037836862934, 0.18784403613607545, -0.219544469172473, 0.25438278924602215, -0.1418818867497773, -0.8129258080691815], -45.56645038888549, 4, DynamicHMC.DoubledTurn, 0.830971186219968, 15), NUTS_Transition{Array{Float64,1},Float64}([1.5982022464491585, 0.2327128321096361, -0.6348551636727054, -0.2900612852304102, -0.22746494255843078, 0.27594213634746967, -0.12992384993499212, -0.3822539841062665, -0.08430281175796932, -0.4396895614302986, 0.19875250911261017, -0.3448143734272381, -1.3074650154471399], -44.495782908196816, 4, DynamicHMC.DoubledTurn, 0.99584397242688, 15), NUTS_Transition{Array{Float64,1},Float64}([0.6654169052097877, 0.31993663769894665, -0.6915926279118951, 0.18221307976458967, 0.23877927065351862, 0.14771922208757773, 0.02096444152426069, -0.36564840651064395, 0.025337251612565774, -0.35170029336954495, 0.13113597885223732, -0.3300950133525761, -0.7156930077649462], -45.8827159924106, 4, DynamicHMC.DoubledTurn, 0.9919789278328549, 15), NUTS_Transition{Array{Float64,1},Float64}([1.6761991137794527, 0.19762734378993144, -0.09949507074006003, 0.038736806880210625, -0.11856886575472428, 0.3890083930451759, 0.0625856245206869, 0.04209653400077704, -0.09968250132528866, -0.20660861417217807, 0.1904657642631363, 0.15891435426513126, -1.876240285334547], -45.542124131701186, 4, DynamicHMC.DoubledTurn, 1.0, 15), NUTS_Transition{Array{Float64,1},Float64}([1.4981269054551085, 0.21638896088434295, -0.11264938179363822, 0.009642527840038218, -0.1397315802880625, 0.31532405735096697, 0.1343920791961766, -0.06768841519786242, -0.12108513071392174, -0.04413462292102993, 0.12783145683882666, 0.11318276312156418, -1.5580772302807961], -42.47805209506156, 4, DynamicHMC.DoubledTurn, 0.9994159537502444, 15), NUTS_Transition{Array{Float64,1},Float64}([1.1485820830403664, 0.2591762939581252, -0.05826278686455012, 0.009517292691021077, 0.009407197711196982, 0.2152282055412573, -0.0888510171945427, -0.270541124121504, 0.14328826776850836, -0.14837317269858308, 0.13073497504165402, -0.25350488591298576, -1.8530780083751184], -39.69607703807404, 4, DynamicHMC.DoubledTurn, 0.9377141671890643, 15), NUTS_Transition{Array{Float64,1},Float64}([1.6206101013425533, 0.20089891413928146, -0.41701910761463357, 0.2412896094712769, -0.08168185313372589, 0.21773075497588326, 0.03248090628877216, -0.5119694535650086, 0.2589150048473959, -0.3086124900661617, 0.36359917496185085, 0.020713735319663654, -1.0735571205283676], -40.21996881674238, 4, DynamicHMC.DoubledTurn, 0.9443334084184568, 15)  …  NUTS_Transition{Array{Float64,1},Float64}([0.7906891912887285, 0.29544630831488855, -0.4212192569632408, 0.3151929015842021, -0.09694163460688793, 0.3820747327599868, -0.040409527462065525, -0.3140126097527199, 0.07560832049998947, -0.3217410697446469, 0.2947499640142658, -0.1329304094281853, -1.513091159638823], -42.86247284422191, 4, DynamicHMC.DoubledTurn, 0.917483042488895, 15), NUTS_Transition{Array{Float64,1},Float64}([1.8526107464988233, 0.1764070997637196, -0.019286323349953567, -0.02104026707345274, -0.033408627515449985, 0.2998418820342438, 0.16412939835555235, -0.34029435936044733, 0.24551596357039804, 0.14256134901122022, 0.318474345132916, 0.05367497521739754, -0.7381965639897018], -49.01437431830534, 4, DynamicHMC.DoubledTurn, 0.8918470675868275, 15), NUTS_Transition{Array{Float64,1},Float64}([0.5861027937238333, 0.31935299079422036, 0.023174022314229104, 0.22168166920672272, -0.21883669430777802, 0.33870200024550545, 0.017818177222132747, -0.6215807475941889, 0.08355495290301881, -0.23583152606530192, 0.2648163641304797, -0.35653860598144554, -1.5486133223870866], -44.3892801411684, 4, DynamicHMC.DoubledTurn, 0.9605084120840333, 15), NUTS_Transition{Array{Float64,1},Float64}([1.0096753277868697, 0.2635555582431174, -0.5376720467198425, 0.24174175607515014, 0.02366394035123419, 0.18509689814625271, 0.09160271094369452, -0.3615571808765097, 0.2763740429073493, -0.3609191955215896, 0.30659157166594786, 0.121217486715991, -0.8145738940363464], -46.95621364350179, 4, DynamicHMC.DoubledTurn, 0.7864238079335534, 15), NUTS_Transition{Array{Float64,1},Float64}([1.0436994513794908, 0.2663940348726994, -0.01738183496642226, 0.09468660221794055, -0.05816312836077399, 0.22055889152349786, -0.14510807915763982, -0.03640805408451101, 0.17864432353628268, -0.023741191254983286, 0.12838943935797542, -0.05998103208000452, -2.2415225161356784], -43.9388372311549, 4, DynamicHMC.DoubledTurn, 0.9917502989677167, 15), NUTS_Transition{Array{Float64,1},Float64}([0.7209898799418977, 0.283010881003885, -0.10891883540688924, 0.16672708807096576, 0.12015005746810412, 0.26359993771469314, 0.3538491411665206, -0.1199818937953618, -0.018042858957240407, -0.09833729602485863, 0.23476650870758567, -0.22231560266756345, -1.5380359109275803], -51.62872244612959, 4, DynamicHMC.DoubledTurn, 0.37889622856389477, 15), NUTS_Transition{Array{Float64,1},Float64}([1.5170416316487658, 0.21897708473629962, -0.1494914682024614, -0.068770193216407, -0.08696748508491037, 0.24704267089441181, -0.18194358600871155, -0.3022265928032015, 0.10872125740607322, -0.25521170391478, 0.107086773651781, -0.07325540995629418, -1.8142283130700516], -43.54412386576654, 4, DynamicHMC.DoubledTurn, 0.9601664374494525, 15), NUTS_Transition{Array{Float64,1},Float64}([1.1812573972047629, 0.2793638512192176, -0.16665002928709033, -0.18082956388325855, -0.11626807561745896, 0.28995519174607337, -0.11416758499289398, -0.2798056348054296, 0.048629809670958465, -0.279673367092106, 0.24384004929150105, -0.25831919573667517, -1.8446684698387856], -47.70825693818817, 4, DynamicHMC.DoubledTurn, 0.670854780956822, 15), NUTS_Transition{Array{Float64,1},Float64}([1.3513048973055637, 0.21327057949995978, -0.14141636374084499, -0.1253654570574351, 0.2385278077273212, 0.4508600538449904, 0.044438747942323484, -0.1870967841140262, 0.30106519921302255, 0.0074100343550683664, 0.3051056745855496, 0.015565789297730143, -1.9130758380728388], -49.80815331669754, 3, DynamicHMC.DoubledTurn, 0.9479141350397813, 7), NUTS_Transition{Array{Float64,1},Float64}([1.7167691177718873, 0.2163462728705809, -0.25157344294111766, -0.3973855012353994, 0.08633939932078477, 0.14112988980485774, -0.21500844701506405, -0.3813256296029083, 0.08917179575147954, -0.4152896221120842, 0.31551879272029104, 0.03661149704036019, -1.6027664975614246], -54.52359825754405, 4, DynamicHMC.DoubledTurn, 0.9509836351007923, 15)], NUTS sampler in 13 dimensions
  stepsize (ϵ) ≈ 0.25
  maximum depth = 10
  Gaussian kinetic energy, √diag(M⁻¹): [0.7338367450164993, 0.0835979590056244, 0.23070010291852278, 0.19893920096127732, 0.19607483756294253, 0.18491705540741513, 0.18051558684656602, 0.20378432357531936, 0.17170046685605653, 0.18043919892687624, 0.1892758779872943, 0.30425917048812934, 0.39237859012941795]
)</code></pre><p>We use the transformation to obtain the posterior from the chain.</p><pre><code class="language-julia">posterior = TransformVariables.transform.(Ref(problem_transformation(p)), get_position.(chain));
posterior[1:5]</code></pre><pre><code class="language-none">5-element Array{NamedTuple{(:β, :α, :σ),Tuple{Array{Float64,1},Array{Float64,1},Float64}},1}:
 (β = [-0.11788603949228967, 0.4257208547214962], α = [-0.3392764838569714, -0.22371618594398138, -0.05048477204892204, 0.04685167059783417, -0.28150871283522255, -0.5192136226109729, 0.0174614568758915, -0.36143155606157346, -0.25229126720517864, -1.0564180406431138], σ = 0.37469183226723735)
 (β = [0.9360024013626295, 0.2946320033722148], α = [-0.40417970152763233, -0.23334805588898727, -0.06879390182288812, 0.1492087174805622, -0.24602692907868265, -0.2975571508064968, -0.17653942721786026, -0.40839375320920507, 0.07378936235212732, -0.37202135573500683], σ = 0.7400867162238415) 
 (β = [0.9710498556820245, 0.2737026672437515], α = [0.2105928564260616, -0.05988040536665559, 0.08598523835902319, 0.44195580969783654, 0.1625629239642345, -0.18347691095310836, -0.06972050194830592, -0.16522175712505496, 0.10704100815187687, -0.2622128990410008], σ = 0.1907817562176516)     
 (β = [0.7067342002196666, 0.2956116923776072], α = [-0.21072440192487046, -0.0504773337597043, -0.16212075128998113, 0.1886590079487413, 0.2335834200851771, -0.17795037836862934, 0.18784403613607545, -0.219544469172473, 0.25438278924602215, -0.1418818867497773], σ = 0.44355839911853023)      
 (β = [1.5982022464491585, 0.2327128321096361], α = [-0.6348551636727054, -0.2900612852304102, -0.22746494255843078, 0.27594213634746967, -0.12992384993499212, -0.3822539841062665, -0.08430281175796932, -0.4396895614302986, 0.19875250911261017, -0.3448143734272381], σ = 0.27050491374433827)   </code></pre><p>Extract the parameter posterior means.</p><pre><code class="language-julia">posterior_β = mean(posterior[i].β for i in 1:length(posterior))
posterior_α = mean(posterior[i].α for i in 1:length(posterior))
posterior_σ = mean(posterior[i].σ for i in 1:length(posterior))</code></pre><pre><code class="language-none">0.3156993527629704</code></pre><p>Effective sample sizes (of untransformed draws)</p><pre><code class="language-julia">ess = mapslices(effective_sample_size, get_position_matrix(chain); dims = 1)
ess</code></pre><pre><code class="language-none">1×13 Array{Float64,2}:
 476.26  464.056  504.089  716.333  …  980.425  537.865  455.227  277.187</code></pre><p>NUTS-specific statistics</p><pre><code class="language-julia">NUTS_statistics(chain)</code></pre><pre><code class="language-none">Hamiltonian Monte Carlo sample of length 1000
  acceptance rate mean: 0.92, min/25%/median/75%/max: 0.11 0.89 0.96 0.99 1.0
  termination: AdjacentTurn =&gt; 5% DoubledTurn =&gt; 95%
  depth: 3 =&gt; 8% 4 =&gt; 92% 5 =&gt; 0%
</code></pre><p>CmdStan result</p><pre><code class="language-julia">m_12_6_result = &quot;
Iterations = 1:1000
Thinning interval = 1
Chains = 1,2,3,4
Samples per chain = 1000

Empirical Posterior Estimates:
                            Mean                SD               Naive SE             MCSE            ESS
            a          1.076167468  0.7704872560 0.01218247319 0.0210530022 1000.000000
           bp         0.263056273  0.0823415805 0.00130193470 0.0022645077 1000.000000
  a_society.1   -0.191723568  0.2421382537 0.00382854195 0.0060563054 1000.000000
  a_society.2    0.054569029  0.2278506876 0.00360263570 0.0051693148 1000.000000
  a_society.3   -0.035935050  0.1926364647 0.00304584994 0.0039948433 1000.000000
  a_society.4    0.334355037  0.1929971201 0.00305155241 0.0063871707  913.029080
  a_society.5    0.049747513  0.1801287716 0.00284808595 0.0043631095 1000.000000
  a_society.6   -0.311903245  0.2096126337 0.00331426674 0.0053000536 1000.000000
  a_society.7    0.148637507  0.1744680594 0.00275858223 0.0047660246 1000.000000
  a_society.8   -0.164567976  0.1821341074 0.00287979309 0.0034297298 1000.000000
  a_society.9    0.277066965  0.1758237250 0.00278001719 0.0055844175  991.286501
 a_society.10   -0.094149204  0.2846206232 0.00450024719 0.0080735022 1000.000000
sigma_society    0.310352849  0.1374834682 0.00217380450 0.0057325226  575.187461
&quot;;</code></pre><pre><code class="language-none">&quot;\nIterations = 1:1000\nThinning interval = 1\nChains = 1,2,3,4\nSamples per chain = 1000\n\nEmpirical Posterior Estimates:\n                            Mean                SD               Naive SE             MCSE            ESS\n            a          1.076167468  0.7704872560 0.01218247319 0.0210530022 1000.000000\n           bp         0.263056273  0.0823415805 0.00130193470 0.0022645077 1000.000000\n  a_society.1   -0.191723568  0.2421382537 0.00382854195 0.0060563054 1000.000000\n  a_society.2    0.054569029  0.2278506876 0.00360263570 0.0051693148 1000.000000\n  a_society.3   -0.035935050  0.1926364647 0.00304584994 0.0039948433 1000.000000\n  a_society.4    0.334355037  0.1929971201 0.00305155241 0.0063871707  913.029080\n  a_society.5    0.049747513  0.1801287716 0.00284808595 0.0043631095 1000.000000\n  a_society.6   -0.311903245  0.2096126337 0.00331426674 0.0053000536 1000.000000\n  a_society.7    0.148637507  0.1744680594 0.00275858223 0.0047660246 1000.000000\n  a_society.8   -0.164567976  0.1821341074 0.00287979309 0.0034297298 1000.000000\n  a_society.9    0.277066965  0.1758237250 0.00278001719 0.0055844175  991.286501\n a_society.10   -0.094149204  0.2846206232 0.00450024719 0.0080735022 1000.000000\nsigma_society    0.310352849  0.1374834682 0.00217380450 0.0057325226  575.187461\n&quot;</code></pre><p>Show means</p><pre><code class="language-julia">[posterior_β, posterior_α, [posterior_σ]]</code></pre><pre><code class="language-none">3-element Array{Array{Float64,1},1}:
 [1.1809346928042324, 0.25261826284101063]                                                                                                                                                                          
 [-0.22853307868986084, 0.034789566268976745, -0.05765606505602865, 0.3207963962185031, 0.03500369703518756, -0.3222236115521845, 0.1373027771147312, -0.17272945132110468, 0.271243948585965, -0.07153845158576355]
 [0.3156993527629704]                                                                                                                                                                                               </code></pre><p>End of m12.6d.jl</p><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p><footer><hr/><a class="previous" href="../../10/m10.04d2/"><span class="direction">Previous</span><span class="title">m10.04d2</span></a><a class="next" href="../m12.6d1/"><span class="direction">Next</span><span class="title">m12.6d1</span></a></footer></article></body></html>
