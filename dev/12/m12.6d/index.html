<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>m12.6d · DynamicHMCModels.jl</title><link href="https://cdnjs.cloudflare.com/ajax/libs/normalize/4.2.0/normalize.min.css" rel="stylesheet" type="text/css"/><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.2.0/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link href="../../assets/documenter.css" rel="stylesheet" type="text/css"/></head><body><nav class="toc"><h1>DynamicHMCModels.jl</h1><select id="version-selector" onChange="window.location.href=this.value" style="visibility: hidden"></select><form class="search" id="search-form" action="../../search/"><input id="search-query" name="q" type="text" placeholder="Search docs"/></form><ul><li><a class="toctext" href="../../intro/">Home</a></li><li><span class="toctext">Chapter 02</span><ul><li><a class="toctext" href="../../02/m2.1d/">m2.1d</a></li></ul></li><li><span class="toctext">Chapter 04</span><ul><li><a class="toctext" href="../../04/m4.1d/">m4.1d</a></li><li><a class="toctext" href="../../04/m4.2d/">m4.2d</a></li><li><a class="toctext" href="../../04/m4.5d/">m4.5d</a></li></ul></li><li><span class="toctext">Chapter 05</span><ul><li><a class="toctext" href="../../05/m5.1d/">m5.1d</a></li><li><a class="toctext" href="../../05/m5.1d1/">m5.1d1</a></li><li><a class="toctext" href="../../05/m5.3d/">m5.3d</a></li><li><a class="toctext" href="../../05/m5.6d/">m5.6d</a></li></ul></li><li><span class="toctext">Chapter 08</span><ul><li><a class="toctext" href="../../08/m8.1d/">m8.1d</a></li></ul></li><li><span class="toctext">Chapter 10</span><ul><li><a class="toctext" href="../../10/m10.02d/">m10.02d</a></li><li><a class="toctext" href="../../10/m10.02d1/">m10.02d1</a></li><li><a class="toctext" href="../../10/m10.04d/">m10.04d</a></li><li><a class="toctext" href="../../10/m10.04d1/">m10.04d1</a></li><li><a class="toctext" href="../../10/m10.04d2/">m10.04d2</a></li></ul></li><li><span class="toctext">Chapter 12</span><ul><li class="current"><a class="toctext" href>m12.6d</a><ul class="internal"></ul></li><li><a class="toctext" href="../m12.6d1/">m12.6d1</a></li><li><a class="toctext" href="../m12.6d2/">m12.6d2</a></li></ul></li><li><a class="toctext" href="../../">Functions</a></li></ul></nav><article id="docs"><header><nav><ul><li>Chapter 12</li><li><a href>m12.6d</a></li></ul><a class="edit-page" href="https://github.com/StatisticalRethinkingJulia/DynamicHMCModels.jl/blob/master/scripts/12/m12.6d.jl"><span class="fa"></span> Edit on GitHub</a></nav><hr/><div id="topbar"><span>m12.6d</span><a class="fa fa-bars" href="#"></a></div></header><pre><code class="language-julia">using DynamicHMCModels

ProjDir = rel_path_d(&quot;..&quot;, &quot;scripts&quot;, &quot;12&quot;)

df = CSV.read(rel_path( &quot;..&quot;, &quot;data&quot;,  &quot;Kline.csv&quot;), delim=&#39;;&#39;);
size(df) # Should be 10x5</code></pre><pre><code class="language-none">(10, 5)</code></pre><p>New col logpop, set log() for population data</p><pre><code class="language-julia">df[:logpop] = map((x) -&gt; log(x), df[:population]);
df[:society] = 1:10;

first(df[[:total_tools, :logpop, :society]], 5)

struct m_12_06d_model{TY &lt;: AbstractVector, TX &lt;: AbstractMatrix,
  TS &lt;: AbstractVector}
    &quot;Observations (total_tools).&quot;
    y::TY
    &quot;Covariates (logpop)&quot;
    X::TX
    &quot;Society&quot;
    S::TS
    &quot;Number of observations (10)&quot;
    N::Int
    &quot;Number of societies (also 10)&quot;
    N_societies::Int
end</code></pre><p>Make the type callable with the parameters <em>as a single argument</em>.</p><pre><code class="language-julia">function (problem::m_12_06d_model)(θ)
    @unpack y, X, S, N, N_societies = problem   # extract the data
    @unpack β, α, σ = θ  # β : a, bp, α : a_society
    ll = 0.0
    ll += logpdf(Cauchy(0, 1), σ)
    ll += sum(logpdf.(Normal(0, σ), α)) # α[1:10]
    ll += logpdf.(Normal(0, 10), β[1]) # a
    ll += logpdf.(Normal(0, 1), β[2]) # a
    ll += sum(
      [loglikelihood(Poisson(exp(α[S[i]] + dot(X[i, :], β))), [y[i]]) for i in 1:N]
    )
    ll
end</code></pre><p>Instantiate the model with data and inits.</p><pre><code class="language-julia">N = size(df, 1)
N_societies = length(unique(df[:society]))
X = hcat(ones(Int64, N), df[:logpop]);
S = df[:society]
y = df[:total_tools]
p = m_12_06d_model(y, X, S, N, N_societies);
θ = (β = [1.0, 0.25], α = rand(Normal(0, 1), N_societies), σ = 0.2)
p(θ)</code></pre><pre><code class="language-none">-366.5384211549115</code></pre><p>Write a function to return properly dimensioned transformation.</p><pre><code class="language-julia">problem_transformation(p::m_12_06d_model) =
    as( (β = as(Array, size(p.X, 2)), α = as(Array, p.N_societies), σ = asℝ₊) )</code></pre><p>Wrap the problem with a transformation, then use Flux for the gradient.</p><pre><code class="language-julia">P = TransformedLogDensity(problem_transformation(p), p)
∇P = LogDensityRejectErrors(ADgradient(:ForwardDiff, P));
#∇P = ADgradient(:ForwardDiff, P);</code></pre><p>Tune and sample.</p><pre><code class="language-julia">chain, NUTS_tuned = NUTS_init_tune_mcmc(∇P, 1000);</code></pre><pre><code class="language-none">(NUTS_Transition{Array{Float64,1},Float64}[NUTS_Transition{Array{Float64,1},Float64}([0.9767653664394426, 0.26392576993570444, -0.1957600335425242, -0.0034767662345835705, -0.04773149631907048, 0.2689713759356569, 0.06659774454689543, -0.2344937754704794, 0.07066825419076397, -0.20804412499119518, 0.3149318177617704, -0.19450915465056196, -1.5894625267151241], -43.843858293750614, 3, DynamicHMC.AdjacentTurn, 0.9941756902056172, 15), NUTS_Transition{Array{Float64,1},Float64}([1.224502550793857, 0.2476206806822816, -0.28336655000961314, 0.011019872637479302, 0.002499484296839046, 0.20801596419431742, -0.2237074371206767, 0.007608464792040276, 0.06934804793013162, -0.1472074693497475, 0.30459525532897247, -0.2141888260987439, -1.6192683339265186], -41.4689357004509, 3, DynamicHMC.DoubledTurn, 0.9108757392945802, 7), NUTS_Transition{Array{Float64,1},Float64}([0.9829365323469788, 0.27864069992127005, -0.3606627403513276, 0.2461913246236163, -0.3896515010502169, 0.5465904929913503, 0.1882170803856191, -0.36077993428893607, 0.23008799024664445, -0.2465383763797239, 0.22323485040978827, -0.09848747683658542, -1.0688588299294912], -44.25649281541375, 4, DynamicHMC.DoubledTurn, 0.8909441615766464, 15), NUTS_Transition{Array{Float64,1},Float64}([1.170507722658592, 0.25094772316245384, 0.11080292807761899, -0.23553019362073377, 0.2665754385875957, 0.10622139059017463, -0.01107249938147934, -0.06314392796532148, 0.12972577973308586, 0.02586570659857651, 0.3998157029146815, -0.0834338174354333, -1.5634921995777484], -45.3141708238405, 4, DynamicHMC.DoubledTurn, 0.8899763712240194, 15), NUTS_Transition{Array{Float64,1},Float64}([1.627475435557491, 0.18825906871177717, -0.34383487118883654, -0.19466479603290215, -0.07397130349179325, 0.47952025225643413, 0.10309256245405599, -0.3024969852945082, 0.3856235280865919, -0.1562416237017435, 0.2581303931944427, 0.18588562457676702, -0.7997930533100069], -45.598785259448974, 4, DynamicHMC.DoubledTurn, 0.8365699682294699, 15), NUTS_Transition{Array{Float64,1},Float64}([1.771931704742468, 0.1713596742452746, -0.38346933537261263, -0.1661514920477696, -0.08101049679747782, 0.45538390614073365, 0.13418265951844352, -0.28275263954427404, 0.44822489873919114, -0.10073157446844996, 0.32126719124277126, 0.26555217038039225, -0.7471556582744405], -44.311827208303484, 4, DynamicHMC.DoubledTurn, 0.9939713825325761, 15), NUTS_Transition{Array{Float64,1},Float64}([0.3731746221091923, 0.3649266153344644, -0.3173769116048964, 0.005356163758166735, -0.276226654032179, 0.3569095820303393, -0.10717129568240974, -0.7131072915607986, -0.08697062100551115, -0.35031138958832225, 0.3451500564556079, -0.6448960399721474, -0.4397697536063745], -47.15380310436968, 5, DynamicHMC.DoubledTurn, 0.9963062039071927, 31), NUTS_Transition{Array{Float64,1},Float64}([1.6336767668974244, 0.2041519288704192, -0.11909082807292545, 0.1488524526368653, -0.004405590543485289, 0.09324006584112345, 0.09152221048258777, -0.03108797518470366, 0.01262503997791456, -0.0298668605823523, 0.19770066558165644, 0.15675950471154693, -2.2206144936754146], -46.239910039118115, 4, DynamicHMC.DoubledTurn, 0.9987160754857817, 15), NUTS_Transition{Array{Float64,1},Float64}([1.4152646267142286, 0.2164441495995767, -0.2747096693361227, -0.11870876302155767, 0.06199015180174351, 0.48438885341285587, -0.001791774542630701, -0.21974828423293732, 0.35162196907096627, -0.052958612165167486, 0.4514215037156411, 0.19345256267615102, -1.22476344435661], -38.48099612275177, 4, DynamicHMC.DoubledTurn, 0.9631381001116239, 15), NUTS_Transition{Array{Float64,1},Float64}([1.4012831791125506, 0.23696827836576664, -0.11181261929520049, 0.06877537305127802, -0.07588978261161648, 0.03466776269185179, 0.08300505728766859, -0.1950050420836042, -0.005717479059833125, -0.028787253389074265, 0.08436512062393613, 0.017766354488651576, -2.122204691055725], -39.65671451107557, 4, DynamicHMC.DoubledTurn, 0.9229404272981829, 15)  …  NUTS_Transition{Array{Float64,1},Float64}([0.5865621379793367, 0.32978372653478394, -0.5868653422556585, -0.3093618140521841, -0.10327267095260348, 0.1957018485677236, -0.08015564133644569, -0.5922113065331214, 0.0347572702877778, -0.5501009025412152, 0.18171620675691305, -0.5617367052539938, -0.9816927396775691], -47.65531250926639, 4, DynamicHMC.DoubledTurn, 0.9308689600667134, 15), NUTS_Transition{Array{Float64,1},Float64}([2.2150798233593596, 0.1264468630866196, 0.03524080000352996, 0.16705021087039987, -0.13170737641338498, 0.7938455853702274, -0.011654564695924886, -0.6449799356661444, 0.4695860806055929, 0.03540759326663474, 0.4864877211127389, 0.5898932525091846, -0.8219361660455193], -55.83820433116748, 4, DynamicHMC.DoubledTurn, 0.9786743682921941, 15), NUTS_Transition{Array{Float64,1},Float64}([2.1290153989571783, 0.12298647909320051, 0.2006461767996885, 0.28527699181459704, 0.12275767110193601, 0.6610697593577858, -0.08839690925764201, -0.4298795208385112, 0.29376607842263286, 0.06912681607997626, 0.4732470890625623, 0.37964097899975713, -1.3864543900194684], -54.253720210526005, 4, DynamicHMC.DoubledTurn, 0.9903580153111474, 15), NUTS_Transition{Array{Float64,1},Float64}([1.6703394782886507, 0.194309675544652, -0.46612945456013516, -0.18282350293916055, -0.17203157289818863, 0.2780586458952413, 0.14688360430562492, -0.3497942477009881, 0.16825741670195182, -0.12085469399518828, 0.42955705115906967, 0.23586341752294737, -0.9506121774822806], -53.59825024870443, 4, DynamicHMC.DoubledTurn, 0.9444936170219613, 15), NUTS_Transition{Array{Float64,1},Float64}([1.7087466416103054, 0.18450191485210535, -0.4221169401662882, -0.24164718108974967, -0.12571340720399732, 0.3211022866291723, 0.21240133225141225, -0.26374333898154173, 0.21827219401496073, -0.10564347749307257, 0.5315227771885577, 0.34389515829771855, -1.0620946483332987], -40.28144025062521, 3, DynamicHMC.AdjacentTurn, 0.9896192449439403, 15), NUTS_Transition{Array{Float64,1},Float64}([1.078624106513886, 0.2742348778839802, 0.22735576470852528, 0.07864249548086304, 0.22275739554715487, 0.1392625622641016, -0.1166572514406252, -0.6900202583269983, 0.1838762703796097, -0.1593615431249948, 0.09225135625745813, -0.2503848962467774, -1.279830874155167], -47.33087989838068, 4, DynamicHMC.DoubledTurn, 0.9516101642139511, 15), NUTS_Transition{Array{Float64,1},Float64}([1.0768380355194331, 0.2547164511814853, -0.4269298653579991, 0.19512057984905365, -0.35787690254433296, 0.33035912464280653, 0.2778176814836429, 0.09337697139577791, 0.24117804887436622, -0.026577280090439952, 0.4480475919398372, -0.0226776849212453, -1.1507045070873725], -48.91433090345501, 4, DynamicHMC.DoubledTurn, 0.9949642863054972, 15), NUTS_Transition{Array{Float64,1},Float64}([0.2611070013812647, 0.3237787178700102, -0.04058658572576665, 0.5293608303682289, 0.17350431376167885, 0.3603747612007913, 0.38457297175305744, 0.13461536765185778, 0.16296197748620406, 0.06089324408219507, 0.4653253859075769, -0.19228736541562208, -1.144612777496885], -47.972391107876945, 4, DynamicHMC.DoubledTurn, 0.8422396586283217, 15), NUTS_Transition{Array{Float64,1},Float64}([1.0061753638829285, 0.27486913564254645, -0.13067780417425745, 0.3262846741993015, -0.012378903998793878, 0.12881790141178023, 0.21769022027746066, 0.0035620000270251834, 0.024491914818659408, -0.030695720190408834, 0.3111509373601013, -0.16541269897177582, -1.2684682541447383], -45.57884320776792, 4, DynamicHMC.DoubledTurn, 0.9814904714621846, 15), NUTS_Transition{Array{Float64,1},Float64}([0.7682987103426098, 0.2941057041257805, -0.1619371612775189, 0.23480710017789302, -0.012129611451776457, 0.06510987254818998, 0.175952260120205, 0.04764702721827344, -0.0963971998329085, -0.041923359373470345, 0.34510344924988645, -0.26263288990554845, -1.2183616379992581], -46.82702665188863, 4, DynamicHMC.DoubledTurn, 0.7161594467825919, 15)], NUTS sampler in 13 dimensions
  stepsize (ϵ) ≈ 0.209
  maximum depth = 10
  Gaussian kinetic energy, √diag(M⁻¹): [0.890089663420597, 0.09733146865131062, 0.2697494789902594, 0.2506868073363849, 0.21937061086472773, 0.19354996245402178, 0.176592102594653, 0.2067196882434048, 0.17478229574687612, 0.1880624751210042, 0.1745056036454707, 0.32005793220832995, 0.39841425675055164]
)</code></pre><p>We use the transformation to obtain the posterior from the chain.</p><pre><code class="language-julia">posterior = TransformVariables.transform.(Ref(problem_transformation(p)), get_position.(chain));
posterior[1:5]</code></pre><pre><code class="language-none">5-element Array{NamedTuple{(:β, :α, :σ),Tuple{Array{Float64,1},Array{Float64,1},Float64}},1}:
 (β = [0.9767653664394426, 0.26392576993570444], α = [-0.1957600335425242, -0.0034767662345835705, -0.04773149631907048, 0.2689713759356569, 0.06659774454689543, -0.2344937754704794, 0.07066825419076397, -0.20804412499119518, 0.3149318177617704, -0.19450915465056196], σ = 0.20403524576266402)
 (β = [1.224502550793857, 0.2476206806822816], α = [-0.28336655000961314, 0.011019872637479302, 0.002499484296839046, 0.20801596419431742, -0.2237074371206767, 0.007608464792040276, 0.06934804793013162, -0.1472074693497475, 0.30459525532897247, -0.2141888260987439], σ = 0.19804354783171577)  
 (β = [0.9829365323469788, 0.27864069992127005], α = [-0.3606627403513276, 0.2461913246236163, -0.3896515010502169, 0.5465904929913503, 0.1882170803856191, -0.36077993428893607, 0.23008799024664445, -0.2465383763797239, 0.22323485040978827, -0.09848747683658542], σ = 0.3434001719023986)      
 (β = [1.170507722658592, 0.25094772316245384], α = [0.11080292807761899, -0.23553019362073377, 0.2665754385875957, 0.10622139059017463, -0.01107249938147934, -0.06314392796532148, 0.12972577973308586, 0.02586570659857651, 0.3998157029146815, -0.0834338174354333], σ = 0.20940351396417295)    
 (β = [1.627475435557491, 0.18825906871177717], α = [-0.34383487118883654, -0.19466479603290215, -0.07397130349179325, 0.47952025225643413, 0.10309256245405599, -0.3024969852945082, 0.3856235280865919, -0.1562416237017435, 0.2581303931944427, 0.18588562457676702], σ = 0.44942196088141806)    </code></pre><p>Extract the parameter posterior means.</p><pre><code class="language-julia">posterior_β = mean(posterior[i].β for i in 1:length(posterior))
posterior_α = mean(posterior[i].α for i in 1:length(posterior))
posterior_σ = mean(posterior[i].σ for i in 1:length(posterior))</code></pre><pre><code class="language-none">0.3115347562424661</code></pre><p>Effective sample sizes (of untransformed draws)</p><pre><code class="language-julia">ess = mapslices(effective_sample_size, get_position_matrix(chain); dims = 1)
ess</code></pre><pre><code class="language-none">1×13 Array{Float64,2}:
 944.524  977.644  1000.0  692.678  …  783.378  828.626  856.794  289.531</code></pre><p>NUTS-specific statistics</p><pre><code class="language-julia">NUTS_statistics(chain)</code></pre><pre><code class="language-none">Hamiltonian Monte Carlo sample of length 1000
  acceptance rate mean: 0.94, min/25%/median/75%/max: 0.46 0.92 0.97 0.99 1.0
  termination: AdjacentTurn =&gt; 8% DoubledTurn =&gt; 92%
  depth: 3 =&gt; 3% 4 =&gt; 93% 5 =&gt; 3%
</code></pre><p>CmdStan result</p><pre><code class="language-julia">m_12_6_result = &quot;
Iterations = 1:1000
Thinning interval = 1
Chains = 1,2,3,4
Samples per chain = 1000

Empirical Posterior Estimates:
                            Mean                SD               Naive SE             MCSE            ESS
            a          1.076167468  0.7704872560 0.01218247319 0.0210530022 1000.000000
           bp         0.263056273  0.0823415805 0.00130193470 0.0022645077 1000.000000
  a_society.1   -0.191723568  0.2421382537 0.00382854195 0.0060563054 1000.000000
  a_society.2    0.054569029  0.2278506876 0.00360263570 0.0051693148 1000.000000
  a_society.3   -0.035935050  0.1926364647 0.00304584994 0.0039948433 1000.000000
  a_society.4    0.334355037  0.1929971201 0.00305155241 0.0063871707  913.029080
  a_society.5    0.049747513  0.1801287716 0.00284808595 0.0043631095 1000.000000
  a_society.6   -0.311903245  0.2096126337 0.00331426674 0.0053000536 1000.000000
  a_society.7    0.148637507  0.1744680594 0.00275858223 0.0047660246 1000.000000
  a_society.8   -0.164567976  0.1821341074 0.00287979309 0.0034297298 1000.000000
  a_society.9    0.277066965  0.1758237250 0.00278001719 0.0055844175  991.286501
 a_society.10   -0.094149204  0.2846206232 0.00450024719 0.0080735022 1000.000000
sigma_society    0.310352849  0.1374834682 0.00217380450 0.0057325226  575.187461
&quot;;</code></pre><pre><code class="language-none">&quot;\nIterations = 1:1000\nThinning interval = 1\nChains = 1,2,3,4\nSamples per chain = 1000\n\nEmpirical Posterior Estimates:\n                            Mean                SD               Naive SE             MCSE            ESS\n            a          1.076167468  0.7704872560 0.01218247319 0.0210530022 1000.000000\n           bp         0.263056273  0.0823415805 0.00130193470 0.0022645077 1000.000000\n  a_society.1   -0.191723568  0.2421382537 0.00382854195 0.0060563054 1000.000000\n  a_society.2    0.054569029  0.2278506876 0.00360263570 0.0051693148 1000.000000\n  a_society.3   -0.035935050  0.1926364647 0.00304584994 0.0039948433 1000.000000\n  a_society.4    0.334355037  0.1929971201 0.00305155241 0.0063871707  913.029080\n  a_society.5    0.049747513  0.1801287716 0.00284808595 0.0043631095 1000.000000\n  a_society.6   -0.311903245  0.2096126337 0.00331426674 0.0053000536 1000.000000\n  a_society.7    0.148637507  0.1744680594 0.00275858223 0.0047660246 1000.000000\n  a_society.8   -0.164567976  0.1821341074 0.00287979309 0.0034297298 1000.000000\n  a_society.9    0.277066965  0.1758237250 0.00278001719 0.0055844175  991.286501\n a_society.10   -0.094149204  0.2846206232 0.00450024719 0.0080735022 1000.000000\nsigma_society    0.310352849  0.1374834682 0.00217380450 0.0057325226  575.187461\n&quot;</code></pre><p>Show means</p><pre><code class="language-julia">[posterior_β, posterior_α, [posterior_σ]]</code></pre><pre><code class="language-none">3-element Array{Array{Float64,1},1}:
 [1.1050468727803056, 0.261078014578953]                                                                                                                                                                            
 [-0.20939804677156879, 0.0399081507602341, -0.04770686295118695, 0.32253503118440663, 0.03523039811816328, -0.3193705725302354, 0.13637547555527219, -0.1690599815903351, 0.2667225855420573, -0.10028318690113519]
 [0.3115347562424661]                                                                                                                                                                                               </code></pre><p>End of m12.6d.jl</p><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p><footer><hr/><a class="previous" href="../../10/m10.04d2/"><span class="direction">Previous</span><span class="title">m10.04d2</span></a><a class="next" href="../m12.6d1/"><span class="direction">Next</span><span class="title">m12.6d1</span></a></footer></article></body></html>
