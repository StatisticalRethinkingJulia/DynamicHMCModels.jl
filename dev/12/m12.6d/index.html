<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>m12.6d · DynamicHMCModels.jl</title><link href="https://cdnjs.cloudflare.com/ajax/libs/normalize/4.2.0/normalize.min.css" rel="stylesheet" type="text/css"/><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.2.0/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link href="../../assets/documenter.css" rel="stylesheet" type="text/css"/></head><body><nav class="toc"><h1>DynamicHMCModels.jl</h1><select id="version-selector" onChange="window.location.href=this.value" style="visibility: hidden"></select><form class="search" id="search-form" action="../../search/"><input id="search-query" name="q" type="text" placeholder="Search docs"/></form><ul><li><a class="toctext" href="../../intro/">Home</a></li><li><span class="toctext">Chapter 02</span><ul><li><a class="toctext" href="../../02/m2.1d/">m2.1d</a></li></ul></li><li><span class="toctext">Chapter 04</span><ul><li><a class="toctext" href="../../04/m4.1d/">m4.1d</a></li><li><a class="toctext" href="../../04/m4.2d/">m4.2d</a></li><li><a class="toctext" href="../../04/m4.5d/">m4.5d</a></li></ul></li><li><span class="toctext">Chapter 05</span><ul><li><a class="toctext" href="../../05/m5.1d/">m5.1d</a></li><li><a class="toctext" href="../../05/m5.1d1/">m5.1d1</a></li><li><a class="toctext" href="../../05/m5.3d/">m5.3d</a></li><li><a class="toctext" href="../../05/m5.6d/">m5.6d</a></li></ul></li><li><span class="toctext">Chapter 08</span><ul><li><a class="toctext" href="../../08/m8.1d/">m8.1d</a></li></ul></li><li><span class="toctext">Chapter 10</span><ul><li><a class="toctext" href="../../10/m10.02d/">m10.02d</a></li><li><a class="toctext" href="../../10/m10.02d1/">m10.02d1</a></li><li><a class="toctext" href="../../10/m10.04d/">m10.04d</a></li><li><a class="toctext" href="../../10/m10.04d1/">m10.04d1</a></li><li><a class="toctext" href="../../10/m10.04d2/">m10.04d2</a></li></ul></li><li><span class="toctext">Chapter 12</span><ul><li class="current"><a class="toctext" href>m12.6d</a><ul class="internal"></ul></li><li><a class="toctext" href="../m12.6d1/">m12.6d1</a></li><li><a class="toctext" href="../m12.6d2/">m12.6d2</a></li></ul></li><li><a class="toctext" href="../../">Functions</a></li></ul></nav><article id="docs"><header><nav><ul><li>Chapter 12</li><li><a href>m12.6d</a></li></ul><a class="edit-page" href="https://github.com/StatisticalRethinkingJulia/DynamicHMCModels.jl/blob/master/scripts/12/m12.6d.jl"><span class="fa"></span> Edit on GitHub</a></nav><hr/><div id="topbar"><span>m12.6d</span><a class="fa fa-bars" href="#"></a></div></header><pre><code class="language-julia">using DynamicHMCModels

ProjDir = rel_path_d(&quot;..&quot;, &quot;scripts&quot;, &quot;12&quot;)

df = CSV.read(rel_path( &quot;..&quot;, &quot;data&quot;,  &quot;Kline.csv&quot;), delim=&#39;;&#39;);
size(df) # Should be 10x5</code></pre><pre><code class="language-none">(10, 5)</code></pre><p>New col logpop, set log() for population data</p><pre><code class="language-julia">df[:logpop] = map((x) -&gt; log(x), df[:population]);
df[:society] = 1:10;

first(df[[:total_tools, :logpop, :society]], 5)

struct m_12_06d_model{TY &lt;: AbstractVector, TX &lt;: AbstractMatrix,
  TS &lt;: AbstractVector}
    &quot;Observations (total_tools).&quot;
    y::TY
    &quot;Covariates (logpop)&quot;
    X::TX
    &quot;Society&quot;
    S::TS
    &quot;Number of observations (10)&quot;
    N::Int
    &quot;Number of societies (also 10)&quot;
    N_societies::Int
end</code></pre><p>Make the type callable with the parameters <em>as a single argument</em>.</p><pre><code class="language-julia">function (problem::m_12_06d_model)(θ)
    @unpack y, X, S, N, N_societies = problem   # extract the data
    @unpack β, α, σ = θ  # β : a, bp, α : a_society
    ll = 0.0
    ll += logpdf(Cauchy(0, 1), σ)
    ll += sum(logpdf.(Normal(0, σ), α)) # α[1:10]
    ll += logpdf.(Normal(0, 10), β[1]) # a
    ll += logpdf.(Normal(0, 1), β[2]) # a
    ll += sum(
      [loglikelihood(Poisson(exp(α[S[i]] + dot(X[i, :], β))), [y[i]]) for i in 1:N]
    )
    ll
end</code></pre><p>Instantiate the model with data and inits.</p><pre><code class="language-julia">N = size(df, 1)
N_societies = length(unique(df[:society]))
X = hcat(ones(Int64, N), df[:logpop]);
S = df[:society]
y = df[:total_tools]
p = m_12_06d_model(y, X, S, N, N_societies);
θ = (β = [1.0, 0.25], α = rand(Normal(0, 1), N_societies), σ = 0.2)
p(θ)</code></pre><pre><code class="language-none">-259.83287522553917</code></pre><p>Write a function to return properly dimensioned transformation.</p><pre><code class="language-julia">problem_transformation(p::m_12_06d_model) =
    as( (β = as(Array, size(p.X, 2)), α = as(Array, p.N_societies), σ = asℝ₊) )</code></pre><p>Wrap the problem with a transformation, then use Flux for the gradient.</p><pre><code class="language-julia">P = TransformedLogDensity(problem_transformation(p), p)
∇P = LogDensityRejectErrors(ADgradient(:ForwardDiff, P));
#∇P = ADgradient(:ForwardDiff, P);</code></pre><p>Tune and sample.</p><pre><code class="language-julia">chain, NUTS_tuned = NUTS_init_tune_mcmc(∇P, 1000);</code></pre><pre><code class="language-none">(NUTS_Transition{Array{Float64,1},Float64}[NUTS_Transition{Array{Float64,1},Float64}([0.13241415008925167, 0.3729081301589678, -0.294175586174907, 0.04995888824700556, 0.18570239636005426, 0.27894069680360734, -0.09115826721236056, -0.09972425874510304, 0.17096102289562526, -0.2781128638145631, 0.4009505032564277, -0.5429258454045833, -1.5081954097732344], -46.39913575446241, 4, DynamicHMC.DoubledTurn, 0.9947502229864718, 15), NUTS_Transition{Array{Float64,1},Float64}([0.08371553719567452, 0.3757387146657488, -0.16522472311865183, -0.02216376762584217, 0.08631752431870493, 0.2661448313432988, -0.15627850732434434, -0.16981342961387655, 0.05199907538931152, -0.25734336779232714, 0.3672322180151362, -0.5909676711074925, -1.3325527108144655], -45.69420754814204, 4, DynamicHMC.DoubledTurn, 1.0, 15), NUTS_Transition{Array{Float64,1},Float64}([1.3933228939375053, 0.22524817690835225, -0.41984141676764064, 0.0430120936353397, -0.022588804516108268, 0.2332745585551357, 0.1575380080194806, -0.40393082702318645, 0.33485460871691747, -0.2250456991089505, 0.15128101336160585, 0.09010397610012064, -1.1550407443211808], -43.55372923271971, 4, DynamicHMC.DoubledTurn, 0.9932648496401593, 15), NUTS_Transition{Array{Float64,1},Float64}([1.3750407991425388, 0.24068452991186312, 0.06986472732602361, 0.0684283270207662, 0.05804738897906359, 0.21929235407880238, -0.0584033564495987, -0.03487736358588299, -0.025383241764646326, 0.026725053106944736, 0.2223393508157165, -0.23068511075758227, -2.1720527295160577], -44.29360664922275, 4, DynamicHMC.DoubledTurn, 0.946081594022325, 15), NUTS_Transition{Array{Float64,1},Float64}([1.791114538011294, 0.1871931664976018, -0.2395276902721261, -0.06941104616840764, -0.08809713315649308, 0.42460233610867604, 0.1826137848230014, -0.21072234259223538, 0.2596673958385364, -0.06559708068788772, 0.19917863967893246, 0.2565218100966998, -1.6294915795155156], -47.017660157838776, 4, DynamicHMC.DoubledTurn, 0.7225885739446, 15), NUTS_Transition{Array{Float64,1},Float64}([1.3316528817787343, 0.2421287016815181, -0.1804297821397992, -0.10351322869085866, -0.07424344189258016, 0.10897678957925531, 0.01550130136794959, -0.37866982102064706, -0.06333369886343826, -0.14390325192327486, 0.39896957130227406, -0.2821842928124781, -1.0634018785700938], -45.75447415998438, 4, DynamicHMC.DoubledTurn, 0.8993157932133538, 15), NUTS_Transition{Array{Float64,1},Float64}([1.3052874501567526, 0.24262136258272227, -0.31056419010200115, -0.014973613187291533, -0.3736880604498807, 0.374526448199868, 0.10608126534121805, -0.07848674322457698, -0.18865523810320864, -0.16085731863516387, 0.32383489973079627, -0.2228103433704596, -1.0133136163990872], -44.875472121936824, 4, DynamicHMC.DoubledTurn, 0.996061953521785, 15), NUTS_Transition{Array{Float64,1},Float64}([1.974386140688628, 0.17490527122158586, -0.36135321639536816, -0.051580841298193764, -0.21861185453560936, 0.3384973916714369, -0.13188085045853065, -0.3092465345036475, -0.1540256558610696, -0.03011136878922693, 0.4995676754241215, 0.07324626345530877, -1.3276526727971805], -44.696420573528556, 4, DynamicHMC.DoubledTurn, 0.9562480048227344, 15), NUTS_Transition{Array{Float64,1},Float64}([1.1922509193362212, 0.25849259607448494, -0.14859335778344973, 0.038528511174905064, -0.12496868238597311, 0.3223471324741844, 0.006710344866330126, -0.16451366303322387, -0.09409147843299709, -0.031667978846459256, 0.4429472042052911, -0.1906620157899732, -1.509463665959642], -45.44045509856937, 4, DynamicHMC.DoubledTurn, 0.8953785818768023, 15), NUTS_Transition{Array{Float64,1},Float64}([1.3696815715018862, 0.22040774862227322, -0.08620959183253972, 0.06977116662084143, -0.3092935753985206, 0.33640841945079486, -0.023268523800980864, -0.06681546574020385, -0.0874138419150382, 0.08257873452787359, 0.3659888573075392, -0.10958308826470492, -1.7381228254156886], -46.48189656863395, 4, DynamicHMC.DoubledTurn, 0.7878049040745829, 15)  …  NUTS_Transition{Array{Float64,1},Float64}([1.380608711396706, 0.2303700857948733, -0.35484138535892723, 0.25504470295543347, -0.2024669106437676, 0.31651447731775767, 0.10338107135023794, -0.5225121128493346, 0.12107026062824414, -0.06272399970281636, 0.2465508727696781, -0.006779785120044818, -1.4428280602587882], -45.7127753927968, 4, DynamicHMC.DoubledTurn, 0.9928215467818652, 15), NUTS_Transition{Array{Float64,1},Float64}([1.7629002702357761, 0.19760858935168493, -0.40102886332608884, 0.0857974136334929, -0.24507429462033553, 0.2394933779996282, 0.08409198951789248, -0.5791365943132184, 0.045110020541584285, -0.12851861289397268, 0.24175171846119176, -0.004945926267563464, -1.0856870442560558], -39.49976530587058, 4, DynamicHMC.DoubledTurn, 0.9236350340827786, 15), NUTS_Transition{Array{Float64,1},Float64}([0.3896087804866411, 0.3276492271488439, 0.0372374029983991, 0.32511422339812157, 0.15096836949773573, 0.5002734989864623, -0.018328260717735495, -0.24135385837382767, 0.024817289309372208, -0.054246353705676834, 0.3562266575125754, -0.23895593801915285, -1.4877533106416125], -41.2947078396246, 4, DynamicHMC.DoubledTurn, 0.9194448964874673, 15), NUTS_Transition{Array{Float64,1},Float64}([1.5021292809269535, 0.2289128498848822, -0.25137361550309234, -0.10018987769647054, -0.15834503687308474, 0.2628763635363281, 0.15198073863928113, -0.3554886352090435, 0.18750479169006173, -0.3975530117329163, 0.09418173812335519, -0.2599369554070291, -0.7548713230537019], -45.16429286644822, 4, DynamicHMC.DoubledTurn, 0.9912997157625185, 15), NUTS_Transition{Array{Float64,1},Float64}([2.5546378170549824, 0.12458944803378671, -0.6594350318180708, -0.4110439929520544, -0.24551035906313387, 0.03838494716703355, -0.13911081374138817, -0.41935849420800875, 0.15351441649695086, -0.17376097613395947, 0.25414005112453775, 0.01448189224446224, -1.3764740863161486], -44.38005721450695, 4, DynamicHMC.DoubledTurn, 0.9903283777396524, 15), NUTS_Transition{Array{Float64,1},Float64}([1.1145586514648669, 0.2658649705077479, 0.035724164667742433, 0.094177276070336, -0.1718340938254275, 0.292391880723419, -0.03687875343425843, -0.45424483007708794, 0.11317284053466833, -0.25971864973896924, 0.10436057298897378, -0.2794983441872216, -0.7976373639074371], -44.46041567588685, 4, DynamicHMC.DoubledTurn, 0.9804228404555658, 15), NUTS_Transition{Array{Float64,1},Float64}([2.0696563117290414, 0.1655042739130223, -0.2732770189058228, -0.302996497856394, -0.19310359952043676, 0.0056381985445370375, 0.050370530274091725, -0.24313216875379673, -0.014210830346694667, -0.2648765128641399, 0.32258590891006345, 0.22517344951994694, -1.306939111922164], -44.51227451629052, 4, DynamicHMC.DoubledTurn, 0.993982684462397, 15), NUTS_Transition{Array{Float64,1},Float64}([-0.42971618505848613, 0.42054758264219433, 0.05778867743430591, 0.24603782761819898, 0.18039337699362792, 0.3726236025419454, -0.0580181656570854, -0.19029713230783893, 0.26710816946837224, -0.1443589353668197, 0.2549172013462374, -0.5073029854109254, -1.4100774159532359], -42.9912122034706, 4, DynamicHMC.DoubledTurn, 0.9784334141970225, 15), NUTS_Transition{Array{Float64,1},Float64}([1.9297389091986168, 0.1669990412432369, -0.3778516769454361, -0.21859262147452194, -0.24437952609583244, 0.42037223765290277, 0.16885080403269287, -0.33373192227655524, 0.06699596002542003, -0.10875257293895799, 0.3661883181175227, 0.11633709206232419, -1.102327654778719], -42.323650960099, 4, DynamicHMC.DoubledTurn, 0.9580678738126761, 15), NUTS_Transition{Array{Float64,1},Float64}([1.7739672285644106, 0.1841067757175687, -0.36074266238143604, -0.03472419364128925, -0.2130405262260602, 0.35202508655487313, 0.2708223337644535, 0.05512240729717442, 0.027103193473495466, 0.09029414086996781, 0.4240298711390931, 0.053284641713103875, -1.5753306697157508], -42.401638518672314, 3, DynamicHMC.DoubledTurn, 0.9828569473583043, 7)], NUTS sampler in 13 dimensions
  stepsize (ϵ) ≈ 0.228
  maximum depth = 10
  Gaussian kinetic energy, √diag(M⁻¹): [0.754077035244496, 0.08518295872576054, 0.24593874188256917, 0.2201902757893631, 0.2017616044735119, 0.1860567453431438, 0.1763040737622734, 0.2212569680440603, 0.18120570122591312, 0.17621585352494343, 0.18041780173732047, 0.3002818652830777, 0.4446714312354982]
)</code></pre><p>We use the transformation to obtain the posterior from the chain.</p><pre><code class="language-julia">posterior = TransformVariables.transform.(Ref(problem_transformation(p)), get_position.(chain));
posterior[1:5]</code></pre><pre><code class="language-none">5-element Array{NamedTuple{(:β, :α, :σ),Tuple{Array{Float64,1},Array{Float64,1},Float64}},1}:
 (β = [0.13241415008925167, 0.3729081301589678], α = [-0.294175586174907, 0.04995888824700556, 0.18570239636005426, 0.27894069680360734, -0.09115826721236056, -0.09972425874510304, 0.17096102289562526, -0.2781128638145631, 0.4009505032564277, -0.5429258454045833], σ = 0.22130898986480776)   
 (β = [0.08371553719567452, 0.3757387146657488], α = [-0.16522472311865183, -0.02216376762584217, 0.08631752431870493, 0.2661448313432988, -0.15627850732434434, -0.16981342961387655, 0.05199907538931152, -0.25734336779232714, 0.3672322180151362, -0.5909676711074925], σ = 0.26380298831284543)
 (β = [1.3933228939375053, 0.22524817690835225], α = [-0.41984141676764064, 0.0430120936353397, -0.022588804516108268, 0.2332745585551357, 0.1575380080194806, -0.40393082702318645, 0.33485460871691747, -0.2250456991089505, 0.15128101336160585, 0.09010397610012064], σ = 0.3150447003594492)   
 (β = [1.3750407991425388, 0.24068452991186312], α = [0.06986472732602361, 0.0684283270207662, 0.05804738897906359, 0.21929235407880238, -0.0584033564495987, -0.03487736358588299, -0.025383241764646326, 0.026725053106944736, 0.2223393508157165, -0.23068511075758227], σ = 0.11394348153704141)
 (β = [1.791114538011294, 0.1871931664976018], α = [-0.2395276902721261, -0.06941104616840764, -0.08809713315649308, 0.42460233610867604, 0.1826137848230014, -0.21072234259223538, 0.2596673958385364, -0.06559708068788772, 0.19917863967893246, 0.2565218100966998], σ = 0.1960292140632578)     </code></pre><p>Extract the parameter posterior means.</p><pre><code class="language-julia">posterior_β = mean(posterior[i].β for i in 1:length(posterior))
posterior_α = mean(posterior[i].α for i in 1:length(posterior))
posterior_σ = mean(posterior[i].σ for i in 1:length(posterior))</code></pre><pre><code class="language-none">0.3052388846150309</code></pre><p>Effective sample sizes (of untransformed draws)</p><pre><code class="language-julia">ess = mapslices(effective_sample_size, get_position_matrix(chain); dims = 1)
ess</code></pre><pre><code class="language-none">1×13 Array{Float64,2}:
 857.007  857.932  643.256  911.286  …  1000.0  951.192  912.595  597.993</code></pre><p>NUTS-specific statistics</p><pre><code class="language-julia">NUTS_statistics(chain)</code></pre><pre><code class="language-none">Hamiltonian Monte Carlo sample of length 1000
  acceptance rate mean: 0.93, min/25%/median/75%/max: 0.28 0.9 0.96 0.99 1.0
  termination: AdjacentTurn =&gt; 6% DoubledTurn =&gt; 94%
  depth: 2 =&gt; 0% 3 =&gt; 4% 4 =&gt; 95% 5 =&gt; 1%
</code></pre><p>CmdStan result</p><pre><code class="language-julia">m_12_6_result = &quot;
Iterations = 1:1000
Thinning interval = 1
Chains = 1,2,3,4
Samples per chain = 1000

Empirical Posterior Estimates:
                            Mean                SD               Naive SE             MCSE            ESS
            a          1.076167468  0.7704872560 0.01218247319 0.0210530022 1000.000000
           bp         0.263056273  0.0823415805 0.00130193470 0.0022645077 1000.000000
  a_society.1   -0.191723568  0.2421382537 0.00382854195 0.0060563054 1000.000000
  a_society.2    0.054569029  0.2278506876 0.00360263570 0.0051693148 1000.000000
  a_society.3   -0.035935050  0.1926364647 0.00304584994 0.0039948433 1000.000000
  a_society.4    0.334355037  0.1929971201 0.00305155241 0.0063871707  913.029080
  a_society.5    0.049747513  0.1801287716 0.00284808595 0.0043631095 1000.000000
  a_society.6   -0.311903245  0.2096126337 0.00331426674 0.0053000536 1000.000000
  a_society.7    0.148637507  0.1744680594 0.00275858223 0.0047660246 1000.000000
  a_society.8   -0.164567976  0.1821341074 0.00287979309 0.0034297298 1000.000000
  a_society.9    0.277066965  0.1758237250 0.00278001719 0.0055844175  991.286501
 a_society.10   -0.094149204  0.2846206232 0.00450024719 0.0080735022 1000.000000
sigma_society    0.310352849  0.1374834682 0.00217380450 0.0057325226  575.187461
&quot;;</code></pre><pre><code class="language-none">&quot;\nIterations = 1:1000\nThinning interval = 1\nChains = 1,2,3,4\nSamples per chain = 1000\n\nEmpirical Posterior Estimates:\n                            Mean                SD               Naive SE             MCSE            ESS\n            a          1.076167468  0.7704872560 0.01218247319 0.0210530022 1000.000000\n           bp         0.263056273  0.0823415805 0.00130193470 0.0022645077 1000.000000\n  a_society.1   -0.191723568  0.2421382537 0.00382854195 0.0060563054 1000.000000\n  a_society.2    0.054569029  0.2278506876 0.00360263570 0.0051693148 1000.000000\n  a_society.3   -0.035935050  0.1926364647 0.00304584994 0.0039948433 1000.000000\n  a_society.4    0.334355037  0.1929971201 0.00305155241 0.0063871707  913.029080\n  a_society.5    0.049747513  0.1801287716 0.00284808595 0.0043631095 1000.000000\n  a_society.6   -0.311903245  0.2096126337 0.00331426674 0.0053000536 1000.000000\n  a_society.7    0.148637507  0.1744680594 0.00275858223 0.0047660246 1000.000000\n  a_society.8   -0.164567976  0.1821341074 0.00287979309 0.0034297298 1000.000000\n  a_society.9    0.277066965  0.1758237250 0.00278001719 0.0055844175  991.286501\n a_society.10   -0.094149204  0.2846206232 0.00450024719 0.0080735022 1000.000000\nsigma_society    0.310352849  0.1374834682 0.00217380450 0.0057325226  575.187461\n&quot;</code></pre><p>Show means</p><pre><code class="language-julia">[posterior_β, posterior_α, [posterior_σ]]</code></pre><pre><code class="language-none">3-element Array{Array{Float64,1},1}:
 [1.1147291126757535, 0.2589508699321731]                                                                                                                                                                             
 [-0.20167066831096328, 0.03660799098189786, -0.04798323898312894, 0.3271696693813306, 0.04617882376909705, -0.31078135364277065, 0.1490737122695013, -0.16384812872746524, 0.27842398366861826, -0.09043460158080209]
 [0.3052388846150309]                                                                                                                                                                                                 </code></pre><p>End of m12.6d.jl</p><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p><footer><hr/><a class="previous" href="../../10/m10.04d2/"><span class="direction">Previous</span><span class="title">m10.04d2</span></a><a class="next" href="../m12.6d1/"><span class="direction">Next</span><span class="title">m12.6d1</span></a></footer></article></body></html>
