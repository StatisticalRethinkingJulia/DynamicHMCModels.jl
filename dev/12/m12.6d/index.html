<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>m12.6d · DynamicHMCModels.jl</title><link href="https://cdnjs.cloudflare.com/ajax/libs/normalize/4.2.0/normalize.min.css" rel="stylesheet" type="text/css"/><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.2.0/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link href="../../assets/documenter.css" rel="stylesheet" type="text/css"/></head><body><nav class="toc"><h1>DynamicHMCModels.jl</h1><select id="version-selector" onChange="window.location.href=this.value" style="visibility: hidden"></select><form class="search" id="search-form" action="../../search/"><input id="search-query" name="q" type="text" placeholder="Search docs"/></form><ul><li><a class="toctext" href="../../intro/">Home</a></li><li><span class="toctext">Chapter 02</span><ul><li><a class="toctext" href="../../02/m2.1d/">m2.1d</a></li></ul></li><li><span class="toctext">Chapter 04</span><ul><li><a class="toctext" href="../../04/m4.1d/">m4.1d</a></li><li><a class="toctext" href="../../04/m4.2d/">m4.2d</a></li><li><a class="toctext" href="../../04/m4.5d/">m4.5d</a></li></ul></li><li><span class="toctext">Chapter 05</span><ul><li><a class="toctext" href="../../05/m5.1d/">m5.1d</a></li><li><a class="toctext" href="../../05/m5.1d1/">m5.1d1</a></li><li><a class="toctext" href="../../05/m5.3d/">m5.3d</a></li><li><a class="toctext" href="../../05/m5.6d/">m5.6d</a></li></ul></li><li><span class="toctext">Chapter 08</span><ul><li><a class="toctext" href="../../08/m8.1d/">m8.1d</a></li></ul></li><li><span class="toctext">Chapter 10</span><ul><li><a class="toctext" href="../../10/m10.02d/">m10.02d</a></li><li><a class="toctext" href="../../10/m10.02d1/">m10.02d1</a></li><li><a class="toctext" href="../../10/m10.04d/">m10.04d</a></li><li><a class="toctext" href="../../10/m10.04d1/">m10.04d1</a></li><li><a class="toctext" href="../../10/m10.04d2/">m10.04d2</a></li></ul></li><li><span class="toctext">Chapter 12</span><ul><li class="current"><a class="toctext" href>m12.6d</a><ul class="internal"></ul></li><li><a class="toctext" href="../m12.6d1/">m12.6d1</a></li><li><a class="toctext" href="../m12.6d2/">m12.6d2</a></li></ul></li><li><a class="toctext" href="../../">Functions</a></li></ul></nav><article id="docs"><header><nav><ul><li>Chapter 12</li><li><a href>m12.6d</a></li></ul><a class="edit-page" href="https://github.com/StatisticalRethinkingJulia/DynamicHMCModels.jl/blob/master/scripts/12/m12.6d.jl"><span class="fa"></span> Edit on GitHub</a></nav><hr/><div id="topbar"><span>m12.6d</span><a class="fa fa-bars" href="#"></a></div></header><pre><code class="language-julia">using DynamicHMCModels

ProjDir = rel_path_d(&quot;..&quot;, &quot;scripts&quot;, &quot;12&quot;)

df = CSV.read(rel_path( &quot;..&quot;, &quot;data&quot;,  &quot;Kline.csv&quot;), delim=&#39;;&#39;);
size(df) # Should be 10x5</code></pre><pre><code class="language-none">(10, 5)</code></pre><p>New col logpop, set log() for population data</p><pre><code class="language-julia">df[:logpop] = map((x) -&gt; log(x), df[:population]);
df[:society] = 1:10;

first(df[[:total_tools, :logpop, :society]], 5)

struct m_12_06d_model{TY &lt;: AbstractVector, TX &lt;: AbstractMatrix,
  TS &lt;: AbstractVector}
    &quot;Observations (total_tools).&quot;
    y::TY
    &quot;Covariates (logpop)&quot;
    X::TX
    &quot;Society&quot;
    S::TS
    &quot;Number of observations (10)&quot;
    N::Int
    &quot;Number of societies (also 10)&quot;
    N_societies::Int
end</code></pre><p>Make the type callable with the parameters <em>as a single argument</em>.</p><pre><code class="language-julia">function (problem::m_12_06d_model)(θ)
    @unpack y, X, S, N, N_societies = problem   # extract the data
    @unpack β, α, σ = θ  # β : a, bp, α : a_society
    ll = 0.0
    ll += logpdf(Cauchy(0, 1), σ)
    ll += sum(logpdf.(Normal(0, σ), α)) # α[1:10]
    ll += logpdf.(Normal(0, 10), β[1]) # a
    ll += logpdf.(Normal(0, 1), β[2]) # a
    ll += sum(
      [loglikelihood(Poisson(exp(α[S[i]] + dot(X[i, :], β))), [y[i]]) for i in 1:N]
    )
    ll
end</code></pre><p>Instantiate the model with data and inits.</p><pre><code class="language-julia">N = size(df, 1)
N_societies = length(unique(df[:society]))
X = hcat(ones(Int64, N), df[:logpop]);
S = df[:society]
y = df[:total_tools]
p = m_12_06d_model(y, X, S, N, N_societies);
θ = (β = [1.0, 0.25], α = rand(Normal(0, 1), N_societies), σ = 0.2)
p(θ)</code></pre><pre><code class="language-none">-177.52945327794114</code></pre><p>Write a function to return properly dimensioned transformation.</p><pre><code class="language-julia">problem_transformation(p::m_12_06d_model) =
    as( (β = as(Array, size(p.X, 2)), α = as(Array, p.N_societies), σ = asℝ₊) )</code></pre><p>Wrap the problem with a transformation, then use Flux for the gradient.</p><pre><code class="language-julia">P = TransformedLogDensity(problem_transformation(p), p)
∇P = LogDensityRejectErrors(ADgradient(:ForwardDiff, P));
#∇P = ADgradient(:ForwardDiff, P);</code></pre><p>Tune and sample.</p><pre><code class="language-julia">chain, NUTS_tuned = NUTS_init_tune_mcmc(∇P, 1000);</code></pre><pre><code class="language-none">(NUTS_Transition{Array{Float64,1},Float64}[NUTS_Transition{Array{Float64,1},Float64}([1.8764413340868273, 0.18943782595824335, -0.5544625872374422, 0.17444427044029412, -0.242293353980645, 0.26180731974338245, -0.12622735706287735, -0.5674931082267506, 0.15284216875243978, -0.5498370541227088, 0.3386148915809434, -0.040662726961722545, -0.8858300219966118], -43.370486905259284, 4, DynamicHMC.DoubledTurn, 1.0, 15), NUTS_Transition{Array{Float64,1},Float64}([2.318898391364303, 0.14112225583681265, -0.6607988049374148, 0.07400889560900296, -0.1786993553789064, 0.21941589527798966, -0.1537525934024559, -0.5615620600903899, 0.14977175929208278, -0.5353342821722185, 0.3797108325002587, 0.09892623771570744, -0.8412089169999046], -46.536376184433045, 4, DynamicHMC.DoubledTurn, 0.9926060878105233, 15), NUTS_Transition{Array{Float64,1},Float64}([2.225871281324063, 0.1523189429854531, -0.7078022145132388, 0.12375575259000085, -0.1931339603002692, 0.1851106703355898, -0.14874022396344194, -0.6741460916221634, 0.09079358979977364, -0.5851031821611211, 0.35625344252892327, 0.025117308960683565, -0.8118362010418326], -45.90558812314138, 4, DynamicHMC.DoubledTurn, 0.987712353299095, 15), NUTS_Transition{Array{Float64,1},Float64}([2.2581167805759987, 0.15795952572353714, -0.9021843838850969, -0.3050487746627725, -0.31057593463827227, 0.12059103302512754, -0.060994767382101786, -0.7452445705111544, 0.16456714530272418, -0.54525569219441, 0.013299367373558572, 0.09435117236964968, -0.8911311199231963], -47.198553554460545, 4, DynamicHMC.DoubledTurn, 0.8054938457810656, 15), NUTS_Transition{Array{Float64,1},Float64}([2.229258770398205, 0.1781712628802298, -0.635347611671052, -0.16676808097222928, -0.4310344465279904, 0.027778550319259146, -0.2882018596281401, -0.8645056998123276, -0.09826108666873365, -0.54589060468817, -0.07340424815209773, -0.15764227172023593, -0.9151490225344263], -46.17700296853588, 4, DynamicHMC.DoubledTurn, 0.9603314412176319, 15), NUTS_Transition{Array{Float64,1},Float64}([0.06726543587075517, 0.3374473792436701, -0.5580640438932467, 0.07599644961664223, 0.3596152450867274, 0.4945281374260569, 0.36445708939350474, 0.24383957372289652, 0.6473588308514653, 0.06744148685156477, 0.45993002250393406, -0.02532982916199805, -1.160987209865137], -52.40765322383228, 4, DynamicHMC.DoubledTurn, 0.898673562173443, 15), NUTS_Transition{Array{Float64,1},Float64}([2.5233603728194587, 0.11848108494417697, -0.7257760302326501, 0.11626711998951204, -0.34006844974221756, 0.2505586179020022, 0.035707554887822304, -0.6932283039034497, -0.19746908188994178, -0.30989288207098536, 0.2617272840781647, 0.17393358424334632, -0.8598484375145745], -54.18360385025405, 4, DynamicHMC.DoubledTurn, 0.9904216737328502, 15), NUTS_Transition{Array{Float64,1},Float64}([1.9511329026463493, 0.19539233857870525, -0.7595104127545459, 0.09244117002532959, -0.3909672383418421, 0.15892309550723435, -0.168184410795011, -0.7549853503397097, -0.324274516716887, -0.2617462716121066, 0.15729267694320534, -0.11117338485254802, -0.7356667642094443], -46.48479162617561, 4, DynamicHMC.DoubledTurn, 0.9911090250807795, 15), NUTS_Transition{Array{Float64,1},Float64}([2.0845411895459964, 0.13188479496123823, -0.17373489116374297, -0.40179379574869756, -0.2388325384434522, 0.40092461368613663, 0.04986553857820603, -0.2870244512158092, 0.7243794281550625, -0.3573214852642613, 0.4133847136932914, 0.6150435971186201, -0.714698359423074], -51.69363922727259, 4, DynamicHMC.DoubledTurn, 0.975017385190061, 15), NUTS_Transition{Array{Float64,1},Float64}([0.595296960094429, 0.31358891639466735, -0.2674311117897044, 0.3669936349772895, 0.20129691397452357, 0.27911002428450815, 0.32518040491773365, -0.03241704537746107, -0.0015009998894449095, 0.0818307387646863, 0.376609177233259, -0.4229240425983454, -1.2696074467170586], -52.57194330725132, 4, DynamicHMC.DoubledTurn, 0.9949900342758443, 15)  …  NUTS_Transition{Array{Float64,1},Float64}([0.32532894882644403, 0.3318843646052538, -0.29161532911868915, 0.2997701022137961, 0.03469859340083467, 0.4446999585401844, 0.05362656752476828, -0.2503588117093817, 0.3593170169148544, -0.2638046038523002, 0.2874592333563584, -0.16949031415972154, -0.9892068292259859], -43.98852357840517, 4, DynamicHMC.DoubledTurn, 0.9681143279709222, 15), NUTS_Transition{Array{Float64,1},Float64}([1.1629500797852694, 0.25822702331149217, -0.25773540549055796, -0.035527363802803205, -0.09841575818097832, 0.2854121904188591, 0.20936812512380742, -0.34620972450946264, -0.015968947879285433, 0.12240046598616683, 0.3953995275450828, -0.15522552232642878, -1.5117840151056015], -42.278098493207885, 4, DynamicHMC.DoubledTurn, 0.9956177932539786, 15), NUTS_Transition{Array{Float64,1},Float64}([0.9047528934062444, 0.27331040796796335, -0.11206036734634917, -0.014088907196779781, -0.17733149806933113, 0.4021591561264085, 0.00910615961080461, -0.2777368456130574, -0.059030374563552146, -0.14906647457581107, 0.15833250191944387, -0.15597932419842592, -1.9006590082231711], -43.98839091634223, 4, DynamicHMC.DoubledTurn, 0.7040394329148493, 15), NUTS_Transition{Array{Float64,1},Float64}([1.791470054178287, 0.1896378698082213, -0.2793571110564711, -0.0038492194804738734, 0.07413996410552495, 0.23954248927778957, 0.11112795804077434, -0.0629127873025258, 0.29609901153476126, 0.014460922132872547, 0.3302032669646153, 0.19313742034484271, -1.366880877593972], -43.60440162072743, 4, DynamicHMC.DoubledTurn, 0.9833494372702204, 15), NUTS_Transition{Array{Float64,1},Float64}([0.5123546975081933, 0.3150577788698265, -0.06829503741528131, 0.14568917541770005, 0.2732515607561627, 0.14924757570243224, -0.1715826477068717, -0.1816096240384522, 0.1928131874254661, -0.3957169682839939, 0.42911704668909023, -0.15719554088398113, -0.7941368349318298], -46.582129071133366, 4, DynamicHMC.DoubledTurn, 0.9154713888569704, 15), NUTS_Transition{Array{Float64,1},Float64}([0.682951566684771, 0.2884418518720899, -0.06903495575113823, 0.4013183343444305, 0.2300991358060917, 0.36040284639060377, -0.3632472337473115, 0.004805051808587866, 0.29617146714281806, -0.010195173385347867, 0.4670638196189064, 0.014555549828510737, -0.9906142486301098], -49.821089548411244, 4, DynamicHMC.DoubledTurn, 0.8534643871381988, 15), NUTS_Transition{Array{Float64,1},Float64}([0.8110634557951519, 0.2885339640708764, 0.07725849366731567, 0.37405490610188685, 0.29393516638029366, 0.3016622071378249, -0.470823375802364, -0.0037340816280923735, 0.354178046663493, -0.019088804744492555, 0.42595556926834577, 0.04314670052822488, -0.9846840114506358], -51.421826104832306, 4, DynamicHMC.DoubledTurn, 0.7814008105665263, 15), NUTS_Transition{Array{Float64,1},Float64}([0.5179377723743896, 0.290602108201633, 0.025847900870256194, 0.5079782103035213, 0.26836064077521254, 0.4726578754426859, -0.27171381251750804, -0.05693936703150497, 0.4359356113816052, -0.07408563335190968, 0.4540627348395599, -0.01663411104842421, -0.6879290653053295], -54.01433538781599, 4, DynamicHMC.DoubledTurn, 0.8459737176845313, 15), NUTS_Transition{Array{Float64,1},Float64}([1.0835035284492351, 0.25782731405875275, -0.10443206982273759, 0.27412350511828637, 0.07531353097948745, 0.3252461032154452, -0.3491287477458144, -0.1197228818488671, 0.3874646641311172, -0.08412628312657955, 0.36131940226225395, 0.175529816429391, -0.8325645024859762], -50.969801457003015, 4, DynamicHMC.DoubledTurn, 0.9900761543224293, 15), NUTS_Transition{Array{Float64,1},Float64}([1.399787136669219, 0.231335745178268, -0.4104403004533146, 0.07230986748737783, -0.14708392152423513, 0.24185332566703455, -0.26687584776369444, -0.30030718481057955, 0.13852401683897292, -0.08613722902364838, 0.2170496025898383, -0.12196381415276257, -1.3003416080678332], -46.46544818124964, 4, DynamicHMC.DoubledTurn, 0.9990760036861291, 15)], NUTS sampler in 13 dimensions
  stepsize (ϵ) ≈ 0.244
  maximum depth = 10
  Gaussian kinetic energy, √diag(M⁻¹): [0.7381633030147788, 0.08250488427821465, 0.23376681761505635, 0.23463297476260825, 0.20595488046917962, 0.18265335318522738, 0.17855978829152405, 0.2036861498679353, 0.16919926708915012, 0.18964485238536133, 0.18681260906622088, 0.2795060098784263, 0.38800744433044976]
)</code></pre><p>We use the transformation to obtain the posterior from the chain.</p><pre><code class="language-julia">posterior = TransformVariables.transform.(Ref(problem_transformation(p)), get_position.(chain));
posterior[1:5]</code></pre><pre><code class="language-none">5-element Array{NamedTuple{(:β, :α, :σ),Tuple{Array{Float64,1},Array{Float64,1},Float64}},1}:
 (β = [1.8764413340868273, 0.18943782595824335], α = [-0.5544625872374422, 0.17444427044029412, -0.242293353980645, 0.26180731974338245, -0.12622735706287735, -0.5674931082267506, 0.15284216875243978, -0.5498370541227088, 0.3386148915809434, -0.040662726961722545], σ = 0.41237175356452094) 
 (β = [2.318898391364303, 0.14112225583681265], α = [-0.6607988049374148, 0.07400889560900296, -0.1786993553789064, 0.21941589527798966, -0.1537525934024559, -0.5615620600903899, 0.14977175929208278, -0.5353342821722185, 0.3797108325002587, 0.09892623771570744], σ = 0.4311889365793974)     
 (β = [2.225871281324063, 0.1523189429854531], α = [-0.7078022145132388, 0.12375575259000085, -0.1931339603002692, 0.1851106703355898, -0.14874022396344194, -0.6741460916221634, 0.09079358979977364, -0.5851031821611211, 0.35625344252892327, 0.025117308960683565], σ = 0.4440419668688161)    
 (β = [2.2581167805759987, 0.15795952572353714], α = [-0.9021843838850969, -0.3050487746627725, -0.31057593463827227, 0.12059103302512754, -0.060994767382101786, -0.7452445705111544, 0.16456714530272418, -0.54525569219441, 0.013299367373558572, 0.09435117236964968], σ = 0.41019151445292373)
 (β = [2.229258770398205, 0.1781712628802298], α = [-0.635347611671052, -0.16676808097222928, -0.4310344465279904, 0.027778550319259146, -0.2882018596281401, -0.8645056998123276, -0.09826108666873365, -0.54589060468817, -0.07340424815209773, -0.15764227172023593], σ = 0.40045694453517766)  </code></pre><p>Extract the parameter posterior means.</p><pre><code class="language-julia">posterior_β = mean(posterior[i].β for i in 1:length(posterior))
posterior_α = mean(posterior[i].α for i in 1:length(posterior))
posterior_σ = mean(posterior[i].σ for i in 1:length(posterior))</code></pre><pre><code class="language-none">0.31682361814692467</code></pre><p>Effective sample sizes (of untransformed draws)</p><pre><code class="language-julia">ess = mapslices(effective_sample_size, get_position_matrix(chain); dims = 1)
ess</code></pre><pre><code class="language-none">1×13 Array{Float64,2}:
 277.789  261.571  304.777  434.048  …  647.826  380.158  250.256  374.336</code></pre><p>NUTS-specific statistics</p><pre><code class="language-julia">NUTS_statistics(chain)</code></pre><pre><code class="language-none">Hamiltonian Monte Carlo sample of length 1000
  acceptance rate mean: 0.92, min/25%/median/75%/max: 0.3 0.89 0.96 0.99 1.0
  termination: AdjacentTurn =&gt; 4% DoubledTurn =&gt; 96%
  depth: 3 =&gt; 6% 4 =&gt; 94% 5 =&gt; 0%
</code></pre><p>CmdStan result</p><pre><code class="language-julia">m_12_6_result = &quot;
Iterations = 1:1000
Thinning interval = 1
Chains = 1,2,3,4
Samples per chain = 1000

Empirical Posterior Estimates:
                            Mean                SD               Naive SE             MCSE            ESS
            a          1.076167468  0.7704872560 0.01218247319 0.0210530022 1000.000000
           bp         0.263056273  0.0823415805 0.00130193470 0.0022645077 1000.000000
  a_society.1   -0.191723568  0.2421382537 0.00382854195 0.0060563054 1000.000000
  a_society.2    0.054569029  0.2278506876 0.00360263570 0.0051693148 1000.000000
  a_society.3   -0.035935050  0.1926364647 0.00304584994 0.0039948433 1000.000000
  a_society.4    0.334355037  0.1929971201 0.00305155241 0.0063871707  913.029080
  a_society.5    0.049747513  0.1801287716 0.00284808595 0.0043631095 1000.000000
  a_society.6   -0.311903245  0.2096126337 0.00331426674 0.0053000536 1000.000000
  a_society.7    0.148637507  0.1744680594 0.00275858223 0.0047660246 1000.000000
  a_society.8   -0.164567976  0.1821341074 0.00287979309 0.0034297298 1000.000000
  a_society.9    0.277066965  0.1758237250 0.00278001719 0.0055844175  991.286501
 a_society.10   -0.094149204  0.2846206232 0.00450024719 0.0080735022 1000.000000
sigma_society    0.310352849  0.1374834682 0.00217380450 0.0057325226  575.187461
&quot;;</code></pre><pre><code class="language-none">&quot;\nIterations = 1:1000\nThinning interval = 1\nChains = 1,2,3,4\nSamples per chain = 1000\n\nEmpirical Posterior Estimates:\n                            Mean                SD               Naive SE             MCSE            ESS\n            a          1.076167468  0.7704872560 0.01218247319 0.0210530022 1000.000000\n           bp         0.263056273  0.0823415805 0.00130193470 0.0022645077 1000.000000\n  a_society.1   -0.191723568  0.2421382537 0.00382854195 0.0060563054 1000.000000\n  a_society.2    0.054569029  0.2278506876 0.00360263570 0.0051693148 1000.000000\n  a_society.3   -0.035935050  0.1926364647 0.00304584994 0.0039948433 1000.000000\n  a_society.4    0.334355037  0.1929971201 0.00305155241 0.0063871707  913.029080\n  a_society.5    0.049747513  0.1801287716 0.00284808595 0.0043631095 1000.000000\n  a_society.6   -0.311903245  0.2096126337 0.00331426674 0.0053000536 1000.000000\n  a_society.7    0.148637507  0.1744680594 0.00275858223 0.0047660246 1000.000000\n  a_society.8   -0.164567976  0.1821341074 0.00287979309 0.0034297298 1000.000000\n  a_society.9    0.277066965  0.1758237250 0.00278001719 0.0055844175  991.286501\n a_society.10   -0.094149204  0.2846206232 0.00450024719 0.0080735022 1000.000000\nsigma_society    0.310352849  0.1374834682 0.00217380450 0.0057325226  575.187461\n&quot;</code></pre><p>Show means</p><pre><code class="language-julia">[posterior_β, posterior_α, [posterior_σ]]</code></pre><pre><code class="language-none">3-element Array{Array{Float64,1},1}:
 [1.1150258854433523, 0.2589720511399559]                                                                                                                                                                             
 [-0.20607679586495808, 0.0546252889755091, -0.052005735801132845, 0.3342652585343202, 0.04526746928932433, -0.31253746024424256, 0.15040474920288704, -0.17104301928674742, 0.2785565957509292, -0.08617280726737567]
 [0.31682361814692467]                                                                                                                                                                                                </code></pre><p>End of m12.6d.jl</p><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p><footer><hr/><a class="previous" href="../../10/m10.04d2/"><span class="direction">Previous</span><span class="title">m10.04d2</span></a><a class="next" href="../m12.6d1/"><span class="direction">Next</span><span class="title">m12.6d1</span></a></footer></article></body></html>
