<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>m12.6d · DynamicHMCModels.jl</title><link href="https://cdnjs.cloudflare.com/ajax/libs/normalize/4.2.0/normalize.min.css" rel="stylesheet" type="text/css"/><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.2.0/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link href="../../assets/documenter.css" rel="stylesheet" type="text/css"/></head><body><nav class="toc"><h1>DynamicHMCModels.jl</h1><select id="version-selector" onChange="window.location.href=this.value" style="visibility: hidden"></select><form class="search" id="search-form" action="../../search/"><input id="search-query" name="q" type="text" placeholder="Search docs"/></form><ul><li><a class="toctext" href="../../intro/">Home</a></li><li><span class="toctext">Chapter 02</span><ul><li><a class="toctext" href="../../02/m2.1d/">m2.1d</a></li></ul></li><li><span class="toctext">Chapter 04</span><ul><li><a class="toctext" href="../../04/m4.1d/">m4.1d</a></li><li><a class="toctext" href="../../04/m4.2d/">m4.2d</a></li><li><a class="toctext" href="../../04/m4.5d/">m4.5d</a></li></ul></li><li><span class="toctext">Chapter 05</span><ul><li><a class="toctext" href="../../05/m5.1d/">m5.1d</a></li><li><a class="toctext" href="../../05/m5.1d1/">m5.1d1</a></li><li><a class="toctext" href="../../05/m5.3d/">m5.3d</a></li><li><a class="toctext" href="../../05/m5.6d/">m5.6d</a></li></ul></li><li><span class="toctext">Chapter 08</span><ul><li><a class="toctext" href="../../08/m8.1d/">m8.1d</a></li></ul></li><li><span class="toctext">Chapter 10</span><ul><li><a class="toctext" href="../../10/m10.02d/">m10.02d</a></li><li><a class="toctext" href="../../10/m10.02d1/">m10.02d1</a></li><li><a class="toctext" href="../../10/m10.04d/">m10.04d</a></li><li><a class="toctext" href="../../10/m10.04d1/">m10.04d1</a></li><li><a class="toctext" href="../../10/m10.04d2/">m10.04d2</a></li></ul></li><li><span class="toctext">Chapter 12</span><ul><li class="current"><a class="toctext" href>m12.6d</a><ul class="internal"></ul></li><li><a class="toctext" href="../m12.6d1/">m12.6d1</a></li><li><a class="toctext" href="../m12.6d2/">m12.6d2</a></li></ul></li><li><a class="toctext" href="../../">Functions</a></li></ul></nav><article id="docs"><header><nav><ul><li>Chapter 12</li><li><a href>m12.6d</a></li></ul><a class="edit-page" href="https://github.com/StatisticalRethinkingJulia/DynamicHMCModels.jl/blob/master/scripts/12/m12.6d.jl"><span class="fa"></span> Edit on GitHub</a></nav><hr/><div id="topbar"><span>m12.6d</span><a class="fa fa-bars" href="#"></a></div></header><pre><code class="language-julia">using DynamicHMCModels

ProjDir = rel_path_d(&quot;..&quot;, &quot;scripts&quot;, &quot;12&quot;)

df = CSV.read(rel_path( &quot;..&quot;, &quot;data&quot;,  &quot;Kline.csv&quot;), delim=&#39;;&#39;);
size(df) # Should be 10x5</code></pre><pre><code class="language-none">(10, 5)</code></pre><p>New col logpop, set log() for population data</p><pre><code class="language-julia">df[:logpop] = map((x) -&gt; log(x), df[:population]);
df[:society] = 1:10;

first(df[[:total_tools, :logpop, :society]], 5)

struct m_12_06d_model{TY &lt;: AbstractVector, TX &lt;: AbstractMatrix,
  TS &lt;: AbstractVector}
    &quot;Observations (total_tools).&quot;
    y::TY
    &quot;Covariates (logpop)&quot;
    X::TX
    &quot;Society&quot;
    S::TS
    &quot;Number of observations (10)&quot;
    N::Int
    &quot;Number of societies (also 10)&quot;
    N_societies::Int
end</code></pre><p>Make the type callable with the parameters <em>as a single argument</em>.</p><pre><code class="language-julia">function (problem::m_12_06d_model)(θ)
    @unpack y, X, S, N, N_societies = problem   # extract the data
    @unpack β, α, σ = θ  # β : a, bp, α : a_society
    ll = 0.0
    ll += logpdf(Cauchy(0, 1), σ)
    ll += sum(logpdf.(Normal(0, σ), α)) # α[1:10]
    ll += logpdf.(Normal(0, 10), β[1]) # a
    ll += logpdf.(Normal(0, 1), β[2]) # a
    ll += sum(
      [loglikelihood(Poisson(exp(α[S[i]] + dot(X[i, :], β))), [y[i]]) for i in 1:N]
    )
    ll
end</code></pre><p>Instantiate the model with data and inits.</p><pre><code class="language-julia">N = size(df, 1)
N_societies = length(unique(df[:society]))
X = hcat(ones(Int64, N), df[:logpop]);
S = df[:society]
y = df[:total_tools]
p = m_12_06d_model(y, X, S, N, N_societies);
θ = (β = [1.0, 0.25], α = rand(Normal(0, 1), N_societies), σ = 0.2)
p(θ)</code></pre><pre><code class="language-none">-283.9305398842816</code></pre><p>Write a function to return properly dimensioned transformation.</p><pre><code class="language-julia">problem_transformation(p::m_12_06d_model) =
    as( (β = as(Array, size(p.X, 2)), α = as(Array, p.N_societies), σ = asℝ₊) )</code></pre><p>Wrap the problem with a transformation, then use Flux for the gradient.</p><pre><code class="language-julia">P = TransformedLogDensity(problem_transformation(p), p)
∇P = LogDensityRejectErrors(ADgradient(:ForwardDiff, P));
#∇P = ADgradient(:ForwardDiff, P);</code></pre><p>Tune and sample.</p><pre><code class="language-julia">chain, NUTS_tuned = NUTS_init_tune_mcmc(∇P, 1000);</code></pre><pre><code class="language-none">(NUTS_Transition{Array{Float64,1},Float64}[NUTS_Transition{Array{Float64,1},Float64}([1.5688294766102886, 0.22547592976185798, -0.09917603692312067, -0.12928445892963952, -0.12886941483169223, -0.07038911506069204, -0.16086299335615015, -0.3917188850077898, -0.08760938847488396, -0.06680472019791106, 0.2645911763156387, -0.09452996798078864, -1.6651744378052231], -49.876895536883055, 4, DynamicHMC.DoubledTurn, 0.8549071433139855, 15), NUTS_Transition{Array{Float64,1},Float64}([1.3867125402721117, 0.2210613550411318, 0.15178968159838443, 0.07958017486868445, -0.09927046685040444, 0.2655487327640672, 0.03628363623007512, -0.13315952491007654, 0.02738545028007993, -0.07172448668625794, 0.29007987859364953, -0.11372753657828473, -1.7998406099160627], -44.44892268901659, 4, DynamicHMC.DoubledTurn, 0.8131274188331056, 15), NUTS_Transition{Array{Float64,1},Float64}([1.122291284711081, 0.2616455703385707, -0.23065434129632095, 0.042175973613021556, 0.03244793771815736, 0.16318167829331887, 0.013614999573538707, -0.1881679005200756, 0.06411797735397429, -0.18728232990302104, 0.10006267735916774, -0.07159794248276312, -2.1318155398822167], -39.80788604060707, 4, DynamicHMC.DoubledTurn, 0.9989579133946701, 15), NUTS_Transition{Array{Float64,1},Float64}([0.8069185214371263, 0.2868334077917769, 0.12228554359890098, -0.03520829922185695, -0.015540940849290634, 0.0611728196585135, -0.05660876531995203, 0.012139815684953186, 0.08875418328711951, 0.01501979341314566, 0.005179062049526399, 0.0003956198124090947, -2.5403696974528733], -37.81942677003249, 3, DynamicHMC.DoubledTurn, 0.9223405432325619, 7), NUTS_Transition{Array{Float64,1},Float64}([1.0914488499809374, 0.27125593765807715, -0.20582339110522713, -0.08174230505712697, -0.09330105408686082, 0.059307906765177776, 0.028765832271348105, -0.0667117164482177, 0.08354395620255878, -0.1929297362797633, 0.03933521519454567, -0.06929542101560238, -2.254281901005708], -39.92449227511931, 3, DynamicHMC.DoubledTurn, 0.7270460026268092, 7), NUTS_Transition{Array{Float64,1},Float64}([1.4517718680992049, 0.22625031263291853, 0.006324577702641707, -0.00013678597267301196, 0.036942702617471984, 0.21911259149566803, -0.07132036742422229, -0.18846181601235312, 0.15460412255891332, -0.01081676227913787, 0.2499775022451493, 0.00036163763024374754, -1.4241999446610047], -42.425843781326634, 4, DynamicHMC.DoubledTurn, 0.9190714214178797, 15), NUTS_Transition{Array{Float64,1},Float64}([1.6002020621119037, 0.20146123079790132, -0.021726191463372665, 0.018475046437790892, 0.07476537266775952, 0.22719742163250928, -0.11184402641585478, -0.13910104440407908, 0.1471456074772671, -0.08312679678027055, 0.21248640067317945, 0.13131308164756006, -1.7674999850234425], -40.45632882831239, 3, DynamicHMC.AdjacentTurn, 0.9756630819971134, 15), NUTS_Transition{Array{Float64,1},Float64}([0.14908947305925807, 0.35037214937784655, -0.34091034566301937, 0.3076742416505708, -0.0750696731691355, 0.6799534267616552, 0.4326910994688488, -0.16298522872314808, 0.26762600974674605, -0.11860756497010935, 0.49502793010651663, -0.28695174377014654, -0.7233082228671963], -44.58776034422053, 4, DynamicHMC.DoubledTurn, 0.9387125976962473, 15), NUTS_Transition{Array{Float64,1},Float64}([1.8566080958347033, 0.17495608239694616, -0.4644339403831598, -0.020645793949270394, -0.20176545396844145, 0.20846809767686492, 0.1574117518463013, -0.266354856951345, 0.11973986417465202, -0.2859924394729494, 0.5479731057129374, 0.16021374105256014, -1.5544438149565636], -44.832388949379016, 4, DynamicHMC.DoubledTurn, 0.9924967516942582, 15), NUTS_Transition{Array{Float64,1},Float64}([0.5977781421992047, 0.3067114591434191, -0.26128868870072863, 0.15569374591484014, -0.05693613650706244, 0.43363704526252533, 0.19888930921396644, -0.05199230626594688, 0.11431651938875889, -0.06471386188150373, 0.513589014821204, -0.1437468131418581, -1.450814208940107], -44.102308798456434, 4, DynamicHMC.DoubledTurn, 0.9913191671175773, 15)  …  NUTS_Transition{Array{Float64,1},Float64}([1.0107278364887284, 0.2654301650610494, -0.5308738339671782, -0.06987615766443836, 0.15513096486759592, 0.26785077432227333, -0.21222442419926235, -0.50995088284598, -0.11709997339601863, -0.4038368077994161, 0.5997253939021945, -0.04512830525047336, -0.8157730259483285], -59.020756454641685, 4, DynamicHMC.DoubledTurn, 1.0, 15), NUTS_Transition{Array{Float64,1},Float64}([1.3696752842113038, 0.21585710937511007, -0.05706190615666283, 0.1545059232310774, -0.30452440142387616, 0.5021577174639057, 0.1370322140791974, -0.2709969544996166, 0.2626518823583481, -0.16958793599053293, 0.17459625716386099, -0.08045582929615527, -1.3814629916933294], -54.83417886571387, 4, DynamicHMC.DoubledTurn, 0.7144404064090148, 15), NUTS_Transition{Array{Float64,1},Float64}([1.2087495650447437, 0.2271595568556132, 0.095707603915496, 0.434784636484197, -0.21045891893281152, 0.14485181888948373, 0.17119399884821268, -0.19146765547219777, 0.46688185793603487, -0.10095574132996449, 0.34739235464611706, 0.05982823305307424, -0.8085177033050007], -49.89533693632081, 4, DynamicHMC.DoubledTurn, 0.971557518775733, 15), NUTS_Transition{Array{Float64,1},Float64}([0.10171894613895191, 0.362437588375174, 0.16588410855434543, 0.42953532248060566, 0.033094292307739866, 0.39611835427904935, -0.003266961912204547, 0.02050338014212478, 0.3403083744543576, -0.051242718290232483, 0.21878863573506158, -0.22614162858199907, -1.1294598705735455], -48.58012634451227, 4, DynamicHMC.DoubledTurn, 0.9669267693219683, 15), NUTS_Transition{Array{Float64,1},Float64}([1.6894707628992873, 0.2126603046983272, -0.20828560989864797, 0.05790683234910887, -0.014600924371530086, 0.1155613307300049, 0.08293719242812948, -0.6478912978713433, -0.03923916940731605, -0.2779426732700396, 0.2520721375005367, 0.025093239731663317, -1.2824706055718538], -43.78871906994032, 4, DynamicHMC.DoubledTurn, 0.9431749021243773, 15), NUTS_Transition{Array{Float64,1},Float64}([0.7186099730946547, 0.29938718667082487, -0.04381823441635959, 0.07567174601007039, 0.023203364448216277, 0.2585123907686496, 0.15150794648596125, -0.4165858735507378, 0.07919746554163964, 0.004484793189322239, 0.14565439967117152, -0.15289875613349418, -1.8303868613155205], -41.93678437494221, 4, DynamicHMC.DoubledTurn, 0.9936598857320506, 15), NUTS_Transition{Array{Float64,1},Float64}([1.248515460740918, 0.23807012332623562, -0.13821231677754012, 0.08376546357179682, 0.039103003715752385, 0.24080282967721148, -0.1950054882272371, -0.08972626138822834, 0.1204013138277294, -0.18289301090311816, 0.338659725235174, 0.12335256595933052, -1.4115782094327136], -41.401767730321424, 4, DynamicHMC.DoubledTurn, 0.9574123485879616, 15), NUTS_Transition{Array{Float64,1},Float64}([1.1843542118183168, 0.2698632038482842, -0.3796866076432941, -0.2608553657863143, -0.214529291647985, 0.09494307836984756, 0.19074518837018256, -0.4793646228134348, 0.09491556266460795, -0.18633728015644535, 0.1484582009219472, -0.2702639449122875, -1.4017671735722557], -45.650170397066006, 4, DynamicHMC.DoubledTurn, 0.9515614247915309, 15), NUTS_Transition{Array{Float64,1},Float64}([0.5797620865282951, 0.31306182412597855, 0.01692092187258855, -0.011054484408557622, -0.19301026590010348, 0.5676109173560303, 0.17830291514087218, -0.6738559512048352, 0.25369048088803203, -0.36713103504471145, 0.315799550458779, -0.11656942751325833, -0.9690145530364321], -45.31023624227596, 4, DynamicHMC.DoubledTurn, 0.9149405717805486, 15), NUTS_Transition{Array{Float64,1},Float64}([1.1297624910336266, 0.25955495941301776, -0.4578413474994975, 0.11368402300145053, 0.07581039069835951, 0.2387132417380312, 0.050266269884293904, -0.2024309230994257, 0.05782301877376145, 0.06927471997973211, 0.3080240209050026, -0.07609002990070761, -1.5800940745089336], -43.30802730167435, 4, DynamicHMC.DoubledTurn, 0.867774338449005, 15)], NUTS sampler in 13 dimensions
  stepsize (ϵ) ≈ 0.215
  maximum depth = 10
  Gaussian kinetic energy, √diag(M⁻¹): [0.7511370427907891, 0.08237010629982547, 0.25002461690291194, 0.2462293430450839, 0.19672931306414487, 0.2091249584900928, 0.16737920681828283, 0.20906675530112132, 0.18818559133300183, 0.1939000354991307, 0.1609988358639023, 0.26589701874409577, 0.43680706711772127]
)</code></pre><p>We use the transformation to obtain the posterior from the chain.</p><pre><code class="language-julia">posterior = TransformVariables.transform.(Ref(problem_transformation(p)), get_position.(chain));
posterior[1:5]</code></pre><pre><code class="language-none">5-element Array{NamedTuple{(:β, :α, :σ),Tuple{Array{Float64,1},Array{Float64,1},Float64}},1}:
 (β = [1.5688294766102886, 0.22547592976185798], α = [-0.09917603692312067, -0.12928445892963952, -0.12886941483169223, -0.07038911506069204, -0.16086299335615015, -0.3917188850077898, -0.08760938847488396, -0.06680472019791106, 0.2645911763156387, -0.09452996798078864], σ = 0.1891576588570661)
 (β = [1.3867125402721117, 0.2210613550411318], α = [0.15178968159838443, 0.07958017486868445, -0.09927046685040444, 0.2655487327640672, 0.03628363623007512, -0.13315952491007654, 0.02738545028007993, -0.07172448668625794, 0.29007987859364953, -0.11372753657828473], σ = 0.16532523732509205)    
 (β = [1.122291284711081, 0.2616455703385707], α = [-0.23065434129632095, 0.042175973613021556, 0.03244793771815736, 0.16318167829331887, 0.013614999573538707, -0.1881679005200756, 0.06411797735397429, -0.18728232990302104, 0.10006267735916774, -0.07159794248276312], σ = 0.11862173574230875)   
 (β = [0.8069185214371263, 0.2868334077917769], α = [0.12228554359890098, -0.03520829922185695, -0.015540940849290634, 0.0611728196585135, -0.05660876531995203, 0.012139815684953186, 0.08875418328711951, 0.01501979341314566, 0.005179062049526399, 0.0003956198124090947], σ = 0.07883724847247112)
 (β = [1.0914488499809374, 0.27125593765807715], α = [-0.20582339110522713, -0.08174230505712697, -0.09330105408686082, 0.059307906765177776, 0.028765832271348105, -0.0667117164482177, 0.08354395620255878, -0.1929297362797633, 0.03933521519454567, -0.06929542101560238], σ = 0.10494888036891444)</code></pre><p>Extract the parameter posterior means.</p><pre><code class="language-julia">posterior_β = mean(posterior[i].β for i in 1:length(posterior))
posterior_α = mean(posterior[i].α for i in 1:length(posterior))
posterior_σ = mean(posterior[i].σ for i in 1:length(posterior))</code></pre><pre><code class="language-none">0.3169726291053662</code></pre><p>Effective sample sizes (of untransformed draws)</p><pre><code class="language-julia">ess = mapslices(effective_sample_size, get_position_matrix(chain); dims = 1)
ess</code></pre><pre><code class="language-none">1×13 Array{Float64,2}:
 685.879  670.157  774.567  825.388  …  745.089  705.328  594.175  367.932</code></pre><p>NUTS-specific statistics</p><pre><code class="language-julia">NUTS_statistics(chain)</code></pre><pre><code class="language-none">Hamiltonian Monte Carlo sample of length 1000
  acceptance rate mean: 0.94, min/25%/median/75%/max: 0.45 0.91 0.97 0.99 1.0
  termination: AdjacentTurn =&gt; 7% DoubledTurn =&gt; 93%
  depth: 3 =&gt; 4% 4 =&gt; 94% 5 =&gt; 2%
</code></pre><p>CmdStan result</p><pre><code class="language-julia">m_12_6_result = &quot;
Iterations = 1:1000
Thinning interval = 1
Chains = 1,2,3,4
Samples per chain = 1000

Empirical Posterior Estimates:
                            Mean                SD               Naive SE             MCSE            ESS
            a          1.076167468  0.7704872560 0.01218247319 0.0210530022 1000.000000
           bp         0.263056273  0.0823415805 0.00130193470 0.0022645077 1000.000000
  a_society.1   -0.191723568  0.2421382537 0.00382854195 0.0060563054 1000.000000
  a_society.2    0.054569029  0.2278506876 0.00360263570 0.0051693148 1000.000000
  a_society.3   -0.035935050  0.1926364647 0.00304584994 0.0039948433 1000.000000
  a_society.4    0.334355037  0.1929971201 0.00305155241 0.0063871707  913.029080
  a_society.5    0.049747513  0.1801287716 0.00284808595 0.0043631095 1000.000000
  a_society.6   -0.311903245  0.2096126337 0.00331426674 0.0053000536 1000.000000
  a_society.7    0.148637507  0.1744680594 0.00275858223 0.0047660246 1000.000000
  a_society.8   -0.164567976  0.1821341074 0.00287979309 0.0034297298 1000.000000
  a_society.9    0.277066965  0.1758237250 0.00278001719 0.0055844175  991.286501
 a_society.10   -0.094149204  0.2846206232 0.00450024719 0.0080735022 1000.000000
sigma_society    0.310352849  0.1374834682 0.00217380450 0.0057325226  575.187461
&quot;;</code></pre><pre><code class="language-none">&quot;\nIterations = 1:1000\nThinning interval = 1\nChains = 1,2,3,4\nSamples per chain = 1000\n\nEmpirical Posterior Estimates:\n                            Mean                SD               Naive SE             MCSE            ESS\n            a          1.076167468  0.7704872560 0.01218247319 0.0210530022 1000.000000\n           bp         0.263056273  0.0823415805 0.00130193470 0.0022645077 1000.000000\n  a_society.1   -0.191723568  0.2421382537 0.00382854195 0.0060563054 1000.000000\n  a_society.2    0.054569029  0.2278506876 0.00360263570 0.0051693148 1000.000000\n  a_society.3   -0.035935050  0.1926364647 0.00304584994 0.0039948433 1000.000000\n  a_society.4    0.334355037  0.1929971201 0.00305155241 0.0063871707  913.029080\n  a_society.5    0.049747513  0.1801287716 0.00284808595 0.0043631095 1000.000000\n  a_society.6   -0.311903245  0.2096126337 0.00331426674 0.0053000536 1000.000000\n  a_society.7    0.148637507  0.1744680594 0.00275858223 0.0047660246 1000.000000\n  a_society.8   -0.164567976  0.1821341074 0.00287979309 0.0034297298 1000.000000\n  a_society.9    0.277066965  0.1758237250 0.00278001719 0.0055844175  991.286501\n a_society.10   -0.094149204  0.2846206232 0.00450024719 0.0080735022 1000.000000\nsigma_society    0.310352849  0.1374834682 0.00217380450 0.0057325226  575.187461\n&quot;</code></pre><p>Show means</p><pre><code class="language-julia">[posterior_β, posterior_α, [posterior_σ]]</code></pre><pre><code class="language-none">3-element Array{Array{Float64,1},1}:
 [1.0584363152240535, 0.2656697495649459]                                                                                                                                                                            
 [-0.20706262524771749, 0.04122973050929427, -0.042549763806481095, 0.3316963040868734, 0.04495247729906853, -0.3247834327694487, 0.1414796054530769, -0.17444264346673324, 0.2780060026982292, -0.11114340958334677]
 [0.3169726291053662]                                                                                                                                                                                                </code></pre><p>End of m12.6d.jl</p><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p><footer><hr/><a class="previous" href="../../10/m10.04d2/"><span class="direction">Previous</span><span class="title">m10.04d2</span></a><a class="next" href="../m12.6d1/"><span class="direction">Next</span><span class="title">m12.6d1</span></a></footer></article></body></html>
