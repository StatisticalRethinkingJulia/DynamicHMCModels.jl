<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>m12.6d · DynamicHMCModels.jl</title><link href="https://cdnjs.cloudflare.com/ajax/libs/normalize/4.2.0/normalize.min.css" rel="stylesheet" type="text/css"/><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.2.0/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link href="../../assets/documenter.css" rel="stylesheet" type="text/css"/></head><body><nav class="toc"><h1>DynamicHMCModels.jl</h1><select id="version-selector" onChange="window.location.href=this.value" style="visibility: hidden"></select><form class="search" id="search-form" action="../../search/"><input id="search-query" name="q" type="text" placeholder="Search docs"/></form><ul><li><a class="toctext" href="../../intro/">Home</a></li><li><span class="toctext">Chapter 02</span><ul><li><a class="toctext" href="../../02/m2.1d/">m2.1d</a></li></ul></li><li><span class="toctext">Chapter 04</span><ul><li><a class="toctext" href="../../04/m4.1d/">m4.1d</a></li><li><a class="toctext" href="../../04/m4.2d/">m4.2d</a></li><li><a class="toctext" href="../../04/m4.5d/">m4.5d</a></li></ul></li><li><span class="toctext">Chapter 05</span><ul><li><a class="toctext" href="../../05/m5.1d/">m5.1d</a></li><li><a class="toctext" href="../../05/m5.1d1/">m5.1d1</a></li><li><a class="toctext" href="../../05/m5.3d/">m5.3d</a></li><li><a class="toctext" href="../../05/m5.6d/">m5.6d</a></li></ul></li><li><span class="toctext">Chapter 08</span><ul><li><a class="toctext" href="../../08/m8.1d/">m8.1d</a></li></ul></li><li><span class="toctext">Chapter 10</span><ul><li><a class="toctext" href="../../10/m10.02d/">m10.02d</a></li><li><a class="toctext" href="../../10/m10.02d1/">m10.02d1</a></li><li><a class="toctext" href="../../10/m10.04d/">m10.04d</a></li><li><a class="toctext" href="../../10/m10.04d1/">m10.04d1</a></li><li><a class="toctext" href="../../10/m10.04d2/">m10.04d2</a></li></ul></li><li><span class="toctext">Chapter 12</span><ul><li class="current"><a class="toctext" href>m12.6d</a><ul class="internal"></ul></li><li><a class="toctext" href="../m12.6d1/">m12.6d1</a></li><li><a class="toctext" href="../m12.6d2/">m12.6d2</a></li></ul></li><li><a class="toctext" href="../../">Functions</a></li></ul></nav><article id="docs"><header><nav><ul><li>Chapter 12</li><li><a href>m12.6d</a></li></ul><a class="edit-page" href="https://github.com/StatisticalRethinkingJulia/DynamicHMCModels.jl/blob/master/scripts/12/m12.6d.jl"><span class="fa"></span> Edit on GitHub</a></nav><hr/><div id="topbar"><span>m12.6d</span><a class="fa fa-bars" href="#"></a></div></header><pre><code class="language-julia">using DynamicHMCModels

ProjDir = rel_path_d(&quot;..&quot;, &quot;scripts&quot;, &quot;12&quot;)

df = CSV.read(rel_path( &quot;..&quot;, &quot;data&quot;,  &quot;Kline.csv&quot;), delim=&#39;;&#39;);
size(df) # Should be 10x5</code></pre><pre><code class="language-none">(10, 5)</code></pre><p>New col logpop, set log() for population data</p><pre><code class="language-julia">df[:logpop] = map((x) -&gt; log(x), df[:population]);
df[:society] = 1:10;

first(df[[:total_tools, :logpop, :society]], 5)

struct m_12_06d_model{TY &lt;: AbstractVector, TX &lt;: AbstractMatrix,
  TS &lt;: AbstractVector}
    &quot;Observations (total_tools).&quot;
    y::TY
    &quot;Covariates (logpop)&quot;
    X::TX
    &quot;Society&quot;
    S::TS
    &quot;Number of observations (10)&quot;
    N::Int
    &quot;Number of societies (also 10)&quot;
    N_societies::Int
end</code></pre><p>Make the type callable with the parameters <em>as a single argument</em>.</p><pre><code class="language-julia">function (problem::m_12_06d_model)(θ)
    @unpack y, X, S, N, N_societies = problem   # extract the data
    @unpack β, α, σ = θ  # β : a, bp, α : a_society
    ll = 0.0
    ll += logpdf(Cauchy(0, 1), σ)
    ll += sum(logpdf.(Normal(0, σ), α)) # α[1:10]
    ll += logpdf.(Normal(0, 10), β[1]) # a
    ll += logpdf.(Normal(0, 1), β[2]) # a
    ll += sum(
      [loglikelihood(Poisson(exp(α[S[i]] + dot(X[i, :], β))), [y[i]]) for i in 1:N]
    )
    ll
end</code></pre><p>Instantiate the model with data and inits.</p><pre><code class="language-julia">N = size(df, 1)
N_societies = length(unique(df[:society]))
X = hcat(ones(Int64, N), df[:logpop]);
S = df[:society]
y = df[:total_tools]
p = m_12_06d_model(y, X, S, N, N_societies);
θ = (β = [1.0, 0.25], α = rand(Normal(0, 1), N_societies), σ = 0.2)
p(θ)</code></pre><pre><code class="language-none">-355.1444248920522</code></pre><p>Write a function to return properly dimensioned transformation.</p><pre><code class="language-julia">problem_transformation(p::m_12_06d_model) =
    as( (β = as(Array, size(p.X, 2)), α = as(Array, p.N_societies), σ = asℝ₊) )</code></pre><p>Wrap the problem with a transformation, then use Flux for the gradient.</p><pre><code class="language-julia">P = TransformedLogDensity(problem_transformation(p), p)
∇P = LogDensityRejectErrors(ADgradient(:ForwardDiff, P));
#∇P = ADgradient(:ForwardDiff, P);</code></pre><p>Tune and sample.</p><pre><code class="language-julia">chain, NUTS_tuned = NUTS_init_tune_mcmc(∇P, 1000);</code></pre><pre><code class="language-none">(NUTS_Transition{Array{Float64,1},Float64}[NUTS_Transition{Array{Float64,1},Float64}([1.1401029155373363, 0.3013296343224123, -0.6112269940628775, -0.38022054315755216, -0.6196644549524901, 0.31105516082308887, -0.23290422283086837, -0.5683267966596214, -0.04961410348006007, -0.5323693790586265, -0.2745912317266645, -0.5558337617461773, -0.6701780444182776], -52.01065332703368, 4, DynamicHMC.DoubledTurn, 0.9444001220146555, 15), NUTS_Transition{Array{Float64,1},Float64}([0.8948412729999988, 0.2756901535192995, -0.3947263634206235, 0.2825701665649865, -0.29786443063893264, 0.1236619048580912, 0.17345021195133062, -0.28543731747348916, 0.10395991628973864, 0.06692885641139124, 0.5692317666647982, -0.08666394982479039, -1.359482244670798], -51.7951385550417, 4, DynamicHMC.DoubledTurn, 0.8123560586271684, 15), NUTS_Transition{Array{Float64,1},Float64}([1.6775001748928313, 0.19603804875079603, -0.1719412561327902, -0.08517486820383124, -0.373758363919977, 0.5267801309284326, 0.06942101603405608, -0.012075464434291947, 0.14103137043854938, -0.20668208556509843, 0.4004626779749167, -0.05313431676736081, -0.976099650318344], -47.95578377664414, 4, DynamicHMC.DoubledTurn, 0.9749558079181372, 15), NUTS_Transition{Array{Float64,1},Float64}([1.3028194826671822, 0.24806960672478479, -0.39536284254949033, -0.09225541830747366, -0.1848114953818336, 0.14801363995947112, -0.08187147155064642, -0.9172305499026547, 0.2409961821325879, -0.15419577651071087, 0.24293842300637405, -0.035955011654721425, -1.0417074061466507], -46.2948681132349, 4, DynamicHMC.DoubledTurn, 0.996949867246285, 15), NUTS_Transition{Array{Float64,1},Float64}([1.4288534187155126, 0.2314039882895563, -0.2222357237149427, 0.3247199193180286, -0.10260638441909249, 0.09116342263671047, 0.015638251915626247, -0.16289948549820968, 0.07317283762545368, -0.1110558426971581, -0.03796464106507778, 0.00014130443819432986, -1.4508781459147333], -49.135137824837486, 4, DynamicHMC.DoubledTurn, 0.9577686680655333, 15), NUTS_Transition{Array{Float64,1},Float64}([-0.26749206137325343, 0.40511017594763404, 0.24672696883263487, 0.12272687549379058, 0.11406184690767532, 0.6086601614152298, 0.062234337071114615, -0.527451843791761, 0.15779596682329217, -0.2116299841610203, 0.2927601465182601, -0.6069711987628832, -0.7730287340709388], -45.12621098897359, 4, DynamicHMC.DoubledTurn, 0.8885402941445335, 15), NUTS_Transition{Array{Float64,1},Float64}([1.4428276946253473, 0.2184313226128884, -0.39470072024720093, -0.0020011085882888384, -0.14935628153655267, 0.4160687371570683, 0.1033985351461815, -0.1411839896093498, -0.001521533590819614, 0.17291023647030251, 0.25999041209939966, 0.0706895227146947, -1.539309053109824], -44.364775186616534, 4, DynamicHMC.DoubledTurn, 0.986454180655556, 15), NUTS_Transition{Array{Float64,1},Float64}([0.6583826174780023, 0.2968068610598788, -0.10401996198729188, 0.1926088362080424, -0.0683119132341891, 0.501278256812789, 0.044554933685216, -0.3724165505393261, 0.48719891184695385, -0.4776109900122155, 0.38007117843811433, -0.25115555718239424, -1.091317634571813], -42.429260275334826, 4, DynamicHMC.DoubledTurn, 0.8976612305398564, 15), NUTS_Transition{Array{Float64,1},Float64}([1.9632208113491871, 0.1766078139916782, -0.1151596782854906, -0.08480671173200173, -0.2254406562442408, 0.14232434553625328, -0.20352495017179356, -0.40512270592636396, 0.16938631462378664, -0.41751306827977097, 0.3906971679305508, 0.2422173121333122, -1.1256045660879344], -47.91497371599306, 4, DynamicHMC.DoubledTurn, 0.9277141733134379, 15), NUTS_Transition{Array{Float64,1},Float64}([1.2111243835975867, 0.2512010959483398, 0.1199018393026225, 0.18402804440165282, -0.17753930891132005, -0.0935681139752594, -0.17198055879488375, -0.4178613227673454, 0.07820074826564447, -0.5370104020516246, 0.2059053148672399, -0.060878597455573155, -1.3369050341579911], -49.43806000133048, 4, DynamicHMC.DoubledTurn, 0.8250517558560501, 15)  …  NUTS_Transition{Array{Float64,1},Float64}([1.0541689102899345, 0.26420292619127284, -0.17621744299987202, -0.08527759364572768, -0.3022888423379571, 0.1426320583163189, 0.14154312204403166, -0.27343734897242844, -0.05003763285356707, 0.14871848280610475, 0.22527941039395014, -0.06258929486490206, -1.1154187746995774], -47.979940739089606, 4, DynamicHMC.DoubledTurn, 0.7894817892880183, 15), NUTS_Transition{Array{Float64,1},Float64}([1.162497231385348, 0.2594320682220348, -0.13057458090842305, -0.036058215952444, 0.15996539181558755, 0.29173338944550753, -0.11432655753492961, -0.24611687053104422, 0.24913332217073064, -0.4605976580747264, 0.36456035855350616, -0.10982414851174471, -1.6420009312239043], -44.04323194885276, 4, DynamicHMC.DoubledTurn, 1.0, 15), NUTS_Transition{Array{Float64,1},Float64}([1.184149843871803, 0.25881495616564104, -0.15947163015621554, 0.2109874110818994, -0.2446660408940993, 0.20474532715449717, -0.09474032362538508, -0.17128176055178634, -0.09670483031098513, 0.13180042675778963, 0.07828273211379516, 0.09206249562547807, -1.5261176928156999], -45.470342686726106, 4, DynamicHMC.DoubledTurn, 0.8785111658332158, 15), NUTS_Transition{Array{Float64,1},Float64}([1.6830734516066552, 0.20141116798638464, -0.32261265773395265, 0.06093586546464416, -0.3956521795626911, 0.41974574898327305, -0.049901521093554065, -0.733868824207876, 0.11696639872540285, -0.157375088701654, 0.2521236544345442, 0.2579692017790057, -0.926742394877768], -47.461245868798954, 4, DynamicHMC.DoubledTurn, 1.0, 15), NUTS_Transition{Array{Float64,1},Float64}([1.4370806964286027, 0.2320370963937876, -0.23907717395765946, 0.0004957945254608354, -0.27494528392394574, 0.3368834697617207, -0.12126532804021864, -0.6979310058395132, -0.10929085816883988, -0.37812391045851496, -0.023869542041723785, 0.03701690715480019, -1.474568833036886], -48.4796605455262, 4, DynamicHMC.DoubledTurn, 0.8142652031276055, 15), NUTS_Transition{Array{Float64,1},Float64}([1.0379153097504537, 0.26779878883101754, 0.008301336497007261, -0.011644459153611474, 0.07302369604870268, 0.20074954515005933, 0.10119080418018787, 0.14420854302697006, 0.37134778251604494, 0.07525084932367312, 0.4238682477426178, -0.18677840049470815, -1.556351097853495], -51.34848487501576, 4, DynamicHMC.DoubledTurn, 0.873076605670867, 15), NUTS_Transition{Array{Float64,1},Float64}([0.667557448944882, 0.2847767199707063, -0.06188364205459377, 0.04299720875453533, 0.1576436790004202, 0.4052880148358995, 0.007940458259283946, -0.30787480778003035, 0.467504572751177, -0.14707560923893148, 0.48990007830905424, -0.269641317297734, -1.3372700918442249], -50.66777031287391, 4, DynamicHMC.DoubledTurn, 0.7712856154923092, 15), NUTS_Transition{Array{Float64,1},Float64}([1.962413712111691, 0.15100159877600028, -0.29318101670692703, 0.01384270734976971, -0.10410495744744953, 0.336333949769317, 0.17782026913079038, -0.5727655227218991, 0.1878416735529878, 0.12962288960198395, 0.3293381803196204, 0.09133296812850553, -1.1442781131983413], -46.59079055607013, 4, DynamicHMC.DoubledTurn, 0.9949037860651923, 15), NUTS_Transition{Array{Float64,1},Float64}([0.3425811367774017, 0.3592836930906578, -0.07643850623554714, 0.17847093007939088, -0.08110726938828947, 0.4010242694062552, -0.016017419696142225, -0.19604193649278656, 0.10041984590473751, -0.23247735719830928, 0.14340052016941385, -0.31017858771216483, -1.7538350115962509], -45.301001124371915, 4, DynamicHMC.DoubledTurn, 0.8889261595753714, 15), NUTS_Transition{Array{Float64,1},Float64}([0.5367901383664178, 0.3210425756261697, -0.4193528130528497, 0.14731043446253367, 0.0587559844682699, 0.4420895060379846, 0.0571180023276438, -0.2690696502601547, 0.13124025574127515, -0.38353179866028403, 0.1847370810064634, -0.21772440170886745, -1.0933159255220855], -41.429772863662926, 4, DynamicHMC.DoubledTurn, 0.997293868730838, 15)], NUTS sampler in 13 dimensions
  stepsize (ϵ) ≈ 0.234
  maximum depth = 10
  Gaussian kinetic energy, √diag(M⁻¹): [0.710765972940894, 0.08038318851041946, 0.23051348059242444, 0.20179070339766134, 0.18707189979996128, 0.17708334351069313, 0.18136737782726656, 0.2122253189708261, 0.18201123931665159, 0.19538732703906891, 0.17259397776425525, 0.2866277548486807, 0.41979381757054346]
)</code></pre><p>We use the transformation to obtain the posterior from the chain.</p><pre><code class="language-julia">posterior = TransformVariables.transform.(Ref(problem_transformation(p)), get_position.(chain));
posterior[1:5]</code></pre><pre><code class="language-none">5-element Array{NamedTuple{(:β, :α, :σ),Tuple{Array{Float64,1},Array{Float64,1},Float64}},1}:
 (β = [1.1401029155373363, 0.3013296343224123], α = [-0.6112269940628775, -0.38022054315755216, -0.6196644549524901, 0.31105516082308887, -0.23290422283086837, -0.5683267966596214, -0.04961410348006007, -0.5323693790586265, -0.2745912317266645, -0.5558337617461773], σ = 0.5116174790405351)    
 (β = [0.8948412729999988, 0.2756901535192995], α = [-0.3947263634206235, 0.2825701665649865, -0.29786443063893264, 0.1236619048580912, 0.17345021195133062, -0.28543731747348916, 0.10395991628973864, 0.06692885641139124, 0.5692317666647982, -0.08666394982479039], σ = 0.2567936988461605)       
 (β = [1.6775001748928313, 0.19603804875079603], α = [-0.1719412561327902, -0.08517486820383124, -0.373758363919977, 0.5267801309284326, 0.06942101603405608, -0.012075464434291947, 0.14103137043854938, -0.20668208556509843, 0.4004626779749167, -0.05313431676736081], σ = 0.37677780184422316)   
 (β = [1.3028194826671822, 0.24806960672478479], α = [-0.39536284254949033, -0.09225541830747366, -0.1848114953818336, 0.14801363995947112, -0.08187147155064642, -0.9172305499026547, 0.2409961821325879, -0.15419577651071087, 0.24293842300637405, -0.035955011654721425], σ = 0.35285170617100914)
 (β = [1.4288534187155126, 0.2314039882895563], α = [-0.2222357237149427, 0.3247199193180286, -0.10260638441909249, 0.09116342263671047, 0.015638251915626247, -0.16289948549820968, 0.07317283762545368, -0.1110558426971581, -0.03796464106507778, 0.00014130443819432986], σ = 0.23436439157041697)</code></pre><p>Extract the parameter posterior means.</p><pre><code class="language-julia">posterior_β = mean(posterior[i].β for i in 1:length(posterior))
posterior_α = mean(posterior[i].α for i in 1:length(posterior))
posterior_σ = mean(posterior[i].σ for i in 1:length(posterior))</code></pre><pre><code class="language-none">0.31720547758063156</code></pre><p>Effective sample sizes (of untransformed draws)</p><pre><code class="language-julia">ess = mapslices(effective_sample_size, get_position_matrix(chain); dims = 1)
ess</code></pre><pre><code class="language-none">1×13 Array{Float64,2}:
 1000.0  1000.0  686.215  945.503  …  743.212  419.705  517.115  375.458</code></pre><p>NUTS-specific statistics</p><pre><code class="language-julia">NUTS_statistics(chain)</code></pre><pre><code class="language-none">Hamiltonian Monte Carlo sample of length 1000
  acceptance rate mean: 0.93, min/25%/median/75%/max: 0.25 0.91 0.97 0.99 1.0
  termination: AdjacentTurn =&gt; 5% DoubledTurn =&gt; 95%
  depth: 2 =&gt; 0% 3 =&gt; 4% 4 =&gt; 94% 5 =&gt; 1%
</code></pre><p>CmdStan result</p><pre><code class="language-julia">m_12_6_result = &quot;
Iterations = 1:1000
Thinning interval = 1
Chains = 1,2,3,4
Samples per chain = 1000

Empirical Posterior Estimates:
                            Mean                SD               Naive SE             MCSE            ESS
            a          1.076167468  0.7704872560 0.01218247319 0.0210530022 1000.000000
           bp         0.263056273  0.0823415805 0.00130193470 0.0022645077 1000.000000
  a_society.1   -0.191723568  0.2421382537 0.00382854195 0.0060563054 1000.000000
  a_society.2    0.054569029  0.2278506876 0.00360263570 0.0051693148 1000.000000
  a_society.3   -0.035935050  0.1926364647 0.00304584994 0.0039948433 1000.000000
  a_society.4    0.334355037  0.1929971201 0.00305155241 0.0063871707  913.029080
  a_society.5    0.049747513  0.1801287716 0.00284808595 0.0043631095 1000.000000
  a_society.6   -0.311903245  0.2096126337 0.00331426674 0.0053000536 1000.000000
  a_society.7    0.148637507  0.1744680594 0.00275858223 0.0047660246 1000.000000
  a_society.8   -0.164567976  0.1821341074 0.00287979309 0.0034297298 1000.000000
  a_society.9    0.277066965  0.1758237250 0.00278001719 0.0055844175  991.286501
 a_society.10   -0.094149204  0.2846206232 0.00450024719 0.0080735022 1000.000000
sigma_society    0.310352849  0.1374834682 0.00217380450 0.0057325226  575.187461
&quot;;</code></pre><pre><code class="language-none">&quot;\nIterations = 1:1000\nThinning interval = 1\nChains = 1,2,3,4\nSamples per chain = 1000\n\nEmpirical Posterior Estimates:\n                            Mean                SD               Naive SE             MCSE            ESS\n            a          1.076167468  0.7704872560 0.01218247319 0.0210530022 1000.000000\n           bp         0.263056273  0.0823415805 0.00130193470 0.0022645077 1000.000000\n  a_society.1   -0.191723568  0.2421382537 0.00382854195 0.0060563054 1000.000000\n  a_society.2    0.054569029  0.2278506876 0.00360263570 0.0051693148 1000.000000\n  a_society.3   -0.035935050  0.1926364647 0.00304584994 0.0039948433 1000.000000\n  a_society.4    0.334355037  0.1929971201 0.00305155241 0.0063871707  913.029080\n  a_society.5    0.049747513  0.1801287716 0.00284808595 0.0043631095 1000.000000\n  a_society.6   -0.311903245  0.2096126337 0.00331426674 0.0053000536 1000.000000\n  a_society.7    0.148637507  0.1744680594 0.00275858223 0.0047660246 1000.000000\n  a_society.8   -0.164567976  0.1821341074 0.00287979309 0.0034297298 1000.000000\n  a_society.9    0.277066965  0.1758237250 0.00278001719 0.0055844175  991.286501\n a_society.10   -0.094149204  0.2846206232 0.00450024719 0.0080735022 1000.000000\nsigma_society    0.310352849  0.1374834682 0.00217380450 0.0057325226  575.187461\n&quot;</code></pre><p>Show means</p><pre><code class="language-julia">[posterior_β, posterior_α, [posterior_σ]]</code></pre><pre><code class="language-none">3-element Array{Array{Float64,1},1}:
 [1.13658087182616, 0.25654453898888635]                                                                                                                                                                            
 [-0.20430210978637156, 0.04791142626405907, -0.04965056042212674, 0.327606358595445, 0.04709717171076843, -0.3173730658896611, 0.15314837166423487, -0.16375729141218323, 0.2787247994771611, -0.07770356608058775]
 [0.31720547758063156]                                                                                                                                                                                              </code></pre><p>End of m12.6d.jl</p><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p><footer><hr/><a class="previous" href="../../10/m10.04d2/"><span class="direction">Previous</span><span class="title">m10.04d2</span></a><a class="next" href="../m12.6d1/"><span class="direction">Next</span><span class="title">m12.6d1</span></a></footer></article></body></html>
