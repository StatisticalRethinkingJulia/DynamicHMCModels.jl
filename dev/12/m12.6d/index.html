<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>m12.6d · DynamicHMCModels.jl</title><link href="https://cdnjs.cloudflare.com/ajax/libs/normalize/4.2.0/normalize.min.css" rel="stylesheet" type="text/css"/><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.2.0/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link href="../../assets/documenter.css" rel="stylesheet" type="text/css"/></head><body><nav class="toc"><h1>DynamicHMCModels.jl</h1><select id="version-selector" onChange="window.location.href=this.value" style="visibility: hidden"></select><form class="search" id="search-form" action="../../search/"><input id="search-query" name="q" type="text" placeholder="Search docs"/></form><ul><li><a class="toctext" href="../../intro/">Home</a></li><li><span class="toctext">Chapter 02</span><ul><li><a class="toctext" href="../../02/m2.1d/">m2.1d</a></li></ul></li><li><span class="toctext">Chapter 04</span><ul><li><a class="toctext" href="../../04/m4.1d/">m4.1d</a></li><li><a class="toctext" href="../../04/m4.2d/">m4.2d</a></li><li><a class="toctext" href="../../04/m4.5d/">m4.5d</a></li></ul></li><li><span class="toctext">Chapter 05</span><ul><li><a class="toctext" href="../../05/m5.1d/">m5.1d</a></li><li><a class="toctext" href="../../05/m5.1d1/">m5.1d1</a></li><li><a class="toctext" href="../../05/m5.3d/">m5.3d</a></li><li><a class="toctext" href="../../05/m5.6d/">m5.6d</a></li></ul></li><li><span class="toctext">Chapter 08</span><ul><li><a class="toctext" href="../../08/m8.1d/">m8.1d</a></li></ul></li><li><span class="toctext">Chapter 10</span><ul><li><a class="toctext" href="../../10/m10.02d/">m10.02d</a></li><li><a class="toctext" href="../../10/m10.02d1/">m10.02d1</a></li><li><a class="toctext" href="../../10/m10.04d/">m10.04d</a></li><li><a class="toctext" href="../../10/m10.04d1/">m10.04d1</a></li><li><a class="toctext" href="../../10/m10.04d2/">m10.04d2</a></li></ul></li><li><span class="toctext">Chapter 12</span><ul><li class="current"><a class="toctext" href>m12.6d</a><ul class="internal"></ul></li><li><a class="toctext" href="../m12.6d1/">m12.6d1</a></li><li><a class="toctext" href="../m12.6d2/">m12.6d2</a></li></ul></li><li><a class="toctext" href="../../">Functions</a></li></ul></nav><article id="docs"><header><nav><ul><li>Chapter 12</li><li><a href>m12.6d</a></li></ul><a class="edit-page" href="https://github.com/StatisticalRethinkingJulia/DynamicHMCModels.jl/blob/master/scripts/12/m12.6d.jl"><span class="fa"></span> Edit on GitHub</a></nav><hr/><div id="topbar"><span>m12.6d</span><a class="fa fa-bars" href="#"></a></div></header><div><pre><code class="language-julia">using DynamicHMCModels

ProjDir = rel_path_d(&quot;..&quot;, &quot;scripts&quot;, &quot;12&quot;)

df = CSV.read(rel_path( &quot;..&quot;, &quot;data&quot;,  &quot;Kline.csv&quot;), delim=&#39;;&#39;);
size(df) # Should be 10x5</code></pre><pre><code class="language-none">(10, 5)</code></pre></div><p>New col logpop, set log() for population data</p><div><pre><code class="language-julia">df[:logpop] = map((x) -&gt; log(x), df[:population]);
df[:society] = 1:10;

first(df[[:total_tools, :logpop, :society]], 5)

struct m_12_06d_model{TY &lt;: AbstractVector, TX &lt;: AbstractMatrix,
  TS &lt;: AbstractVector}
    &quot;Observations (total_tools).&quot;
    y::TY
    &quot;Covariates (logpop)&quot;
    X::TX
    &quot;Society&quot;
    S::TS
    &quot;Number of observations (10)&quot;
    N::Int
    &quot;Number of societies (also 10)&quot;
    N_societies::Int
end</code></pre></div><p>Make the type callable with the parameters <em>as a single argument</em>.</p><div><pre><code class="language-julia">function (problem::m_12_06d_model)(θ)
    @unpack y, X, S, N, N_societies = problem   # extract the data
    @unpack β, α, σ = θ  # β : a, bp, α : a_society
    ll = 0.0
    ll += logpdf(Cauchy(0, 1), σ)
    ll += sum(logpdf.(Normal(0, σ), α)) # α[1:10]
    ll += logpdf.(Normal(0, 10), β[1]) # a
    ll += logpdf.(Normal(0, 1), β[2]) # a
    ll += sum(
      [loglikelihood(Poisson(exp(α[S[i]] + dot(X[i, :], β))), [y[i]]) for i in 1:N]
    )
    ll
end</code></pre></div><p>Instantiate the model with data and inits.</p><div><pre><code class="language-julia">N = size(df, 1)
N_societies = length(unique(df[:society]))
X = hcat(ones(Int64, N), df[:logpop]);
S = df[:society]
y = df[:total_tools]
p = m_12_06d_model(y, X, S, N, N_societies);
θ = (β = [1.0, 0.25], α = rand(Normal(0, 1), N_societies), σ = 0.2)
p(θ)</code></pre><pre><code class="language-none">-404.73214318798716</code></pre></div><p>Write a function to return properly dimensioned transformation.</p><div><pre><code class="language-julia">problem_transformation(p::m_12_06d_model) =
    as( (β = as(Array, size(p.X, 2)), α = as(Array, p.N_societies), σ = asℝ₊) )</code></pre></div><p>Wrap the problem with a transformation, then use Flux for the gradient.</p><div><pre><code class="language-julia">P = TransformedLogDensity(problem_transformation(p), p)
∇P = LogDensityRejectErrors(ADgradient(:ForwardDiff, P));
#∇P = ADgradient(:ForwardDiff, P);</code></pre></div><p>Tune and sample.</p><div><pre><code class="language-julia">chain, NUTS_tuned = NUTS_init_tune_mcmc(∇P, 1000);</code></pre><pre><code class="language-none">MCMC, adapting ϵ (75 steps)
0.0027 s/step ...done
MCMC, adapting ϵ (25 steps)
0.003 s/step ...done
MCMC, adapting ϵ (50 steps)
0.0028 s/step ...done
MCMC, adapting ϵ (100 steps)
0.001 s/step ...done
MCMC, adapting ϵ (200 steps)
0.0007 s/step ...done
MCMC, adapting ϵ (400 steps)
0.00047 s/step ...done
MCMC, adapting ϵ (50 steps)
0.00063 s/step ...done
MCMC (1000 steps)
0.00044 s/step ...done
(NUTS_Transition{Array{Float64,1},Float64}[NUTS_Transition{Array{Float64,1},Float64}([0.6921981158266355, 0.30034366408709134, -0.16730723961992067, -0.03073304317149951, 0.034257871068712434, -0.012163346062619665, 0.2447876162756848, -0.3273676721337962, 0.3993399399791108, -0.14156868159294497, 0.3227531693021914, -0.3023767221643311, -1.0988259671714877], -46.07150780972102, 4, DynamicHMC.DoubledTurn, 0.8095068283247449, 15), NUTS_Transition{Array{Float64,1},Float64}([1.230128378102332, 0.2412259503240794, -0.2257857009491347, -0.07394245508548083, 0.1731850235895305, 0.07871344509428962, 0.21385423262823436, -0.5042894539935157, 0.6003093668917464, -0.034583135968489394, 0.4754315521667403, -0.16412508417366473, -0.8221406202623007], -47.53715769374139, 4, DynamicHMC.DoubledTurn, 0.9935482833889975, 15), NUTS_Transition{Array{Float64,1},Float64}([0.6360412456713007, 0.30172884482257295, 0.042137682216015805, 0.17147861878901852, -0.047562074296938824, 0.333912770827379, 0.013672724582671943, -0.035872150420336715, -0.10850870332682089, -0.09088511825133513, 0.10020813128532251, 0.029534243753332624, -2.3250622994112633], -46.4307210106024, 4, DynamicHMC.DoubledTurn, 0.9983975265672029, 15), NUTS_Transition{Array{Float64,1},Float64}([1.218465081658275, 0.26626321392437047, -0.057889338293901846, -0.13131669850846708, -0.15116050171525663, 0.09019460558385446, 0.055172109331996434, -0.5309230527147144, 0.16820894335921205, -0.40372892193089915, 0.2504291514105054, -0.45816888156306423, -1.136687992240083], -44.798382787730255, 4, DynamicHMC.DoubledTurn, 0.9933780383065388, 15), NUTS_Transition{Array{Float64,1},Float64}([1.5476242965845992, 0.20354382494652068, -0.15482583149660717, -0.03125541682355591, 0.18958024499932957, 0.4692785669235452, 0.2404518067853753, -0.49715036663511514, 0.2282320376951229, -0.21986313413000974, 0.26845553449228954, 0.25069976467949573, -1.433220329157263], -43.90693092735085, 4, DynamicHMC.DoubledTurn, 0.9605588133347015, 15), NUTS_Transition{Array{Float64,1},Float64}([1.6413212265272223, 0.19969710592214482, -0.06364483348763271, 0.09689345565611998, 0.06455691380689023, 0.3726962819582746, 0.19195472018899043, -0.2524364877284863, 0.20343568275926496, -0.4385820091400823, 0.287923563104496, -0.0703451173768699, -1.3920662284537852], -44.02002723749097, 4, DynamicHMC.DoubledTurn, 0.9779395697908801, 15), NUTS_Transition{Array{Float64,1},Float64}([0.45901862645751174, 0.32731313463869405, -0.06355966185298662, 0.07528007926100429, -0.13310943054274849, 0.14676445383939415, 0.027819704501022825, -0.11038649768258278, 0.1420272664420647, 0.26302513742634814, 0.17572336199926564, -0.08231207434582136, -2.1250909685374775], -45.0864100587149, 4, DynamicHMC.DoubledTurn, 0.9899781739215605, 15), NUTS_Transition{Array{Float64,1},Float64}([1.339559674163783, 0.2402962615737168, -0.06406846565555065, -0.04111196106097157, 0.06703141932990875, 0.10768753828703073, -0.0125987796432291, -0.11742692617047965, 0.01854142005951627, -0.3118700115565958, 0.12236390164471825, 0.14225438494699086, -1.9952356811562586], -45.018410465901894, 4, DynamicHMC.DoubledTurn, 0.950158585248968, 15), NUTS_Transition{Array{Float64,1},Float64}([1.1774029056894215, 0.2586312867455829, 0.007495984676334947, -0.0077046382857223275, 0.03019972727682378, 0.21370735289994175, 0.057382587631205656, -0.22851897285013664, 0.03529227416318609, 0.07300102403293739, 0.05849203624428111, -0.12162957647105146, -2.35033406123557], -41.658993960597876, 3, DynamicHMC.AdjacentTurn, 0.9910344979006778, 15), NUTS_Transition{Array{Float64,1},Float64}([1.2175234262213135, 0.254794454933634, -0.08731976660673635, -0.007862134284366322, -0.0221354425772282, -0.0172171269722936, 0.04465037095200383, -0.06235525413641052, 0.022477756961907406, -0.056560855883878935, 0.1536295693620742, -0.054391945519410415, -2.0999197215944574], -38.52736374849044, 4, DynamicHMC.DoubledTurn, 0.9709322005439006, 15)  …  NUTS_Transition{Array{Float64,1},Float64}([1.544860899003366, 0.20786295495430548, -0.28451609321734683, -0.2533361637018151, -0.12880658733416897, 0.34303077031465184, 0.05725625632183658, -0.14403375909395877, 0.01643388303519354, -0.2900956267463921, 0.2556849583041806, 0.22188972481537342, -1.6316916192360298], -39.823931323683226, 4, DynamicHMC.DoubledTurn, 0.960878548629164, 15), NUTS_Transition{Array{Float64,1},Float64}([0.8406781360385017, 0.2797343647251936, -0.023873044924536527, -0.07681431998571045, -0.007234763803890959, 0.4554949306758546, 0.18241809947981702, -0.050515470089415954, 0.04067813805551649, -0.21760325103166414, 0.34399502293611584, 0.03079151056944804, -1.800620836069615], -43.02197983078388, 3, DynamicHMC.DoubledTurn, 0.8967643215516539, 7), NUTS_Transition{Array{Float64,1},Float64}([1.029539261804461, 0.28929737096526614, -0.3625656441092012, 0.24762830689252913, -0.1427723312689415, -0.027561710889360682, -0.2384235113519939, -0.7241697749703899, 0.12103378992645326, -0.24829671860928765, 0.05990476655869232, -0.43406187084245085, -1.0711254110768351], -46.370360045965235, 4, DynamicHMC.DoubledTurn, 0.8212984865704702, 15), NUTS_Transition{Array{Float64,1},Float64}([0.04647348552918767, 0.3791276473349633, -0.002414799966070632, 0.025046597880718495, 0.03620163154312981, 0.42798628030328234, 0.2941256466946698, -0.3231402399428943, -0.10469477574222648, -0.27942147374305487, 0.1287529148406902, -0.37466296210318006, -0.9023830356223359], -45.19696231807275, 4, DynamicHMC.DoubledTurn, 0.9938260325275915, 15), NUTS_Transition{Array{Float64,1},Float64}([0.05459906685073514, 0.3751240701363914, 0.030438545753255688, -0.015129650213767463, 0.07760689429977533, 0.4361411668246693, 0.2733907225480523, -0.3264613719446401, -0.15885139740844534, -0.2814789991010173, 0.10714936138655834, -0.40677089214986123, -0.989881222033791], -44.30073449888668, 4, DynamicHMC.DoubledTurn, 0.9649849367481279, 15), NUTS_Transition{Array{Float64,1},Float64}([1.2940846171591531, 0.2509220200296786, -0.3333086939367219, -0.012168676999949623, 0.0005162966921682267, 0.25581832065794596, 0.0314970184528097, -0.6808777021107475, -0.3510934930898273, -0.27483993471129176, 0.07619279185454324, -0.10228802082309174, -1.3339576842159404], -46.1861257541422, 4, DynamicHMC.DoubledTurn, 0.9848471556922945, 15), NUTS_Transition{Array{Float64,1},Float64}([0.8863712839140265, 0.2927908072957469, -0.41449478593102107, 0.22000746229413365, -0.31389849573294204, 0.28215301768938944, 0.20585695384537234, -0.16702354784586415, -0.08480971096715624, -0.38672331328458487, 0.05348874730255718, -0.24311542793540275, -0.8703236204857682], -47.667808720818236, 4, DynamicHMC.DoubledTurn, 0.9984957159156055, 15), NUTS_Transition{Array{Float64,1},Float64}([1.6067417334380745, 0.20156212254918696, 0.04478590535813767, -0.3171426210878753, 0.19926462650547938, 0.44832043578818903, -0.19831627098576662, -0.378885095820281, 0.19739175436225997, -0.057105030666462275, 0.4169004414272352, -0.040667185206204215, -1.572877803705735], -46.29066853574649, 4, DynamicHMC.DoubledTurn, 0.9870015022451242, 15), NUTS_Transition{Array{Float64,1},Float64}([0.08698300032092503, 0.36191858467484933, -0.007044667013263173, 0.18546002232174688, -0.06963797496050131, 0.25078220165185366, 0.03219119439967522, -0.24928153139571513, 0.13500768188185633, -0.37373875277766755, 0.4941526068778147, -0.33184234854589834, -0.7679947783094592], -48.083840765341016, 4, DynamicHMC.DoubledTurn, 0.9869398518959327, 15), NUTS_Transition{Array{Float64,1},Float64}([-0.03529627755046188, 0.3851702460454671, -0.18762329023813096, 0.21852397447886984, -0.08654675851405398, 0.28917107421972005, 0.11747229905213058, -0.24243018444439707, -0.013381737509731026, -0.184029373193945, 0.429117430507629, -0.49386833994669527, -1.0455218698927835], -46.26502344596495, 4, DynamicHMC.DoubledTurn, 0.9115914090559746, 15)], NUTS sampler in 13 dimensions
  stepsize (ϵ) ≈ 0.211
  maximum depth = 10
  Gaussian kinetic energy, √diag(M⁻¹): [0.786645947692201, 0.08846207846549901, 0.2731990747969388, 0.21901676520999677, 0.19895675841024454, 0.1780022743656863, 0.1754466624388055, 0.19610104018570526, 0.18459001211890344, 0.1969653930875958, 0.18164473424651037, 0.30019801192344925, 0.4293622527703376]
)</code></pre></div><p>We use the transformation to obtain the posterior from the chain.</p><div><pre><code class="language-julia">posterior = TransformVariables.transform.(Ref(problem_transformation(p)), get_position.(chain));
posterior[1:5]</code></pre><pre><code class="language-none">5-element Array{NamedTuple{(:β, :α, :σ),Tuple{Array{Float64,1},Array{Float64,1},Float64}},1}:
 (β = [0.6921981158266355, 0.30034366408709134], α = [-0.16730723961992067, -0.03073304317149951, 0.034257871068712434, -0.012163346062619665, 0.2447876162756848, -0.3273676721337962, 0.3993399399791108, -0.14156868159294497, 0.3227531693021914, -0.3023767221643311], σ = 0.33326211477474915)
 (β = [1.230128378102332, 0.2412259503240794], α = [-0.2257857009491347, -0.07394245508548083, 0.1731850235895305, 0.07871344509428962, 0.21385423262823436, -0.5042894539935157, 0.6003093668917464, -0.034583135968489394, 0.4754315521667403, -0.16412508417366473], σ = 0.4394898659476667)
 (β = [0.6360412456713007, 0.30172884482257295], α = [0.042137682216015805, 0.17147861878901852, -0.047562074296938824, 0.333912770827379, 0.013672724582671943, -0.035872150420336715, -0.10850870332682089, -0.09088511825133513, 0.10020813128532251, 0.029534243753332624], σ = 0.09777735239010979)
 (β = [1.218465081658275, 0.26626321392437047], α = [-0.057889338293901846, -0.13131669850846708, -0.15116050171525663, 0.09019460558385446, 0.055172109331996434, -0.5309230527147144, 0.16820894335921205, -0.40372892193089915, 0.2504291514105054, -0.45816888156306423], σ = 0.3208800209471294)
 (β = [1.5476242965845992, 0.20354382494652068], α = [-0.15482583149660717, -0.03125541682355591, 0.18958024499932957, 0.4692785669235452, 0.2404518067853753, -0.49715036663511514, 0.2282320376951229, -0.21986313413000974, 0.26845553449228954, 0.25069976467949573], σ = 0.2385395082918865)</code></pre></div><p>Extract the parameter posterior means.</p><div><pre><code class="language-julia">posterior_β = mean(posterior[i].β for i in 1:length(posterior))
posterior_α = mean(posterior[i].α for i in 1:length(posterior))
posterior_σ = mean(posterior[i].σ for i in 1:length(posterior))</code></pre><pre><code class="language-none">0.31081615457475886</code></pre></div><p>Effective sample sizes (of untransformed draws)</p><div><pre><code class="language-julia">ess = mapslices(effective_sample_size, get_position_matrix(chain); dims = 1)
ess</code></pre><pre><code class="language-none">1×13 Array{Float64,2}:
 589.075  584.865  792.12  746.123  …  948.035  852.816  608.428  344.913</code></pre></div><p>NUTS-specific statistics</p><div><pre><code class="language-julia">NUTS_statistics(chain)</code></pre><pre><code class="language-none">Hamiltonian Monte Carlo sample of length 1000
  acceptance rate mean: 0.94, min/25%/median/75%/max: 0.0 0.92 0.97 0.99 1.0
  termination: AdjacentTurn =&gt; 11% DoubledTurn =&gt; 89%
  depth: 3 =&gt; 4% 4 =&gt; 92% 5 =&gt; 4%</code></pre></div><p>CmdStan result</p><div><pre><code class="language-julia">m_12_6_result = &quot;
Iterations = 1:1000
Thinning interval = 1
Chains = 1,2,3,4
Samples per chain = 1000

Empirical Posterior Estimates:
                            Mean                SD               Naive SE             MCSE            ESS
            a          1.076167468  0.7704872560 0.01218247319 0.0210530022 1000.000000
           bp         0.263056273  0.0823415805 0.00130193470 0.0022645077 1000.000000
  a_society.1   -0.191723568  0.2421382537 0.00382854195 0.0060563054 1000.000000
  a_society.2    0.054569029  0.2278506876 0.00360263570 0.0051693148 1000.000000
  a_society.3   -0.035935050  0.1926364647 0.00304584994 0.0039948433 1000.000000
  a_society.4    0.334355037  0.1929971201 0.00305155241 0.0063871707  913.029080
  a_society.5    0.049747513  0.1801287716 0.00284808595 0.0043631095 1000.000000
  a_society.6   -0.311903245  0.2096126337 0.00331426674 0.0053000536 1000.000000
  a_society.7    0.148637507  0.1744680594 0.00275858223 0.0047660246 1000.000000
  a_society.8   -0.164567976  0.1821341074 0.00287979309 0.0034297298 1000.000000
  a_society.9    0.277066965  0.1758237250 0.00278001719 0.0055844175  991.286501
 a_society.10   -0.094149204  0.2846206232 0.00450024719 0.0080735022 1000.000000
sigma_society    0.310352849  0.1374834682 0.00217380450 0.0057325226  575.187461
&quot;;</code></pre><pre><code class="language-none">&quot;\nIterations = 1:1000\nThinning interval = 1\nChains = 1,2,3,4\nSamples per chain = 1000\n\nEmpirical Posterior Estimates:\n                            Mean                SD               Naive SE             MCSE            ESS\n            a          1.076167468  0.7704872560 0.01218247319 0.0210530022 1000.000000\n           bp         0.263056273  0.0823415805 0.00130193470 0.0022645077 1000.000000\n  a_society.1   -0.191723568  0.2421382537 0.00382854195 0.0060563054 1000.000000\n  a_society.2    0.054569029  0.2278506876 0.00360263570 0.0051693148 1000.000000\n  a_society.3   -0.035935050  0.1926364647 0.00304584994 0.0039948433 1000.000000\n  a_society.4    0.334355037  0.1929971201 0.00305155241 0.0063871707  913.029080\n  a_society.5    0.049747513  0.1801287716 0.00284808595 0.0043631095 1000.000000\n  a_society.6   -0.311903245  0.2096126337 0.00331426674 0.0053000536 1000.000000\n  a_society.7    0.148637507  0.1744680594 0.00275858223 0.0047660246 1000.000000\n  a_society.8   -0.164567976  0.1821341074 0.00287979309 0.0034297298 1000.000000\n  a_society.9    0.277066965  0.1758237250 0.00278001719 0.0055844175  991.286501\n a_society.10   -0.094149204  0.2846206232 0.00450024719 0.0080735022 1000.000000\nsigma_society    0.310352849  0.1374834682 0.00217380450 0.0057325226  575.187461\n&quot;</code></pre></div><p>Show means</p><div><pre><code class="language-julia">[posterior_β, posterior_α, [posterior_σ]]</code></pre><pre><code class="language-none">3-element Array{Array{Float64,1},1}:
 [1.1260298573410557, 0.2590549679141716]
 [-0.19520956038190704, 0.034426514486579664, -0.036132333901253366, 0.31569503697938595, 0.03937631705560414, -0.3246001967719196, 0.13865467112613816, -0.17845322139179504, 0.2679126392706468, -0.09405529970197231]
 [0.31081615457475886]</code></pre></div><p>End of m12.6d.jl</p><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p><footer><hr/><a class="previous" href="../../10/m10.04d2/"><span class="direction">Previous</span><span class="title">m10.04d2</span></a><a class="next" href="../m12.6d1/"><span class="direction">Next</span><span class="title">m12.6d1</span></a></footer></article></body></html>
