<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>m12.6d · DynamicHMCModels.jl</title><link href="https://cdnjs.cloudflare.com/ajax/libs/normalize/4.2.0/normalize.min.css" rel="stylesheet" type="text/css"/><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.2.0/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link href="../../assets/documenter.css" rel="stylesheet" type="text/css"/></head><body><nav class="toc"><h1>DynamicHMCModels.jl</h1><select id="version-selector" onChange="window.location.href=this.value" style="visibility: hidden"></select><form class="search" id="search-form" action="../../search/"><input id="search-query" name="q" type="text" placeholder="Search docs"/></form><ul><li><a class="toctext" href="../../intro/">Home</a></li><li><span class="toctext">Chapter 02</span><ul><li><a class="toctext" href="../../02/m2.1d/">m2.1d</a></li></ul></li><li><span class="toctext">Chapter 04</span><ul><li><a class="toctext" href="../../04/m4.1d/">m4.1d</a></li><li><a class="toctext" href="../../04/m4.2d/">m4.2d</a></li><li><a class="toctext" href="../../04/m4.5d/">m4.5d</a></li></ul></li><li><span class="toctext">Chapter 05</span><ul><li><a class="toctext" href="../../05/m5.1d/">m5.1d</a></li><li><a class="toctext" href="../../05/m5.1d1/">m5.1d1</a></li><li><a class="toctext" href="../../05/m5.3d/">m5.3d</a></li><li><a class="toctext" href="../../05/m5.6d/">m5.6d</a></li></ul></li><li><span class="toctext">Chapter 08</span><ul><li><a class="toctext" href="../../08/m8.1d/">m8.1d</a></li></ul></li><li><span class="toctext">Chapter 10</span><ul><li><a class="toctext" href="../../10/m10.02d/">m10.02d</a></li><li><a class="toctext" href="../../10/m10.02d1/">m10.02d1</a></li><li><a class="toctext" href="../../10/m10.04d/">m10.04d</a></li><li><a class="toctext" href="../../10/m10.04d1/">m10.04d1</a></li><li><a class="toctext" href="../../10/m10.04d2/">m10.04d2</a></li></ul></li><li><span class="toctext">Chapter 12</span><ul><li class="current"><a class="toctext" href>m12.6d</a><ul class="internal"></ul></li><li><a class="toctext" href="../m12.6d1/">m12.6d1</a></li><li><a class="toctext" href="../m12.6d2/">m12.6d2</a></li></ul></li><li><a class="toctext" href="../../">Functions</a></li></ul></nav><article id="docs"><header><nav><ul><li>Chapter 12</li><li><a href>m12.6d</a></li></ul><a class="edit-page" href="https://github.com/StatisticalRethinkingJulia/DynamicHMCModels.jl/blob/master/scripts/12/m12.6d.jl"><span class="fa"></span> Edit on GitHub</a></nav><hr/><div id="topbar"><span>m12.6d</span><a class="fa fa-bars" href="#"></a></div></header><pre><code class="language-julia">using DynamicHMCModels

ProjDir = rel_path_d(&quot;..&quot;, &quot;scripts&quot;, &quot;12&quot;)

df = CSV.read(rel_path( &quot;..&quot;, &quot;data&quot;,  &quot;Kline.csv&quot;), delim=&#39;;&#39;);
size(df) # Should be 10x5</code></pre><pre><code class="language-none">(10, 5)</code></pre><p>New col logpop, set log() for population data</p><pre><code class="language-julia">df[:logpop] = map((x) -&gt; log(x), df[:population]);
df[:society] = 1:10;

first(df[[:total_tools, :logpop, :society]], 5)

struct m_12_06d_model{TY &lt;: AbstractVector, TX &lt;: AbstractMatrix,
  TS &lt;: AbstractVector}
    &quot;Observations (total_tools).&quot;
    y::TY
    &quot;Covariates (logpop)&quot;
    X::TX
    &quot;Society&quot;
    S::TS
    &quot;Number of observations (10)&quot;
    N::Int
    &quot;Number of societies (also 10)&quot;
    N_societies::Int
end</code></pre><p>Make the type callable with the parameters <em>as a single argument</em>.</p><pre><code class="language-julia">function (problem::m_12_06d_model)(θ)
    @unpack y, X, S, N, N_societies = problem   # extract the data
    @unpack β, α, σ = θ  # β : a, bp, α : a_society
    ll = 0.0
    ll += logpdf(Cauchy(0, 1), σ)
    ll += sum(logpdf.(Normal(0, σ), α)) # α[1:10]
    ll += logpdf.(Normal(0, 10), β[1]) # a
    ll += logpdf.(Normal(0, 1), β[2]) # a
    ll += sum(
      [loglikelihood(Poisson(exp(α[S[i]] + dot(X[i, :], β))), [y[i]]) for i in 1:N]
    )
    ll
end</code></pre><p>Instantiate the model with data and inits.</p><pre><code class="language-julia">N = size(df, 1)
N_societies = length(unique(df[:society]))
X = hcat(ones(Int64, N), df[:logpop]);
S = df[:society]
y = df[:total_tools]
p = m_12_06d_model(y, X, S, N, N_societies);
θ = (β = [1.0, 0.25], α = rand(Normal(0, 1), N_societies), σ = 0.2)
p(θ)</code></pre><pre><code class="language-none">-230.25372163182038</code></pre><p>Write a function to return properly dimensioned transformation.</p><pre><code class="language-julia">problem_transformation(p::m_12_06d_model) =
    as( (β = as(Array, size(p.X, 2)), α = as(Array, p.N_societies), σ = asℝ₊) )</code></pre><p>Wrap the problem with a transformation, then use Flux for the gradient.</p><pre><code class="language-julia">P = TransformedLogDensity(problem_transformation(p), p)
∇P = LogDensityRejectErrors(ADgradient(:ForwardDiff, P));
#∇P = ADgradient(:ForwardDiff, P);</code></pre><p>Tune and sample.</p><pre><code class="language-julia">chain, NUTS_tuned = NUTS_init_tune_mcmc(∇P, 1000);</code></pre><pre><code class="language-none">(NUTS_Transition{Array{Float64,1},Float64}[NUTS_Transition{Array{Float64,1},Float64}([2.075635609801923, 0.16460706706725303, -0.6568046599534312, -0.18442166549923106, -0.17796602690169974, 0.12256339611430397, 0.011688376374027629, -0.12510967020147504, 0.06138692177798156, -0.4555220167961287, 0.07415597066736729, -0.006345304984051919, -1.4038465260263846], -43.727018181920926, 4, DynamicHMC.DoubledTurn, 0.9935055228297186, 15), NUTS_Transition{Array{Float64,1},Float64}([0.29743535271565624, 0.3100612922956974, 0.33201209259105385, 0.31590233140726054, 0.3622592053721623, 0.705755112989208, 0.1675548114599119, -0.6043771972136694, 0.2928060034939825, 0.16607424825188843, 0.598077977132243, 0.05314281714507706, -0.8707294582445885], -52.85336945667641, 4, DynamicHMC.DoubledTurn, 0.46774669891736104, 15), NUTS_Transition{Array{Float64,1},Float64}([-0.2438779808037832, 0.3510756887571428, 0.20402707795704034, 0.7921190911589258, 0.2673881182448562, 0.9509326315066225, 0.3284395158190936, -0.32017346113975714, 0.5535807160575051, 0.1633858741088622, 0.8614426956979911, 0.06941071833321077, -0.5739772718211901], -49.59890382326401, 4, DynamicHMC.DoubledTurn, 0.9320388569296312, 15), NUTS_Transition{Array{Float64,1},Float64}([1.8860596853878249, 0.15560136991746096, -0.16194074594315122, 0.1343217473689179, 0.12065651157786886, 0.46577301297274115, 0.2566055488150256, -0.33421506852361554, 0.2826803419884365, 0.10819500924853807, 0.5024813531487595, 0.3957295824450697, -1.0470961456275838], -46.05292253106602, 4, DynamicHMC.DoubledTurn, 0.9925776425159035, 15), NUTS_Transition{Array{Float64,1},Float64}([0.421277759495236, 0.33816891035967794, -0.6285652297839837, 0.29624009731080303, -0.15754666397488862, 0.3201744503928135, 0.12663697668379498, -0.3732251164204107, 0.3425260311028894, -0.19182217821193082, 0.3260920078845044, -0.41649348253915736, -0.9810931522809293], -43.74466444656904, 4, DynamicHMC.DoubledTurn, 0.939906039287805, 15), NUTS_Transition{Array{Float64,1},Float64}([0.6965955325114004, 0.3007249560335255, 0.08212210390802166, 0.1752469919074576, 0.32719407856245497, 0.5820791147221336, 0.29586739703182163, -0.5033151113191155, -0.06845725092212482, -0.310249021405697, 0.19944085633550845, -0.12837104064559374, -1.3927072599430987], -47.65567999257874, 4, DynamicHMC.DoubledTurn, 0.8594820550078294, 15), NUTS_Transition{Array{Float64,1},Float64}([1.3822198844081457, 0.22017447112117283, -0.40844406934514293, 0.1406968328677524, -0.28039014621674974, 0.20900146302807643, -0.02769695132652062, -0.08635249290763578, 0.46779606666988105, 0.15951657967409313, 0.5269356639755102, 0.17336092748051657, -1.0632866355484902], -47.1676472321209, 4, DynamicHMC.DoubledTurn, 0.7922387509427277, 15), NUTS_Transition{Array{Float64,1},Float64}([1.249214680504462, 0.2540081148010379, -0.07621972039068256, -0.07617769261082072, 0.12087085951184975, 0.34675653301772535, 0.0730937720061289, -0.368494662581184, -0.13561162027483276, -0.4249656155819379, 0.12020583246689977, -0.0890040498982543, -1.8101048609740327], -44.90901357319075, 4, DynamicHMC.DoubledTurn, 0.8780898806793601, 15), NUTS_Transition{Array{Float64,1},Float64}([1.0583597363807005, 0.2587591775880159, -0.306659284764386, 0.3003418001406953, -0.40325336312496635, 0.34094878386461414, -0.0830473398941438, -0.18342744354790086, 0.49923864997456213, -0.009592693325922275, 0.3441080618314846, -0.05058412096563503, -0.9260488279243223], -47.27885805145974, 4, DynamicHMC.DoubledTurn, 0.9883948591478513, 15), NUTS_Transition{Array{Float64,1},Float64}([1.5865194855161993, 0.19969166113217146, -0.13069835251199885, 0.18899075702535625, -0.17656345943813959, 0.5340382562669518, -0.08172378477894135, -0.2690712983500182, 0.16679010925740467, 0.0552170661064914, 0.31088870924760115, 0.21715222539844847, -1.4113933400803877], -44.14669184113212, 4, DynamicHMC.DoubledTurn, 0.9924538289186877, 15)  …  NUTS_Transition{Array{Float64,1},Float64}([1.5832488334569006, 0.21035636790419932, -0.09216607322337805, -0.30836433544748726, 0.012504256246501966, 0.22230284965818187, -0.06945322558904961, -0.17796653677190596, -0.11023377571703466, 0.06010466811668312, -0.037947816022345995, 0.18189890314618962, -1.5363915940272217], -46.795171889341745, 4, DynamicHMC.DoubledTurn, 0.9467301578295833, 15), NUTS_Transition{Array{Float64,1},Float64}([2.2553244881444643, 0.08628620143336783, -0.24168996474291082, 0.37308666291063963, 0.11948853546876126, 0.53296630563806, 0.3058013599166143, -0.22257735145100466, 0.6160206377687725, 0.02012413099045507, 0.9160949315018183, 0.8214917622410697, -0.8596137394182375], -54.15338821415626, 4, DynamicHMC.DoubledTurn, 0.7047443834754652, 15), NUTS_Transition{Array{Float64,1},Float64}([2.274273650244311, 0.09242259808673317, -0.22610165529964793, 0.14925780214414577, -0.033845228470327705, 0.5121142164767905, 0.5352423771386882, -0.325857765274868, 0.6930474848335534, 0.11554900055138984, 0.8546729687637574, 0.8088254052959912, -0.6781182661134192], -50.37279346522, 3, DynamicHMC.AdjacentTurn, 0.7452001334415218, 15), NUTS_Transition{Array{Float64,1},Float64}([0.65163498784596, 0.3474175331172534, -0.5249736803105223, -0.1764685053915512, -0.015375308626944837, 0.2603478938650965, -0.3384580993271328, -0.43702611178692147, -0.21847868784918412, -0.3375739916641469, -0.19998181232779963, -0.7307126564788439, -0.750974601261538], -53.753938582612854, 4, DynamicHMC.AdjacentTurn, 0.8699628306340622, 31), NUTS_Transition{Array{Float64,1},Float64}([0.6165165020607805, 0.3505371416903693, -0.5044895663390192, -0.3003104954225226, -0.24943320303853128, 0.03435328905627928, -0.11021062889111118, -0.43776053695066774, -0.270814551868863, -0.5969615346374718, -0.17874375542658338, -0.7559914267298193, -0.8446297842479406], -49.2344512755064, 4, DynamicHMC.DoubledTurn, 0.9899895261771225, 15), NUTS_Transition{Array{Float64,1},Float64}([0.6124331201800133, 0.3281860990077927, -0.6091096460135681, -0.17508294001826252, 0.11019385659200531, 0.3959685366445357, -0.09527662851239592, -0.6906302363882252, -0.2567819016525875, -0.45468322214625134, 0.31555110129364994, -0.26641582915321615, -0.7608600909891381], -49.36100984507441, 4, DynamicHMC.DoubledTurn, 0.9154970562443494, 15), NUTS_Transition{Array{Float64,1},Float64}([1.4357327482287257, 0.2120868793421157, -0.2351050992504285, 0.30599626262031415, 0.044257229372803596, 0.47790467078644366, -0.11655777524490879, -0.0976973054073465, 0.23855523729262873, -0.18083214900091174, 0.10515149533228257, 0.022681901205245873, -1.343949284398047], -50.747425429773244, 4, DynamicHMC.DoubledTurn, 0.6818333839967752, 15), NUTS_Transition{Array{Float64,1},Float64}([0.6730900233300695, 0.3099665795894858, -0.04900751543407873, -0.20352460294634142, -0.020144114614665372, 0.19827433317644041, 0.10108797601187505, -0.4882951372151859, 0.07332242002979077, -0.07999943027965055, 0.3781719357951591, -0.18127955974895538, -1.5136587271505273], -41.49352791679804, 4, DynamicHMC.DoubledTurn, 0.9899161966653304, 15), NUTS_Transition{Array{Float64,1},Float64}([0.9609154118797201, 0.2690821054389596, 0.07897703323950002, -0.02361235224066424, -0.08118719795092671, 0.2650595390184718, 0.0653790986504092, -0.4240594166572966, 0.0007689799043017892, -0.0693310546789587, 0.6095099082842745, 0.01968053298088991, -1.3801421807486887], -45.6454369918032, 4, DynamicHMC.DoubledTurn, 0.8827699539382061, 15), NUTS_Transition{Array{Float64,1},Float64}([0.79457954554345, 0.2944823393571877, -0.11519414692632873, -0.106430857105264, -0.2488261810677777, 0.13570925957121682, -0.02988765732636243, -0.5991683404578432, 0.04886644812849612, 0.054834834797648384, 0.5040939634586684, -0.0008799367412639595, -1.1077101903331708], -47.859526203791994, 4, DynamicHMC.DoubledTurn, 0.7153501412662353, 15)], NUTS sampler in 13 dimensions
  stepsize (ϵ) ≈ 0.283
  maximum depth = 10
  Gaussian kinetic energy, √diag(M⁻¹): [0.8263362617570859, 0.09120453799191745, 0.2631635353282589, 0.22433320605145932, 0.1936230704740698, 0.19302782531671406, 0.17070280145227038, 0.20281272599282493, 0.1706129831046443, 0.17276871971624352, 0.18933895454177962, 0.30495204460067654, 0.38950711306862457]
)</code></pre><p>We use the transformation to obtain the posterior from the chain.</p><pre><code class="language-julia">posterior = TransformVariables.transform.(Ref(problem_transformation(p)), get_position.(chain));
posterior[1:5]</code></pre><pre><code class="language-none">5-element Array{NamedTuple{(:β, :α, :σ),Tuple{Array{Float64,1},Array{Float64,1},Float64}},1}:
 (β = [2.075635609801923, 0.16460706706725303], α = [-0.6568046599534312, -0.18442166549923106, -0.17796602690169974, 0.12256339611430397, 0.011688376374027629, -0.12510967020147504, 0.06138692177798156, -0.4555220167961287, 0.07415597066736729, -0.006345304984051919], σ = 0.24565024426001147)
 (β = [0.29743535271565624, 0.3100612922956974], α = [0.33201209259105385, 0.31590233140726054, 0.3622592053721623, 0.705755112989208, 0.1675548114599119, -0.6043771972136694, 0.2928060034939825, 0.16607424825188843, 0.598077977132243, 0.05314281714507706], σ = 0.41864605302287355)            
 (β = [-0.2438779808037832, 0.3510756887571428], α = [0.20402707795704034, 0.7921190911589258, 0.2673881182448562, 0.9509326315066225, 0.3284395158190936, -0.32017346113975714, 0.5535807160575051, 0.1633858741088622, 0.8614426956979911, 0.06941071833321077], σ = 0.5632806573200185)            
 (β = [1.8860596853878249, 0.15560136991746096], α = [-0.16194074594315122, 0.1343217473689179, 0.12065651157786886, 0.46577301297274115, 0.2566055488150256, -0.33421506852361554, 0.2826803419884365, 0.10819500924853807, 0.5024813531487595, 0.3957295824450697], σ = 0.350955394205467)          
 (β = [0.421277759495236, 0.33816891035967794], α = [-0.6285652297839837, 0.29624009731080303, -0.15754666397488862, 0.3201744503928135, 0.12663697668379498, -0.3732251164204107, 0.3425260311028894, -0.19182217821193082, 0.3260920078845044, -0.41649348253915736], σ = 0.37490105083092984)      </code></pre><p>Extract the parameter posterior means.</p><pre><code class="language-julia">posterior_β = mean(posterior[i].β for i in 1:length(posterior))
posterior_α = mean(posterior[i].α for i in 1:length(posterior))
posterior_σ = mean(posterior[i].σ for i in 1:length(posterior))</code></pre><pre><code class="language-none">0.3030471381235758</code></pre><p>Effective sample sizes (of untransformed draws)</p><pre><code class="language-julia">ess = mapslices(effective_sample_size, get_position_matrix(chain); dims = 1)
ess</code></pre><pre><code class="language-none">1×13 Array{Float64,2}:
 951.152  1000.0  1000.0  1000.0  …  821.513  162.971  333.69  449.393</code></pre><p>NUTS-specific statistics</p><pre><code class="language-julia">NUTS_statistics(chain)</code></pre><pre><code class="language-none">Hamiltonian Monte Carlo sample of length 1000
  acceptance rate mean: 0.89, min/25%/median/75%/max: 0.21 0.85 0.94 0.98 1.0
  termination: AdjacentDivergent =&gt; 0% AdjacentTurn =&gt; 9% DoubledTurn =&gt; 91%
  depth: 2 =&gt; 0% 3 =&gt; 17% 4 =&gt; 82%
</code></pre><p>CmdStan result</p><pre><code class="language-julia">m_12_6_result = &quot;
Iterations = 1:1000
Thinning interval = 1
Chains = 1,2,3,4
Samples per chain = 1000

Empirical Posterior Estimates:
                            Mean                SD               Naive SE             MCSE            ESS
            a          1.076167468  0.7704872560 0.01218247319 0.0210530022 1000.000000
           bp         0.263056273  0.0823415805 0.00130193470 0.0022645077 1000.000000
  a_society.1   -0.191723568  0.2421382537 0.00382854195 0.0060563054 1000.000000
  a_society.2    0.054569029  0.2278506876 0.00360263570 0.0051693148 1000.000000
  a_society.3   -0.035935050  0.1926364647 0.00304584994 0.0039948433 1000.000000
  a_society.4    0.334355037  0.1929971201 0.00305155241 0.0063871707  913.029080
  a_society.5    0.049747513  0.1801287716 0.00284808595 0.0043631095 1000.000000
  a_society.6   -0.311903245  0.2096126337 0.00331426674 0.0053000536 1000.000000
  a_society.7    0.148637507  0.1744680594 0.00275858223 0.0047660246 1000.000000
  a_society.8   -0.164567976  0.1821341074 0.00287979309 0.0034297298 1000.000000
  a_society.9    0.277066965  0.1758237250 0.00278001719 0.0055844175  991.286501
 a_society.10   -0.094149204  0.2846206232 0.00450024719 0.0080735022 1000.000000
sigma_society    0.310352849  0.1374834682 0.00217380450 0.0057325226  575.187461
&quot;;</code></pre><pre><code class="language-none">&quot;\nIterations = 1:1000\nThinning interval = 1\nChains = 1,2,3,4\nSamples per chain = 1000\n\nEmpirical Posterior Estimates:\n                            Mean                SD               Naive SE             MCSE            ESS\n            a          1.076167468  0.7704872560 0.01218247319 0.0210530022 1000.000000\n           bp         0.263056273  0.0823415805 0.00130193470 0.0022645077 1000.000000\n  a_society.1   -0.191723568  0.2421382537 0.00382854195 0.0060563054 1000.000000\n  a_society.2    0.054569029  0.2278506876 0.00360263570 0.0051693148 1000.000000\n  a_society.3   -0.035935050  0.1926364647 0.00304584994 0.0039948433 1000.000000\n  a_society.4    0.334355037  0.1929971201 0.00305155241 0.0063871707  913.029080\n  a_society.5    0.049747513  0.1801287716 0.00284808595 0.0043631095 1000.000000\n  a_society.6   -0.311903245  0.2096126337 0.00331426674 0.0053000536 1000.000000\n  a_society.7    0.148637507  0.1744680594 0.00275858223 0.0047660246 1000.000000\n  a_society.8   -0.164567976  0.1821341074 0.00287979309 0.0034297298 1000.000000\n  a_society.9    0.277066965  0.1758237250 0.00278001719 0.0055844175  991.286501\n a_society.10   -0.094149204  0.2846206232 0.00450024719 0.0080735022 1000.000000\nsigma_society    0.310352849  0.1374834682 0.00217380450 0.0057325226  575.187461\n&quot;</code></pre><p>Show means</p><pre><code class="language-julia">[posterior_β, posterior_α, [posterior_σ]]</code></pre><pre><code class="language-none">3-element Array{Array{Float64,1},1}:
 [1.1221706719175442, 0.25883408316695067]                                                                                                                                                                             
 [-0.20007594376573748, 0.039371648143001044, -0.046605137907435173, 0.3294215335797423, 0.04368571241478844, -0.3139628762573653, 0.13921621033953127, -0.1698482272566506, 0.27181821820704194, -0.08581296861962079]
 [0.3030471381235758]                                                                                                                                                                                                  </code></pre><p>End of m12.6d.jl</p><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p><footer><hr/><a class="previous" href="../../10/m10.04d2/"><span class="direction">Previous</span><span class="title">m10.04d2</span></a><a class="next" href="../m12.6d1/"><span class="direction">Next</span><span class="title">m12.6d1</span></a></footer></article></body></html>
