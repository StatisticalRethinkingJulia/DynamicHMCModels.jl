<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>m12.6d · DynamicHMCModels.jl</title><link href="https://cdnjs.cloudflare.com/ajax/libs/normalize/4.2.0/normalize.min.css" rel="stylesheet" type="text/css"/><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.2.0/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link href="../../assets/documenter.css" rel="stylesheet" type="text/css"/></head><body><nav class="toc"><h1>DynamicHMCModels.jl</h1><select id="version-selector" onChange="window.location.href=this.value" style="visibility: hidden"></select><form class="search" id="search-form" action="../../search/"><input id="search-query" name="q" type="text" placeholder="Search docs"/></form><ul><li><a class="toctext" href="../../intro/">Home</a></li><li><span class="toctext">Chapter 02</span><ul><li><a class="toctext" href="../../02/m2.1d/">m2.1d</a></li></ul></li><li><span class="toctext">Chapter 04</span><ul><li><a class="toctext" href="../../04/m4.1d/">m4.1d</a></li><li><a class="toctext" href="../../04/m4.2d/">m4.2d</a></li><li><a class="toctext" href="../../04/m4.5d/">m4.5d</a></li></ul></li><li><span class="toctext">Chapter 05</span><ul><li><a class="toctext" href="../../05/m5.1d/">m5.1d</a></li><li><a class="toctext" href="../../05/m5.1d1/">m5.1d1</a></li><li><a class="toctext" href="../../05/m5.3d/">m5.3d</a></li><li><a class="toctext" href="../../05/m5.6d/">m5.6d</a></li></ul></li><li><span class="toctext">Chapter 08</span><ul><li><a class="toctext" href="../../08/m8.1d/">m8.1d</a></li></ul></li><li><span class="toctext">Chapter 10</span><ul><li><a class="toctext" href="../../10/m10.02d/">m10.02d</a></li><li><a class="toctext" href="../../10/m10.02d1/">m10.02d1</a></li><li><a class="toctext" href="../../10/m10.04d/">m10.04d</a></li><li><a class="toctext" href="../../10/m10.04d1/">m10.04d1</a></li><li><a class="toctext" href="../../10/m10.04d2/">m10.04d2</a></li></ul></li><li><span class="toctext">Chapter 12</span><ul><li class="current"><a class="toctext" href>m12.6d</a><ul class="internal"></ul></li><li><a class="toctext" href="../m12.6d1/">m12.6d1</a></li><li><a class="toctext" href="../m12.6d2/">m12.6d2</a></li></ul></li><li><a class="toctext" href="../../">Functions</a></li></ul></nav><article id="docs"><header><nav><ul><li>Chapter 12</li><li><a href>m12.6d</a></li></ul><a class="edit-page" href="https://github.com/StatisticalRethinkingJulia/DynamicHMCModels.jl/blob/master/scripts/12/m12.6d.jl"><span class="fa"></span> Edit on GitHub</a></nav><hr/><div id="topbar"><span>m12.6d</span><a class="fa fa-bars" href="#"></a></div></header><pre><code class="language-julia">using DynamicHMCModels

ProjDir = rel_path_d(&quot;..&quot;, &quot;scripts&quot;, &quot;12&quot;)

df = CSV.read(rel_path( &quot;..&quot;, &quot;data&quot;,  &quot;Kline.csv&quot;), delim=&#39;;&#39;);
size(df) # Should be 10x5</code></pre><pre><code class="language-none">(10, 5)</code></pre><p>New col logpop, set log() for population data</p><pre><code class="language-julia">df[:logpop] = map((x) -&gt; log(x), df[:population]);
df[:society] = 1:10;

first(df[[:total_tools, :logpop, :society]], 5)

struct m_12_06d_model{TY &lt;: AbstractVector, TX &lt;: AbstractMatrix,
  TS &lt;: AbstractVector}
    &quot;Observations (total_tools).&quot;
    y::TY
    &quot;Covariates (logpop)&quot;
    X::TX
    &quot;Society&quot;
    S::TS
    &quot;Number of observations (10)&quot;
    N::Int
    &quot;Number of societies (also 10)&quot;
    N_societies::Int
end</code></pre><p>Make the type callable with the parameters <em>as a single argument</em>.</p><pre><code class="language-julia">function (problem::m_12_06d_model)(θ)
    @unpack y, X, S, N, N_societies = problem   # extract the data
    @unpack β, α, σ = θ  # β : a, bp, α : a_society
    ll = 0.0
    ll += logpdf(Cauchy(0, 1), σ)
    ll += sum(logpdf.(Normal(0, σ), α)) # α[1:10]
    ll += logpdf.(Normal(0, 10), β[1]) # a
    ll += logpdf.(Normal(0, 1), β[2]) # a
    ll += sum(
      [loglikelihood(Poisson(exp(α[S[i]] + dot(X[i, :], β))), [y[i]]) for i in 1:N]
    )
    ll
end</code></pre><p>Instantiate the model with data and inits.</p><pre><code class="language-julia">N = size(df, 1)
N_societies = length(unique(df[:society]))
X = hcat(ones(Int64, N), df[:logpop]);
S = df[:society]
y = df[:total_tools]
p = m_12_06d_model(y, X, S, N, N_societies);
θ = (β = [1.0, 0.25], α = rand(Normal(0, 1), N_societies), σ = 0.2)
p(θ)</code></pre><pre><code class="language-none">-213.7187886372878</code></pre><p>Write a function to return properly dimensioned transformation.</p><pre><code class="language-julia">problem_transformation(p::m_12_06d_model) =
    as( (β = as(Array, size(p.X, 2)), α = as(Array, p.N_societies), σ = asℝ₊) )</code></pre><p>Wrap the problem with a transformation, then use Flux for the gradient.</p><pre><code class="language-julia">P = TransformedLogDensity(problem_transformation(p), p)
∇P = LogDensityRejectErrors(ADgradient(:ForwardDiff, P));
#∇P = ADgradient(:ForwardDiff, P);</code></pre><p>Tune and sample.</p><pre><code class="language-julia">chain, NUTS_tuned = NUTS_init_tune_mcmc(∇P, 1000);</code></pre><pre><code class="language-none">(NUTS_Transition{Array{Float64,1},Float64}[NUTS_Transition{Array{Float64,1},Float64}([1.4351411710091906, 0.22864028862722474, 0.025664068609720654, 0.11429744901527056, 0.006975546139571895, 0.347175386034651, 0.13386098628113946, -0.13414933356251427, 0.11063077868090496, -0.2343533667689914, 0.16269213088589868, -0.02629555876265867, -1.6577109837577557], -40.78216285788697, 4, DynamicHMC.DoubledTurn, 0.9797284405626331, 15), NUTS_Transition{Array{Float64,1},Float64}([0.6859433047698953, 0.3031128961416872, -0.04082642057408899, 0.08918558147675357, 0.018238464512509593, 0.07870719621215512, 0.029857210774472596, -0.12565927668363575, 0.10918198554473826, -0.012151673319205511, 0.19079366702103148, -0.08234535083495395, -2.150999355082562], -42.41285907161413, 4, DynamicHMC.DoubledTurn, 0.9054280095303339, 15), NUTS_Transition{Array{Float64,1},Float64}([1.0145564760888057, 0.2645092706162956, -0.007132765517366857, -0.1632518469311004, -0.08511159996051867, 0.007862802904569727, 0.06992802510141984, 0.006286427592077469, 0.15311066318544808, -0.18752328420918896, 0.25507269163093654, -0.06596745345027416, -2.006440901689922], -41.77240354782372, 3, DynamicHMC.DoubledTurn, 0.751610987212942, 7), NUTS_Transition{Array{Float64,1},Float64}([0.712259582197649, 0.304487669273926, -0.06441912082175591, -0.11759229175884192, 0.07681673957675333, 0.001291965501205348, -0.06842286970996483, -0.11126290294655247, 0.0045383317822688535, -0.1296610829482825, 0.21773500985481328, -0.1726441837153465, -1.7623249186255452], -46.225285606120096, 4, DynamicHMC.DoubledTurn, 0.8569224593802651, 15), NUTS_Transition{Array{Float64,1},Float64}([1.620230965809149, 0.20878924697463624, -0.3799840913756628, 0.1181208470824957, -0.3806853221735947, 0.6001574292263833, 0.058216818883087246, -0.677743749074208, 0.22858209965365192, -0.23730297964306485, 0.25744799336192475, -0.14569204655003837, -0.6358892212219729], -46.015374015634684, 4, DynamicHMC.DoubledTurn, 0.8151675500408028, 15), NUTS_Transition{Array{Float64,1},Float64}([0.5242971047595996, 0.3080884125158602, -0.10588290805779113, 0.010446814462557224, 0.21971132238943097, 0.12125852709361896, 0.11408669803322377, 0.011048330259619848, 0.12922838604508755, -0.0029162071647147875, 0.30619516492321025, -0.05875144391280958, -1.9285547379440895], -46.11572814014353, 4, DynamicHMC.DoubledTurn, 0.9217787866930529, 15), NUTS_Transition{Array{Float64,1},Float64}([1.0874678610788555, 0.25943546671323153, -0.2874418454446183, 0.11349525127130382, 0.1321339474148636, 0.10217482044309424, 0.0705639190555237, -0.2190735565249537, 0.23953983532188447, -0.04057998918489199, 0.01126534533863302, 0.01014724238214734, -1.6551989139125995], -44.77445505560787, 4, DynamicHMC.DoubledTurn, 0.9524650769136618, 15), NUTS_Transition{Array{Float64,1},Float64}([0.921553322262838, 0.2832177704869166, -0.2720569690163271, 0.024184535546444855, -0.18627120266720462, 0.6326800587322619, -0.0226317220726324, -0.5165600708635201, 0.07492609258283861, -0.22151243719949296, 0.5387374508359488, -0.15234332185206612, -1.0362660750631936], -44.48000757250856, 4, DynamicHMC.DoubledTurn, 0.9084793109173709, 15), NUTS_Transition{Array{Float64,1},Float64}([1.9251924983112498, 0.18076211090456323, -0.18702786775953742, -0.1587998686042113, -0.14550893788825145, 0.19984563118903265, 0.021685691247238126, -0.13374453335472147, -0.05528662854957934, -0.12587235779868594, 0.2837379639042932, 0.2518914488854278, -1.7978482039331396], -44.95218970538653, 3, DynamicHMC.AdjacentTurn, 0.9482573479701205, 15), NUTS_Transition{Array{Float64,1},Float64}([0.786706758912039, 0.3120034252245281, 0.0007503227256633396, -0.14554260707888747, 0.014596411982769342, 0.1984319601559185, 0.20760750783820753, -0.5635367794864401, 0.2695578478904948, -0.3003739690956932, 0.15388076279637197, -0.6183182214821505, -1.4558930760628137], -51.95405686115609, 4, DynamicHMC.DoubledTurn, 0.9176627204449567, 15)  …  NUTS_Transition{Array{Float64,1},Float64}([1.1799477110796248, 0.22608585672080073, -0.07472934921268315, 0.16660096986452205, 0.16088017106479657, 0.3498581977713556, 0.16540867628123973, -0.205199892975214, 0.8087429417856175, -0.6161860962587841, 0.4683258198107518, 0.29761295498825135, -0.5914138058904802], -54.22532535756564, 4, DynamicHMC.DoubledTurn, 0.9117869586536339, 15), NUTS_Transition{Array{Float64,1},Float64}([2.6800911696478185, 0.07511004336220287, -0.5030312077695587, 0.2652967862643837, -0.261083912869025, 0.12760012092994766, -0.005953773028214593, -0.40899466911683513, 0.3207537349933699, -0.6380175700104217, 0.44493822237506236, 0.7806546410351156, -0.7629581813351054], -57.03133241461515, 4, DynamicHMC.DoubledTurn, 0.9978980846535263, 15), NUTS_Transition{Array{Float64,1},Float64}([0.28879354875669483, 0.34950650060762134, -0.1993478710583481, -0.045828066271798314, -0.3182269301934325, 0.2565592441055337, -0.0015673034579592703, -0.45730191909824436, 0.16024190127180243, -0.14340211146126497, 0.3862188445223077, -0.26579826058670597, -1.3517668816061514], -55.564707435429995, 4, DynamicHMC.DoubledTurn, 0.9260075228902878, 15), NUTS_Transition{Array{Float64,1},Float64}([1.8322589422789075, 0.18560945132116874, -0.3608533766127434, 0.030755825263404375, 0.18928435453557235, 0.37899416508372563, -0.0719177783381277, -0.18238397690580013, 0.16744486214115226, -0.19670387024844438, 0.10755311599325175, 0.10133824198975813, -1.3192663543854477], -44.368496262585026, 4, DynamicHMC.DoubledTurn, 0.905189115307648, 15), NUTS_Transition{Array{Float64,1},Float64}([1.0912411451878774, 0.2572033033511016, -0.0018630611691611491, 0.2187227855067823, -0.004978286124250872, 0.38669442342785426, 0.005672585435503905, -0.16858075525338162, 0.3009869534074936, 0.14395364088426832, 0.07984220418062739, -0.036545911510556875, -1.7431522622443727], -43.26836818448238, 4, DynamicHMC.DoubledTurn, 0.9870086968731774, 15), NUTS_Transition{Array{Float64,1},Float64}([0.7939119465034582, 0.2824824104505184, -0.008288943949309872, 0.28070224365099306, 0.04571544153525421, 0.4902183369775806, 0.018360322406049658, -0.21445628536698097, 0.31330213242760424, 0.1428692790140055, 0.10248818461110097, -0.12245149995623701, -1.6058398224205415], -43.16609724894194, 4, DynamicHMC.DoubledTurn, 0.9607795088732495, 15), NUTS_Transition{Array{Float64,1},Float64}([1.7671924193233766, 0.20684052462479569, -0.15866883253962388, -0.07980594506764285, -0.22171192614175775, 0.23499419235460475, -0.010007414149948973, -0.5442979626670185, 0.03740913279966945, -0.42173481323946255, 0.547374652034687, -0.09479844247312055, -0.9363311345244205], -46.65034696935834, 4, DynamicHMC.DoubledTurn, 0.8643411629513599, 15), NUTS_Transition{Array{Float64,1},Float64}([0.5994461558463584, 0.3105838895724265, -0.07395900815714536, -0.0747963573513865, 0.14653211873961797, 0.4832815749961434, 0.27722632230629196, -0.3164873034456954, 0.07326376279183035, -0.12105938533934699, 0.24090547976188784, -0.3314899589906142, -1.5564715116560213], -44.8743835682091, 4, DynamicHMC.DoubledTurn, 0.9761638847461803, 15), NUTS_Transition{Array{Float64,1},Float64}([2.193546274372756, 0.14918537339223562, -0.28541533858936824, 0.15845238173401324, -0.5311370274305482, 0.2189902071200855, -0.10648556650180177, -0.35931134269205006, 0.09894329538071207, -0.1905722343094243, 0.3924503715363243, 0.20538758154708694, -1.0212649183338056], -48.167540488122334, 4, DynamicHMC.DoubledTurn, 0.7495474733771423, 15), NUTS_Transition{Array{Float64,1},Float64}([1.6505817244500225, 0.20424795223585154, -0.49572488871666864, 0.019790922654568395, -0.14871817256895442, 0.2827081501860034, -0.07084858583224622, -0.4357849537865801, 0.10775739493738505, -0.3879621694207189, 0.15963890305952938, 0.11352656879769416, -1.27193083972752], -45.715014982762085, 3, DynamicHMC.AdjacentTurn, 0.9852866627928947, 15)], NUTS sampler in 13 dimensions
  stepsize (ϵ) ≈ 0.242
  maximum depth = 10
  Gaussian kinetic energy, √diag(M⁻¹): [0.7499912447396726, 0.08396845627954913, 0.2451676304172939, 0.2215005413875045, 0.20599314178686218, 0.19002792031976007, 0.19501950796020676, 0.21469452877430895, 0.17385434274381092, 0.18145385715538215, 0.17588877190368502, 0.28354841642515205, 0.38208252059132514]
)</code></pre><p>We use the transformation to obtain the posterior from the chain.</p><pre><code class="language-julia">posterior = TransformVariables.transform.(Ref(problem_transformation(p)), get_position.(chain));
posterior[1:5]</code></pre><pre><code class="language-none">5-element Array{NamedTuple{(:β, :α, :σ),Tuple{Array{Float64,1},Array{Float64,1},Float64}},1}:
 (β = [1.4351411710091906, 0.22864028862722474], α = [0.025664068609720654, 0.11429744901527056, 0.006975546139571895, 0.347175386034651, 0.13386098628113946, -0.13414933356251427, 0.11063077868090496, -0.2343533667689914, 0.16269213088589868, -0.02629555876265867], σ = 0.19057470982120553)    
 (β = [0.6859433047698953, 0.3031128961416872], α = [-0.04082642057408899, 0.08918558147675357, 0.018238464512509593, 0.07870719621215512, 0.029857210774472596, -0.12565927668363575, 0.10918198554473826, -0.012151673319205511, 0.19079366702103148, -0.08234535083495395], σ = 0.11636780688599685)
 (β = [1.0145564760888057, 0.2645092706162956], α = [-0.007132765517366857, -0.1632518469311004, -0.08511159996051867, 0.007862802904569727, 0.06992802510141984, 0.006286427592077469, 0.15311066318544808, -0.18752328420918896, 0.25507269163093654, -0.06596745345027416], σ = 0.1344664031714522) 
 (β = [0.712259582197649, 0.304487669273926], α = [-0.06441912082175591, -0.11759229175884192, 0.07681673957675333, 0.001291965501205348, -0.06842286970996483, -0.11126290294655247, 0.0045383317822688535, -0.1296610829482825, 0.21773500985481328, -0.1726441837153465], σ = 0.1716453381270462)   
 (β = [1.620230965809149, 0.20878924697463624], α = [-0.3799840913756628, 0.1181208470824957, -0.3806853221735947, 0.6001574292263833, 0.058216818883087246, -0.677743749074208, 0.22858209965365192, -0.23730297964306485, 0.25744799336192475, -0.14569204655003837], σ = 0.5294644678867984)        </code></pre><p>Extract the parameter posterior means.</p><pre><code class="language-julia">posterior_β = mean(posterior[i].β for i in 1:length(posterior))
posterior_α = mean(posterior[i].α for i in 1:length(posterior))
posterior_σ = mean(posterior[i].σ for i in 1:length(posterior))</code></pre><pre><code class="language-none">0.3079070749233228</code></pre><p>Effective sample sizes (of untransformed draws)</p><pre><code class="language-julia">ess = mapslices(effective_sample_size, get_position_matrix(chain); dims = 1)
ess</code></pre><pre><code class="language-none">1×13 Array{Float64,2}:
 917.572  856.407  955.928  1000.0  …  850.656  939.882  631.985  335.554</code></pre><p>NUTS-specific statistics</p><pre><code class="language-julia">NUTS_statistics(chain)</code></pre><pre><code class="language-none">Hamiltonian Monte Carlo sample of length 1000
  acceptance rate mean: 0.92, min/25%/median/75%/max: 0.02 0.89 0.96 0.99 1.0
  termination: AdjacentTurn =&gt; 4% DoubledTurn =&gt; 96%
  depth: 3 =&gt; 7% 4 =&gt; 93%
</code></pre><p>CmdStan result</p><pre><code class="language-julia">m_12_6_result = &quot;
Iterations = 1:1000
Thinning interval = 1
Chains = 1,2,3,4
Samples per chain = 1000

Empirical Posterior Estimates:
                            Mean                SD               Naive SE             MCSE            ESS
            a          1.076167468  0.7704872560 0.01218247319 0.0210530022 1000.000000
           bp         0.263056273  0.0823415805 0.00130193470 0.0022645077 1000.000000
  a_society.1   -0.191723568  0.2421382537 0.00382854195 0.0060563054 1000.000000
  a_society.2    0.054569029  0.2278506876 0.00360263570 0.0051693148 1000.000000
  a_society.3   -0.035935050  0.1926364647 0.00304584994 0.0039948433 1000.000000
  a_society.4    0.334355037  0.1929971201 0.00305155241 0.0063871707  913.029080
  a_society.5    0.049747513  0.1801287716 0.00284808595 0.0043631095 1000.000000
  a_society.6   -0.311903245  0.2096126337 0.00331426674 0.0053000536 1000.000000
  a_society.7    0.148637507  0.1744680594 0.00275858223 0.0047660246 1000.000000
  a_society.8   -0.164567976  0.1821341074 0.00287979309 0.0034297298 1000.000000
  a_society.9    0.277066965  0.1758237250 0.00278001719 0.0055844175  991.286501
 a_society.10   -0.094149204  0.2846206232 0.00450024719 0.0080735022 1000.000000
sigma_society    0.310352849  0.1374834682 0.00217380450 0.0057325226  575.187461
&quot;;</code></pre><pre><code class="language-none">&quot;\nIterations = 1:1000\nThinning interval = 1\nChains = 1,2,3,4\nSamples per chain = 1000\n\nEmpirical Posterior Estimates:\n                            Mean                SD               Naive SE             MCSE            ESS\n            a          1.076167468  0.7704872560 0.01218247319 0.0210530022 1000.000000\n           bp         0.263056273  0.0823415805 0.00130193470 0.0022645077 1000.000000\n  a_society.1   -0.191723568  0.2421382537 0.00382854195 0.0060563054 1000.000000\n  a_society.2    0.054569029  0.2278506876 0.00360263570 0.0051693148 1000.000000\n  a_society.3   -0.035935050  0.1926364647 0.00304584994 0.0039948433 1000.000000\n  a_society.4    0.334355037  0.1929971201 0.00305155241 0.0063871707  913.029080\n  a_society.5    0.049747513  0.1801287716 0.00284808595 0.0043631095 1000.000000\n  a_society.6   -0.311903245  0.2096126337 0.00331426674 0.0053000536 1000.000000\n  a_society.7    0.148637507  0.1744680594 0.00275858223 0.0047660246 1000.000000\n  a_society.8   -0.164567976  0.1821341074 0.00287979309 0.0034297298 1000.000000\n  a_society.9    0.277066965  0.1758237250 0.00278001719 0.0055844175  991.286501\n a_society.10   -0.094149204  0.2846206232 0.00450024719 0.0080735022 1000.000000\nsigma_society    0.310352849  0.1374834682 0.00217380450 0.0057325226  575.187461\n&quot;</code></pre><p>Show means</p><pre><code class="language-julia">[posterior_β, posterior_α, [posterior_σ]]</code></pre><pre><code class="language-none">3-element Array{Array{Float64,1},1}:
 [1.0875316977739913, 0.2632100442411216]                                                                                                                                                                            
 [-0.21460548005015284, 0.039125026185500615, -0.05557941384802401, 0.319002794119848, 0.039690059420320785, -0.32333227882515375, 0.14322721612802397, -0.1834439941948172, 0.2680058679765229, -0.1056616530160465]
 [0.3079070749233228]                                                                                                                                                                                                </code></pre><p>End of m12.6d.jl</p><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p><footer><hr/><a class="previous" href="../../10/m10.04d2/"><span class="direction">Previous</span><span class="title">m10.04d2</span></a><a class="next" href="../m12.6d1/"><span class="direction">Next</span><span class="title">m12.6d1</span></a></footer></article></body></html>
