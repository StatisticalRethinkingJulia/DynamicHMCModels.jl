<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>m12.6d · DynamicHMCModels.jl</title><link href="https://cdnjs.cloudflare.com/ajax/libs/normalize/4.2.0/normalize.min.css" rel="stylesheet" type="text/css"/><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.2.0/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link href="../../assets/documenter.css" rel="stylesheet" type="text/css"/></head><body><nav class="toc"><h1>DynamicHMCModels.jl</h1><select id="version-selector" onChange="window.location.href=this.value" style="visibility: hidden"></select><form class="search" id="search-form" action="../../search/"><input id="search-query" name="q" type="text" placeholder="Search docs"/></form><ul><li><a class="toctext" href="../../intro/">Home</a></li><li><span class="toctext">Chapter 02</span><ul><li><a class="toctext" href="../../02/m2.1d/">m2.1d</a></li></ul></li><li><span class="toctext">Chapter 04</span><ul><li><a class="toctext" href="../../04/m4.1d/">m4.1d</a></li><li><a class="toctext" href="../../04/m4.2d/">m4.2d</a></li><li><a class="toctext" href="../../04/m4.5d/">m4.5d</a></li></ul></li><li><span class="toctext">Chapter 05</span><ul><li><a class="toctext" href="../../05/m5.1d/">m5.1d</a></li><li><a class="toctext" href="../../05/m5.1d1/">m5.1d1</a></li><li><a class="toctext" href="../../05/m5.3d/">m5.3d</a></li><li><a class="toctext" href="../../05/m5.6d/">m5.6d</a></li></ul></li><li><span class="toctext">Chapter 08</span><ul><li><a class="toctext" href="../../08/m8.1d/">m8.1d</a></li></ul></li><li><span class="toctext">Chapter 10</span><ul><li><a class="toctext" href="../../10/m10.02d/">m10.02d</a></li><li><a class="toctext" href="../../10/m10.02d1/">m10.02d1</a></li><li><a class="toctext" href="../../10/m10.04d/">m10.04d</a></li><li><a class="toctext" href="../../10/m10.04d1/">m10.04d1</a></li><li><a class="toctext" href="../../10/m10.04d2/">m10.04d2</a></li></ul></li><li><span class="toctext">Chapter 12</span><ul><li class="current"><a class="toctext" href>m12.6d</a><ul class="internal"></ul></li><li><a class="toctext" href="../m12.6d1/">m12.6d1</a></li><li><a class="toctext" href="../m12.6d2/">m12.6d2</a></li></ul></li><li><a class="toctext" href="../../">Functions</a></li></ul></nav><article id="docs"><header><nav><ul><li>Chapter 12</li><li><a href>m12.6d</a></li></ul><a class="edit-page" href="https://github.com/StatisticalRethinkingJulia/DynamicHMCModels.jl/blob/master/scripts/12/m12.6d.jl"><span class="fa"></span> Edit on GitHub</a></nav><hr/><div id="topbar"><span>m12.6d</span><a class="fa fa-bars" href="#"></a></div></header><pre><code class="language-julia">using DynamicHMCModels

ProjDir = rel_path_d(&quot;..&quot;, &quot;scripts&quot;, &quot;12&quot;)

df = CSV.read(rel_path( &quot;..&quot;, &quot;data&quot;,  &quot;Kline.csv&quot;), delim=&#39;;&#39;);
size(df) # Should be 10x5</code></pre><pre><code class="language-none">(10, 5)</code></pre><p>New col logpop, set log() for population data</p><pre><code class="language-julia">df[:logpop] = map((x) -&gt; log(x), df[:population]);
df[:society] = 1:10;

first(df[[:total_tools, :logpop, :society]], 5)

struct m_12_06d_model{TY &lt;: AbstractVector, TX &lt;: AbstractMatrix,
  TS &lt;: AbstractVector}
    &quot;Observations (total_tools).&quot;
    y::TY
    &quot;Covariates (logpop)&quot;
    X::TX
    &quot;Society&quot;
    S::TS
    &quot;Number of observations (10)&quot;
    N::Int
    &quot;Number of societies (also 10)&quot;
    N_societies::Int
end</code></pre><p>Make the type callable with the parameters <em>as a single argument</em>.</p><pre><code class="language-julia">function (problem::m_12_06d_model)(θ)
    @unpack y, X, S, N, N_societies = problem   # extract the data
    @unpack β, α, σ = θ  # β : a, bp, α : a_society
    ll = 0.0
    ll += logpdf(Cauchy(0, 1), σ)
    ll += sum(logpdf.(Normal(0, σ), α)) # α[1:10]
    ll += logpdf.(Normal(0, 10), β[1]) # a
    ll += logpdf.(Normal(0, 1), β[2]) # a
    ll += sum(
      [loglikelihood(Poisson(exp(α[S[i]] + dot(X[i, :], β))), [y[i]]) for i in 1:N]
    )
    ll
end</code></pre><p>Instantiate the model with data and inits.</p><pre><code class="language-julia">N = size(df, 1)
N_societies = length(unique(df[:society]))
X = hcat(ones(Int64, N), df[:logpop]);
S = df[:society]
y = df[:total_tools]
p = m_12_06d_model(y, X, S, N, N_societies);
θ = (β = [1.0, 0.25], α = rand(Normal(0, 1), N_societies), σ = 0.2)
p(θ)</code></pre><pre><code class="language-none">-327.7289297324837</code></pre><p>Write a function to return properly dimensioned transformation.</p><pre><code class="language-julia">problem_transformation(p::m_12_06d_model) =
    as( (β = as(Array, size(p.X, 2)), α = as(Array, p.N_societies), σ = asℝ₊) )</code></pre><p>Wrap the problem with a transformation, then use Flux for the gradient.</p><pre><code class="language-julia">P = TransformedLogDensity(problem_transformation(p), p)
∇P = LogDensityRejectErrors(ADgradient(:ForwardDiff, P));
#∇P = ADgradient(:ForwardDiff, P);</code></pre><p>Tune and sample.</p><pre><code class="language-julia">chain, NUTS_tuned = NUTS_init_tune_mcmc(∇P, 1000);</code></pre><pre><code class="language-none">(NUTS_Transition{Array{Float64,1},Float64}[NUTS_Transition{Array{Float64,1},Float64}([0.67900299645377, 0.32110061430618553, -0.49465914168304387, -0.23267300163451352, -0.11209568875567907, 0.19162492513564783, -0.13394096539366204, -0.5572340847670353, -0.05153225443319397, -0.2775580221452842, 0.27724428618894664, -0.4676310768588639, -1.0771491800863822], -43.45467042066382, 4, DynamicHMC.DoubledTurn, 0.9755193227391595, 15), NUTS_Transition{Array{Float64,1},Float64}([1.2435872317389667, 0.2363565208959047, -0.3062472617897489, 0.35333635209118786, -0.1593481613734234, 0.4012394603203651, 0.1259313455632607, -0.07683280692583945, 0.26734714732346865, -0.010470837885239882, 0.1494924297146224, 0.30867584797448083, -1.4457099362489656], -46.52078307987604, 4, DynamicHMC.DoubledTurn, 0.9616881006292698, 15), NUTS_Transition{Array{Float64,1},Float64}([1.154024247428633, 0.2640573788675426, -0.07149707069590519, -0.055661319489566013, 0.06284309622854978, 0.07168475062117169, -0.21877988418651087, -0.11803237878986268, 0.08855196654585237, -0.15068692089496502, 0.21153625361587727, -0.13203317324097086, -1.491036944493676], -46.88973718962689, 4, DynamicHMC.DoubledTurn, 0.998559247208789, 15), NUTS_Transition{Array{Float64,1},Float64}([0.8441258087660751, 0.2850783770027077, -0.3946984083396924, 0.085217510071858, -0.3504905926056929, 0.6731881182111212, 0.25445456547334444, -0.3864763254652531, 0.32576419392361494, -0.17889199302557207, 0.2437468236801026, -0.35557035628816436, -0.8747054638036574], -47.186830760068204, 4, DynamicHMC.DoubledTurn, 0.7081325348926755, 15), NUTS_Transition{Array{Float64,1},Float64}([0.1473048218590742, 0.3627222508742899, 0.19093122029987264, 0.28017920635238736, -0.027824425375151965, 0.2700366166360049, 0.05550721009404446, -0.21528152079107318, 0.1921207724715517, -0.3602163335709808, 0.3737470303480532, -0.2593224788114469, -1.2980921429697398], -45.279689707144655, 4, DynamicHMC.DoubledTurn, 0.9805435959582219, 15), NUTS_Transition{Array{Float64,1},Float64}([1.1881208918315087, 0.24918600672753738, -0.23081800270057862, -0.01368906337222768, -0.044074553824569186, 0.2864437640771331, -0.03975176814949748, -0.2755036271382929, 0.138294320111718, -0.37311011041041, 0.41677407734485666, 0.046104585296811815, -0.9329599501147894], -45.58190078312346, 4, DynamicHMC.DoubledTurn, 0.6017333152708427, 15), NUTS_Transition{Array{Float64,1},Float64}([1.2399992415958843, 0.24140478133233292, -0.21838052235625943, 0.046173234998511434, 0.015502851817839454, 0.24669076368613618, -0.0458364646833491, -0.30530565005024446, 0.1530691273507427, -0.3747877493662332, 0.36291566691719024, 0.014984585720083137, -1.0944704217684953], -38.63937424102983, 3, DynamicHMC.AdjacentTurn, 0.9703813375648698, 15), NUTS_Transition{Array{Float64,1},Float64}([0.6042283080437303, 0.31152622263619917, -0.06956980571518899, 0.3235971371767719, 0.17339356955192045, 0.4990931282443726, 0.4472191897159833, -0.604860228101642, 0.019477120277044353, -0.470597542766968, 0.5087956474005332, -0.35932287266105917, -0.9381788004155037], -46.47503127887293, 4, DynamicHMC.DoubledTurn, 0.978244838231404, 15), NUTS_Transition{Array{Float64,1},Float64}([2.247327788136935, 0.14726347349776395, -0.22153648246850796, -0.29832717128257613, -0.19805984677604935, 0.16474563014418026, -0.12613876367942958, -0.4185371473708102, 0.24544621351090273, -0.2747138985451219, -0.02226546503862039, 0.20146211501677622, -1.6092476720532867], -48.030380814558995, 4, DynamicHMC.AdjacentTurn, 0.9988249087548885, 31), NUTS_Transition{Array{Float64,1},Float64}([0.15707411372887398, 0.3691840544839644, -0.13409979842289613, 0.23065269984342324, -0.13980437380712604, 0.3098513030959815, -0.05052197348318504, -0.3817596591921809, 0.00474019114843488, -0.2839931404927909, 0.1687823195318805, -0.40587652130545937, -0.8384112924566556], -42.54039117351264, 4, DynamicHMC.DoubledTurn, 1.0, 15)  …  NUTS_Transition{Array{Float64,1},Float64}([1.505825436259185, 0.21073659274027454, 0.10350385864771415, 0.1960879185897574, -0.1262888879720115, 0.2697871803381865, 0.42008126181273975, -0.09477689798388159, 0.06641775148492303, -0.4685229892436924, 0.4537021500820041, 0.15464539869072064, -1.3631718898157434], -51.838697627512836, 4, DynamicHMC.DoubledTurn, 0.9878116431326098, 15), NUTS_Transition{Array{Float64,1},Float64}([1.6124105959701618, 0.20422273178953732, -0.34116918590133183, -0.06772762936266945, -0.13611993526987615, 0.511369637268152, 0.23641371369300873, -0.20001325386039623, 0.14696067415523828, -0.25857532344124184, 0.5588162126702962, 0.1912223074606968, -0.883193783150181], -47.14280433817624, 4, DynamicHMC.DoubledTurn, 0.895454149535046, 15), NUTS_Transition{Array{Float64,1},Float64}([0.32671932652279556, 0.3381798762481409, 0.07551870261274972, 0.2836489336069871, -0.004526035778407461, 0.4222692982129219, 0.5434516044996957, -0.010547104844488772, 0.14555307232820464, -0.02961272613536644, 0.3050838674950618, -0.08821226591846931, -1.4929243119166808], -46.112103221873525, 4, DynamicHMC.DoubledTurn, 0.9696171851288526, 15), NUTS_Transition{Array{Float64,1},Float64}([0.7436833468671397, 0.28175764135558545, -0.003825534043538678, 0.14547866880988253, -0.05935794626119582, 0.35957645630395896, 0.43729066936680494, -0.011308889014579764, 0.05484907221023159, -0.14614340041523627, 0.3073300760983805, -0.0045459518477141, -1.7051683596921043], -47.46207420627619, 4, DynamicHMC.DoubledTurn, 0.9995380881355802, 15), NUTS_Transition{Array{Float64,1},Float64}([2.106750282186641, 0.16024813154889495, -0.5123201155220523, -0.19661479864365444, -0.06338134055021348, 0.1985309727880428, -0.11205410278503417, -0.5481042206326187, 0.22003544907340294, -0.050938540335596805, 0.3687130419931728, 0.18920885521300018, -0.8472416431448413], -42.47584793830067, 4, DynamicHMC.DoubledTurn, 1.0, 15), NUTS_Transition{Array{Float64,1},Float64}([2.759165693325515, 0.07574916433450263, -0.8911832995561875, 0.1851528403378759, -0.21829706468457374, 0.10563397682028165, -0.10112845293558094, -0.3735938941660977, 0.3033472038919255, -0.2953078627276188, 0.4382662049571623, 0.41868114912109217, -0.6661575319811296], -49.43880546990782, 3, DynamicHMC.AdjacentTurn, 0.648330254466268, 15), NUTS_Transition{Array{Float64,1},Float64}([0.4942527159349744, 0.34620542219830197, -0.1807588731075856, -0.26368347790798413, -0.23190214161225806, 0.15008445342395632, -0.23870013693931505, -0.8069564365176508, -0.27966711390317134, -0.5578349151288005, 0.1436117991783419, -0.4095657555808262, -0.8828433881069432], -53.76384193694779, 4, DynamicHMC.DoubledTurn, 0.9346617112029539, 15), NUTS_Transition{Array{Float64,1},Float64}([1.0510937674644265, 0.26572560412816326, -0.018606379223207715, 0.3873913704496173, -0.03036002347847023, 0.21598052280599633, 0.14140083695798267, -0.1941007722872476, 0.41886854685531233, -0.10669349627698356, 0.20066027198869993, -0.17137685785548668, -1.2856561402846771], -47.035037394402856, 4, DynamicHMC.DoubledTurn, 0.9154446250714552, 15), NUTS_Transition{Array{Float64,1},Float64}([1.2752213175098235, 0.22591355641466598, -0.23314750057179923, 0.4471499416007284, 0.23944862755715204, 0.4152167371018356, 0.23269021141009294, -0.4459834728167511, 0.4065040661080275, -0.12899708026222073, 0.46017922648988163, 0.14482015399650733, -1.1731237220477855], -47.13047535269243, 4, DynamicHMC.DoubledTurn, 0.9675205022513886, 15), NUTS_Transition{Array{Float64,1},Float64}([1.0695881707347141, 0.2817230425954598, -0.07627465313670218, -0.05688511866148886, -0.273622346430763, 0.14279492523712517, -0.13322000769761233, -0.4489608458243759, -0.028334250015418325, -0.38673565625335843, 0.07864892044430474, -0.20992663905142583, -1.0514463418311288], -42.205078399986405, 4, DynamicHMC.DoubledTurn, 0.9759771949781834, 15)], NUTS sampler in 13 dimensions
  stepsize (ϵ) ≈ 0.22
  maximum depth = 10
  Gaussian kinetic energy, √diag(M⁻¹): [0.796562739286428, 0.08759689197816276, 0.28166138688591097, 0.23406265031650136, 0.19004222493900821, 0.1864804109016391, 0.17029014239809434, 0.21147375738377358, 0.1957568512461986, 0.17327962241325842, 0.14964648992896346, 0.27336603012513205, 0.3819689545244543]
)</code></pre><p>We use the transformation to obtain the posterior from the chain.</p><pre><code class="language-julia">posterior = TransformVariables.transform.(Ref(problem_transformation(p)), get_position.(chain));
posterior[1:5]</code></pre><pre><code class="language-none">5-element Array{NamedTuple{(:β, :α, :σ),Tuple{Array{Float64,1},Array{Float64,1},Float64}},1}:
 (β = [0.67900299645377, 0.32110061430618553], α = [-0.49465914168304387, -0.23267300163451352, -0.11209568875567907, 0.19162492513564783, -0.13394096539366204, -0.5572340847670353, -0.05153225443319397, -0.2775580221452842, 0.27724428618894664, -0.4676310768588639], σ = 0.3405650326203066)   
 (β = [1.2435872317389667, 0.2363565208959047], α = [-0.3062472617897489, 0.35333635209118786, -0.1593481613734234, 0.4012394603203651, 0.1259313455632607, -0.07683280692583945, 0.26734714732346865, -0.010470837885239882, 0.1494924297146224, 0.30867584797448083], σ = 0.23557877126563714)      
 (β = [1.154024247428633, 0.2640573788675426], α = [-0.07149707069590519, -0.055661319489566013, 0.06284309622854978, 0.07168475062117169, -0.21877988418651087, -0.11803237878986268, 0.08855196654585237, -0.15068692089496502, 0.21153625361587727, -0.13203317324097086], σ = 0.22513907772979339)
 (β = [0.8441258087660751, 0.2850783770027077], α = [-0.3946984083396924, 0.085217510071858, -0.3504905926056929, 0.6731881182111212, 0.25445456547334444, -0.3864763254652531, 0.32576419392361494, -0.17889199302557207, 0.2437468236801026, -0.35557035628816436], σ = 0.4169848187156771)         
 (β = [0.1473048218590742, 0.3627222508742899], α = [0.19093122029987264, 0.28017920635238736, -0.027824425375151965, 0.2700366166360049, 0.05550721009404446, -0.21528152079107318, 0.1921207724715517, -0.3602163335709808, 0.3737470303480532, -0.2593224788114469], σ = 0.27305224104365333)      </code></pre><p>Extract the parameter posterior means.</p><pre><code class="language-julia">posterior_β = mean(posterior[i].β for i in 1:length(posterior))
posterior_α = mean(posterior[i].α for i in 1:length(posterior))
posterior_σ = mean(posterior[i].σ for i in 1:length(posterior))</code></pre><pre><code class="language-none">0.30560850505884635</code></pre><p>Effective sample sizes (of untransformed draws)</p><pre><code class="language-julia">ess = mapslices(effective_sample_size, get_position_matrix(chain); dims = 1)
ess</code></pre><pre><code class="language-none">1×13 Array{Float64,2}:
 993.283  998.025  1000.0  781.894  …  1000.0  620.99  863.369  286.793</code></pre><p>NUTS-specific statistics</p><pre><code class="language-julia">NUTS_statistics(chain)</code></pre><pre><code class="language-none">Hamiltonian Monte Carlo sample of length 1000
  acceptance rate mean: 0.94, min/25%/median/75%/max: 0.21 0.92 0.97 0.99 1.0
  termination: AdjacentTurn =&gt; 10% DoubledTurn =&gt; 90%
  depth: 2 =&gt; 0% 3 =&gt; 4% 4 =&gt; 93% 5 =&gt; 3%
</code></pre><p>CmdStan result</p><pre><code class="language-julia">m_12_6_result = &quot;
Iterations = 1:1000
Thinning interval = 1
Chains = 1,2,3,4
Samples per chain = 1000

Empirical Posterior Estimates:
                            Mean                SD               Naive SE             MCSE            ESS
            a          1.076167468  0.7704872560 0.01218247319 0.0210530022 1000.000000
           bp         0.263056273  0.0823415805 0.00130193470 0.0022645077 1000.000000
  a_society.1   -0.191723568  0.2421382537 0.00382854195 0.0060563054 1000.000000
  a_society.2    0.054569029  0.2278506876 0.00360263570 0.0051693148 1000.000000
  a_society.3   -0.035935050  0.1926364647 0.00304584994 0.0039948433 1000.000000
  a_society.4    0.334355037  0.1929971201 0.00305155241 0.0063871707  913.029080
  a_society.5    0.049747513  0.1801287716 0.00284808595 0.0043631095 1000.000000
  a_society.6   -0.311903245  0.2096126337 0.00331426674 0.0053000536 1000.000000
  a_society.7    0.148637507  0.1744680594 0.00275858223 0.0047660246 1000.000000
  a_society.8   -0.164567976  0.1821341074 0.00287979309 0.0034297298 1000.000000
  a_society.9    0.277066965  0.1758237250 0.00278001719 0.0055844175  991.286501
 a_society.10   -0.094149204  0.2846206232 0.00450024719 0.0080735022 1000.000000
sigma_society    0.310352849  0.1374834682 0.00217380450 0.0057325226  575.187461
&quot;;</code></pre><pre><code class="language-none">&quot;\nIterations = 1:1000\nThinning interval = 1\nChains = 1,2,3,4\nSamples per chain = 1000\n\nEmpirical Posterior Estimates:\n                            Mean                SD               Naive SE             MCSE            ESS\n            a          1.076167468  0.7704872560 0.01218247319 0.0210530022 1000.000000\n           bp         0.263056273  0.0823415805 0.00130193470 0.0022645077 1000.000000\n  a_society.1   -0.191723568  0.2421382537 0.00382854195 0.0060563054 1000.000000\n  a_society.2    0.054569029  0.2278506876 0.00360263570 0.0051693148 1000.000000\n  a_society.3   -0.035935050  0.1926364647 0.00304584994 0.0039948433 1000.000000\n  a_society.4    0.334355037  0.1929971201 0.00305155241 0.0063871707  913.029080\n  a_society.5    0.049747513  0.1801287716 0.00284808595 0.0043631095 1000.000000\n  a_society.6   -0.311903245  0.2096126337 0.00331426674 0.0053000536 1000.000000\n  a_society.7    0.148637507  0.1744680594 0.00275858223 0.0047660246 1000.000000\n  a_society.8   -0.164567976  0.1821341074 0.00287979309 0.0034297298 1000.000000\n  a_society.9    0.277066965  0.1758237250 0.00278001719 0.0055844175  991.286501\n a_society.10   -0.094149204  0.2846206232 0.00450024719 0.0080735022 1000.000000\nsigma_society    0.310352849  0.1374834682 0.00217380450 0.0057325226  575.187461\n&quot;</code></pre><p>Show means</p><pre><code class="language-julia">[posterior_β, posterior_α, [posterior_σ]]</code></pre><pre><code class="language-none">3-element Array{Array{Float64,1},1}:
 [1.0787361277972505, 0.26346167204139537]                                                                                                                                                                             
 [-0.19753789502398508, 0.051595503705418246, -0.04279693598153064, 0.3309649520604424, 0.04476092084914032, -0.31425511226964087, 0.14397649169741747, -0.16523757381667242, 0.2723881578422355, -0.10446587720336534]
 [0.30560850505884635]                                                                                                                                                                                                 </code></pre><p>End of m12.6d.jl</p><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p><footer><hr/><a class="previous" href="../../10/m10.04d2/"><span class="direction">Previous</span><span class="title">m10.04d2</span></a><a class="next" href="../m12.6d1/"><span class="direction">Next</span><span class="title">m12.6d1</span></a></footer></article></body></html>
