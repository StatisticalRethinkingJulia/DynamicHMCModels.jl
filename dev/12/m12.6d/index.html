<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>m12.6d · DynamicHMCModels.jl</title><link href="https://cdnjs.cloudflare.com/ajax/libs/normalize/4.2.0/normalize.min.css" rel="stylesheet" type="text/css"/><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.2.0/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link href="../../assets/documenter.css" rel="stylesheet" type="text/css"/></head><body><nav class="toc"><h1>DynamicHMCModels.jl</h1><select id="version-selector" onChange="window.location.href=this.value" style="visibility: hidden"></select><form class="search" id="search-form" action="../../search/"><input id="search-query" name="q" type="text" placeholder="Search docs"/></form><ul><li><a class="toctext" href="../../intro/">Home</a></li><li><span class="toctext">Chapter 02</span><ul><li><a class="toctext" href="../../02/m2.1d/">m2.1d</a></li></ul></li><li><span class="toctext">Chapter 04</span><ul><li><a class="toctext" href="../../04/m4.1d/">m4.1d</a></li><li><a class="toctext" href="../../04/m4.2d/">m4.2d</a></li><li><a class="toctext" href="../../04/m4.5d/">m4.5d</a></li></ul></li><li><span class="toctext">Chapter 05</span><ul><li><a class="toctext" href="../../05/m5.1d/">m5.1d</a></li><li><a class="toctext" href="../../05/m5.1d1/">m5.1d1</a></li><li><a class="toctext" href="../../05/m5.3d/">m5.3d</a></li><li><a class="toctext" href="../../05/m5.6d/">m5.6d</a></li></ul></li><li><span class="toctext">Chapter 08</span><ul><li><a class="toctext" href="../../08/m8.1d/">m8.1d</a></li></ul></li><li><span class="toctext">Chapter 10</span><ul><li><a class="toctext" href="../../10/m10.02d/">m10.02d</a></li><li><a class="toctext" href="../../10/m10.02d1/">m10.02d1</a></li><li><a class="toctext" href="../../10/m10.04d/">m10.04d</a></li><li><a class="toctext" href="../../10/m10.04d1/">m10.04d1</a></li></ul></li><li><span class="toctext">Chapter 12</span><ul><li class="current"><a class="toctext" href>m12.6d</a><ul class="internal"></ul></li><li><a class="toctext" href="../m12.6d1/">m12.6d1</a></li></ul></li><li><a class="toctext" href="../../">Functions</a></li></ul></nav><article id="docs"><header><nav><ul><li>Chapter 12</li><li><a href>m12.6d</a></li></ul><a class="edit-page" href="https://github.com/StatisticalRethinkingJulia/DynamicHMCModels.jl/blob/master/scripts/12/m12.6d.jl"><span class="fa"></span> Edit on GitHub</a></nav><hr/><div id="topbar"><span>m12.6d</span><a class="fa fa-bars" href="#"></a></div></header><div><pre><code class="language-julia">using DynamicHMCModels

ProjDir = rel_path_d(&quot;..&quot;, &quot;scripts&quot;, &quot;12&quot;)

df = CSV.read(rel_path( &quot;..&quot;, &quot;data&quot;,  &quot;Kline.csv&quot;), delim=&#39;;&#39;);
size(df) # Should be 10x5</code></pre><pre><code class="language-none">(10, 5)</code></pre></div><p>New col logpop, set log() for population data</p><div><pre><code class="language-julia">df[:logpop] = map((x) -&gt; log(x), df[:population]);
df[:society] = 1:10;

first(df[[:total_tools, :logpop, :society]], 5)

struct m_12_06d_model{TY &lt;: AbstractVector, TX &lt;: AbstractMatrix,
  TS &lt;: AbstractVector}
    &quot;Observations (total_tools).&quot;
    y::TY
    &quot;Covariates (logpop)&quot;
    X::TX
    &quot;Society&quot;
    S::TS
    &quot;Number of observations (10)&quot;
    N::Int
    &quot;Number of societies (also 10)&quot;
    N_societies::Int
end</code></pre></div><p>Make the type callable with the parameters <em>as a single argument</em>.</p><div><pre><code class="language-julia">function (problem::m_12_06d_model)(θ)
    @unpack y, X, S, N, N_societies = problem   # extract the data
    @unpack β, α, σ = θ  # β : a, bp, α : a_society
    ll = 0.0
    ll += logpdf(Cauchy(0, 1), σ)
    ll += sum(logpdf.(Normal(0, σ), α)) # α[1:10]
    ll += logpdf.(Normal(0, 10), β[1]) # a
    ll += logpdf.(Normal(0, 1), β[2]) # a
    ll += sum(
      [loglikelihood(Poisson(exp(α[S[i]] + dot(X[i, :], β))), [y[i]]) for i in 1:N]
    )
    ll
end</code></pre></div><p>Instantiate the model with data and inits.</p><div><pre><code class="language-julia">N = size(df, 1)
N_societies = length(unique(df[:society]))
X = hcat(ones(Int64, N), df[:logpop]);
S = df[:society]
y = df[:total_tools]
p = m_12_06d_model(y, X, S, N, N_societies);
θ = (β = [1.0, 0.25], α = rand(Normal(0, 1), N_societies), σ = 0.2)
p(θ)</code></pre><pre><code class="language-none">-185.88177613635256</code></pre></div><p>Write a function to return properly dimensioned transformation.</p><div><pre><code class="language-julia">problem_transformation(p::m_12_06d_model) =
    as( (β = as(Array, size(p.X, 2)), α = as(Array, p.N_societies), σ = asℝ₊) )</code></pre></div><p>Wrap the problem with a transformation, then use Flux for the gradient.</p><div><pre><code class="language-julia">P = TransformedLogDensity(problem_transformation(p), p)
∇P = LogDensityRejectErrors(ADgradient(:ForwardDiff, P));
#∇P = ADgradient(:ForwardDiff, P);</code></pre></div><p>Tune and sample.</p><div><pre><code class="language-julia">chain, NUTS_tuned = NUTS_init_tune_mcmc(∇P, 1000);</code></pre><pre><code class="language-none">MCMC, adapting ϵ (75 steps)
0.003 s/step ...done
MCMC, adapting ϵ (25 steps)
0.0035 s/step ...done
MCMC, adapting ϵ (50 steps)
0.003 s/step ...done
MCMC, adapting ϵ (100 steps)
0.0014 s/step ...done
MCMC, adapting ϵ (200 steps)
0.00094 s/step ...done
MCMC, adapting ϵ (400 steps)
0.00053 s/step ...done
MCMC, adapting ϵ (50 steps)
0.00067 s/step ...done
MCMC (1000 steps)
0.00044 s/step ...done
(NUTS_Transition{Array{Float64,1},Float64}[NUTS_Transition{Array{Float64,1},Float64}([1.5809324575846777, 0.2018433289779412, -0.14257109091119496, 0.0021615300899397952, -0.26950076243112087, 0.302967292404358, 0.14765149510436437, 0.06010907526353183, 0.3622772218601067, -0.05657512726836844, 0.31170634507097955, 0.13334743097643637, -1.1434990388176334], -42.21149985515399, 4, DynamicHMC.DoubledTurn, 0.9926988298679487, 15), NUTS_Transition{Array{Float64,1},Float64}([1.3590059842295954, 0.22392036456942505, -0.43988341051610214, 0.18315389487699368, 0.08890841203161105, 0.5561449131018978, 0.10070398083109774, -0.5524582318437976, 0.0005577928127834808, 0.13547379985265828, 0.5535919292049724, 0.08527524537717153, -1.2212630855102449], -47.45975053379314, 4, DynamicHMC.DoubledTurn, 0.8536922508823053, 15), NUTS_Transition{Array{Float64,1},Float64}([1.574359912132364, 0.20218963783700872, -0.49459480653959165, 0.1091853028677525, 0.0011933824781357044, 0.24450458679165413, 0.2463367825064623, -0.4171725065326856, 0.0010834653291227781, -0.08108756946976653, 0.5570752932867931, 0.14547691073695224, -1.3213730601597706], -44.63494169045184, 4, DynamicHMC.DoubledTurn, 1.0, 15), NUTS_Transition{Array{Float64,1},Float64}([0.6688665512449837, 0.3024535285446815, 0.2550003734243367, -0.1247343159725682, -0.060026116764849896, 0.6041715352133994, -0.1222062036925931, -0.037182936249841904, 0.24036959017050397, 0.026953161160829922, 0.12636240760707992, -0.11422283336934802, -1.2926878922519602], -45.24900835553229, 4, DynamicHMC.DoubledTurn, 0.9431179886456368, 15), NUTS_Transition{Array{Float64,1},Float64}([1.3695871641870954, 0.23204144352301148, -0.6783055272476496, 0.019366132462501504, -0.006379782930006557, 0.06640880185468462, 0.23261452176750794, -0.5958288908451855, 0.19048460150930374, -0.24496908245502813, 0.4982862573210401, 0.018067837882123985, -1.064187978663745], -47.80085439983164, 4, DynamicHMC.DoubledTurn, 0.965429923947651, 15), NUTS_Transition{Array{Float64,1},Float64}([1.6453919209163845, 0.22513649809150274, -0.6170671563115465, -0.2744091868537711, -0.6163029820605057, -0.03676372428007821, 0.03423367294210939, -0.4643136152871608, 0.1730767906045893, -0.3034947924416212, 0.19445200166473636, -0.09967007277293172, -1.1960964001594028], -47.40314582074544, 4, DynamicHMC.DoubledTurn, 0.9090176723094096, 15), NUTS_Transition{Array{Float64,1},Float64}([2.1609928093147546, 0.14943970913737453, -0.49226208802417687, -0.129784215588168, -0.015042006163512228, 0.37415710403772545, -0.19973224799211464, -0.5311698886071796, -0.14927623667260706, -0.289640041727286, 0.2573053843756362, 0.17365408566319154, -0.6392987000338279], -47.20155128904356, 4, DynamicHMC.DoubledTurn, 0.9221073289619229, 15), NUTS_Transition{Array{Float64,1},Float64}([0.6362219449828163, 0.30726427549117274, -0.14897951438066656, -0.07040780353590707, -0.26588078420370015, 0.25328271597038793, 0.23923779760435496, -0.49267207482523584, 0.4137948429945262, -0.4833769792758197, 0.3119144707815317, -0.2489054395600369, -0.7534614849629259], -52.31241904743102, 4, DynamicHMC.DoubledTurn, 0.99270967317531, 15), NUTS_Transition{Array{Float64,1},Float64}([0.7292693218052702, 0.3186968964050832, 0.0036791917348920483, -0.18171810122752033, -0.178645839263045, 0.19430567034821444, 0.2556108295346472, -0.6273358787007016, 0.44384820923284213, -0.41034561948752946, 0.0678232466167819, -0.48077974614376784, -0.9244090422777769], -53.037446228162594, 4, DynamicHMC.DoubledTurn, 0.7341959120818224, 15), NUTS_Transition{Array{Float64,1},Float64}([1.789572742120939, 0.19967714146339696, -0.6792816456153675, 0.2013024126931047, -0.297850728488336, 0.15207744585487049, -0.5640623232721528, -0.7371763952892256, -0.4489394911437364, -0.31438493493554, 0.3472039264019718, 0.03869827484943866, -0.9431170257650733], -53.90956384033944, 4, DynamicHMC.DoubledTurn, 0.9396236463001126, 15)  …  NUTS_Transition{Array{Float64,1},Float64}([1.7503815789321127, 0.1985513271327271, -0.06059829471375336, -0.2619399162678463, -0.16713267328017573, 0.006566714201550694, -0.0021297961456165776, -0.51174909139172, 0.1651393342425554, -0.02653448623317759, 0.2166991511272841, -0.07757891337522295, -1.5114586411239228], -50.369817423879056, 4, DynamicHMC.DoubledTurn, 1.0, 15), NUTS_Transition{Array{Float64,1},Float64}([1.8433727222731395, 0.17346533482590676, -0.182962969671553, -0.2595085326813843, -0.06648613901539492, 0.19216424995645132, 0.17818780190540034, -0.388299970259252, 0.12687610237257063, -0.10068943426369918, 0.4946350266013591, 0.2010648704262308, -1.3283305422415237], -41.84238277139562, 4, DynamicHMC.DoubledTurn, 0.9570053697881842, 15), NUTS_Transition{Array{Float64,1},Float64}([-0.4726787497427347, 0.45309779934150235, 0.19025923679493606, 0.2169210251316689, 0.022324181769201836, 0.4105832177111299, 0.00934485476700022, -0.4318576729651785, 0.07020653329391098, -0.35123701055260076, -0.022357312529692395, -0.8387354721279877, -0.8406441857616829], -44.53811554107038, 4, DynamicHMC.DoubledTurn, 0.8742137029054243, 15), NUTS_Transition{Array{Float64,1},Float64}([0.07665979988269744, 0.3749858925117528, 0.11726273034074133, 0.4214525833921263, 0.11123248649257422, 0.4087864478266903, 0.3969370884723106, -0.7619884223822718, 0.5373079753109198, -0.42623868297619194, 0.33465826687837225, -0.5228712905921648, -0.8944049262797819], -49.55373974852938, 4, DynamicHMC.DoubledTurn, 0.9167432993670415, 15), NUTS_Transition{Array{Float64,1},Float64}([2.106747443537523, 0.16804232688073206, -0.4758989970432611, -0.07015965174131991, -0.22726088401486083, 0.2139529290325446, -0.19543204984144472, -0.5983644426429363, -0.0758494576548543, -0.15730320783008722, 0.20650809507819712, 0.16867800741177388, -1.181338802160124], -49.18916081183519, 4, DynamicHMC.DoubledTurn, 0.9460446827036831, 15), NUTS_Transition{Array{Float64,1},Float64}([0.4949550680586698, 0.31452798389353875, -0.10625593741850221, 0.010277425495852935, 0.09393445836248113, 0.347352898880757, 0.26636144754192137, 0.08748786113486115, 0.27355768922582563, -0.00781243969280912, 0.28311579356325006, -0.2493520436219907, -1.5365429550938892], -41.83511380093043, 4, DynamicHMC.DoubledTurn, 0.9925522862765817, 15), NUTS_Transition{Array{Float64,1},Float64}([1.2493570909912843, 0.25784885263449037, -0.11572583476483492, 0.011392116355653691, -0.03384255314485773, 0.16926238179751513, 0.06851467190681816, -0.44081425885785597, 0.16506694073324293, -0.2722057401701164, 0.35446620556155956, -0.2579540649369511, -0.8454125735919594], -44.25701499871643, 4, DynamicHMC.DoubledTurn, 0.9397288864530876, 15), NUTS_Transition{Array{Float64,1},Float64}([1.0607952005290606, 0.259777845566993, -0.15195959553621072, 0.09017208469793092, -0.0019231883534174855, 0.48559895220499577, 0.012144552915517318, -0.29326560239069815, 0.02796354684454072, -0.15782325600533406, 0.1937561832652578, -0.023833084548199227, -1.5993619315290675], -41.450091488561775, 4, DynamicHMC.DoubledTurn, 0.9980921618518482, 15), NUTS_Transition{Array{Float64,1},Float64}([1.3210047401513771, 0.24743519913968529, -0.03233597465285894, -0.008270995240783986, 0.011132761926013451, 0.017958869527554232, 0.0024014831608846696, -0.08188702477357704, -0.06150854651557987, -0.03254373843469046, 0.09093902607347254, -0.038596972026956555, -2.945174058249887], -36.53908770713122, 4, DynamicHMC.AdjacentTurn, 0.7408460769279123, 31), NUTS_Transition{Array{Float64,1},Float64}([1.3210047401513771, 0.24743519913968529, -0.03233597465285894, -0.008270995240783986, 0.011132761926013451, 0.017958869527554232, 0.0024014831608846696, -0.08188702477357704, -0.06150854651557987, -0.03254373843469046, 0.09093902607347254, -0.038596972026956555, -2.945174058249887], -36.49651009625598, 2, DynamicHMC.AdjacentTurn, 0.07726876824722197, 7)], NUTS sampler in 13 dimensions
  stepsize (ϵ) ≈ 0.253
  maximum depth = 10
  Gaussian kinetic energy, √diag(M⁻¹): [0.7045820513138719, 0.07862674782698238, 0.2263280907593181, 0.21163762141869585, 0.20764330529337743, 0.183541506127345, 0.18063965734058168, 0.18357079073459773, 0.1686328271368984, 0.16388801806127068, 0.17159615593974192, 0.26588632820368036, 0.3891072194495754]
)</code></pre></div><p>We use the transformation to obtain the posterior from the chain.</p><div><pre><code class="language-julia">posterior = TransformVariables.transform.(Ref(problem_transformation(p)), get_position.(chain));
posterior[1:5]</code></pre><pre><code class="language-none">5-element Array{NamedTuple{(:β, :α, :σ),Tuple{Array{Float64,1},Array{Float64,1},Float64}},1}:
 (β = [1.5809324575846777, 0.2018433289779412], α = [-0.14257109091119496, 0.0021615300899397952, -0.26950076243112087, 0.302967292404358, 0.14765149510436437, 0.06010907526353183, 0.3622772218601067, -0.05657512726836844, 0.31170634507097955, 0.13334743097643637], σ = 0.31870191817859705)
 (β = [1.3590059842295954, 0.22392036456942505], α = [-0.43988341051610214, 0.18315389487699368, 0.08890841203161105, 0.5561449131018978, 0.10070398083109774, -0.5524582318437976, 0.0005577928127834808, 0.13547379985265828, 0.5535919292049724, 0.08527524537717153], σ = 0.29485750138175404)
 (β = [1.574359912132364, 0.20218963783700872], α = [-0.49459480653959165, 0.1091853028677525, 0.0011933824781357044, 0.24450458679165413, 0.2463367825064623, -0.4171725065326856, 0.0010834653291227781, -0.08108756946976653, 0.5570752932867931, 0.14547691073695224], σ = 0.26676876082455825)
 (β = [0.6688665512449837, 0.3024535285446815], α = [0.2550003734243367, -0.1247343159725682, -0.060026116764849896, 0.6041715352133994, -0.1222062036925931, -0.037182936249841904, 0.24036959017050397, 0.026953161160829922, 0.12636240760707992, -0.11422283336934802], σ = 0.2745318783776873)
 (β = [1.3695871641870954, 0.23204144352301148], α = [-0.6783055272476496, 0.019366132462501504, -0.006379782930006557, 0.06640880185468462, 0.23261452176750794, -0.5958288908451855, 0.19048460150930374, -0.24496908245502813, 0.4982862573210401, 0.018067837882123985], σ = 0.34500789482435557)</code></pre></div><p>Extract the parameter posterior means.</p><div><pre><code class="language-julia">posterior_β = mean(posterior[i].β for i in 1:length(posterior))
posterior_α = mean(posterior[i].α for i in 1:length(posterior))
posterior_σ = mean(posterior[i].σ for i in 1:length(posterior))</code></pre><pre><code class="language-none">0.31377189008795425</code></pre></div><p>Effective sample sizes (of untransformed draws)</p><div><pre><code class="language-julia">ess = mapslices(effective_sample_size, get_position_matrix(chain); dims = 1)
ess</code></pre><pre><code class="language-none">1×13 Array{Float64,2}:
 1000.0  1000.0  1000.0  1000.0  1000.0  …  1000.0  888.948  1000.0  499.1</code></pre></div><p>NUTS-specific statistics</p><div><pre><code class="language-julia">NUTS_statistics(chain)</code></pre><pre><code class="language-none">Hamiltonian Monte Carlo sample of length 1000
  acceptance rate mean: 0.94, min/25%/median/75%/max: 0.08 0.91 0.97 0.99 1.0
  termination: AdjacentTurn =&gt; 3% DoubledTurn =&gt; 97%
  depth: 2 =&gt; 0% 3 =&gt; 6% 4 =&gt; 94% 5 =&gt; 0%</code></pre></div><p>CmdStan result</p><div><pre><code class="language-julia">m_12_6_result = &quot;
Iterations = 1:1000
Thinning interval = 1
Chains = 1,2,3,4
Samples per chain = 1000

Empirical Posterior Estimates:
                            Mean                SD               Naive SE             MCSE            ESS
            a          1.076167468  0.7704872560 0.01218247319 0.0210530022 1000.000000
           bp         0.263056273  0.0823415805 0.00130193470 0.0022645077 1000.000000
  a_society.1   -0.191723568  0.2421382537 0.00382854195 0.0060563054 1000.000000
  a_society.2    0.054569029  0.2278506876 0.00360263570 0.0051693148 1000.000000
  a_society.3   -0.035935050  0.1926364647 0.00304584994 0.0039948433 1000.000000
  a_society.4    0.334355037  0.1929971201 0.00305155241 0.0063871707  913.029080
  a_society.5    0.049747513  0.1801287716 0.00284808595 0.0043631095 1000.000000
  a_society.6   -0.311903245  0.2096126337 0.00331426674 0.0053000536 1000.000000
  a_society.7    0.148637507  0.1744680594 0.00275858223 0.0047660246 1000.000000
  a_society.8   -0.164567976  0.1821341074 0.00287979309 0.0034297298 1000.000000
  a_society.9    0.277066965  0.1758237250 0.00278001719 0.0055844175  991.286501
 a_society.10   -0.094149204  0.2846206232 0.00450024719 0.0080735022 1000.000000
sigma_society    0.310352849  0.1374834682 0.00217380450 0.0057325226  575.187461
&quot;;</code></pre><pre><code class="language-none">&quot;\nIterations = 1:1000\nThinning interval = 1\nChains = 1,2,3,4\nSamples per chain = 1000\n\nEmpirical Posterior Estimates:\n                            Mean                SD               Naive SE             MCSE            ESS\n            a          1.076167468  0.7704872560 0.01218247319 0.0210530022 1000.000000\n           bp         0.263056273  0.0823415805 0.00130193470 0.0022645077 1000.000000\n  a_society.1   -0.191723568  0.2421382537 0.00382854195 0.0060563054 1000.000000\n  a_society.2    0.054569029  0.2278506876 0.00360263570 0.0051693148 1000.000000\n  a_society.3   -0.035935050  0.1926364647 0.00304584994 0.0039948433 1000.000000\n  a_society.4    0.334355037  0.1929971201 0.00305155241 0.0063871707  913.029080\n  a_society.5    0.049747513  0.1801287716 0.00284808595 0.0043631095 1000.000000\n  a_society.6   -0.311903245  0.2096126337 0.00331426674 0.0053000536 1000.000000\n  a_society.7    0.148637507  0.1744680594 0.00275858223 0.0047660246 1000.000000\n  a_society.8   -0.164567976  0.1821341074 0.00287979309 0.0034297298 1000.000000\n  a_society.9    0.277066965  0.1758237250 0.00278001719 0.0055844175  991.286501\n a_society.10   -0.094149204  0.2846206232 0.00450024719 0.0080735022 1000.000000\nsigma_society    0.310352849  0.1374834682 0.00217380450 0.0057325226  575.187461\n&quot;</code></pre></div><p>Show means</p><div><pre><code class="language-julia">[posterior_β, posterior_α, [posterior_σ]]</code></pre><pre><code class="language-none">3-element Array{Array{Float64,1},1}:
 [1.0993893029072712, 0.26144197952561987]
 [-0.21916440837863285, 0.03905729203915544, -0.05145066462343477, 0.3259156267760743, 0.044994145504273275, -0.3324684061081438, 0.14983341196320485, -0.1732946833230362, 0.2781704352543692, -0.09999109281314213]
 [0.31377189008795425]</code></pre></div><p>End of m12.6d.jl</p><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p><footer><hr/><a class="previous" href="../../10/m10.04d1/"><span class="direction">Previous</span><span class="title">m10.04d1</span></a><a class="next" href="../m12.6d1/"><span class="direction">Next</span><span class="title">m12.6d1</span></a></footer></article></body></html>
