<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>m12.6d · DynamicHMCModels.jl</title><link href="https://cdnjs.cloudflare.com/ajax/libs/normalize/4.2.0/normalize.min.css" rel="stylesheet" type="text/css"/><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.2.0/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link href="../../assets/documenter.css" rel="stylesheet" type="text/css"/></head><body><nav class="toc"><h1>DynamicHMCModels.jl</h1><select id="version-selector" onChange="window.location.href=this.value" style="visibility: hidden"></select><form class="search" id="search-form" action="../../search/"><input id="search-query" name="q" type="text" placeholder="Search docs"/></form><ul><li><a class="toctext" href="../../intro/">Home</a></li><li><span class="toctext">Chapter 02</span><ul><li><a class="toctext" href="../../02/m2.1d/">m2.1d</a></li></ul></li><li><span class="toctext">Chapter 04</span><ul><li><a class="toctext" href="../../04/m4.1d/">m4.1d</a></li><li><a class="toctext" href="../../04/m4.2d/">m4.2d</a></li><li><a class="toctext" href="../../04/m4.5d/">m4.5d</a></li></ul></li><li><span class="toctext">Chapter 05</span><ul><li><a class="toctext" href="../../05/m5.1d/">m5.1d</a></li><li><a class="toctext" href="../../05/m5.1d1/">m5.1d1</a></li><li><a class="toctext" href="../../05/m5.3d/">m5.3d</a></li><li><a class="toctext" href="../../05/m5.6d/">m5.6d</a></li></ul></li><li><span class="toctext">Chapter 08</span><ul><li><a class="toctext" href="../../08/m8.1d/">m8.1d</a></li></ul></li><li><span class="toctext">Chapter 10</span><ul><li><a class="toctext" href="../../10/m10.02d/">m10.02d</a></li><li><a class="toctext" href="../../10/m10.02d1/">m10.02d1</a></li><li><a class="toctext" href="../../10/m10.04d/">m10.04d</a></li><li><a class="toctext" href="../../10/m10.04d1/">m10.04d1</a></li><li><a class="toctext" href="../../10/m10.04d2/">m10.04d2</a></li></ul></li><li><span class="toctext">Chapter 12</span><ul><li class="current"><a class="toctext" href>m12.6d</a><ul class="internal"></ul></li><li><a class="toctext" href="../m12.6d1/">m12.6d1</a></li><li><a class="toctext" href="../m12.6d2/">m12.6d2</a></li></ul></li><li><a class="toctext" href="../../">Functions</a></li></ul></nav><article id="docs"><header><nav><ul><li>Chapter 12</li><li><a href>m12.6d</a></li></ul><a class="edit-page" href="https://github.com/StatisticalRethinkingJulia/DynamicHMCModels.jl/blob/master/scripts/12/m12.6d.jl"><span class="fa"></span> Edit on GitHub</a></nav><hr/><div id="topbar"><span>m12.6d</span><a class="fa fa-bars" href="#"></a></div></header><pre><code class="language-julia">using DynamicHMCModels

ProjDir = rel_path_d(&quot;..&quot;, &quot;scripts&quot;, &quot;12&quot;)

df = CSV.read(rel_path( &quot;..&quot;, &quot;data&quot;,  &quot;Kline.csv&quot;), delim=&#39;;&#39;);
size(df) # Should be 10x5</code></pre><pre><code class="language-none">(10, 5)</code></pre><p>New col logpop, set log() for population data</p><pre><code class="language-julia">df[:logpop] = map((x) -&gt; log(x), df[:population]);
df[:society] = 1:10;

first(df[[:total_tools, :logpop, :society]], 5)

struct m_12_06d_model{TY &lt;: AbstractVector, TX &lt;: AbstractMatrix,
  TS &lt;: AbstractVector}
    &quot;Observations (total_tools).&quot;
    y::TY
    &quot;Covariates (logpop)&quot;
    X::TX
    &quot;Society&quot;
    S::TS
    &quot;Number of observations (10)&quot;
    N::Int
    &quot;Number of societies (also 10)&quot;
    N_societies::Int
end</code></pre><p>Make the type callable with the parameters <em>as a single argument</em>.</p><pre><code class="language-julia">function (problem::m_12_06d_model)(θ)
    @unpack y, X, S, N, N_societies = problem   # extract the data
    @unpack β, α, σ = θ  # β : a, bp, α : a_society
    ll = 0.0
    ll += logpdf(Cauchy(0, 1), σ)
    ll += sum(logpdf.(Normal(0, σ), α)) # α[1:10]
    ll += logpdf.(Normal(0, 10), β[1]) # a
    ll += logpdf.(Normal(0, 1), β[2]) # a
    ll += sum(
      [loglikelihood(Poisson(exp(α[S[i]] + dot(X[i, :], β))), [y[i]]) for i in 1:N]
    )
    ll
end</code></pre><p>Instantiate the model with data and inits.</p><pre><code class="language-julia">N = size(df, 1)
N_societies = length(unique(df[:society]))
X = hcat(ones(Int64, N), df[:logpop]);
S = df[:society]
y = df[:total_tools]
p = m_12_06d_model(y, X, S, N, N_societies);
θ = (β = [1.0, 0.25], α = rand(Normal(0, 1), N_societies), σ = 0.2)
p(θ)</code></pre><pre><code class="language-none">-382.02782322396774</code></pre><p>Write a function to return properly dimensioned transformation.</p><pre><code class="language-julia">problem_transformation(p::m_12_06d_model) =
    as( (β = as(Array, size(p.X, 2)), α = as(Array, p.N_societies), σ = asℝ₊) )</code></pre><p>Wrap the problem with a transformation, then use Flux for the gradient.</p><pre><code class="language-julia">P = TransformedLogDensity(problem_transformation(p), p)
∇P = LogDensityRejectErrors(ADgradient(:ForwardDiff, P));
#∇P = ADgradient(:ForwardDiff, P);</code></pre><p>Tune and sample.</p><pre><code class="language-julia">chain, NUTS_tuned = NUTS_init_tune_mcmc(∇P, 1000);</code></pre><pre><code class="language-none">(NUTS_Transition{Array{Float64,1},Float64}[NUTS_Transition{Array{Float64,1},Float64}([-0.4550946423959591, 0.4243202573643265, -0.26568573572868875, 0.1419615925385028, 0.19180417184761583, 0.39092277454063507, -0.07367624757564371, -0.27966136872981473, 0.37043843375502555, 0.047280224504634684, 0.3528950547424741, -0.5648156083495371, -1.3540590310016798], -49.504413076700075, 4, DynamicHMC.DoubledTurn, 0.9707299142772239, 15), NUTS_Transition{Array{Float64,1},Float64}([1.1158247197698348, 0.24498157649642893, -0.13073917234901766, -0.1905527699333022, 0.11444910227716548, 0.5353619926557743, 0.030515355134445588, -0.09617279418802163, 0.30145633400210575, 0.046852099097167255, 0.4352396937198415, 0.16522119737984706, -1.088137586701056], -44.85688113315436, 4, DynamicHMC.DoubledTurn, 0.9975008452694245, 15), NUTS_Transition{Array{Float64,1},Float64}([1.8842909295005417, 0.1499269160976927, -0.4468137725320772, 0.008084405492573048, -0.06495441258269855, 0.459926390665833, 0.10369752888112597, -0.21762444092700056, 0.3744172972496789, 0.08279687473539497, 0.8814376216547064, 0.46972713542253514, -0.7961433557565551], -43.072974939269194, 4, DynamicHMC.DoubledTurn, 0.9982389959455955, 15), NUTS_Transition{Array{Float64,1},Float64}([0.48066359488889016, 0.3489047902401066, -0.009103084837346134, 0.09825776782465034, 0.017420976324613507, 0.5048242169630142, -0.002412706526863424, -0.27454351300016344, -0.1148040913226763, -0.22663636913949642, -0.11053126875111208, -0.5335647343953588, -1.2946167850566614], -53.30001936182097, 4, DynamicHMC.DoubledTurn, 0.7133195949233748, 15), NUTS_Transition{Array{Float64,1},Float64}([1.8702333742192796, 0.17153650485887295, -0.3638368865656853, -0.015484634300093225, -0.1105502380493284, 0.05691825323764484, 0.04659543005361318, -0.3088600647204991, 0.32542688739958825, -0.17575518970125534, 0.5751216157542769, 0.10418121821798682, -1.4178445528918648], -44.198911402517886, 4, DynamicHMC.DoubledTurn, 0.9998475007691601, 15), NUTS_Transition{Array{Float64,1},Float64}([1.1397861509991598, 0.2662023844109237, -0.24496773129485314, 0.0015948917743545538, 0.04300467388602004, 0.39463821051708026, 0.04373792795412558, -0.8064556232553759, -0.12842618307893858, -0.19036885991443103, 0.03615067272114943, -0.07994762493483168, -0.934198616152832], -45.94206799386086, 4, DynamicHMC.DoubledTurn, 0.9980926595947673, 15), NUTS_Transition{Array{Float64,1},Float64}([0.5186136106301499, 0.31431880075313584, -0.27934250955566947, 0.2857311295892654, -0.017824953232272345, 0.3535913011285988, 0.11596361521194185, -0.042148061971162915, 0.24845618908190534, -0.17969931907050665, 0.43280965638076657, -0.13325265875737713, -1.2687722284227725], -45.871278140032665, 4, DynamicHMC.DoubledTurn, 0.9928792451187043, 15), NUTS_Transition{Array{Float64,1},Float64}([1.6999038462996219, 0.19567902929727618, -0.12705592815575, -0.18219580647473296, -0.10965650653491343, 0.3507273634781911, 0.039844364967484704, -0.6240682047187915, 0.10510851830425834, -0.2653378523309241, 0.23927308363128644, 0.08674632264902052, -1.0016977994786294], -42.42215153756897, 4, DynamicHMC.DoubledTurn, 0.8494840450316187, 15), NUTS_Transition{Array{Float64,1},Float64}([1.3488885970436768, 0.21192616581378457, -0.46181859238379347, 0.3071568674552856, -0.017915591145987956, 0.36036564469095267, 0.11770938712979898, -0.041164967566586746, 0.38089684256996437, 0.17149687361393293, 0.5851715898877387, 0.1756324348144354, -0.7466598372955993], -44.31872762509703, 4, DynamicHMC.DoubledTurn, 0.9739712833921575, 15), NUTS_Transition{Array{Float64,1},Float64}([3.709540554518029, -0.03774329716750842, -0.9717846617216389, -0.33599582503428904, -0.27612126220308975, 0.5320654802842487, 0.09627525977530546, -0.4818985118437382, 0.22935773571603765, 0.025879783174751612, 0.8038241914578785, 0.8427109783958533, -0.9067280109450966], -50.37883241581205, 4, DynamicHMC.DoubledTurn, 0.9830411529006131, 15)  …  NUTS_Transition{Array{Float64,1},Float64}([1.1337319835912458, 0.23878215522684917, -0.3285904912370493, 0.4342907628199558, -0.13415229048857044, 0.325273171836064, 0.2628336145824732, 0.055278057693117166, 0.31289264481008916, 0.09777778428079875, 0.6212003259937879, 0.20591638185193545, -0.683431725327123], -48.1097618820907, 4, DynamicHMC.DoubledTurn, 0.9480651065193125, 15), NUTS_Transition{Array{Float64,1},Float64}([0.5649772287715766, 0.28880797810092756, 0.06379967652890314, 0.48898291140684375, -0.06662606369766538, 0.46642821184630195, 0.3183921274679487, 0.1166332487137517, 0.33769963212237397, 0.20907853011777947, 0.60101104915057, 0.016194355927933328, -0.9884185942385737], -46.44189255547554, 4, DynamicHMC.AdjacentTurn, 0.9981083297006667, 31), NUTS_Transition{Array{Float64,1},Float64}([1.2677433277771701, 0.24629131357074593, -0.2619707760488224, -0.02069026615835999, 0.00632503282365282, 0.612982682842168, -0.031057743160790803, -0.49689707055892424, 0.26575133293072206, 0.04345610883947816, 0.29320058920771186, 0.11936150484825701, -1.0264619965680943], -46.89160336850721, 4, DynamicHMC.DoubledTurn, 0.8039345087108549, 15), NUTS_Transition{Array{Float64,1},Float64}([0.9855517638905101, 0.28263075394654513, -0.175949788056823, 0.11762682551826634, -0.006776834274249164, 0.03603724294788426, 0.0894591312529577, -0.29268153817660714, -0.003462265391060322, -0.2048251588019032, 0.24524432087827167, -0.3011894803042766, -1.8119952922807328], -41.73448207594296, 4, DynamicHMC.DoubledTurn, 1.0, 15), NUTS_Transition{Array{Float64,1},Float64}([0.8076049619584054, 0.30599649920529676, -0.2100365101089277, 0.011656633223208479, -0.02750202236871649, 0.44471445128823134, -0.07885361597067926, -0.5089572217766787, 0.10164464847037713, -0.1665475443995204, 0.01631677385327722, -0.45301519432541426, -0.9653705648406884], -41.05270499887477, 3, DynamicHMC.AdjacentTurn, 0.9646930386434236, 15), NUTS_Transition{Array{Float64,1},Float64}([1.3683476799843268, 0.24780343580589184, -0.12860417141707262, -0.05153235030247707, -0.33233095902389975, 0.28257905078596357, 0.05182027126327916, -0.39602467973322114, 0.10672708447494286, 0.004296109112232105, 0.05299895047778083, -0.5483008396169735, -1.573188494991992], -48.41439053032699, 4, DynamicHMC.DoubledTurn, 0.9341425940254074, 15), NUTS_Transition{Array{Float64,1},Float64}([1.3158082934536244, 0.20989877827783346, -0.18809986325802797, 0.32610936274081304, 0.14716497022484915, 0.36954913701523406, 0.1880299493595467, -0.19956458108687242, 0.2890733827709194, -0.31018056327045007, 0.3490403256741225, 0.3073122582683072, -1.2065690329599255], -50.346673548954605, 4, DynamicHMC.DoubledTurn, 0.8244124915678147, 15), NUTS_Transition{Array{Float64,1},Float64}([1.5104155888209982, 0.21234745010687536, -0.36973299877830246, 0.009233996276979267, -0.2655726028172887, 0.3713363104662657, 0.06022351551529818, -0.24741739083500472, 0.44055933019748206, -0.20094204005174915, 0.39923224769692195, 0.30318249499909633, -0.9868652547875936], -46.25991932347476, 4, DynamicHMC.DoubledTurn, 0.9731306729514333, 15), NUTS_Transition{Array{Float64,1},Float64}([1.79834066219694, 0.18719259234732136, -0.654708808291607, -0.11455191113356701, 0.009614449442712676, 0.37964880389569017, 0.19802653739162593, -0.3072013906133516, -0.15180284030438485, -0.14476345404653243, 0.3404387561266497, -0.018806204764198618, -0.9501451665690267], -45.01976910151218, 4, DynamicHMC.DoubledTurn, 0.9911983496449359, 15), NUTS_Transition{Array{Float64,1},Float64}([1.3779793283241377, 0.20922468999008664, -0.48935571731000715, 0.12218740928207159, -0.0683432300795719, 0.44750281873933545, 0.30507931270421934, -0.32655164596359176, 0.34033105835930333, -0.08820900100030553, 0.4586593181180356, 0.3590444122621674, -1.197050530379397], -43.92749760753485, 4, DynamicHMC.DoubledTurn, 0.9999465449429681, 15)], NUTS sampler in 13 dimensions
  stepsize (ϵ) ≈ 0.235
  maximum depth = 10
  Gaussian kinetic energy, √diag(M⁻¹): [0.787954191152894, 0.08863719647988928, 0.24529043905981565, 0.23088195541237871, 0.19502398477255992, 0.1877628505248508, 0.16810118739672208, 0.19232420082667925, 0.1778754888474777, 0.1742658031152861, 0.15986185095587208, 0.28418709463301456, 0.3762293503818233]
)</code></pre><p>We use the transformation to obtain the posterior from the chain.</p><pre><code class="language-julia">posterior = TransformVariables.transform.(Ref(problem_transformation(p)), get_position.(chain));
posterior[1:5]</code></pre><pre><code class="language-none">5-element Array{NamedTuple{(:β, :α, :σ),Tuple{Array{Float64,1},Array{Float64,1},Float64}},1}:
 (β = [-0.4550946423959591, 0.4243202573643265], α = [-0.26568573572868875, 0.1419615925385028, 0.19180417184761583, 0.39092277454063507, -0.07367624757564371, -0.27966136872981473, 0.37043843375502555, 0.047280224504634684, 0.3528950547424741, -0.5648156083495371], σ = 0.25819012909112143)     
 (β = [1.1158247197698348, 0.24498157649642893], α = [-0.13073917234901766, -0.1905527699333022, 0.11444910227716548, 0.5353619926557743, 0.030515355134445588, -0.09617279418802163, 0.30145633400210575, 0.046852099097167255, 0.4352396937198415, 0.16522119737984706], σ = 0.33684325123555214)     
 (β = [1.8842909295005417, 0.1499269160976927], α = [-0.4468137725320772, 0.008084405492573048, -0.06495441258269855, 0.459926390665833, 0.10369752888112597, -0.21762444092700056, 0.3744172972496789, 0.08279687473539497, 0.8814376216547064, 0.46972713542253514], σ = 0.4510652119732108)          
 (β = [0.48066359488889016, 0.3489047902401066], α = [-0.009103084837346134, 0.09825776782465034, 0.017420976324613507, 0.5048242169630142, -0.002412706526863424, -0.27454351300016344, -0.1148040913226763, -0.22663636913949642, -0.11053126875111208, -0.5335647343953588], σ = 0.27400284620003157)
 (β = [1.8702333742192796, 0.17153650485887295], α = [-0.3638368865656853, -0.015484634300093225, -0.1105502380493284, 0.05691825323764484, 0.04659543005361318, -0.3088600647204991, 0.32542688739958825, -0.17575518970125534, 0.5751216157542769, 0.10418121821798682], σ = 0.2422355805752839)      </code></pre><p>Extract the parameter posterior means.</p><pre><code class="language-julia">posterior_β = mean(posterior[i].β for i in 1:length(posterior))
posterior_α = mean(posterior[i].α for i in 1:length(posterior))
posterior_σ = mean(posterior[i].σ for i in 1:length(posterior))</code></pre><pre><code class="language-none">0.3112469084952423</code></pre><p>Effective sample sizes (of untransformed draws)</p><pre><code class="language-julia">ess = mapslices(effective_sample_size, get_position_matrix(chain); dims = 1)
ess</code></pre><pre><code class="language-none">1×13 Array{Float64,2}:
 634.783  512.441  700.418  729.361  …  810.59  559.408  156.827  581.991</code></pre><p>NUTS-specific statistics</p><pre><code class="language-julia">NUTS_statistics(chain)</code></pre><pre><code class="language-none">Hamiltonian Monte Carlo sample of length 1000
  acceptance rate mean: 0.94, min/25%/median/75%/max: 0.52 0.91 0.97 0.99 1.0
  termination: AdjacentTurn =&gt; 5% DoubledTurn =&gt; 95%
  depth: 3 =&gt; 5% 4 =&gt; 94% 5 =&gt; 0% 6 =&gt; 0%
</code></pre><p>CmdStan result</p><pre><code class="language-julia">m_12_6_result = &quot;
Iterations = 1:1000
Thinning interval = 1
Chains = 1,2,3,4
Samples per chain = 1000

Empirical Posterior Estimates:
                            Mean                SD               Naive SE             MCSE            ESS
            a          1.076167468  0.7704872560 0.01218247319 0.0210530022 1000.000000
           bp         0.263056273  0.0823415805 0.00130193470 0.0022645077 1000.000000
  a_society.1   -0.191723568  0.2421382537 0.00382854195 0.0060563054 1000.000000
  a_society.2    0.054569029  0.2278506876 0.00360263570 0.0051693148 1000.000000
  a_society.3   -0.035935050  0.1926364647 0.00304584994 0.0039948433 1000.000000
  a_society.4    0.334355037  0.1929971201 0.00305155241 0.0063871707  913.029080
  a_society.5    0.049747513  0.1801287716 0.00284808595 0.0043631095 1000.000000
  a_society.6   -0.311903245  0.2096126337 0.00331426674 0.0053000536 1000.000000
  a_society.7    0.148637507  0.1744680594 0.00275858223 0.0047660246 1000.000000
  a_society.8   -0.164567976  0.1821341074 0.00287979309 0.0034297298 1000.000000
  a_society.9    0.277066965  0.1758237250 0.00278001719 0.0055844175  991.286501
 a_society.10   -0.094149204  0.2846206232 0.00450024719 0.0080735022 1000.000000
sigma_society    0.310352849  0.1374834682 0.00217380450 0.0057325226  575.187461
&quot;;</code></pre><pre><code class="language-none">&quot;\nIterations = 1:1000\nThinning interval = 1\nChains = 1,2,3,4\nSamples per chain = 1000\n\nEmpirical Posterior Estimates:\n                            Mean                SD               Naive SE             MCSE            ESS\n            a          1.076167468  0.7704872560 0.01218247319 0.0210530022 1000.000000\n           bp         0.263056273  0.0823415805 0.00130193470 0.0022645077 1000.000000\n  a_society.1   -0.191723568  0.2421382537 0.00382854195 0.0060563054 1000.000000\n  a_society.2    0.054569029  0.2278506876 0.00360263570 0.0051693148 1000.000000\n  a_society.3   -0.035935050  0.1926364647 0.00304584994 0.0039948433 1000.000000\n  a_society.4    0.334355037  0.1929971201 0.00305155241 0.0063871707  913.029080\n  a_society.5    0.049747513  0.1801287716 0.00284808595 0.0043631095 1000.000000\n  a_society.6   -0.311903245  0.2096126337 0.00331426674 0.0053000536 1000.000000\n  a_society.7    0.148637507  0.1744680594 0.00275858223 0.0047660246 1000.000000\n  a_society.8   -0.164567976  0.1821341074 0.00287979309 0.0034297298 1000.000000\n  a_society.9    0.277066965  0.1758237250 0.00278001719 0.0055844175  991.286501\n a_society.10   -0.094149204  0.2846206232 0.00450024719 0.0080735022 1000.000000\nsigma_society    0.310352849  0.1374834682 0.00217380450 0.0057325226  575.187461\n&quot;</code></pre><p>Show means</p><pre><code class="language-julia">[posterior_β, posterior_α, [posterior_σ]]</code></pre><pre><code class="language-none">3-element Array{Array{Float64,1},1}:
 [1.0953647286273622, 0.26156284970374294]                                                                                                                                                                              
 [-0.20111181887602292, 0.037073215279123044, -0.045558870081484674, 0.3254447617808929, 0.043543759623996266, -0.3227708072587845, 0.14399327428080755, -0.17909727866230124, 0.2839420165318205, -0.09949442264560367]
 [0.3112469084952423]                                                                                                                                                                                                   </code></pre><p>End of m12.6d.jl</p><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p><footer><hr/><a class="previous" href="../../10/m10.04d2/"><span class="direction">Previous</span><span class="title">m10.04d2</span></a><a class="next" href="../m12.6d1/"><span class="direction">Next</span><span class="title">m12.6d1</span></a></footer></article></body></html>
