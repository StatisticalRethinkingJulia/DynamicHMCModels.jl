<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>m12.6d · DynamicHMCModels.jl</title><link href="https://cdnjs.cloudflare.com/ajax/libs/normalize/4.2.0/normalize.min.css" rel="stylesheet" type="text/css"/><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.2.0/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link href="../../assets/documenter.css" rel="stylesheet" type="text/css"/></head><body><nav class="toc"><h1>DynamicHMCModels.jl</h1><select id="version-selector" onChange="window.location.href=this.value" style="visibility: hidden"></select><form class="search" id="search-form" action="../../search/"><input id="search-query" name="q" type="text" placeholder="Search docs"/></form><ul><li><a class="toctext" href="../../intro/">Home</a></li><li><span class="toctext">Chapter 02</span><ul><li><a class="toctext" href="../../02/m2.1d/">m2.1d</a></li></ul></li><li><span class="toctext">Chapter 04</span><ul><li><a class="toctext" href="../../04/m4.1d/">m4.1d</a></li><li><a class="toctext" href="../../04/m4.2d/">m4.2d</a></li><li><a class="toctext" href="../../04/m4.5d/">m4.5d</a></li></ul></li><li><span class="toctext">Chapter 05</span><ul><li><a class="toctext" href="../../05/m5.1d/">m5.1d</a></li><li><a class="toctext" href="../../05/m5.1d1/">m5.1d1</a></li><li><a class="toctext" href="../../05/m5.3d/">m5.3d</a></li><li><a class="toctext" href="../../05/m5.6d/">m5.6d</a></li></ul></li><li><span class="toctext">Chapter 08</span><ul><li><a class="toctext" href="../../08/m8.1d/">m8.1d</a></li></ul></li><li><span class="toctext">Chapter 10</span><ul><li><a class="toctext" href="../../10/m10.02d/">m10.02d</a></li><li><a class="toctext" href="../../10/m10.02d1/">m10.02d1</a></li><li><a class="toctext" href="../../10/m10.04d/">m10.04d</a></li><li><a class="toctext" href="../../10/m10.04d1/">m10.04d1</a></li><li><a class="toctext" href="../../10/m10.04d2/">m10.04d2</a></li></ul></li><li><span class="toctext">Chapter 12</span><ul><li class="current"><a class="toctext" href>m12.6d</a><ul class="internal"></ul></li><li><a class="toctext" href="../m12.6d1/">m12.6d1</a></li><li><a class="toctext" href="../m12.6d2/">m12.6d2</a></li></ul></li><li><a class="toctext" href="../../">Functions</a></li></ul></nav><article id="docs"><header><nav><ul><li>Chapter 12</li><li><a href>m12.6d</a></li></ul><a class="edit-page" href="https://github.com/StatisticalRethinkingJulia/DynamicHMCModels.jl/blob/master/scripts/12/m12.6d.jl"><span class="fa"></span> Edit on GitHub</a></nav><hr/><div id="topbar"><span>m12.6d</span><a class="fa fa-bars" href="#"></a></div></header><pre><code class="language-julia">using DynamicHMCModels

ProjDir = rel_path_d(&quot;..&quot;, &quot;scripts&quot;, &quot;12&quot;)

df = CSV.read(rel_path( &quot;..&quot;, &quot;data&quot;,  &quot;Kline.csv&quot;), delim=&#39;;&#39;);
size(df) # Should be 10x5</code></pre><pre><code class="language-none">(10, 5)</code></pre><p>New col logpop, set log() for population data</p><pre><code class="language-julia">df[:logpop] = map((x) -&gt; log(x), df[:population]);
df[:society] = 1:10;

first(df[[:total_tools, :logpop, :society]], 5)

struct m_12_06d_model{TY &lt;: AbstractVector, TX &lt;: AbstractMatrix,
  TS &lt;: AbstractVector}
    &quot;Observations (total_tools).&quot;
    y::TY
    &quot;Covariates (logpop)&quot;
    X::TX
    &quot;Society&quot;
    S::TS
    &quot;Number of observations (10)&quot;
    N::Int
    &quot;Number of societies (also 10)&quot;
    N_societies::Int
end</code></pre><p>Make the type callable with the parameters <em>as a single argument</em>.</p><pre><code class="language-julia">function (problem::m_12_06d_model)(θ)
    @unpack y, X, S, N, N_societies = problem   # extract the data
    @unpack β, α, σ = θ  # β : a, bp, α : a_society
    ll = 0.0
    ll += logpdf(Cauchy(0, 1), σ)
    ll += sum(logpdf.(Normal(0, σ), α)) # α[1:10]
    ll += logpdf.(Normal(0, 10), β[1]) # a
    ll += logpdf.(Normal(0, 1), β[2]) # a
    ll += sum(
      [loglikelihood(Poisson(exp(α[S[i]] + dot(X[i, :], β))), [y[i]]) for i in 1:N]
    )
    ll
end</code></pre><p>Instantiate the model with data and inits.</p><pre><code class="language-julia">N = size(df, 1)
N_societies = length(unique(df[:society]))
X = hcat(ones(Int64, N), df[:logpop]);
S = df[:society]
y = df[:total_tools]
p = m_12_06d_model(y, X, S, N, N_societies);
θ = (β = [1.0, 0.25], α = rand(Normal(0, 1), N_societies), σ = 0.2)
p(θ)</code></pre><pre><code class="language-none">-367.0811397352951</code></pre><p>Write a function to return properly dimensioned transformation.</p><pre><code class="language-julia">problem_transformation(p::m_12_06d_model) =
    as( (β = as(Array, size(p.X, 2)), α = as(Array, p.N_societies), σ = asℝ₊) )</code></pre><p>Wrap the problem with a transformation, then use Flux for the gradient.</p><pre><code class="language-julia">P = TransformedLogDensity(problem_transformation(p), p)
∇P = LogDensityRejectErrors(ADgradient(:ForwardDiff, P));
#∇P = ADgradient(:ForwardDiff, P);</code></pre><p>Tune and sample.</p><pre><code class="language-julia">chain, NUTS_tuned = NUTS_init_tune_mcmc(∇P, 1000);</code></pre><pre><code class="language-none">(NUTS_Transition{Array{Float64,1},Float64}[NUTS_Transition{Array{Float64,1},Float64}([0.3835828763510679, 0.34003640948231784, -0.49126920462246404, 0.0014479908032973918, -0.13748032473037708, 0.5873242756847302, 0.22474040510134521, -0.07066819173450316, 0.20292615583517812, -0.38782938323033933, 0.08010230181328876, -0.4760725284011768, -0.8552510754959761], -48.43250550676853, 4, DynamicHMC.DoubledTurn, 1.0, 15), NUTS_Transition{Array{Float64,1},Float64}([0.0351585667061175, 0.38318019738951814, 0.045067199546184, 0.3064257444299674, 0.08911841930793968, 0.3440351847996754, 0.07203298110071976, -0.0568217356942203, 0.2768223169430378, -0.13835692034530242, 0.06235360834727653, -0.5518479290019753, -1.2094624490337162], -47.025864508756385, 4, DynamicHMC.DoubledTurn, 0.9399976274114873, 15), NUTS_Transition{Array{Float64,1},Float64}([0.827841375926964, 0.2998036732109398, -0.22986338696109027, -0.14890399547092675, 0.10340972400310731, 0.07685078986722198, -0.10294424496377516, -0.4979754561465864, 0.14416352862327664, -0.37993788364509956, 0.1839436752908275, -0.18163105544628394, -1.2956127885429278], -41.298733747376865, 4, DynamicHMC.DoubledTurn, 1.0, 15), NUTS_Transition{Array{Float64,1},Float64}([1.822957659982233, 0.17567256864325997, -0.1560848610222596, 0.14192026326417267, -0.16432449046554282, 0.5153567514714953, 0.12867579658933595, -0.18679380535258233, 0.23208597051895205, 0.12627921107507828, 0.4240426952087178, 0.14802756651856097, -1.0522717772889132], -43.36838496850058, 4, DynamicHMC.DoubledTurn, 0.9423833444213795, 15), NUTS_Transition{Array{Float64,1},Float64}([0.9925517184933994, 0.26457825930798906, 0.04685894540706121, 0.26301118116171857, 0.1716716854521583, 0.4190392073240414, 0.2722236651318909, -0.2776619258083292, 0.3841866456605859, -0.33178202205046486, 0.10615367163006023, 0.05201269882165168, -1.115233526726584], -45.79155428814898, 4, DynamicHMC.DoubledTurn, 0.9650528928494416, 15), NUTS_Transition{Array{Float64,1},Float64}([2.27604242769865, 0.14600816263112756, -0.5153192017621733, -0.16636783808103944, -0.4190885529345577, 0.1711589288840332, 0.08291949991763137, -0.5383476200800419, 0.09026593499653236, -0.45147660239237963, 0.3101079866110366, 0.04340515922646603, -1.3354634564513825], -47.23648080230209, 4, DynamicHMC.DoubledTurn, 0.904314303244811, 15), NUTS_Transition{Array{Float64,1},Float64}([0.168900718964735, 0.35473706275640593, 0.08781034405522725, 0.26304121927319, 0.42265486917979433, 0.47653269322455233, 0.17593621606063675, -0.2700856154549931, 0.34921480202859406, 0.016531921241605352, 0.16138216710552297, -0.10874459448809745, -1.414093757534312], -47.88840530661694, 4, DynamicHMC.DoubledTurn, 0.8109743286893883, 15), NUTS_Transition{Array{Float64,1},Float64}([0.2411434495457316, 0.3363043935805335, 0.09032612688789135, 0.1202758726850398, 0.2115771093778298, 0.43566559150293616, 0.10751350371568702, -0.198902064820519, 0.33823936744848926, -0.004069774958693671, 0.22277921138071236, -0.24933950943689226, -1.19645896018345], -44.16093345387951, 4, DynamicHMC.DoubledTurn, 0.9528152110107904, 15), NUTS_Transition{Array{Float64,1},Float64}([1.8401483593625332, 0.17889177473046022, -0.23159172665229377, -0.058171638611441256, -0.3979256493919336, 0.26150624917006243, 0.14915258845915436, -0.553662915640228, 0.045255420735819604, -0.29176823784636974, 0.3006096241220709, 0.005690849038972018, -1.5158824187899929], -43.94166462261715, 4, DynamicHMC.DoubledTurn, 0.9601236182485365, 15), NUTS_Transition{Array{Float64,1},Float64}([1.3826000292679559, 0.24871739916110408, -0.3085460871311521, -0.12432354248376391, -0.23718386322739865, 0.3197870681095518, 0.09276543475319364, -0.5233861398216455, 0.09474700918434373, -0.22566174860407714, 0.23791129727686144, -0.11261350379376261, -1.3561815692959112], -41.4728134190917, 3, DynamicHMC.DoubledTurn, 1.0, 7)  …  NUTS_Transition{Array{Float64,1},Float64}([0.5650835159351841, 0.3511772058486977, -0.3750322422396072, -0.16214796957474892, -0.21572581515590827, 0.1754556666255554, -0.2071923342046022, -0.749588285342184, -0.2084257365411895, -0.5292702333377044, 0.04674890496193104, -0.7548230955030462, -0.5856312680702532], -42.954709544144876, 4, DynamicHMC.DoubledTurn, 0.9848812951926188, 15), NUTS_Transition{Array{Float64,1},Float64}([1.1170655284953503, 0.23127220056122894, 0.07808694867223565, 0.22664984882436992, 0.03653315020480534, 0.6654276109218668, 0.29783538011784955, -0.23471420593308154, 0.6147970619222665, -0.137499000818267, 0.6025876919994057, 0.19364550425318564, -0.8339188326834454], -48.94729386832094, 4, DynamicHMC.DoubledTurn, 0.8715676845680106, 15), NUTS_Transition{Array{Float64,1},Float64}([-0.9632449572042354, 0.4531122145198124, 0.19671787282637357, 0.650676629866983, 0.188367266346939, 0.7663378261307666, 0.5033949381591796, -0.07782216369028985, 0.41034433975840134, -0.21050646064322795, 0.40433484362078687, -0.2841482094756299, -0.9428084314702642], -45.231957593761464, 4, DynamicHMC.DoubledTurn, 0.9887314247163229, 15), NUTS_Transition{Array{Float64,1},Float64}([1.7007692915615789, 0.20362267735097753, -0.2720526327105351, -0.24917813304808029, -0.12318091007972143, 0.21224921094535712, -0.1443331417112182, -0.25048199469202737, 0.03254733151227013, -0.11311970222969382, 0.1649965421545822, -0.07037346424521747, -1.5760752525490336], -46.69227882585915, 4, DynamicHMC.DoubledTurn, 0.9518249216405451, 15), NUTS_Transition{Array{Float64,1},Float64}([1.8330624520791696, 0.20153848152587506, -0.34683978956429035, -0.2806921223005828, -0.22321344287895092, 0.1892732866050198, -0.05488800277063636, -0.4184348428128108, -0.034692961133640315, -0.3005336082959664, 0.06791374155427517, -0.22874702284980217, -1.2897491061765383], -44.07669981351105, 4, DynamicHMC.DoubledTurn, 0.9501350240680044, 15), NUTS_Transition{Array{Float64,1},Float64}([0.9663363876295902, 0.26233179972406667, 0.21953541452323333, 0.29719766492421595, 0.004143947605130732, 0.4279858975716928, -0.005147408019289451, -0.025171332679509835, 0.38605119514708125, -0.04451384777068109, 0.23803842910317569, 0.05847968314632268, -1.5576110285904905], -44.796249820259824, 4, DynamicHMC.DoubledTurn, 0.8948783665324153, 15), NUTS_Transition{Array{Float64,1},Float64}([1.6705824813599677, 0.1916849022657474, -0.6765851347525143, 0.13614613861313107, 0.0030693537499499463, 0.3334938492836291, 0.034098240162677464, 0.10361513276147108, 0.22286592475192393, -0.17426521308682708, 0.6072760913299399, 0.3186000463667976, -0.3762227086858323], -50.89694888295774, 4, DynamicHMC.DoubledTurn, 0.893414969702841, 15), NUTS_Transition{Array{Float64,1},Float64}([1.2003015967831834, 0.22877179870817194, -0.31397329509410576, 0.14942576088454715, 0.3644788743835989, 0.6032121086751434, 0.1554357810968611, -0.6958631793572329, 0.1917620887397709, -0.06840188934869162, 0.3616167877095245, 0.20058644472765774, -1.3630767233511547], -51.94647758707813, 4, DynamicHMC.AdjacentTurn, 0.9922977032776602, 31), NUTS_Transition{Array{Float64,1},Float64}([1.2276230003146518, 0.2517120239278586, -0.027450122821913524, -0.0827470452026208, -0.35550426556193954, 0.00042818219124898804, 0.015072781771722152, 0.01297973356886313, 0.16252768453405753, -0.10353305176714803, 0.1485450867608168, -0.1437546770443868, -2.018276755995721], -46.02599400174057, 4, DynamicHMC.DoubledTurn, 1.0, 15), NUTS_Transition{Array{Float64,1},Float64}([0.7138964507895128, 0.28646124341342416, -0.2071040811818705, 0.34189404654439115, 0.5197436425480454, 0.6623433394728528, 0.28171353389320736, -0.7674570672319024, 0.33332883594957596, -0.30711622917289355, 0.3245570188569491, -0.08663689180529338, -0.7791077011400166], -46.269377144566995, 4, DynamicHMC.DoubledTurn, 0.9603233267137522, 15)], NUTS sampler in 13 dimensions
  stepsize (ϵ) ≈ 0.245
  maximum depth = 10
  Gaussian kinetic energy, √diag(M⁻¹): [0.741138670573553, 0.08310967466571803, 0.22881946917454488, 0.2273457203844121, 0.17438218320296303, 0.17949111156622116, 0.17305303253635682, 0.20479205848260268, 0.17698209372878354, 0.19635662989497885, 0.16949774750226948, 0.2805270635834719, 0.4561368657733797]
)</code></pre><p>We use the transformation to obtain the posterior from the chain.</p><pre><code class="language-julia">posterior = TransformVariables.transform.(Ref(problem_transformation(p)), get_position.(chain));
posterior[1:5]</code></pre><pre><code class="language-none">5-element Array{NamedTuple{(:β, :α, :σ),Tuple{Array{Float64,1},Array{Float64,1},Float64}},1}:
 (β = [0.3835828763510679, 0.34003640948231784], α = [-0.49126920462246404, 0.0014479908032973918, -0.13748032473037708, 0.5873242756847302, 0.22474040510134521, -0.07066819173450316, 0.20292615583517812, -0.38782938323033933, 0.08010230181328876, -0.4760725284011768], σ = 0.4251764262977143)
 (β = [0.0351585667061175, 0.38318019738951814], α = [0.045067199546184, 0.3064257444299674, 0.08911841930793968, 0.3440351847996754, 0.07203298110071976, -0.0568217356942203, 0.2768223169430378, -0.13835692034530242, 0.06235360834727653, -0.5518479290019753], σ = 0.2983576187570072)         
 (β = [0.827841375926964, 0.2998036732109398], α = [-0.22986338696109027, -0.14890399547092675, 0.10340972400310731, 0.07685078986722198, -0.10294424496377516, -0.4979754561465864, 0.14416352862327664, -0.37993788364509956, 0.1839436752908275, -0.18163105544628394], σ = 0.273730074273414)    
 (β = [1.822957659982233, 0.17567256864325997], α = [-0.1560848610222596, 0.14192026326417267, -0.16432449046554282, 0.5153567514714953, 0.12867579658933595, -0.18679380535258233, 0.23208597051895205, 0.12627921107507828, 0.4240426952087178, 0.14802756651856097], σ = 0.34914367080623854)     
 (β = [0.9925517184933994, 0.26457825930798906], α = [0.04685894540706121, 0.26301118116171857, 0.1716716854521583, 0.4190392073240414, 0.2722236651318909, -0.2776619258083292, 0.3841866456605859, -0.33178202205046486, 0.10615367163006023, 0.05201269882165168], σ = 0.32783871085860017)       </code></pre><p>Extract the parameter posterior means.</p><pre><code class="language-julia">posterior_β = mean(posterior[i].β for i in 1:length(posterior))
posterior_α = mean(posterior[i].α for i in 1:length(posterior))
posterior_σ = mean(posterior[i].σ for i in 1:length(posterior))</code></pre><pre><code class="language-none">0.3081725406373706</code></pre><p>Effective sample sizes (of untransformed draws)</p><pre><code class="language-julia">ess = mapslices(effective_sample_size, get_position_matrix(chain); dims = 1)
ess</code></pre><pre><code class="language-none">1×13 Array{Float64,2}:
 1000.0  1000.0  1000.0  1000.0  …  745.084  589.236  780.024  524.727</code></pre><p>NUTS-specific statistics</p><pre><code class="language-julia">NUTS_statistics(chain)</code></pre><pre><code class="language-none">Hamiltonian Monte Carlo sample of length 1000
  acceptance rate mean: 0.93, min/25%/median/75%/max: 0.37 0.9 0.96 0.99 1.0
  termination: AdjacentTurn =&gt; 5% DoubledTurn =&gt; 95%
  depth: 3 =&gt; 6% 4 =&gt; 93% 5 =&gt; 0%
</code></pre><p>CmdStan result</p><pre><code class="language-julia">m_12_6_result = &quot;
Iterations = 1:1000
Thinning interval = 1
Chains = 1,2,3,4
Samples per chain = 1000

Empirical Posterior Estimates:
                            Mean                SD               Naive SE             MCSE            ESS
            a          1.076167468  0.7704872560 0.01218247319 0.0210530022 1000.000000
           bp         0.263056273  0.0823415805 0.00130193470 0.0022645077 1000.000000
  a_society.1   -0.191723568  0.2421382537 0.00382854195 0.0060563054 1000.000000
  a_society.2    0.054569029  0.2278506876 0.00360263570 0.0051693148 1000.000000
  a_society.3   -0.035935050  0.1926364647 0.00304584994 0.0039948433 1000.000000
  a_society.4    0.334355037  0.1929971201 0.00305155241 0.0063871707  913.029080
  a_society.5    0.049747513  0.1801287716 0.00284808595 0.0043631095 1000.000000
  a_society.6   -0.311903245  0.2096126337 0.00331426674 0.0053000536 1000.000000
  a_society.7    0.148637507  0.1744680594 0.00275858223 0.0047660246 1000.000000
  a_society.8   -0.164567976  0.1821341074 0.00287979309 0.0034297298 1000.000000
  a_society.9    0.277066965  0.1758237250 0.00278001719 0.0055844175  991.286501
 a_society.10   -0.094149204  0.2846206232 0.00450024719 0.0080735022 1000.000000
sigma_society    0.310352849  0.1374834682 0.00217380450 0.0057325226  575.187461
&quot;;</code></pre><pre><code class="language-none">&quot;\nIterations = 1:1000\nThinning interval = 1\nChains = 1,2,3,4\nSamples per chain = 1000\n\nEmpirical Posterior Estimates:\n                            Mean                SD               Naive SE             MCSE            ESS\n            a          1.076167468  0.7704872560 0.01218247319 0.0210530022 1000.000000\n           bp         0.263056273  0.0823415805 0.00130193470 0.0022645077 1000.000000\n  a_society.1   -0.191723568  0.2421382537 0.00382854195 0.0060563054 1000.000000\n  a_society.2    0.054569029  0.2278506876 0.00360263570 0.0051693148 1000.000000\n  a_society.3   -0.035935050  0.1926364647 0.00304584994 0.0039948433 1000.000000\n  a_society.4    0.334355037  0.1929971201 0.00305155241 0.0063871707  913.029080\n  a_society.5    0.049747513  0.1801287716 0.00284808595 0.0043631095 1000.000000\n  a_society.6   -0.311903245  0.2096126337 0.00331426674 0.0053000536 1000.000000\n  a_society.7    0.148637507  0.1744680594 0.00275858223 0.0047660246 1000.000000\n  a_society.8   -0.164567976  0.1821341074 0.00287979309 0.0034297298 1000.000000\n  a_society.9    0.277066965  0.1758237250 0.00278001719 0.0055844175  991.286501\n a_society.10   -0.094149204  0.2846206232 0.00450024719 0.0080735022 1000.000000\nsigma_society    0.310352849  0.1374834682 0.00217380450 0.0057325226  575.187461\n&quot;</code></pre><p>Show means</p><pre><code class="language-julia">[posterior_β, posterior_α, [posterior_σ]]</code></pre><pre><code class="language-none">3-element Array{Array{Float64,1},1}:
 [1.0997315056622963, 0.26045106714098887]                                                                                                                                                                             
 [-0.19332700635728245, 0.039501108999489824, -0.03735978678762831, 0.33289530484867935, 0.05412656423107555, -0.3109941556529881, 0.15073781780226284, -0.16702557804066942, 0.2800646910054289, -0.08144282350413952]
 [0.3081725406373706]                                                                                                                                                                                                  </code></pre><p>End of m12.6d.jl</p><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p><footer><hr/><a class="previous" href="../../10/m10.04d2/"><span class="direction">Previous</span><span class="title">m10.04d2</span></a><a class="next" href="../m12.6d1/"><span class="direction">Next</span><span class="title">m12.6d1</span></a></footer></article></body></html>
