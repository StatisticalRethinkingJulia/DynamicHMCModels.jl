<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>m12.6d · DynamicHMCModels.jl</title><link href="https://cdnjs.cloudflare.com/ajax/libs/normalize/4.2.0/normalize.min.css" rel="stylesheet" type="text/css"/><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.2.0/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link href="../../assets/documenter.css" rel="stylesheet" type="text/css"/></head><body><nav class="toc"><h1>DynamicHMCModels.jl</h1><select id="version-selector" onChange="window.location.href=this.value" style="visibility: hidden"></select><form class="search" id="search-form" action="../../search/"><input id="search-query" name="q" type="text" placeholder="Search docs"/></form><ul><li><a class="toctext" href="../../intro/">Home</a></li><li><span class="toctext">Chapter 02</span><ul><li><a class="toctext" href="../../02/m2.1d/">m2.1d</a></li></ul></li><li><span class="toctext">Chapter 04</span><ul><li><a class="toctext" href="../../04/m4.1d/">m4.1d</a></li><li><a class="toctext" href="../../04/m4.2d/">m4.2d</a></li><li><a class="toctext" href="../../04/m4.5d/">m4.5d</a></li></ul></li><li><span class="toctext">Chapter 05</span><ul><li><a class="toctext" href="../../05/m5.1d/">m5.1d</a></li><li><a class="toctext" href="../../05/m5.1d1/">m5.1d1</a></li><li><a class="toctext" href="../../05/m5.3d/">m5.3d</a></li><li><a class="toctext" href="../../05/m5.6d/">m5.6d</a></li></ul></li><li><span class="toctext">Chapter 08</span><ul><li><a class="toctext" href="../../08/m8.1d/">m8.1d</a></li></ul></li><li><span class="toctext">Chapter 10</span><ul><li><a class="toctext" href="../../10/m10.02d/">m10.02d</a></li><li><a class="toctext" href="../../10/m10.02d1/">m10.02d1</a></li><li><a class="toctext" href="../../10/m10.04d/">m10.04d</a></li><li><a class="toctext" href="../../10/m10.04d1/">m10.04d1</a></li><li><a class="toctext" href="../../10/m10.04d2/">m10.04d2</a></li></ul></li><li><span class="toctext">Chapter 12</span><ul><li class="current"><a class="toctext" href>m12.6d</a><ul class="internal"></ul></li><li><a class="toctext" href="../m12.6d1/">m12.6d1</a></li><li><a class="toctext" href="../m12.6d2/">m12.6d2</a></li></ul></li><li><a class="toctext" href="../../">Functions</a></li></ul></nav><article id="docs"><header><nav><ul><li>Chapter 12</li><li><a href>m12.6d</a></li></ul><a class="edit-page" href="https://github.com/StatisticalRethinkingJulia/DynamicHMCModels.jl/blob/master/scripts/12/m12.6d.jl"><span class="fa"></span> Edit on GitHub</a></nav><hr/><div id="topbar"><span>m12.6d</span><a class="fa fa-bars" href="#"></a></div></header><pre><code class="language-julia">using DynamicHMCModels

ProjDir = rel_path_d(&quot;..&quot;, &quot;scripts&quot;, &quot;12&quot;)

df = CSV.read(rel_path( &quot;..&quot;, &quot;data&quot;,  &quot;Kline.csv&quot;), delim=&#39;;&#39;);
size(df) # Should be 10x5</code></pre><pre><code class="language-none">(10, 5)</code></pre><p>New col logpop, set log() for population data</p><pre><code class="language-julia">df[:logpop] = map((x) -&gt; log(x), df[:population]);
df[:society] = 1:10;

first(df[[:total_tools, :logpop, :society]], 5)

struct m_12_06d_model{TY &lt;: AbstractVector, TX &lt;: AbstractMatrix,
  TS &lt;: AbstractVector}
    &quot;Observations (total_tools).&quot;
    y::TY
    &quot;Covariates (logpop)&quot;
    X::TX
    &quot;Society&quot;
    S::TS
    &quot;Number of observations (10)&quot;
    N::Int
    &quot;Number of societies (also 10)&quot;
    N_societies::Int
end</code></pre><p>Make the type callable with the parameters <em>as a single argument</em>.</p><pre><code class="language-julia">function (problem::m_12_06d_model)(θ)
    @unpack y, X, S, N, N_societies = problem   # extract the data
    @unpack β, α, σ = θ  # β : a, bp, α : a_society
    ll = 0.0
    ll += logpdf(Cauchy(0, 1), σ)
    ll += sum(logpdf.(Normal(0, σ), α)) # α[1:10]
    ll += logpdf.(Normal(0, 10), β[1]) # a
    ll += logpdf.(Normal(0, 1), β[2]) # a
    ll += sum(
      [loglikelihood(Poisson(exp(α[S[i]] + dot(X[i, :], β))), [y[i]]) for i in 1:N]
    )
    ll
end</code></pre><p>Instantiate the model with data and inits.</p><pre><code class="language-julia">N = size(df, 1)
N_societies = length(unique(df[:society]))
X = hcat(ones(Int64, N), df[:logpop]);
S = df[:society]
y = df[:total_tools]
p = m_12_06d_model(y, X, S, N, N_societies);
θ = (β = [1.0, 0.25], α = rand(Normal(0, 1), N_societies), σ = 0.2)
p(θ)</code></pre><pre><code class="language-none">-531.6130491820843</code></pre><p>Write a function to return properly dimensioned transformation.</p><pre><code class="language-julia">problem_transformation(p::m_12_06d_model) =
    as( (β = as(Array, size(p.X, 2)), α = as(Array, p.N_societies), σ = asℝ₊) )</code></pre><p>Wrap the problem with a transformation, then use Flux for the gradient.</p><pre><code class="language-julia">P = TransformedLogDensity(problem_transformation(p), p)
∇P = LogDensityRejectErrors(ADgradient(:ForwardDiff, P));
#∇P = ADgradient(:ForwardDiff, P);</code></pre><p>Tune and sample.</p><pre><code class="language-julia">chain, NUTS_tuned = NUTS_init_tune_mcmc(∇P, 1000);</code></pre><pre><code class="language-none">(NUTS_Transition{Array{Float64,1},Float64}[NUTS_Transition{Array{Float64,1},Float64}([1.3221691206186483, 0.2540442854255642, -0.5152535895236328, -0.3371999491426157, -0.04476668585386588, 0.31763936856049146, -0.042390027073283834, -0.6624099172020579, 0.07882659935551667, -0.2809160461820395, 0.11979927705157789, -0.3209958003927784, -1.176337446927818], -45.89501548580965, 3, DynamicHMC.AdjacentTurn, 0.8632780433401283, 15), NUTS_Transition{Array{Float64,1},Float64}([1.5192809117283144, 0.2134357618229347, -0.018438401556507306, -0.12028362660972795, 0.22346159572695945, 0.10779537001517495, 0.14643085802103267, -0.4602382146355661, 0.3238878933712088, -0.3454479946487094, 0.3463186365688615, -0.005580185636725785, -1.3634323199980911], -45.39054218614276, 4, DynamicHMC.DoubledTurn, 0.9818144029375254, 15), NUTS_Transition{Array{Float64,1},Float64}([0.9750686704498935, 0.28956859454531525, -0.4092113076676823, 0.06036890272206603, -0.038837870103134914, 0.18592213021192622, -0.006181868397964592, -0.20434862390225644, 0.1691284994455095, -0.1657029655356408, 0.21465984387603837, -0.32972785421673756, -1.773810525582747], -46.59434504683841, 4, DynamicHMC.DoubledTurn, 0.72845710816911, 15), NUTS_Transition{Array{Float64,1},Float64}([1.0415839413906829, 0.26112721886217, 0.15485463613885153, -0.07468383543328026, -0.014289874836037074, 0.2757286760728884, -0.007301005080002799, -0.2464330028448457, 0.21658876679092248, -0.07813128543162551, 0.086909436430447, -0.009029601273373482, -1.3424177819326617], -41.06400490375459, 4, DynamicHMC.DoubledTurn, 0.9926175123253335, 15), NUTS_Transition{Array{Float64,1},Float64}([2.442933508496638, 0.12105155147329325, 0.08617021576113405, -0.24437826487682895, -0.1880927034746143, -0.04015203216806615, -0.04389086973346491, -0.22072526195047049, -0.0668534447032372, -0.207769862782511, -0.08472002330865382, 0.16466795146831664, -1.5912592693931567], -49.046941448540174, 3, DynamicHMC.DoubledTurn, 0.7863112773761036, 7), NUTS_Transition{Array{Float64,1},Float64}([-1.1687394212334548, 0.49033198638249376, -0.2758348499893933, 0.35277670387067783, 0.1530733770335688, 0.959151979688372, 0.010664337188728428, -0.11572081775668089, 0.3929858340962559, -0.2648036939216284, 0.5493559194152999, -0.5559088666605536, -0.8798002585274207], -54.29113316073781, 4, DynamicHMC.DoubledTurn, 0.9363995075752715, 15), NUTS_Transition{Array{Float64,1},Float64}([2.6314951958567754, 0.12259236591405268, -0.34501793607498427, -0.14089057919700235, 0.006224245835443704, -0.044432163170158995, 0.1767118321471279, -0.5155532058829343, -0.12420811552167095, -0.21869265247833045, -0.11704227086766059, 0.1607284063665641, -1.3896767804336745], -53.313021795899196, 4, DynamicHMC.DoubledTurn, 0.8141573356029689, 15), NUTS_Transition{Array{Float64,1},Float64}([0.6253879659264996, 0.29819244970059805, -0.26453223108232327, 0.28756735877746215, 0.1402703752074231, 0.6501842585190171, 0.19099099440503867, -0.061807530180237616, 0.44200174626104477, -0.06527969374249071, 0.76195769925599, 0.1270722933981148, -0.9022210013571212], -54.75263227524292, 3, DynamicHMC.AdjacentTurn, 0.8834000098353935, 15), NUTS_Transition{Array{Float64,1},Float64}([2.1964063758375083, 0.10936947111780984, -0.6282637826229306, 0.20244502667288541, 0.005873497364868259, 0.645981410340042, 0.3250444971958787, -0.1597452271347877, 0.4152020916617686, 0.10105753840237144, 0.42442830056419945, 0.5039556448559191, -0.5425826088471037], -47.645312723366104, 4, DynamicHMC.DoubledTurn, 1.0, 15), NUTS_Transition{Array{Float64,1},Float64}([2.1176921773728745, 0.1297315055916405, -0.5719685903732383, 0.20475038959385367, 0.013257137640520378, 0.6592311652614691, 0.3746576033831525, -0.16715917660035762, 0.4567475659694754, 0.045015949181646774, 0.4470339219803113, 0.42424276897076596, -0.5128840704740155], -47.74314167407611, 4, DynamicHMC.DoubledTurn, 0.9478190775842934, 15)  …  NUTS_Transition{Array{Float64,1},Float64}([1.0110668688969366, 0.2762212112952759, -0.19618313845443175, -0.16334577633008251, -0.10509073872861564, 0.3651484773922324, -0.12490354572035722, -0.6359985333227323, -0.17560059746266063, -0.4316157152420477, 0.40333819369743484, -0.32201271449137436, -1.1442026527339195], -44.68254114987099, 4, DynamicHMC.DoubledTurn, 0.92760784269409, 15), NUTS_Transition{Array{Float64,1},Float64}([1.6591097106539012, 0.21397403398149578, -0.14635621842929827, -0.21767879391390416, -0.07646555714334077, 0.3106939817430327, -0.09012079542590182, -0.26630973460532414, 0.1732661105188935, 0.017552183866611976, 0.17946964319336728, -0.0189880717251006, -1.4631993256841833], -43.762887686187575, 4, DynamicHMC.DoubledTurn, 0.9852822028402453, 15), NUTS_Transition{Array{Float64,1},Float64}([0.33593139492539437, 0.3340520373730195, -0.1848787092864666, 0.037438366698087186, -0.08320777216751131, 0.3536196559563343, 0.11544375418589184, -0.197920973581793, 0.057513656978654015, -0.18706173606465454, 0.3012995652120396, -0.23757298856081294, -1.6699041388172924], -39.687773845325005, 4, DynamicHMC.DoubledTurn, 0.9995549478408947, 15), NUTS_Transition{Array{Float64,1},Float64}([1.3913511376832322, 0.23327388325476045, -0.02877367182485817, 0.29009467634849045, 0.012183129428593925, 0.3294548668020447, 0.037326244562922675, -0.4563296528104001, -0.08287536463831112, -0.2852244543281944, 0.38117774904937723, -0.059883067950194935, -1.1408723299187826], -41.08742772765516, 4, DynamicHMC.DoubledTurn, 0.9878640748567775, 15), NUTS_Transition{Array{Float64,1},Float64}([1.067593320128565, 0.24534954772920786, -0.320170677720706, -0.1804901432106399, 0.00409575660127463, 0.507624504794708, -0.04305630122855973, -0.1717536460724865, 0.47169535546252345, -0.0573217586221582, 0.3246404583667545, 0.11461967662209346, -1.0224671812481902], -48.48459006303852, 4, DynamicHMC.DoubledTurn, 0.7153396948286118, 15), NUTS_Transition{Array{Float64,1},Float64}([1.5956165044040107, 0.21105556668678546, -0.3661455138910078, 0.16387936554866767, -0.07221443507321451, 0.1618978617426508, 0.14111394048666429, -0.5755798271325396, -0.08146689591183334, -0.1837307721758823, 0.32758163965666404, -0.02364907159428771, -1.293279160875259], -46.54058098680156, 4, DynamicHMC.DoubledTurn, 0.9500588240672111, 15), NUTS_Transition{Array{Float64,1},Float64}([0.3569247125598797, 0.33653595679229553, 0.020542893116407442, -0.11797099869930858, -0.15031112698094454, 0.3574284681262258, 0.04296945822980695, -0.10803821349726465, 0.3720604880795308, -0.1519006686796058, 0.20783254918197103, -0.33606118078245784, -1.4804533746214135], -41.636977700151775, 4, DynamicHMC.DoubledTurn, 0.8653940040110157, 15), NUTS_Transition{Array{Float64,1},Float64}([0.7109172772721559, 0.30059961275143576, 0.05178807671098012, 0.3225744863387085, 0.21641075396447326, 0.18342679738755446, 0.1419582167262731, -0.6273671887294201, -0.09628216203514772, -0.027365569160601816, 0.32926106949994716, -0.3002018878325685, -1.1674447916122812], -47.43716866670293, 4, DynamicHMC.DoubledTurn, 0.9719097758942683, 15), NUTS_Transition{Array{Float64,1},Float64}([1.2453753911830965, 0.24011629709963184, -0.1584034173735469, 0.007926775274014086, 0.06807428159867548, 0.26510155448591954, 0.04004810085370937, -0.44247709531054913, 0.14494647832221563, -0.23346954931547947, 0.38457131227122854, -0.026629698345359526, -0.9601956850788651], -42.40550301908597, 3, DynamicHMC.DoubledTurn, 1.0, 7), NUTS_Transition{Array{Float64,1},Float64}([1.0790443732902608, 0.27952134522540123, 0.2525312905461934, -0.02805160783314585, -0.10871243163193862, 0.1486867129832687, 0.1363645979775976, -0.5261291506344578, 0.02782444434905984, -0.4476166311666815, 0.1509288502353974, -0.2200038881657438, -1.0811983336318869], -43.46053619085038, 3, DynamicHMC.DoubledTurn, 0.9360380629467461, 7)], NUTS sampler in 13 dimensions
  stepsize (ϵ) ≈ 0.246
  maximum depth = 10
  Gaussian kinetic energy, √diag(M⁻¹): [0.7930083832102484, 0.08743029379223426, 0.25838442422343655, 0.21422678997792446, 0.20319293300648802, 0.20664726534551445, 0.18170706558807156, 0.21468466667399547, 0.17410701251415409, 0.18593216868759657, 0.1668689251098207, 0.2949052562894276, 0.39444495401492763]
)</code></pre><p>We use the transformation to obtain the posterior from the chain.</p><pre><code class="language-julia">posterior = TransformVariables.transform.(Ref(problem_transformation(p)), get_position.(chain));
posterior[1:5]</code></pre><pre><code class="language-none">5-element Array{NamedTuple{(:β, :α, :σ),Tuple{Array{Float64,1},Array{Float64,1},Float64}},1}:
 (β = [1.3221691206186483, 0.2540442854255642], α = [-0.5152535895236328, -0.3371999491426157, -0.04476668585386588, 0.31763936856049146, -0.042390027073283834, -0.6624099172020579, 0.07882659935551667, -0.2809160461820395, 0.11979927705157789, -0.3209958003927784], σ = 0.3084062267714708)   
 (β = [1.5192809117283144, 0.2134357618229347], α = [-0.018438401556507306, -0.12028362660972795, 0.22346159572695945, 0.10779537001517495, 0.14643085802103267, -0.4602382146355661, 0.3238878933712088, -0.3454479946487094, 0.3463186365688615, -0.005580185636725785], σ = 0.25578134514515294)  
 (β = [0.9750686704498935, 0.28956859454531525], α = [-0.4092113076676823, 0.06036890272206603, -0.038837870103134914, 0.18592213021192622, -0.006181868397964592, -0.20434862390225644, 0.1691284994455095, -0.1657029655356408, 0.21465984387603837, -0.32972785421673756], σ = 0.1696851656711272)
 (β = [1.0415839413906829, 0.26112721886217], α = [0.15485463613885153, -0.07468383543328026, -0.014289874836037074, 0.2757286760728884, -0.007301005080002799, -0.2464330028448457, 0.21658876679092248, -0.07813128543162551, 0.086909436430447, -0.009029601273373482], σ = 0.2612133475688736)   
 (β = [2.442933508496638, 0.12105155147329325], α = [0.08617021576113405, -0.24437826487682895, -0.1880927034746143, -0.04015203216806615, -0.04389086973346491, -0.22072526195047049, -0.0668534447032372, -0.207769862782511, -0.08472002330865382, 0.16466795146831664], σ = 0.2036689760735057)  </code></pre><p>Extract the parameter posterior means.</p><pre><code class="language-julia">posterior_β = mean(posterior[i].β for i in 1:length(posterior))
posterior_α = mean(posterior[i].α for i in 1:length(posterior))
posterior_σ = mean(posterior[i].σ for i in 1:length(posterior))</code></pre><pre><code class="language-none">0.31763015674030287</code></pre><p>Effective sample sizes (of untransformed draws)</p><pre><code class="language-julia">ess = mapslices(effective_sample_size, get_position_matrix(chain); dims = 1)
ess</code></pre><pre><code class="language-none">1×13 Array{Float64,2}:
 900.382  781.707  1000.0  1000.0  …  1000.0  737.568  616.241  541.841</code></pre><p>NUTS-specific statistics</p><pre><code class="language-julia">NUTS_statistics(chain)</code></pre><pre><code class="language-none">Hamiltonian Monte Carlo sample of length 1000
  acceptance rate mean: 0.92, min/25%/median/75%/max: 0.41 0.88 0.95 0.99 1.0
  termination: AdjacentTurn =&gt; 4% DoubledTurn =&gt; 96%
  depth: 2 =&gt; 0% 3 =&gt; 7% 4 =&gt; 93% 5 =&gt; 0%
</code></pre><p>CmdStan result</p><pre><code class="language-julia">m_12_6_result = &quot;
Iterations = 1:1000
Thinning interval = 1
Chains = 1,2,3,4
Samples per chain = 1000

Empirical Posterior Estimates:
                            Mean                SD               Naive SE             MCSE            ESS
            a          1.076167468  0.7704872560 0.01218247319 0.0210530022 1000.000000
           bp         0.263056273  0.0823415805 0.00130193470 0.0022645077 1000.000000
  a_society.1   -0.191723568  0.2421382537 0.00382854195 0.0060563054 1000.000000
  a_society.2    0.054569029  0.2278506876 0.00360263570 0.0051693148 1000.000000
  a_society.3   -0.035935050  0.1926364647 0.00304584994 0.0039948433 1000.000000
  a_society.4    0.334355037  0.1929971201 0.00305155241 0.0063871707  913.029080
  a_society.5    0.049747513  0.1801287716 0.00284808595 0.0043631095 1000.000000
  a_society.6   -0.311903245  0.2096126337 0.00331426674 0.0053000536 1000.000000
  a_society.7    0.148637507  0.1744680594 0.00275858223 0.0047660246 1000.000000
  a_society.8   -0.164567976  0.1821341074 0.00287979309 0.0034297298 1000.000000
  a_society.9    0.277066965  0.1758237250 0.00278001719 0.0055844175  991.286501
 a_society.10   -0.094149204  0.2846206232 0.00450024719 0.0080735022 1000.000000
sigma_society    0.310352849  0.1374834682 0.00217380450 0.0057325226  575.187461
&quot;;</code></pre><pre><code class="language-none">&quot;\nIterations = 1:1000\nThinning interval = 1\nChains = 1,2,3,4\nSamples per chain = 1000\n\nEmpirical Posterior Estimates:\n                            Mean                SD               Naive SE             MCSE            ESS\n            a          1.076167468  0.7704872560 0.01218247319 0.0210530022 1000.000000\n           bp         0.263056273  0.0823415805 0.00130193470 0.0022645077 1000.000000\n  a_society.1   -0.191723568  0.2421382537 0.00382854195 0.0060563054 1000.000000\n  a_society.2    0.054569029  0.2278506876 0.00360263570 0.0051693148 1000.000000\n  a_society.3   -0.035935050  0.1926364647 0.00304584994 0.0039948433 1000.000000\n  a_society.4    0.334355037  0.1929971201 0.00305155241 0.0063871707  913.029080\n  a_society.5    0.049747513  0.1801287716 0.00284808595 0.0043631095 1000.000000\n  a_society.6   -0.311903245  0.2096126337 0.00331426674 0.0053000536 1000.000000\n  a_society.7    0.148637507  0.1744680594 0.00275858223 0.0047660246 1000.000000\n  a_society.8   -0.164567976  0.1821341074 0.00287979309 0.0034297298 1000.000000\n  a_society.9    0.277066965  0.1758237250 0.00278001719 0.0055844175  991.286501\n a_society.10   -0.094149204  0.2846206232 0.00450024719 0.0080735022 1000.000000\nsigma_society    0.310352849  0.1374834682 0.00217380450 0.0057325226  575.187461\n&quot;</code></pre><p>Show means</p><pre><code class="language-julia">[posterior_β, posterior_α, [posterior_σ]]</code></pre><pre><code class="language-none">3-element Array{Array{Float64,1},1}:
 [1.1202790282876234, 0.2583950622850252]                                                                                                                                                                               
 [-0.20837166363458987, 0.03782004526517977, -0.04138515932868199, 0.34242756987767353, 0.048007527702139764, -0.32840817514431514, 0.15081807270143396, -0.1736936673827441, 0.28218378120745163, -0.09096057814451719]
 [0.31763015674030287]                                                                                                                                                                                                  </code></pre><p>End of m12.6d.jl</p><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p><footer><hr/><a class="previous" href="../../10/m10.04d2/"><span class="direction">Previous</span><span class="title">m10.04d2</span></a><a class="next" href="../m12.6d1/"><span class="direction">Next</span><span class="title">m12.6d1</span></a></footer></article></body></html>
