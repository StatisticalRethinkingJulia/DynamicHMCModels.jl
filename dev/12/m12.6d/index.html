<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>m12.6d · DynamicHMCModels.jl</title><link href="https://cdnjs.cloudflare.com/ajax/libs/normalize/4.2.0/normalize.min.css" rel="stylesheet" type="text/css"/><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.2.0/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link href="../../assets/documenter.css" rel="stylesheet" type="text/css"/></head><body><nav class="toc"><h1>DynamicHMCModels.jl</h1><select id="version-selector" onChange="window.location.href=this.value" style="visibility: hidden"></select><form class="search" id="search-form" action="../../search/"><input id="search-query" name="q" type="text" placeholder="Search docs"/></form><ul><li><a class="toctext" href="../../intro/">Home</a></li><li><span class="toctext">Chapter 02</span><ul><li><a class="toctext" href="../../02/m2.1d/">m2.1d</a></li></ul></li><li><span class="toctext">Chapter 04</span><ul><li><a class="toctext" href="../../04/m4.1d/">m4.1d</a></li><li><a class="toctext" href="../../04/m4.2d/">m4.2d</a></li><li><a class="toctext" href="../../04/m4.5d/">m4.5d</a></li></ul></li><li><span class="toctext">Chapter 05</span><ul><li><a class="toctext" href="../../05/m5.1d/">m5.1d</a></li><li><a class="toctext" href="../../05/m5.1d1/">m5.1d1</a></li><li><a class="toctext" href="../../05/m5.3d/">m5.3d</a></li><li><a class="toctext" href="../../05/m5.6d/">m5.6d</a></li></ul></li><li><span class="toctext">Chapter 08</span><ul><li><a class="toctext" href="../../08/m8.1d/">m8.1d</a></li></ul></li><li><span class="toctext">Chapter 10</span><ul><li><a class="toctext" href="../../10/m10.02d/">m10.02d</a></li><li><a class="toctext" href="../../10/m10.02d1/">m10.02d1</a></li><li><a class="toctext" href="../../10/m10.04d/">m10.04d</a></li><li><a class="toctext" href="../../10/m10.04d1/">m10.04d1</a></li><li><a class="toctext" href="../../10/m10.04d2/">m10.04d2</a></li></ul></li><li><span class="toctext">Chapter 12</span><ul><li class="current"><a class="toctext" href>m12.6d</a><ul class="internal"></ul></li><li><a class="toctext" href="../m12.6d1/">m12.6d1</a></li><li><a class="toctext" href="../m12.6d2/">m12.6d2</a></li></ul></li><li><a class="toctext" href="../../">Functions</a></li></ul></nav><article id="docs"><header><nav><ul><li>Chapter 12</li><li><a href>m12.6d</a></li></ul><a class="edit-page" href="https://github.com/StatisticalRethinkingJulia/DynamicHMCModels.jl/blob/master/scripts/12/m12.6d.jl"><span class="fa"></span> Edit on GitHub</a></nav><hr/><div id="topbar"><span>m12.6d</span><a class="fa fa-bars" href="#"></a></div></header><pre><code class="language-julia">using DynamicHMCModels

ProjDir = rel_path_d(&quot;..&quot;, &quot;scripts&quot;, &quot;12&quot;)

df = CSV.read(rel_path( &quot;..&quot;, &quot;data&quot;,  &quot;Kline.csv&quot;), delim=&#39;;&#39;);
size(df) # Should be 10x5</code></pre><pre><code class="language-none">(10, 5)</code></pre><p>New col logpop, set log() for population data</p><pre><code class="language-julia">df[:logpop] = map((x) -&gt; log(x), df[:population]);
df[:society] = 1:10;

first(df[[:total_tools, :logpop, :society]], 5)

struct m_12_06d_model{TY &lt;: AbstractVector, TX &lt;: AbstractMatrix,
  TS &lt;: AbstractVector}
    &quot;Observations (total_tools).&quot;
    y::TY
    &quot;Covariates (logpop)&quot;
    X::TX
    &quot;Society&quot;
    S::TS
    &quot;Number of observations (10)&quot;
    N::Int
    &quot;Number of societies (also 10)&quot;
    N_societies::Int
end</code></pre><p>Make the type callable with the parameters <em>as a single argument</em>.</p><pre><code class="language-julia">function (problem::m_12_06d_model)(θ)
    @unpack y, X, S, N, N_societies = problem   # extract the data
    @unpack β, α, σ = θ  # β : a, bp, α : a_society
    ll = 0.0
    ll += logpdf(Cauchy(0, 1), σ)
    ll += sum(logpdf.(Normal(0, σ), α)) # α[1:10]
    ll += logpdf.(Normal(0, 10), β[1]) # a
    ll += logpdf.(Normal(0, 1), β[2]) # a
    ll += sum(
      [loglikelihood(Poisson(exp(α[S[i]] + dot(X[i, :], β))), [y[i]]) for i in 1:N]
    )
    ll
end</code></pre><p>Instantiate the model with data and inits.</p><pre><code class="language-julia">N = size(df, 1)
N_societies = length(unique(df[:society]))
X = hcat(ones(Int64, N), df[:logpop]);
S = df[:society]
y = df[:total_tools]
p = m_12_06d_model(y, X, S, N, N_societies);
θ = (β = [1.0, 0.25], α = rand(Normal(0, 1), N_societies), σ = 0.2)
p(θ)</code></pre><pre><code class="language-none">-826.3216982667884</code></pre><p>Write a function to return properly dimensioned transformation.</p><pre><code class="language-julia">problem_transformation(p::m_12_06d_model) =
    as( (β = as(Array, size(p.X, 2)), α = as(Array, p.N_societies), σ = asℝ₊) )</code></pre><p>Wrap the problem with a transformation, then use Flux for the gradient.</p><pre><code class="language-julia">P = TransformedLogDensity(problem_transformation(p), p)
∇P = LogDensityRejectErrors(ADgradient(:ForwardDiff, P));
#∇P = ADgradient(:ForwardDiff, P);</code></pre><p>Tune and sample.</p><pre><code class="language-julia">chain, NUTS_tuned = NUTS_init_tune_mcmc(∇P, 1000);</code></pre><pre><code class="language-none">(NUTS_Transition{Array{Float64,1},Float64}[NUTS_Transition{Array{Float64,1},Float64}([2.3726359611718433, 0.1185857717533395, -0.09803931991410986, -0.09960515386842045, -0.20034599987420124, -0.012896943602377664, 0.0557339017114281, -0.488034117221538, 0.11354473056990796, 0.04464974998161498, 0.36944419779005533, 0.48094484763277906, -0.7209106624788513], -50.288948498991296, 4, DynamicHMC.DoubledTurn, 0.9425194441930587, 15), NUTS_Transition{Array{Float64,1},Float64}([1.968874613836512, 0.1596645840022979, -0.10390023362249143, -0.13562079097959362, -0.13116170131167318, -0.004924057089946327, -0.19890311103316843, -0.37296315281193665, 0.11530366780463629, -0.16927102937097077, 0.270606907293998, 0.5607350838820453, -0.9065334760872545], -49.87628766858538, 4, DynamicHMC.DoubledTurn, 0.9649606395221902, 15), NUTS_Transition{Array{Float64,1},Float64}([0.7255723028215171, 0.2719703440372114, -0.5116548490987268, 0.31270141853587763, 0.2614342837370167, 1.0508728090527346, 0.5989508105620293, -0.2392331886610819, 0.47479504908543024, 0.03328239813371163, 0.7723077814795044, -0.04537924527895906, -0.8323347826819469], -52.17950090601449, 4, DynamicHMC.DoubledTurn, 0.9859291945014433, 15), NUTS_Transition{Array{Float64,1},Float64}([0.9154045174564929, 0.2655559956653036, -0.2872798957523335, 0.17255651933916819, 0.16882838483846851, 0.6409404352015653, 0.49783885642549924, -0.35832208501639, 0.2081453156592855, -0.1279325046976283, 0.4373535827905395, -0.2700250770845891, -1.038547675077489], -51.51723978276268, 3, DynamicHMC.AdjacentTurn, 0.9110712983276428, 15), NUTS_Transition{Array{Float64,1},Float64}([0.571304758340093, 0.31465711945627445, -0.2578651833567303, 0.1104058490478525, 0.08431546328348266, 0.7202511187719627, 0.2567737846182635, -0.04016346740763442, 0.27223961704830524, -0.08503922834433619, 0.35131554113419333, -0.359891631825838, -1.060486099972068], -45.36520676550171, 4, DynamicHMC.DoubledTurn, 1.0, 15), NUTS_Transition{Array{Float64,1},Float64}([1.1914938510163544, 0.21792041540465315, -0.1316106303246922, -0.03203701349758027, 0.1501477698759571, 0.6024791941292063, 0.4226046800374215, -0.21949543263645893, 0.38857614400268725, 0.18251071889453296, 0.7298388071896732, 0.46718280365479237, -0.6033461024392024], -46.86139755413734, 4, DynamicHMC.DoubledTurn, 0.9529347990711038, 15), NUTS_Transition{Array{Float64,1},Float64}([1.4680220361958671, 0.19219903747402223, 0.03578589830379526, -0.13748052782571385, 0.2598159355499579, 0.6491266187642903, 0.16637205255359033, -0.2857254577744485, 0.2856080891709599, 0.042498649834398064, 0.5467422384446141, 0.5564218921955657, -1.319183076068429], -48.63371798552404, 4, DynamicHMC.DoubledTurn, 0.9695218284624612, 15), NUTS_Transition{Array{Float64,1},Float64}([1.1537464333307346, 0.23827135683365108, -0.003437717085460982, 0.08504330770425651, 0.12328671889768364, 0.6454840088838112, 0.28722268298813963, -0.32038768913466514, 0.1970186110716937, -0.36752858827189355, 0.49248697535034297, 0.18972735477814723, -0.5351928063645838], -46.714605729587035, 4, DynamicHMC.DoubledTurn, 1.0, 15), NUTS_Transition{Array{Float64,1},Float64}([2.6813526165666355, 0.10011828557280879, -0.39659695597796674, -0.5100706218115816, -0.004007379890770074, 0.11365926891779907, -0.06720477434995471, -0.30531487856372724, -0.01968198391765674, -0.3842629546967606, 0.2242658849087155, 0.31288550655029623, -1.4771432496520165], -45.403526351630276, 4, DynamicHMC.DoubledTurn, 0.9970063445038497, 15), NUTS_Transition{Array{Float64,1},Float64}([1.9778836837633809, 0.17562445306152596, -0.4699492590542115, -0.4306280381753537, 0.10156345042006318, 0.19031304211264022, 0.018224270913623736, -0.43308440089876743, 0.12457610644133543, -0.42794753603919355, 0.23684014482103388, 0.0503998144138986, -1.206188974065013], -45.789870050510125, 4, DynamicHMC.DoubledTurn, 0.8122957518308593, 15)  …  NUTS_Transition{Array{Float64,1},Float64}([1.1161799551296587, 0.2458180499046431, -0.231600571755822, 0.0076683462290563845, 0.2321929435366118, 0.46641655757444733, 0.43718180604438756, 0.17024393068687033, 0.48297555246408186, -0.08073516405739378, 0.502629289244161, 0.043119093970465726, -0.5953855707771759], -55.57571855853723, 4, DynamicHMC.DoubledTurn, 1.0, 15), NUTS_Transition{Array{Float64,1},Float64}([1.7794798250789554, 0.16410586060386229, -0.3154416058217478, -0.22489149247725423, 0.18442811411598392, 0.48490591846910597, 0.2105478741626049, -0.09085409092420595, 0.1847154482451135, -0.1010538247807013, 0.7246805620081431, 0.24703916646261237, -0.5903801833368354], -50.167133150036086, 4, DynamicHMC.DoubledTurn, 0.9990268949342589, 15), NUTS_Transition{Array{Float64,1},Float64}([1.7339204891307838, 0.17845550396531915, -0.4645047254704906, -0.24029216782091758, 0.08012980309269656, 0.45347938182100483, 0.23602389192137152, -0.23765380570652314, 0.34003627235158856, -0.06144611862771314, 0.8761136512220474, 0.2667952526594072, -0.3884774259925477], -48.106875444525684, 4, DynamicHMC.DoubledTurn, 0.9751433260807152, 15), NUTS_Transition{Array{Float64,1},Float64}([0.7777393089147436, 0.2983251980841163, 0.1193489381571554, 0.08022425188772181, -0.0990248380626535, 0.25658809536644217, 0.08809570180635963, -0.3208958169560132, 0.18387327734112163, -0.14741756937587708, -0.13263380206050113, -0.1720838254936222, -1.9477753190367215], -49.335246453253916, 4, DynamicHMC.DoubledTurn, 0.9844975541035353, 15), NUTS_Transition{Array{Float64,1},Float64}([2.098573505625168, 0.13898024052620664, -0.4856690004207299, 0.03254501204846996, 0.007834529833486703, 0.17960100674155374, 0.07828153890639304, -0.24227330320822477, 0.22302206211617095, -0.10777403056147442, 0.7404428508621497, 0.4894822870593937, -0.6011828563340534], -47.84681130122999, 4, DynamicHMC.DoubledTurn, 0.8460275113866732, 15), NUTS_Transition{Array{Float64,1},Float64}([1.0360874185611662, 0.2646999444523891, 0.22511209688619704, -0.17517404726317382, -0.09614922043798194, 0.3911886885115874, -0.1720056115895815, -0.30261798719931876, 0.16636009880005923, 0.06806074358155537, 0.09966963955316356, -0.2677435861865919, -1.808876273420522], -47.73151535379222, 4, DynamicHMC.DoubledTurn, 0.8828410083580622, 15), NUTS_Transition{Array{Float64,1},Float64}([1.609950635852578, 0.18839764214332447, -0.6496547709945882, 0.3726181162065611, 0.027416382573211755, 0.4446534109198143, 0.5393186437937735, -0.15594480266178168, 0.05915846509846296, -0.4319591509658391, 0.545339141804195, 0.44913061182630054, -0.44829862349206623], -52.3578865477886, 4, DynamicHMC.DoubledTurn, 0.945273146323233, 15), NUTS_Transition{Array{Float64,1},Float64}([2.20700319776049, 0.1365553289052524, -0.5168426839969177, -0.17478848882091014, -0.5064957407668879, 0.545106355572983, -0.20230358050871303, -0.20055487292590354, 0.03006495512278974, -0.11656869110067741, 0.19013893806769594, 0.13387408812182297, -1.3117626425394322], -55.13250366388232, 4, DynamicHMC.DoubledTurn, 0.7893874960295797, 15), NUTS_Transition{Array{Float64,1},Float64}([2.092486786112864, 0.16223022915843172, -0.551575358613535, -0.2523852729894251, -0.3131908415762608, 0.6097008166857398, -0.13400510403540056, -0.3654653322068052, 0.029667059142617646, -0.22956832213329265, 0.1790345394736613, 0.16129873918308235, -1.1837465304835924], -49.56086789982049, 4, DynamicHMC.DoubledTurn, 0.9998701242121425, 15), NUTS_Transition{Array{Float64,1},Float64}([1.0514607023886098, 0.27971775053250775, -0.14418565166004865, 0.049635437347846936, -0.015568880817032643, 0.16964732776576474, 0.17948701424481756, -0.4741224718694249, 0.16747731376433383, -0.34681415412437716, 0.35243025800534633, -0.1633163600330793, -1.4098475521988652], -43.87165274737551, 4, DynamicHMC.DoubledTurn, 0.8459090231045562, 15)], NUTS sampler in 13 dimensions
  stepsize (ϵ) ≈ 0.235
  maximum depth = 10
  Gaussian kinetic energy, √diag(M⁻¹): [0.7106936152812785, 0.08069965418590629, 0.22878488835555133, 0.22109937172509347, 0.20182274212516194, 0.1944976522429952, 0.1673889485927187, 0.22250136118769498, 0.17787091461531299, 0.17899838983593713, 0.18036120582895782, 0.294592916520477, 0.4134800636763586]
)</code></pre><p>We use the transformation to obtain the posterior from the chain.</p><pre><code class="language-julia">posterior = TransformVariables.transform.(Ref(problem_transformation(p)), get_position.(chain));
posterior[1:5]</code></pre><pre><code class="language-none">5-element Array{NamedTuple{(:β, :α, :σ),Tuple{Array{Float64,1},Array{Float64,1},Float64}},1}:
 (β = [2.3726359611718433, 0.1185857717533395], α = [-0.09803931991410986, -0.09960515386842045, -0.20034599987420124, -0.012896943602377664, 0.0557339017114281, -0.488034117221538, 0.11354473056990796, 0.04464974998161498, 0.36944419779005533, 0.48094484763277906], σ = 0.48630919071603906)
 (β = [1.968874613836512, 0.1596645840022979], α = [-0.10390023362249143, -0.13562079097959362, -0.13116170131167318, -0.004924057089946327, -0.19890311103316843, -0.37296315281193665, 0.11530366780463629, -0.16927102937097077, 0.270606907293998, 0.5607350838820453], σ = 0.4039220052028955)
 (β = [0.7255723028215171, 0.2719703440372114], α = [-0.5116548490987268, 0.31270141853587763, 0.2614342837370167, 1.0508728090527346, 0.5989508105620293, -0.2392331886610819, 0.47479504908543024, 0.03328239813371163, 0.7723077814795044, -0.04537924527895906], σ = 0.4350323935730873)       
 (β = [0.9154045174564929, 0.2655559956653036], α = [-0.2872798957523335, 0.17255651933916819, 0.16882838483846851, 0.6409404352015653, 0.49783885642549924, -0.35832208501639, 0.2081453156592855, -0.1279325046976283, 0.4373535827905395, -0.2700250770845891], σ = 0.35396838594462376)        
 (β = [0.571304758340093, 0.31465711945627445], α = [-0.2578651833567303, 0.1104058490478525, 0.08431546328348266, 0.7202511187719627, 0.2567737846182635, -0.04016346740763442, 0.27223961704830524, -0.08503922834433619, 0.35131554113419333, -0.359891631825838], σ = 0.34628743909627463)     </code></pre><p>Extract the parameter posterior means.</p><pre><code class="language-julia">posterior_β = mean(posterior[i].β for i in 1:length(posterior))
posterior_α = mean(posterior[i].α for i in 1:length(posterior))
posterior_σ = mean(posterior[i].σ for i in 1:length(posterior))</code></pre><pre><code class="language-none">0.3095890810700937</code></pre><p>Effective sample sizes (of untransformed draws)</p><pre><code class="language-julia">ess = mapslices(effective_sample_size, get_position_matrix(chain); dims = 1)
ess</code></pre><pre><code class="language-none">1×13 Array{Float64,2}:
 1000.0  1000.0  806.134  733.998  …  761.042  888.722  1000.0  405.425</code></pre><p>NUTS-specific statistics</p><pre><code class="language-julia">NUTS_statistics(chain)</code></pre><pre><code class="language-none">Hamiltonian Monte Carlo sample of length 1000
  acceptance rate mean: 0.93, min/25%/median/75%/max: 0.46 0.9 0.96 0.99 1.0
  termination: AdjacentTurn =&gt; 4% DoubledTurn =&gt; 96%
  depth: 2 =&gt; 0% 3 =&gt; 6% 4 =&gt; 94% 5 =&gt; 0%
</code></pre><p>CmdStan result</p><pre><code class="language-julia">m_12_6_result = &quot;
Iterations = 1:1000
Thinning interval = 1
Chains = 1,2,3,4
Samples per chain = 1000

Empirical Posterior Estimates:
                            Mean                SD               Naive SE             MCSE            ESS
            a          1.076167468  0.7704872560 0.01218247319 0.0210530022 1000.000000
           bp         0.263056273  0.0823415805 0.00130193470 0.0022645077 1000.000000
  a_society.1   -0.191723568  0.2421382537 0.00382854195 0.0060563054 1000.000000
  a_society.2    0.054569029  0.2278506876 0.00360263570 0.0051693148 1000.000000
  a_society.3   -0.035935050  0.1926364647 0.00304584994 0.0039948433 1000.000000
  a_society.4    0.334355037  0.1929971201 0.00305155241 0.0063871707  913.029080
  a_society.5    0.049747513  0.1801287716 0.00284808595 0.0043631095 1000.000000
  a_society.6   -0.311903245  0.2096126337 0.00331426674 0.0053000536 1000.000000
  a_society.7    0.148637507  0.1744680594 0.00275858223 0.0047660246 1000.000000
  a_society.8   -0.164567976  0.1821341074 0.00287979309 0.0034297298 1000.000000
  a_society.9    0.277066965  0.1758237250 0.00278001719 0.0055844175  991.286501
 a_society.10   -0.094149204  0.2846206232 0.00450024719 0.0080735022 1000.000000
sigma_society    0.310352849  0.1374834682 0.00217380450 0.0057325226  575.187461
&quot;;</code></pre><pre><code class="language-none">&quot;\nIterations = 1:1000\nThinning interval = 1\nChains = 1,2,3,4\nSamples per chain = 1000\n\nEmpirical Posterior Estimates:\n                            Mean                SD               Naive SE             MCSE            ESS\n            a          1.076167468  0.7704872560 0.01218247319 0.0210530022 1000.000000\n           bp         0.263056273  0.0823415805 0.00130193470 0.0022645077 1000.000000\n  a_society.1   -0.191723568  0.2421382537 0.00382854195 0.0060563054 1000.000000\n  a_society.2    0.054569029  0.2278506876 0.00360263570 0.0051693148 1000.000000\n  a_society.3   -0.035935050  0.1926364647 0.00304584994 0.0039948433 1000.000000\n  a_society.4    0.334355037  0.1929971201 0.00305155241 0.0063871707  913.029080\n  a_society.5    0.049747513  0.1801287716 0.00284808595 0.0043631095 1000.000000\n  a_society.6   -0.311903245  0.2096126337 0.00331426674 0.0053000536 1000.000000\n  a_society.7    0.148637507  0.1744680594 0.00275858223 0.0047660246 1000.000000\n  a_society.8   -0.164567976  0.1821341074 0.00287979309 0.0034297298 1000.000000\n  a_society.9    0.277066965  0.1758237250 0.00278001719 0.0055844175  991.286501\n a_society.10   -0.094149204  0.2846206232 0.00450024719 0.0080735022 1000.000000\nsigma_society    0.310352849  0.1374834682 0.00217380450 0.0057325226  575.187461\n&quot;</code></pre><p>Show means</p><pre><code class="language-julia">[posterior_β, posterior_α, [posterior_σ]]</code></pre><pre><code class="language-none">3-element Array{Array{Float64,1},1}:
 [1.097214459225568, 0.2609044822699805]                                                                                                                                                                               
 [-0.20786237451473608, 0.046112811436549654, -0.05072886967362239, 0.33100535232283373, 0.048293683776328304, -0.3209812278916903, 0.14973323385434326, -0.16928795261695798, 0.2752953630060652, -0.0905417374747895]
 [0.3095890810700937]                                                                                                                                                                                                  </code></pre><p>End of m12.6d.jl</p><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p><footer><hr/><a class="previous" href="../../10/m10.04d2/"><span class="direction">Previous</span><span class="title">m10.04d2</span></a><a class="next" href="../m12.6d1/"><span class="direction">Next</span><span class="title">m12.6d1</span></a></footer></article></body></html>
