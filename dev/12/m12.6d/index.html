<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>m12.6d · DynamicHMCModels.jl</title><link href="https://cdnjs.cloudflare.com/ajax/libs/normalize/4.2.0/normalize.min.css" rel="stylesheet" type="text/css"/><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.2.0/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link href="../../assets/documenter.css" rel="stylesheet" type="text/css"/></head><body><nav class="toc"><h1>DynamicHMCModels.jl</h1><select id="version-selector" onChange="window.location.href=this.value" style="visibility: hidden"></select><form class="search" id="search-form" action="../../search/"><input id="search-query" name="q" type="text" placeholder="Search docs"/></form><ul><li><a class="toctext" href="../../intro/">Home</a></li><li><span class="toctext">Chapter 02</span><ul><li><a class="toctext" href="../../02/m2.1d/">m2.1d</a></li></ul></li><li><span class="toctext">Chapter 04</span><ul><li><a class="toctext" href="../../04/m4.1d/">m4.1d</a></li><li><a class="toctext" href="../../04/m4.2d/">m4.2d</a></li><li><a class="toctext" href="../../04/m4.5d/">m4.5d</a></li></ul></li><li><span class="toctext">Chapter 05</span><ul><li><a class="toctext" href="../../05/m5.1d/">m5.1d</a></li><li><a class="toctext" href="../../05/m5.1d1/">m5.1d1</a></li><li><a class="toctext" href="../../05/m5.3d/">m5.3d</a></li><li><a class="toctext" href="../../05/m5.6d/">m5.6d</a></li></ul></li><li><span class="toctext">Chapter 08</span><ul><li><a class="toctext" href="../../08/m8.1d/">m8.1d</a></li></ul></li><li><span class="toctext">Chapter 10</span><ul><li><a class="toctext" href="../../10/m10.02d/">m10.02d</a></li><li><a class="toctext" href="../../10/m10.02d1/">m10.02d1</a></li><li><a class="toctext" href="../../10/m10.04d/">m10.04d</a></li><li><a class="toctext" href="../../10/m10.04d1/">m10.04d1</a></li><li><a class="toctext" href="../../10/m10.04d2/">m10.04d2</a></li></ul></li><li><span class="toctext">Chapter 12</span><ul><li class="current"><a class="toctext" href>m12.6d</a><ul class="internal"></ul></li><li><a class="toctext" href="../m12.6d1/">m12.6d1</a></li><li><a class="toctext" href="../m12.6d2/">m12.6d2</a></li></ul></li><li><a class="toctext" href="../../">Functions</a></li></ul></nav><article id="docs"><header><nav><ul><li>Chapter 12</li><li><a href>m12.6d</a></li></ul><a class="edit-page" href="https://github.com/StatisticalRethinkingJulia/DynamicHMCModels.jl/blob/master/scripts/12/m12.6d.jl"><span class="fa"></span> Edit on GitHub</a></nav><hr/><div id="topbar"><span>m12.6d</span><a class="fa fa-bars" href="#"></a></div></header><pre><code class="language-julia">using DynamicHMCModels

ProjDir = rel_path_d(&quot;..&quot;, &quot;scripts&quot;, &quot;12&quot;)

df = CSV.read(rel_path( &quot;..&quot;, &quot;data&quot;,  &quot;Kline.csv&quot;), delim=&#39;;&#39;);
size(df) # Should be 10x5</code></pre><pre><code class="language-none">(10, 5)</code></pre><p>New col logpop, set log() for population data</p><pre><code class="language-julia">df[:logpop] = map((x) -&gt; log(x), df[:population]);
df[:society] = 1:10;

first(df[[:total_tools, :logpop, :society]], 5)

struct m_12_06d_model{TY &lt;: AbstractVector, TX &lt;: AbstractMatrix,
  TS &lt;: AbstractVector}
    &quot;Observations (total_tools).&quot;
    y::TY
    &quot;Covariates (logpop)&quot;
    X::TX
    &quot;Society&quot;
    S::TS
    &quot;Number of observations (10)&quot;
    N::Int
    &quot;Number of societies (also 10)&quot;
    N_societies::Int
end</code></pre><p>Make the type callable with the parameters <em>as a single argument</em>.</p><pre><code class="language-julia">function (problem::m_12_06d_model)(θ)
    @unpack y, X, S, N, N_societies = problem   # extract the data
    @unpack β, α, σ = θ  # β : a, bp, α : a_society
    ll = 0.0
    ll += logpdf(Cauchy(0, 1), σ)
    ll += sum(logpdf.(Normal(0, σ), α)) # α[1:10]
    ll += logpdf.(Normal(0, 10), β[1]) # a
    ll += logpdf.(Normal(0, 1), β[2]) # a
    ll += sum(
      [loglikelihood(Poisson(exp(α[S[i]] + dot(X[i, :], β))), [y[i]]) for i in 1:N]
    )
    ll
end</code></pre><p>Instantiate the model with data and inits.</p><pre><code class="language-julia">N = size(df, 1)
N_societies = length(unique(df[:society]))
X = hcat(ones(Int64, N), df[:logpop]);
S = df[:society]
y = df[:total_tools]
p = m_12_06d_model(y, X, S, N, N_societies);
θ = (β = [1.0, 0.25], α = rand(Normal(0, 1), N_societies), σ = 0.2)
p(θ)</code></pre><pre><code class="language-none">-274.7977383342934</code></pre><p>Write a function to return properly dimensioned transformation.</p><pre><code class="language-julia">problem_transformation(p::m_12_06d_model) =
    as( (β = as(Array, size(p.X, 2)), α = as(Array, p.N_societies), σ = asℝ₊) )</code></pre><p>Wrap the problem with a transformation, then use Flux for the gradient.</p><pre><code class="language-julia">P = TransformedLogDensity(problem_transformation(p), p)
∇P = LogDensityRejectErrors(ADgradient(:ForwardDiff, P));
#∇P = ADgradient(:ForwardDiff, P);</code></pre><p>Tune and sample.</p><pre><code class="language-julia">chain, NUTS_tuned = NUTS_init_tune_mcmc(∇P, 1000);</code></pre><pre><code class="language-none">(NUTS_Transition{Array{Float64,1},Float64}[NUTS_Transition{Array{Float64,1},Float64}([2.1175753647232263, 0.154813042707025, -0.030961166935267345, -0.1904819176034214, 0.07098674104552062, 0.25107903034574963, -0.1445437993505942, -0.20271994098118398, -0.017626132495767548, -0.03252083356013249, 0.23498860571913846, 0.14406932274743747, -1.6538848304573457], -44.99250298625675, 4, DynamicHMC.DoubledTurn, 0.9999525737840881, 15), NUTS_Transition{Array{Float64,1},Float64}([1.8347235175200913, 0.18370823909092013, -0.4465098201760278, 0.08812729134562067, 0.054750041289643656, 0.2895018997762029, -0.03511970385330649, -0.31715312462501805, 0.06746361502094278, -0.19001519809970963, 0.27966326558073795, 0.2643814376906615, -1.4055448642028479], -44.48024740839812, 4, DynamicHMC.DoubledTurn, 0.9037990947650533, 15), NUTS_Transition{Array{Float64,1},Float64}([1.2469713006535332, 0.25186169830689437, -0.4373891453053867, 0.00030386814767622075, 0.08138779452011526, 0.1420507172045956, -0.21104933089610955, -0.4492174965393643, 0.08359001576736667, -0.33569900918052764, 0.11626347042682358, -0.11423004142345741, -1.2924715651680145], -41.44959904931517, 4, DynamicHMC.DoubledTurn, 0.9280942045461911, 15), NUTS_Transition{Array{Float64,1},Float64}([1.2094925584745546, 0.2547683609442918, -0.43385476729535366, 0.11793426286828725, 0.023988484955376792, 0.42985076642859965, 0.19593935608438148, -0.2543016402544782, 0.19288283069485293, -0.5465263106217717, 0.5137724942756382, -0.22162694949883138, -0.9515209803536756], -45.84825766677943, 4, DynamicHMC.DoubledTurn, 0.9344190231414217, 15), NUTS_Transition{Array{Float64,1},Float64}([1.8620734424758965, 0.18217324795910178, -0.5153661854896006, -0.008539374001706082, -0.024052167553723254, 0.38814579197864413, 0.14058828253061678, -0.3186152562337951, 0.219784260960496, -0.5012003521214224, 0.5105250234163127, -0.0503015802406631, -0.9107996967069645], -44.18744005646667, 4, DynamicHMC.DoubledTurn, 0.9780215536300702, 15), NUTS_Transition{Array{Float64,1},Float64}([2.8723980800795523, 0.06758921797603344, -0.6757956785420485, -0.09287793565708442, -0.022907333142010423, 0.22490568672491362, 0.06411139160484434, -0.36059172130824024, 0.24679492322257532, -0.49478877980737396, 0.529447382158968, 0.5793978035352513, -1.1032343438103152], -44.721323962794806, 4, DynamicHMC.DoubledTurn, 0.9955756106329744, 15), NUTS_Transition{Array{Float64,1},Float64}([1.640332844550112, 0.20913796108631938, -0.5565078549921694, -0.014369670000913881, -0.25326677874234116, 0.4703235472998732, 0.24931627710297605, -0.7695784771023484, 0.12982187816676366, -0.18506945551306633, 0.07354031273044558, 0.10179481738416887, -0.9250273199680414], -48.19501066832219, 4, DynamicHMC.AdjacentTurn, 0.9967297958604886, 31), NUTS_Transition{Array{Float64,1},Float64}([1.0110479998764494, 0.2704569636128747, -0.32632622959130564, 0.2760751362747435, -0.12751168229297752, 0.39207075435694994, -0.0014170899974046067, 0.10309361675156448, 0.1612367542707985, -0.2010153094947417, 0.17337753901579533, -0.05124946958979894, -1.5507962655853036], -44.85101451896794, 4, DynamicHMC.DoubledTurn, 0.9916833899309822, 15), NUTS_Transition{Array{Float64,1},Float64}([1.8529928351293372, 0.18635962442956483, -0.25557233816860947, -0.3967417162045233, -0.11088157332467731, 0.10641127741898654, -0.010485175745207041, -0.8939629677963723, -0.0018027261323177307, -0.17483191141077117, 0.32146422269526387, 0.008682996118484027, -1.1348048027170123], -44.849826219248044, 4, DynamicHMC.DoubledTurn, 0.916076884785972, 15), NUTS_Transition{Array{Float64,1},Float64}([2.0885889924228107, 0.14931709356128858, -0.29268795095211836, -0.022366302714296515, 0.11170687201873127, 0.3631309321577362, 0.04830282828849007, -0.5253695527904706, 0.19289451047073589, 0.033472776653524654, 0.5164777846252357, 0.09277973306290249, -0.8241900086104265], -47.93494533807902, 4, DynamicHMC.DoubledTurn, 0.9463169627114428, 15)  …  NUTS_Transition{Array{Float64,1},Float64}([0.8706607232287065, 0.2923939184679065, -0.1848138673638562, 0.07192563703784657, -0.10687140406436184, 0.11087091564735788, 0.08907060949722073, -0.09525162626324075, 0.27490260896278057, -0.08557008363359489, 0.07330434792462273, -0.08575569734941382, -1.6673308884920586], -44.06308724629714, 4, DynamicHMC.DoubledTurn, 0.80199713036899, 15), NUTS_Transition{Array{Float64,1},Float64}([1.6088052707450429, 0.20000422827006534, -0.10276814645701587, 0.014279323864404576, 0.26341307294399996, 0.5865496433286088, 0.13593371104423227, -0.19324101264917692, 0.0938632582302092, -0.07536357012752257, 0.5436506019317984, 0.09205323832252436, -1.276719060000488], -43.376777778852, 4, DynamicHMC.DoubledTurn, 0.978287111606391, 15), NUTS_Transition{Array{Float64,1},Float64}([0.6419844555948456, 0.31876717059632875, -0.23279362946974447, -0.11390286997088508, -0.3059519622909153, 0.010997045838811881, -0.007025414891830787, -0.44354411801184, 0.1858221759283933, -0.30469299110508247, -0.16568988220260472, -0.3210533554280636, -1.4996702311968189], -46.19753084417463, 4, DynamicHMC.DoubledTurn, 0.9310913234371868, 15), NUTS_Transition{Array{Float64,1},Float64}([1.4247014726681326, 0.2116163996104925, -0.34149429905837503, 0.08773878440541448, 0.12026014471916707, 0.7240290935173749, 0.17307681780001483, -0.04386989089744292, 0.37694935698549614, -0.25011492410048003, 0.6227055100105612, 0.23942949217671303, -1.1042890840170998], -46.54661650598624, 4, DynamicHMC.DoubledTurn, 1.0, 15), NUTS_Transition{Array{Float64,1},Float64}([0.4430707131048774, 0.3491491330944368, 0.04435243087200659, -0.194103308899672, 0.1636501961215224, 0.3343826178846647, -0.16708110753978234, -0.5489943932751985, 0.09264691521978798, -0.4032787398129447, 0.1849018051923518, -0.43260609057242194, -1.409648878075046], -45.56545786527826, 4, DynamicHMC.DoubledTurn, 0.9573217260029795, 15), NUTS_Transition{Array{Float64,1},Float64}([1.2980353239863007, 0.22767666749351784, -0.08713293035414135, 0.2786894562159602, -0.10056247950456071, 0.3483356630431915, 0.08893228303578368, -0.5008778849468498, 0.35159298677605244, 0.07986292111101399, 0.3939438870712191, 0.03604731472121765, -0.8938532850028892], -43.46347871323561, 4, DynamicHMC.DoubledTurn, 0.9573266988582063, 15), NUTS_Transition{Array{Float64,1},Float64}([0.2156891066083102, 0.3698576816318742, -0.02648816602770627, 0.24736838980053222, -0.03931744258178517, 0.15174864376957287, -0.034010869916198457, -0.26414178937685195, -0.06291872276099603, -0.29239211916811797, 0.14907879677666075, -0.3622924237842092, -1.4204264111951046], -43.5929319411722, 4, DynamicHMC.DoubledTurn, 0.8511446818900515, 15), NUTS_Transition{Array{Float64,1},Float64}([0.24341121741271468, 0.33837045450141845, 0.05744065568592401, 0.3275753111930488, 0.2005530298346041, 0.28617128596402075, 0.11102332984411394, -0.2981768018108424, 0.004693694772774787, -0.11193376405639806, 0.17141105112947888, -0.1342923716097676, -1.5322608322514084], -45.12034300617279, 4, DynamicHMC.DoubledTurn, 0.6423500048177492, 15), NUTS_Transition{Array{Float64,1},Float64}([0.7719318748849754, 0.29056224723063107, 0.060983424285777195, 0.33947831688387065, 0.11289467527314506, 0.31197158369720224, 0.05615157198963511, -0.34161292503533736, 0.05927284651507696, -0.07638344877811973, 0.2694010506518688, 0.16861586861981065, -1.396644608413481], -45.21244431259216, 4, DynamicHMC.DoubledTurn, 0.9917641281469044, 15), NUTS_Transition{Array{Float64,1},Float64}([0.8229866011497622, 0.29196392768367363, -0.32843531750869165, -0.21427073277448208, -0.25639107575369796, 0.11018779067287113, -0.04277641099326228, -0.14046769136653645, 0.1864949950261207, -0.10730680877656668, 0.285749462696616, -0.325697664044511, -1.6680247826486336], -43.16692975030684, 4, DynamicHMC.DoubledTurn, 0.99919731478011, 15)], NUTS sampler in 13 dimensions
  stepsize (ϵ) ≈ 0.23
  maximum depth = 10
  Gaussian kinetic energy, √diag(M⁻¹): [0.6975078866883632, 0.08112760098841779, 0.2142969394714181, 0.22070347176381955, 0.19844119285812062, 0.18427099752987236, 0.17062590920632914, 0.2291425650177216, 0.18642290464987124, 0.2015848836634619, 0.17491255657200205, 0.30889296869416655, 0.35201539425922596]
)</code></pre><p>We use the transformation to obtain the posterior from the chain.</p><pre><code class="language-julia">posterior = TransformVariables.transform.(Ref(problem_transformation(p)), get_position.(chain));
posterior[1:5]</code></pre><pre><code class="language-none">5-element Array{NamedTuple{(:β, :α, :σ),Tuple{Array{Float64,1},Array{Float64,1},Float64}},1}:
 (β = [2.1175753647232263, 0.154813042707025], α = [-0.030961166935267345, -0.1904819176034214, 0.07098674104552062, 0.25107903034574963, -0.1445437993505942, -0.20271994098118398, -0.017626132495767548, -0.03252083356013249, 0.23498860571913846, 0.14406932274743747], σ = 0.19130527461134883) 
 (β = [1.8347235175200913, 0.18370823909092013], α = [-0.4465098201760278, 0.08812729134562067, 0.054750041289643656, 0.2895018997762029, -0.03511970385330649, -0.31715312462501805, 0.06746361502094278, -0.19001519809970963, 0.27966326558073795, 0.2643814376906615], σ = 0.24523340114261066)   
 (β = [1.2469713006535332, 0.25186169830689437], α = [-0.4373891453053867, 0.00030386814767622075, 0.08138779452011526, 0.1420507172045956, -0.21104933089610955, -0.4492174965393643, 0.08359001576736667, -0.33569900918052764, 0.11626347042682358, -0.11423004142345741], σ = 0.27459127348254014)
 (β = [1.2094925584745546, 0.2547683609442918], α = [-0.43385476729535366, 0.11793426286828725, 0.023988484955376792, 0.42985076642859965, 0.19593935608438148, -0.2543016402544782, 0.19288283069485293, -0.5465263106217717, 0.5137724942756382, -0.22162694949883138], σ = 0.3861532450688679)     
 (β = [1.8620734424758965, 0.18217324795910178], α = [-0.5153661854896006, -0.008539374001706082, -0.024052167553723254, 0.38814579197864413, 0.14058828253061678, -0.3186152562337951, 0.219784260960496, -0.5012003521214224, 0.5105250234163127, -0.0503015802406631], σ = 0.402202455413004)      </code></pre><p>Extract the parameter posterior means.</p><pre><code class="language-julia">posterior_β = mean(posterior[i].β for i in 1:length(posterior))
posterior_α = mean(posterior[i].α for i in 1:length(posterior))
posterior_σ = mean(posterior[i].σ for i in 1:length(posterior))</code></pre><pre><code class="language-none">0.31761087927820514</code></pre><p>Effective sample sizes (of untransformed draws)</p><pre><code class="language-julia">ess = mapslices(effective_sample_size, get_position_matrix(chain); dims = 1)
ess</code></pre><pre><code class="language-none">1×13 Array{Float64,2}:
 662.335  715.814  640.393  787.724  …  845.919  1000.0  1000.0  396.649</code></pre><p>NUTS-specific statistics</p><pre><code class="language-julia">NUTS_statistics(chain)</code></pre><pre><code class="language-none">Hamiltonian Monte Carlo sample of length 1000
  acceptance rate mean: 0.94, min/25%/median/75%/max: 0.5 0.91 0.97 0.99 1.0
  termination: AdjacentTurn =&gt; 6% DoubledTurn =&gt; 94%
  depth: 3 =&gt; 4% 4 =&gt; 95% 5 =&gt; 1%
</code></pre><p>CmdStan result</p><pre><code class="language-julia">m_12_6_result = &quot;
Iterations = 1:1000
Thinning interval = 1
Chains = 1,2,3,4
Samples per chain = 1000

Empirical Posterior Estimates:
                            Mean                SD               Naive SE             MCSE            ESS
            a          1.076167468  0.7704872560 0.01218247319 0.0210530022 1000.000000
           bp         0.263056273  0.0823415805 0.00130193470 0.0022645077 1000.000000
  a_society.1   -0.191723568  0.2421382537 0.00382854195 0.0060563054 1000.000000
  a_society.2    0.054569029  0.2278506876 0.00360263570 0.0051693148 1000.000000
  a_society.3   -0.035935050  0.1926364647 0.00304584994 0.0039948433 1000.000000
  a_society.4    0.334355037  0.1929971201 0.00305155241 0.0063871707  913.029080
  a_society.5    0.049747513  0.1801287716 0.00284808595 0.0043631095 1000.000000
  a_society.6   -0.311903245  0.2096126337 0.00331426674 0.0053000536 1000.000000
  a_society.7    0.148637507  0.1744680594 0.00275858223 0.0047660246 1000.000000
  a_society.8   -0.164567976  0.1821341074 0.00287979309 0.0034297298 1000.000000
  a_society.9    0.277066965  0.1758237250 0.00278001719 0.0055844175  991.286501
 a_society.10   -0.094149204  0.2846206232 0.00450024719 0.0080735022 1000.000000
sigma_society    0.310352849  0.1374834682 0.00217380450 0.0057325226  575.187461
&quot;;</code></pre><pre><code class="language-none">&quot;\nIterations = 1:1000\nThinning interval = 1\nChains = 1,2,3,4\nSamples per chain = 1000\n\nEmpirical Posterior Estimates:\n                            Mean                SD               Naive SE             MCSE            ESS\n            a          1.076167468  0.7704872560 0.01218247319 0.0210530022 1000.000000\n           bp         0.263056273  0.0823415805 0.00130193470 0.0022645077 1000.000000\n  a_society.1   -0.191723568  0.2421382537 0.00382854195 0.0060563054 1000.000000\n  a_society.2    0.054569029  0.2278506876 0.00360263570 0.0051693148 1000.000000\n  a_society.3   -0.035935050  0.1926364647 0.00304584994 0.0039948433 1000.000000\n  a_society.4    0.334355037  0.1929971201 0.00305155241 0.0063871707  913.029080\n  a_society.5    0.049747513  0.1801287716 0.00284808595 0.0043631095 1000.000000\n  a_society.6   -0.311903245  0.2096126337 0.00331426674 0.0053000536 1000.000000\n  a_society.7    0.148637507  0.1744680594 0.00275858223 0.0047660246 1000.000000\n  a_society.8   -0.164567976  0.1821341074 0.00287979309 0.0034297298 1000.000000\n  a_society.9    0.277066965  0.1758237250 0.00278001719 0.0055844175  991.286501\n a_society.10   -0.094149204  0.2846206232 0.00450024719 0.0080735022 1000.000000\nsigma_society    0.310352849  0.1374834682 0.00217380450 0.0057325226  575.187461\n&quot;</code></pre><p>Show means</p><pre><code class="language-julia">[posterior_β, posterior_α, [posterior_σ]]</code></pre><pre><code class="language-none">3-element Array{Array{Float64,1},1}:
 [1.096269107476829, 0.26190411217606113]                                                                                                                                                                           
 [-0.21449767896559316, 0.032563781223717406, -0.05227924592976223, 0.32293891990885676, 0.0408457978592343, -0.3331931839971036, 0.14466368111625738, -0.1810743717892455, 0.27030234270130865, -0.101637625289147]
 [0.31761087927820514]                                                                                                                                                                                              </code></pre><p>End of m12.6d.jl</p><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p><footer><hr/><a class="previous" href="../../10/m10.04d2/"><span class="direction">Previous</span><span class="title">m10.04d2</span></a><a class="next" href="../m12.6d1/"><span class="direction">Next</span><span class="title">m12.6d1</span></a></footer></article></body></html>
