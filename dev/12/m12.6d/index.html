<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>m12.6d · DynamicHMCModels.jl</title><link href="https://cdnjs.cloudflare.com/ajax/libs/normalize/4.2.0/normalize.min.css" rel="stylesheet" type="text/css"/><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.2.0/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link href="../../assets/documenter.css" rel="stylesheet" type="text/css"/></head><body><nav class="toc"><h1>DynamicHMCModels.jl</h1><select id="version-selector" onChange="window.location.href=this.value" style="visibility: hidden"></select><form class="search" id="search-form" action="../../search/"><input id="search-query" name="q" type="text" placeholder="Search docs"/></form><ul><li><a class="toctext" href="../../intro/">Home</a></li><li><span class="toctext">Chapter 02</span><ul><li><a class="toctext" href="../../02/m2.1d/">m2.1d</a></li></ul></li><li><span class="toctext">Chapter 04</span><ul><li><a class="toctext" href="../../04/m4.1d/">m4.1d</a></li><li><a class="toctext" href="../../04/m4.2d/">m4.2d</a></li><li><a class="toctext" href="../../04/m4.5d/">m4.5d</a></li></ul></li><li><span class="toctext">Chapter 05</span><ul><li><a class="toctext" href="../../05/m5.1d/">m5.1d</a></li><li><a class="toctext" href="../../05/m5.1d1/">m5.1d1</a></li><li><a class="toctext" href="../../05/m5.3d/">m5.3d</a></li><li><a class="toctext" href="../../05/m5.6d/">m5.6d</a></li></ul></li><li><span class="toctext">Chapter 08</span><ul><li><a class="toctext" href="../../08/m8.1d/">m8.1d</a></li></ul></li><li><span class="toctext">Chapter 10</span><ul><li><a class="toctext" href="../../10/m10.02d/">m10.02d</a></li><li><a class="toctext" href="../../10/m10.02d1/">m10.02d1</a></li><li><a class="toctext" href="../../10/m10.04d/">m10.04d</a></li><li><a class="toctext" href="../../10/m10.04d1/">m10.04d1</a></li><li><a class="toctext" href="../../10/m10.04d2/">m10.04d2</a></li></ul></li><li><span class="toctext">Chapter 12</span><ul><li class="current"><a class="toctext" href>m12.6d</a><ul class="internal"></ul></li><li><a class="toctext" href="../m12.6d1/">m12.6d1</a></li><li><a class="toctext" href="../m12.6d2/">m12.6d2</a></li></ul></li><li><a class="toctext" href="../../">Functions</a></li></ul></nav><article id="docs"><header><nav><ul><li>Chapter 12</li><li><a href>m12.6d</a></li></ul><a class="edit-page" href="https://github.com/StatisticalRethinkingJulia/DynamicHMCModels.jl/blob/master/scripts/12/m12.6d.jl"><span class="fa"></span> Edit on GitHub</a></nav><hr/><div id="topbar"><span>m12.6d</span><a class="fa fa-bars" href="#"></a></div></header><pre><code class="language-julia">using DynamicHMCModels

ProjDir = rel_path_d(&quot;..&quot;, &quot;scripts&quot;, &quot;12&quot;)

df = CSV.read(rel_path( &quot;..&quot;, &quot;data&quot;,  &quot;Kline.csv&quot;), delim=&#39;;&#39;);
size(df) # Should be 10x5</code></pre><pre><code class="language-none">(10, 5)</code></pre><p>New col logpop, set log() for population data</p><pre><code class="language-julia">df[:logpop] = map((x) -&gt; log(x), df[:population]);
df[:society] = 1:10;

first(df[[:total_tools, :logpop, :society]], 5)

struct m_12_06d_model{TY &lt;: AbstractVector, TX &lt;: AbstractMatrix,
  TS &lt;: AbstractVector}
    &quot;Observations (total_tools).&quot;
    y::TY
    &quot;Covariates (logpop)&quot;
    X::TX
    &quot;Society&quot;
    S::TS
    &quot;Number of observations (10)&quot;
    N::Int
    &quot;Number of societies (also 10)&quot;
    N_societies::Int
end</code></pre><p>Make the type callable with the parameters <em>as a single argument</em>.</p><pre><code class="language-julia">function (problem::m_12_06d_model)(θ)
    @unpack y, X, S, N, N_societies = problem   # extract the data
    @unpack β, α, σ = θ  # β : a, bp, α : a_society
    ll = 0.0
    ll += logpdf(Cauchy(0, 1), σ)
    ll += sum(logpdf.(Normal(0, σ), α)) # α[1:10]
    ll += logpdf.(Normal(0, 10), β[1]) # a
    ll += logpdf.(Normal(0, 1), β[2]) # a
    ll += sum(
      [loglikelihood(Poisson(exp(α[S[i]] + dot(X[i, :], β))), [y[i]]) for i in 1:N]
    )
    ll
end</code></pre><p>Instantiate the model with data and inits.</p><pre><code class="language-julia">N = size(df, 1)
N_societies = length(unique(df[:society]))
X = hcat(ones(Int64, N), df[:logpop]);
S = df[:society]
y = df[:total_tools]
p = m_12_06d_model(y, X, S, N, N_societies);
θ = (β = [1.0, 0.25], α = rand(Normal(0, 1), N_societies), σ = 0.2)
p(θ)</code></pre><pre><code class="language-none">-225.58751755284942</code></pre><p>Write a function to return properly dimensioned transformation.</p><pre><code class="language-julia">problem_transformation(p::m_12_06d_model) =
    as( (β = as(Array, size(p.X, 2)), α = as(Array, p.N_societies), σ = asℝ₊) )</code></pre><p>Wrap the problem with a transformation, then use Flux for the gradient.</p><pre><code class="language-julia">P = TransformedLogDensity(problem_transformation(p), p)
∇P = LogDensityRejectErrors(ADgradient(:ForwardDiff, P));
#∇P = ADgradient(:ForwardDiff, P);</code></pre><p>Tune and sample.</p><pre><code class="language-julia">chain, NUTS_tuned = NUTS_init_tune_mcmc(∇P, 1000);</code></pre><pre><code class="language-none">(NUTS_Transition{Array{Float64,1},Float64}[NUTS_Transition{Array{Float64,1},Float64}([1.5828563151022261, 0.21800723822061735, -0.10586910492863759, -0.12267322299950074, -0.1629833176458871, 0.24488241889278003, 0.24198385790603713, -0.2375725950276783, 0.2155030303442187, -0.23570303440735793, -0.08690913163444813, -0.1695226436292353, -1.3284698184269321], -44.0533714367425, 4, DynamicHMC.DoubledTurn, 0.9654098179417396, 15), NUTS_Transition{Array{Float64,1},Float64}([0.28092923606303666, 0.3470694248159433, -0.2669000606747126, 0.09292124625720066, 0.05860840881896786, 0.45571174420434923, -0.3203577709043378, -0.6910029113934099, -0.09610980469144839, -0.07535316286798613, 0.5149716496035917, -0.23477736158445875, -1.1907780531617902], -48.18491498613714, 4, DynamicHMC.DoubledTurn, 0.9704795269059922, 15), NUTS_Transition{Array{Float64,1},Float64}([1.2764113670627726, 0.23258548774519855, -0.007642010278645986, 0.1896319327182049, -0.05805719585883166, 0.5482373727073147, 0.3428241988663095, 0.2901847786519655, 0.5459058304244031, -0.16535619401654403, 0.3243795373964323, -0.14601045444041486, -1.0694547232145035], -52.903494716401816, 4, DynamicHMC.DoubledTurn, 0.791998821904455, 15), NUTS_Transition{Array{Float64,1},Float64}([1.1280393280874046, 0.2579770651903016, -0.26170949502636914, -0.23279151884180135, 0.09005274455616705, 0.17616588695925445, 0.024639193439982, -0.9061365714230668, -0.1047493044656109, -0.11652855151792471, 0.29805058632024456, 0.03638191882782067, -1.260915201003844], -53.28788563509521, 4, DynamicHMC.DoubledTurn, 0.9978294550146672, 15), NUTS_Transition{Array{Float64,1},Float64}([0.5924123826350897, 0.3099844920995787, 0.22857377450953678, 0.1450146855680956, 0.06632104769761926, 0.6551887466625593, 0.06147704725457876, -0.10815119912696217, 0.1598861318798026, -0.10143035415483101, 0.3162726248530639, -0.13590994645674523, -1.4273919322854975], -49.29373777252895, 4, DynamicHMC.DoubledTurn, 0.8321524689872918, 15), NUTS_Transition{Array{Float64,1},Float64}([2.238312786416644, 0.1560349150422151, -0.7310316832732335, -0.40133553048395015, -0.11569692041764028, 0.11077729890252111, -0.2043492226466026, -0.3683398482712785, 0.1834666083544446, -0.47128808666922706, 0.0530003908327343, 0.107689610710455, -1.1653813630455463], -44.407449425388094, 4, DynamicHMC.DoubledTurn, 0.8042959489029481, 15), NUTS_Transition{Array{Float64,1},Float64}([2.220111226461259, 0.1594573386966244, -0.5918192460242182, -0.3788218009377037, -0.13057297923755465, -0.008212678695993049, -0.22655314068102458, -0.16967276757331065, 0.24098522271354364, -0.4310144702182382, 0.07954599328950906, -0.07267398307425373, -1.3848871168806305], -49.192063261553585, 4, DynamicHMC.DoubledTurn, 0.9356495738937196, 15), NUTS_Transition{Array{Float64,1},Float64}([1.273563847013642, 0.2478069574288855, -0.15175449958314224, -0.08673213224511521, -0.3523697249637186, 0.4781342752525274, -0.06373209809171468, -0.5308753413907951, -0.27285481527128613, 0.026956438388020726, 0.4302108666906944, -0.19544957725199189, -0.8039643667137107], -50.234948002162966, 4, DynamicHMC.DoubledTurn, 0.9975212763821867, 15), NUTS_Transition{Array{Float64,1},Float64}([1.8855221154324315, 0.1884795422365741, -0.21754929651641078, -0.23120201469306934, -0.3751350239794984, 0.29093236807150774, -0.10961624859129852, -0.4256279513958351, -0.11653943527667371, 0.06366140046309415, 0.43393468797728385, -0.06507682627096013, -0.8528008321141743], -49.92586218384109, 4, DynamicHMC.DoubledTurn, 0.9715519872097654, 15), NUTS_Transition{Array{Float64,1},Float64}([0.8393093592911061, 0.2848066450331678, -0.25101462310108325, -0.13739891935046938, -0.24338924266514164, 0.43421622949450167, 0.08711098817654252, -0.31991971297447813, 0.15148736988907968, 0.08880452303264678, 0.4371788867516007, -0.30855105417658896, -0.7231039724857046], -48.26744520660548, 4, DynamicHMC.DoubledTurn, 0.9853650217736399, 15)  …  NUTS_Transition{Array{Float64,1},Float64}([1.1198924310237899, 0.24543035015056863, -0.06430072170673126, 0.2249210485117388, 0.026958958596039265, 0.32019472801786014, 0.006606015159287274, -0.12408336061872946, -0.04867999237965952, -0.40483777744485616, 0.3160359664935758, 0.01988473105320157, -1.4315703196135554], -46.368222368652155, 4, DynamicHMC.DoubledTurn, 0.9920324897293824, 15), NUTS_Transition{Array{Float64,1},Float64}([0.9413369609252901, 0.2726968126677474, -0.18834605038424473, 0.024934839398636735, 0.06241769923390914, 0.174038932209431, -0.2941122863869249, -0.5143078004200726, 0.2428247805333773, -0.2732479725478334, 0.33033348335590484, -0.2469642046310354, -1.1599112658465458], -47.4565074701708, 4, DynamicHMC.DoubledTurn, 0.9310860788348366, 15), NUTS_Transition{Array{Float64,1},Float64}([0.9525172519453455, 0.28927496434369293, -0.03525604081801911, -0.010793645983471788, 0.03233155615727322, 0.13091385075383352, -0.1896858826981232, -0.4652588876243134, 0.25978806811982513, -0.18648783754801046, 0.31829515940772624, -0.11080690402961388, -1.3115674794405126], -43.82206888230677, 4, DynamicHMC.DoubledTurn, 0.9944828902181051, 15), NUTS_Transition{Array{Float64,1},Float64}([2.0181917766486226, 0.15000219885731433, -0.33657882180776516, -0.41639450664635796, 0.10394549523556762, 0.5676026669955127, 0.29894661991049587, -0.13566850707309502, 0.2941094553922069, 0.16391905828853526, 0.14850549489877246, 0.1519118819511553, -1.129429890635494], -51.47866629831404, 4, DynamicHMC.DoubledTurn, 0.7480351029343967, 15), NUTS_Transition{Array{Float64,1},Float64}([0.7330002511052471, 0.31118797249037355, -0.02878983507677485, 0.030968891044585126, -0.14951468772045767, 0.18738721325612603, 0.06186235234727687, -0.39779147974788837, -0.09269042066644832, -0.7071215924990057, 0.36408804326173994, -0.21204548410306284, -1.3621950568095664], -50.9835828949293, 4, DynamicHMC.DoubledTurn, 0.9984472454935621, 15), NUTS_Transition{Array{Float64,1},Float64}([1.3774574583362507, 0.22470418399016512, -0.48776789600052783, 0.04585607289396336, 0.027281277252067276, 0.5581762218568306, -1.86508240012824e-5, -0.2068682881392902, 0.499440401220778, 0.1972198645141986, 0.27825501423260596, 0.10403448919812389, -1.1957135618411945], -45.75199468918495, 4, DynamicHMC.DoubledTurn, 0.938297791242954, 15), NUTS_Transition{Array{Float64,1},Float64}([0.9747471985220231, 0.2524540370331272, 0.06565887307046576, -0.07824439125426819, 0.4191930344948595, 0.5245028964752352, 0.11770939000811692, -0.5481910714717184, 0.414376878640182, -0.1820386449814006, 0.5977852218457029, 0.14543106840074538, -0.7841042267249171], -49.77457447831131, 4, DynamicHMC.DoubledTurn, 0.9144821773600641, 15), NUTS_Transition{Array{Float64,1},Float64}([1.8513532559429573, 0.16197912889883803, 0.0798101528405203, 0.11151000505917089, 0.07092275734665565, 0.20134953405507575, 0.3312148096617823, -0.599250371027463, 0.5753352427825245, -0.2449914322855108, 0.5818053660899729, 0.2342384595538514, -1.0285524199244525], -50.012100650863665, 4, DynamicHMC.DoubledTurn, 0.9840172927114125, 15), NUTS_Transition{Array{Float64,1},Float64}([0.899681561384365, 0.2999976912197484, -0.34000408331030424, -0.14119305274958324, -0.24072060246043342, 0.3662015268345893, -0.32083984040909347, -0.0420536393407239, -0.2161237839176242, -0.25977183573088636, 0.09557215675035134, -0.2541821897046658, -1.662447751793454], -48.84617488233023, 4, DynamicHMC.DoubledTurn, 0.9963315222209251, 15), NUTS_Transition{Array{Float64,1},Float64}([1.09384855888033, 0.2333047605297939, 0.06539666633993628, 0.2887907078178804, 0.36655417482699504, 0.44195908275013757, 0.5205189035895585, -0.7311103600785464, 0.6166186999281699, 0.050950796793956386, 0.6106554137163103, 0.16399426359143177, -0.8906433855355487], -48.94022673868019, 4, DynamicHMC.DoubledTurn, 0.9471534818741532, 15)], NUTS sampler in 13 dimensions
  stepsize (ϵ) ≈ 0.25
  maximum depth = 10
  Gaussian kinetic energy, √diag(M⁻¹): [0.7245444426311985, 0.08248634023492417, 0.2715832369146387, 0.2114175868092412, 0.1786439153432584, 0.2007725654845119, 0.17021040388716108, 0.23024877252750148, 0.16972142518007702, 0.16953696116333236, 0.17946843785436528, 0.29659808570520846, 0.4180013348681466]
)</code></pre><p>We use the transformation to obtain the posterior from the chain.</p><pre><code class="language-julia">posterior = TransformVariables.transform.(Ref(problem_transformation(p)), get_position.(chain));
posterior[1:5]</code></pre><pre><code class="language-none">5-element Array{NamedTuple{(:β, :α, :σ),Tuple{Array{Float64,1},Array{Float64,1},Float64}},1}:
 (β = [1.5828563151022261, 0.21800723822061735], α = [-0.10586910492863759, -0.12267322299950074, -0.1629833176458871, 0.24488241889278003, 0.24198385790603713, -0.2375725950276783, 0.2155030303442187, -0.23570303440735793, -0.08690913163444813, -0.1695226436292353], σ = 0.2648822693204398)
 (β = [0.28092923606303666, 0.3470694248159433], α = [-0.2669000606747126, 0.09292124625720066, 0.05860840881896786, 0.45571174420434923, -0.3203577709043378, -0.6910029113934099, -0.09610980469144839, -0.07535316286798613, 0.5149716496035917, -0.23477736158445875], σ = 0.3039846558091508) 
 (β = [1.2764113670627726, 0.23258548774519855], α = [-0.007642010278645986, 0.1896319327182049, -0.05805719585883166, 0.5482373727073147, 0.3428241988663095, 0.2901847786519655, 0.5459058304244031, -0.16535619401654403, 0.3243795373964323, -0.14601045444041486], σ = 0.3431956030025601)    
 (β = [1.1280393280874046, 0.2579770651903016], α = [-0.26170949502636914, -0.23279151884180135, 0.09005274455616705, 0.17616588695925445, 0.024639193439982, -0.9061365714230668, -0.1047493044656109, -0.11652855151792471, 0.29805058632024456, 0.03638191882782067], σ = 0.2833945448070379)   
 (β = [0.5924123826350897, 0.3099844920995787], α = [0.22857377450953678, 0.1450146855680956, 0.06632104769761926, 0.6551887466625593, 0.06147704725457876, -0.10815119912696217, 0.1598861318798026, -0.10143035415483101, 0.3162726248530639, -0.13590994645674523], σ = 0.239933870717377)      </code></pre><p>Extract the parameter posterior means.</p><pre><code class="language-julia">posterior_β = mean(posterior[i].β for i in 1:length(posterior))
posterior_α = mean(posterior[i].α for i in 1:length(posterior))
posterior_σ = mean(posterior[i].σ for i in 1:length(posterior))</code></pre><pre><code class="language-none">0.3117697071022007</code></pre><p>Effective sample sizes (of untransformed draws)</p><pre><code class="language-julia">ess = mapslices(effective_sample_size, get_position_matrix(chain); dims = 1)
ess</code></pre><pre><code class="language-none">1×13 Array{Float64,2}:
 839.487  854.289  894.546  824.939  …  1000.0  848.234  861.349  478.187</code></pre><p>NUTS-specific statistics</p><pre><code class="language-julia">NUTS_statistics(chain)</code></pre><pre><code class="language-none">Hamiltonian Monte Carlo sample of length 1000
  acceptance rate mean: 0.93, min/25%/median/75%/max: 0.43 0.89 0.96 0.99 1.0
  termination: AdjacentTurn =&gt; 4% DoubledTurn =&gt; 96%
  depth: 3 =&gt; 6% 4 =&gt; 93% 5 =&gt; 0%
</code></pre><p>CmdStan result</p><pre><code class="language-julia">m_12_6_result = &quot;
Iterations = 1:1000
Thinning interval = 1
Chains = 1,2,3,4
Samples per chain = 1000

Empirical Posterior Estimates:
                            Mean                SD               Naive SE             MCSE            ESS
            a          1.076167468  0.7704872560 0.01218247319 0.0210530022 1000.000000
           bp         0.263056273  0.0823415805 0.00130193470 0.0022645077 1000.000000
  a_society.1   -0.191723568  0.2421382537 0.00382854195 0.0060563054 1000.000000
  a_society.2    0.054569029  0.2278506876 0.00360263570 0.0051693148 1000.000000
  a_society.3   -0.035935050  0.1926364647 0.00304584994 0.0039948433 1000.000000
  a_society.4    0.334355037  0.1929971201 0.00305155241 0.0063871707  913.029080
  a_society.5    0.049747513  0.1801287716 0.00284808595 0.0043631095 1000.000000
  a_society.6   -0.311903245  0.2096126337 0.00331426674 0.0053000536 1000.000000
  a_society.7    0.148637507  0.1744680594 0.00275858223 0.0047660246 1000.000000
  a_society.8   -0.164567976  0.1821341074 0.00287979309 0.0034297298 1000.000000
  a_society.9    0.277066965  0.1758237250 0.00278001719 0.0055844175  991.286501
 a_society.10   -0.094149204  0.2846206232 0.00450024719 0.0080735022 1000.000000
sigma_society    0.310352849  0.1374834682 0.00217380450 0.0057325226  575.187461
&quot;;</code></pre><pre><code class="language-none">&quot;\nIterations = 1:1000\nThinning interval = 1\nChains = 1,2,3,4\nSamples per chain = 1000\n\nEmpirical Posterior Estimates:\n                            Mean                SD               Naive SE             MCSE            ESS\n            a          1.076167468  0.7704872560 0.01218247319 0.0210530022 1000.000000\n           bp         0.263056273  0.0823415805 0.00130193470 0.0022645077 1000.000000\n  a_society.1   -0.191723568  0.2421382537 0.00382854195 0.0060563054 1000.000000\n  a_society.2    0.054569029  0.2278506876 0.00360263570 0.0051693148 1000.000000\n  a_society.3   -0.035935050  0.1926364647 0.00304584994 0.0039948433 1000.000000\n  a_society.4    0.334355037  0.1929971201 0.00305155241 0.0063871707  913.029080\n  a_society.5    0.049747513  0.1801287716 0.00284808595 0.0043631095 1000.000000\n  a_society.6   -0.311903245  0.2096126337 0.00331426674 0.0053000536 1000.000000\n  a_society.7    0.148637507  0.1744680594 0.00275858223 0.0047660246 1000.000000\n  a_society.8   -0.164567976  0.1821341074 0.00287979309 0.0034297298 1000.000000\n  a_society.9    0.277066965  0.1758237250 0.00278001719 0.0055844175  991.286501\n a_society.10   -0.094149204  0.2846206232 0.00450024719 0.0080735022 1000.000000\nsigma_society    0.310352849  0.1374834682 0.00217380450 0.0057325226  575.187461\n&quot;</code></pre><p>Show means</p><pre><code class="language-julia">[posterior_β, posterior_α, [posterior_σ]]</code></pre><pre><code class="language-none">3-element Array{Array{Float64,1},1}:
 [1.0998722977439155, 0.2609913594197577]                                                                                                                                                                             
 [-0.20853532665997526, 0.04538326685569892, -0.03913574134733313, 0.3351065467054266, 0.04486652602942544, -0.3303296281409087, 0.14966843888571213, -0.17772574690209486, 0.28323351171685635, -0.09322285340203279]
 [0.3117697071022007]                                                                                                                                                                                                 </code></pre><p>End of m12.6d.jl</p><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p><footer><hr/><a class="previous" href="../../10/m10.04d2/"><span class="direction">Previous</span><span class="title">m10.04d2</span></a><a class="next" href="../m12.6d1/"><span class="direction">Next</span><span class="title">m12.6d1</span></a></footer></article></body></html>
