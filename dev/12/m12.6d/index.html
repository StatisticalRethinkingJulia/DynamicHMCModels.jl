<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>m12.6d · DynamicHMCModels.jl</title><link href="https://cdnjs.cloudflare.com/ajax/libs/normalize/4.2.0/normalize.min.css" rel="stylesheet" type="text/css"/><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.2.0/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link href="../../assets/documenter.css" rel="stylesheet" type="text/css"/></head><body><nav class="toc"><h1>DynamicHMCModels.jl</h1><select id="version-selector" onChange="window.location.href=this.value" style="visibility: hidden"></select><form class="search" id="search-form" action="../../search/"><input id="search-query" name="q" type="text" placeholder="Search docs"/></form><ul><li><a class="toctext" href="../../intro/">Home</a></li><li><span class="toctext">Chapter 02</span><ul><li><a class="toctext" href="../../02/m2.1d/">m2.1d</a></li></ul></li><li><span class="toctext">Chapter 04</span><ul><li><a class="toctext" href="../../04/m4.1d/">m4.1d</a></li><li><a class="toctext" href="../../04/m4.2d/">m4.2d</a></li><li><a class="toctext" href="../../04/m4.5d/">m4.5d</a></li></ul></li><li><span class="toctext">Chapter 05</span><ul><li><a class="toctext" href="../../05/m5.1d/">m5.1d</a></li><li><a class="toctext" href="../../05/m5.1d1/">m5.1d1</a></li><li><a class="toctext" href="../../05/m5.3d/">m5.3d</a></li><li><a class="toctext" href="../../05/m5.6d/">m5.6d</a></li></ul></li><li><span class="toctext">Chapter 08</span><ul><li><a class="toctext" href="../../08/m8.1d/">m8.1d</a></li></ul></li><li><span class="toctext">Chapter 10</span><ul><li><a class="toctext" href="../../10/m10.02d/">m10.02d</a></li><li><a class="toctext" href="../../10/m10.02d1/">m10.02d1</a></li><li><a class="toctext" href="../../10/m10.04d/">m10.04d</a></li><li><a class="toctext" href="../../10/m10.04d1/">m10.04d1</a></li><li><a class="toctext" href="../../10/m10.04d2/">m10.04d2</a></li></ul></li><li><span class="toctext">Chapter 12</span><ul><li class="current"><a class="toctext" href>m12.6d</a><ul class="internal"></ul></li><li><a class="toctext" href="../m12.6d1/">m12.6d1</a></li><li><a class="toctext" href="../m12.6d2/">m12.6d2</a></li></ul></li><li><a class="toctext" href="../../">Functions</a></li></ul></nav><article id="docs"><header><nav><ul><li>Chapter 12</li><li><a href>m12.6d</a></li></ul><a class="edit-page" href="https://github.com/StatisticalRethinkingJulia/DynamicHMCModels.jl/blob/master/scripts/12/m12.6d.jl"><span class="fa"></span> Edit on GitHub</a></nav><hr/><div id="topbar"><span>m12.6d</span><a class="fa fa-bars" href="#"></a></div></header><pre><code class="language-julia">using DynamicHMCModels

ProjDir = rel_path_d(&quot;..&quot;, &quot;scripts&quot;, &quot;12&quot;)

df = CSV.read(rel_path( &quot;..&quot;, &quot;data&quot;,  &quot;Kline.csv&quot;), delim=&#39;;&#39;);
size(df) # Should be 10x5</code></pre><pre><code class="language-none">(10, 5)</code></pre><p>New col logpop, set log() for population data</p><pre><code class="language-julia">df[:logpop] = map((x) -&gt; log(x), df[:population]);
df[:society] = 1:10;

first(df[[:total_tools, :logpop, :society]], 5)

struct m_12_06d_model{TY &lt;: AbstractVector, TX &lt;: AbstractMatrix,
  TS &lt;: AbstractVector}
    &quot;Observations (total_tools).&quot;
    y::TY
    &quot;Covariates (logpop)&quot;
    X::TX
    &quot;Society&quot;
    S::TS
    &quot;Number of observations (10)&quot;
    N::Int
    &quot;Number of societies (also 10)&quot;
    N_societies::Int
end</code></pre><p>Make the type callable with the parameters <em>as a single argument</em>.</p><pre><code class="language-julia">function (problem::m_12_06d_model)(θ)
    @unpack y, X, S, N, N_societies = problem   # extract the data
    @unpack β, α, σ = θ  # β : a, bp, α : a_society
    ll = 0.0
    ll += logpdf(Cauchy(0, 1), σ)
    ll += sum(logpdf.(Normal(0, σ), α)) # α[1:10]
    ll += logpdf.(Normal(0, 10), β[1]) # a
    ll += logpdf.(Normal(0, 1), β[2]) # a
    ll += sum(
      [loglikelihood(Poisson(exp(α[S[i]] + dot(X[i, :], β))), [y[i]]) for i in 1:N]
    )
    ll
end</code></pre><p>Instantiate the model with data and inits.</p><pre><code class="language-julia">N = size(df, 1)
N_societies = length(unique(df[:society]))
X = hcat(ones(Int64, N), df[:logpop]);
S = df[:society]
y = df[:total_tools]
p = m_12_06d_model(y, X, S, N, N_societies);
θ = (β = [1.0, 0.25], α = rand(Normal(0, 1), N_societies), σ = 0.2)
p(θ)</code></pre><pre><code class="language-none">-268.1091573741659</code></pre><p>Write a function to return properly dimensioned transformation.</p><pre><code class="language-julia">problem_transformation(p::m_12_06d_model) =
    as( (β = as(Array, size(p.X, 2)), α = as(Array, p.N_societies), σ = asℝ₊) )</code></pre><p>Wrap the problem with a transformation, then use Flux for the gradient.</p><pre><code class="language-julia">P = TransformedLogDensity(problem_transformation(p), p)
∇P = LogDensityRejectErrors(ADgradient(:ForwardDiff, P));
#∇P = ADgradient(:ForwardDiff, P);</code></pre><p>Tune and sample.</p><pre><code class="language-julia">chain, NUTS_tuned = NUTS_init_tune_mcmc(∇P, 1000);</code></pre><pre><code class="language-none">(NUTS_Transition{Array{Float64,1},Float64}[NUTS_Transition{Array{Float64,1},Float64}([1.680106412681618, 0.1988355773575641, -0.21843953095331836, 0.07111309635147664, -0.2788503873268048, -0.08551020089314856, -0.2961605289780153, -0.2937783532333108, 0.05534615279303415, -0.07318509979799132, 0.30174193465485316, 0.12372806534400843, -1.6788551797231939], -44.68598613733185, 4, DynamicHMC.DoubledTurn, 0.9999059295863387, 15), NUTS_Transition{Array{Float64,1},Float64}([1.6712483281676933, 0.20050300544972272, -0.3722102761677626, -0.254654039929115, 0.095484150017689, 0.5753339161084517, 0.34650260518662346, -0.3231237900891358, 0.11851547991083132, -0.2728164534654172, 0.24117745493835024, -0.06344313243365621, -1.202532364386368], -48.520607815642464, 4, DynamicHMC.DoubledTurn, 0.8150253036249501, 15), NUTS_Transition{Array{Float64,1},Float64}([0.28183523082708706, 0.3424489288285489, -0.058180986617405825, 0.3497938531055998, -0.10219423200530717, 0.08882326641317188, -0.09484228503853727, -0.16667232124019646, 0.26997103006301765, -0.08853761141796947, 0.28280795285717997, -0.0647453909439192, -1.3985182279379886], -47.573138301648186, 4, DynamicHMC.DoubledTurn, 0.9852723482720338, 15), NUTS_Transition{Array{Float64,1},Float64}([1.3008772904109294, 0.24548797641167008, -0.1593200559807764, -0.2225109957570126, 0.00820495490900777, 0.5355720699084394, 0.16695686145617958, -0.37553864471714626, 0.07373655646099007, -0.3975983481971194, 0.2098423726082247, -0.21040923226694025, -1.5902149132713566], -43.65029187762697, 4, DynamicHMC.DoubledTurn, 0.9965970471567559, 15), NUTS_Transition{Array{Float64,1},Float64}([0.9148211004953622, 0.2863536554868037, -0.13562599787225954, 0.29950471853986715, -0.08374087103261263, -0.011903831511472614, -0.1388526931583882, -0.25209014293378723, 0.12818216752836853, 0.08389006931017896, 0.09970196985980381, -0.03167196635273348, -1.641819793910842], -43.82079146453839, 4, DynamicHMC.DoubledTurn, 0.9533088858227882, 15), NUTS_Transition{Array{Float64,1},Float64}([1.5898728047226294, 0.20076543100905186, -0.3651683311712954, -0.3518089391865707, -0.032699305485775626, 0.5706753010574768, 0.23740333199871633, -0.44476747630629515, 0.278263557780126, -0.3655008747540924, 0.49540343452943364, -0.04129579776454678, -1.0247304033838498], -46.02746701535557, 4, DynamicHMC.DoubledTurn, 0.9761729861176153, 15), NUTS_Transition{Array{Float64,1},Float64}([1.0302634298919289, 0.27022956205316523, -0.11118119127201224, 0.29762686959721885, -0.02913162643222554, 0.17020746075374005, -0.09426744081871216, -0.2461935194585474, 0.14001189779239487, -0.023968956660215222, 0.2787731607174336, -0.09212777520424004, -1.2721190903710504], -44.547803924262396, 4, DynamicHMC.DoubledTurn, 0.9964639952990774, 15), NUTS_Transition{Array{Float64,1},Float64}([1.0782947982964715, 0.2709430396965989, -0.30041503783259765, -0.14432571762094965, -0.18384768489759687, 0.41349412183308365, 0.21996334117654176, -0.48614047105981034, 0.0713776912896173, -0.3551110064259455, 0.31075460617115047, -0.1316789363653818, -1.5028481679608694], -40.188790495851144, 3, DynamicHMC.AdjacentTurn, 0.9199252220077786, 15), NUTS_Transition{Array{Float64,1},Float64}([1.1226690172842697, 0.2593557479133339, -0.15998883236537856, 0.006724435927729422, -0.06115462901627909, 0.2891635328117982, -0.12042501539074633, -0.27097677791621105, -0.0960293178087063, 0.05148627285937754, 0.18676779488224676, -0.1004742384416987, -1.1856681647134388], -43.32157868306856, 4, DynamicHMC.DoubledTurn, 0.9821127900546188, 15), NUTS_Transition{Array{Float64,1},Float64}([1.7297035745801306, 0.19526220960199506, -0.03477532548005342, 0.09324341553061048, 0.05780326103410789, 0.174899200350702, 0.08605767961782772, -0.41924977149085296, 0.2755895207090583, -0.3357493025034983, 0.2687090570099888, 0.09103895254542409, -1.629290028423575], -44.122860135932704, 4, DynamicHMC.DoubledTurn, 0.9917467601258368, 15)  …  NUTS_Transition{Array{Float64,1},Float64}([0.5774915703417824, 0.33195473613657156, -0.14630241706012315, -0.1243666914037821, -0.3878008189752905, 0.31060761602236514, -0.23841139710957943, -0.4740739995085103, 0.10779976429939939, -0.023784944130503548, 0.4101371456337306, -0.4240006692391842, -1.022751184723995], -48.53949564779, 4, DynamicHMC.DoubledTurn, 0.8560392621133579, 15), NUTS_Transition{Array{Float64,1},Float64}([0.9672738673784036, 0.2664771900070838, -0.4149784798057034, 0.41136399308544497, -0.0285042342440959, 0.46485543214723374, 8.26500614186168e-5, -0.03616085728484167, 0.23475003175948875, -0.13250629007516002, 0.3656440465290024, 0.20455272117960077, -1.4455219026749555], -48.64637515910763, 4, DynamicHMC.DoubledTurn, 0.9877232574923658, 15), NUTS_Transition{Array{Float64,1},Float64}([0.04381894623019545, 0.37697252725686925, -0.17745171784424357, 0.10580580469025481, 0.1391302754218289, 0.5823305335955221, 0.16760048142562228, -0.783711382351645, 0.41066204669699646, -0.10172341997574919, 0.23062678775568898, -0.37625487402486263, -1.1150900707671416], -47.2130506075495, 4, DynamicHMC.DoubledTurn, 0.9999496584742364, 15), NUTS_Transition{Array{Float64,1},Float64}([2.2210587238783748, 0.13474164597059363, -0.12104193905721658, -0.055589289407900894, -0.2216378385862316, 0.06501817001238006, -0.11952769945708515, -0.13504370567595833, 0.10139805408648106, 0.02744142005648329, 0.3113488790334909, 0.2806213527283302, -1.638922519984737], -44.71995827699218, 4, DynamicHMC.DoubledTurn, 1.0, 15), NUTS_Transition{Array{Float64,1},Float64}([0.8775827570721327, 0.2813967027529365, -0.10952686535034492, 0.28184481757491775, -0.31553522538940726, 0.5555682449072166, 0.33899662461991126, -0.516346506626211, 0.007591584146804984, 0.009371572629844852, 0.5243039540296415, -0.2616634860764614, -0.6193414143486992], -45.84485692194845, 4, DynamicHMC.DoubledTurn, 0.9690826863324244, 15), NUTS_Transition{Array{Float64,1},Float64}([-0.03077867244993014, 0.34627551337471213, 0.24704141023398238, 0.5388255373460543, 0.3403326107609473, 0.8415245429368534, 0.5135471024545063, 0.12588849339263739, 0.30675657543016144, 0.026162980255703377, 0.6750871083107526, -0.11825196861619841, -1.1876472919570422], -50.73167406980076, 4, DynamicHMC.DoubledTurn, 0.9764228030360201, 15), NUTS_Transition{Array{Float64,1},Float64}([1.057880899212058, 0.2956224678295059, -0.2898863333841972, -0.10891198123189996, -0.26273513574583346, -0.039337745903711946, -0.2838201226993701, -0.6609913287309531, -0.009422313369609067, -0.5575409313454508, -0.27885553150926345, -0.2939323634377059, -1.468573476174134], -56.803675303683335, 4, DynamicHMC.DoubledTurn, 0.8914910642908078, 15), NUTS_Transition{Array{Float64,1},Float64}([0.4302462662942823, 0.2939949455212641, -0.08459351102865406, 0.4569052285251336, 0.20843365540689265, 0.7975353311747491, 0.6295351671269853, -0.03849396518329236, 0.4797525047608297, -0.14682543611608395, 0.9681037230536214, -0.0016519406099486378, -0.8095575239232181], -51.078277717187014, 4, DynamicHMC.DoubledTurn, 0.9970928272778653, 15), NUTS_Transition{Array{Float64,1},Float64}([0.32877846096995006, 0.33432627325160524, 0.1611861293775134, 0.16157504568478764, -0.40156619438334595, 0.414143639737449, 0.19759111452139705, 0.0723305570679949, 0.14528691908337565, 0.07151126125159446, 0.2207217762543349, -0.1790273624015003, -0.9156688028361302], -55.24882301614401, 4, DynamicHMC.DoubledTurn, 0.9286150309252458, 15), NUTS_Transition{Array{Float64,1},Float64}([1.7884783056200695, 0.1852141580862183, -0.5312959146308983, 0.05236268171822716, 0.26614503780011217, 0.32487772811124643, -0.10043805541159181, -0.7022065855051832, 0.19004316401522559, -0.5203472584483956, 0.3991096350857565, 0.06598615253115726, -1.1735086180030756], -48.2480177905728, 4, DynamicHMC.DoubledTurn, 0.8264009482702953, 15)], NUTS sampler in 13 dimensions
  stepsize (ϵ) ≈ 0.264
  maximum depth = 10
  Gaussian kinetic energy, √diag(M⁻¹): [0.639571668476013, 0.07284301542796646, 0.2284520792727942, 0.21118082048754594, 0.18328206754697773, 0.17829012848136913, 0.17209074074146385, 0.21679928804891585, 0.1816528892146493, 0.16723879344143003, 0.1705023900212237, 0.2691643831044469, 0.3982353881200254]
)</code></pre><p>We use the transformation to obtain the posterior from the chain.</p><pre><code class="language-julia">posterior = TransformVariables.transform.(Ref(problem_transformation(p)), get_position.(chain));
posterior[1:5]</code></pre><pre><code class="language-none">5-element Array{NamedTuple{(:β, :α, :σ),Tuple{Array{Float64,1},Array{Float64,1},Float64}},1}:
 (β = [1.680106412681618, 0.1988355773575641], α = [-0.21843953095331836, 0.07111309635147664, -0.2788503873268048, -0.08551020089314856, -0.2961605289780153, -0.2937783532333108, 0.05534615279303415, -0.07318509979799132, 0.30174193465485316, 0.12372806534400843], σ = 0.18658746292499)       
 (β = [1.6712483281676933, 0.20050300544972272], α = [-0.3722102761677626, -0.254654039929115, 0.095484150017689, 0.5753339161084517, 0.34650260518662346, -0.3231237900891358, 0.11851547991083132, -0.2728164534654172, 0.24117745493835024, -0.06344313243365621], σ = 0.30043244336144326)        
 (β = [0.28183523082708706, 0.3424489288285489], α = [-0.058180986617405825, 0.3497938531055998, -0.10219423200530717, 0.08882326641317188, -0.09484228503853727, -0.16667232124019646, 0.26997103006301765, -0.08853761141796947, 0.28280795285717997, -0.0647453909439192], σ = 0.24696263528723675)
 (β = [1.3008772904109294, 0.24548797641167008], α = [-0.1593200559807764, -0.2225109957570126, 0.00820495490900777, 0.5355720699084394, 0.16695686145617958, -0.37553864471714626, 0.07373655646099007, -0.3975983481971194, 0.2098423726082247, -0.21040923226694025], σ = 0.20388179012297383)     
 (β = [0.9148211004953622, 0.2863536554868037], α = [-0.13562599787225954, 0.29950471853986715, -0.08374087103261263, -0.011903831511472614, -0.1388526931583882, -0.25209014293378723, 0.12818216752836853, 0.08389006931017896, 0.09970196985980381, -0.03167196635273348], σ = 0.1936273595933489) </code></pre><p>Extract the parameter posterior means.</p><pre><code class="language-julia">posterior_β = mean(posterior[i].β for i in 1:length(posterior))
posterior_α = mean(posterior[i].α for i in 1:length(posterior))
posterior_σ = mean(posterior[i].σ for i in 1:length(posterior))</code></pre><pre><code class="language-none">0.300104526742633</code></pre><p>Effective sample sizes (of untransformed draws)</p><pre><code class="language-julia">ess = mapslices(effective_sample_size, get_position_matrix(chain); dims = 1)
ess</code></pre><pre><code class="language-none">1×13 Array{Float64,2}:
 551.67  576.52  888.748  726.057  …  877.825  923.086  623.682  454.317</code></pre><p>NUTS-specific statistics</p><pre><code class="language-julia">NUTS_statistics(chain)</code></pre><pre><code class="language-none">Hamiltonian Monte Carlo sample of length 1000
  acceptance rate mean: 0.92, min/25%/median/75%/max: 0.38 0.88 0.96 0.99 1.0
  termination: AdjacentTurn =&gt; 5% DoubledTurn =&gt; 95%
  depth: 2 =&gt; 0% 3 =&gt; 10% 4 =&gt; 90% 5 =&gt; 0%
</code></pre><p>CmdStan result</p><pre><code class="language-julia">m_12_6_result = &quot;
Iterations = 1:1000
Thinning interval = 1
Chains = 1,2,3,4
Samples per chain = 1000

Empirical Posterior Estimates:
                            Mean                SD               Naive SE             MCSE            ESS
            a          1.076167468  0.7704872560 0.01218247319 0.0210530022 1000.000000
           bp         0.263056273  0.0823415805 0.00130193470 0.0022645077 1000.000000
  a_society.1   -0.191723568  0.2421382537 0.00382854195 0.0060563054 1000.000000
  a_society.2    0.054569029  0.2278506876 0.00360263570 0.0051693148 1000.000000
  a_society.3   -0.035935050  0.1926364647 0.00304584994 0.0039948433 1000.000000
  a_society.4    0.334355037  0.1929971201 0.00305155241 0.0063871707  913.029080
  a_society.5    0.049747513  0.1801287716 0.00284808595 0.0043631095 1000.000000
  a_society.6   -0.311903245  0.2096126337 0.00331426674 0.0053000536 1000.000000
  a_society.7    0.148637507  0.1744680594 0.00275858223 0.0047660246 1000.000000
  a_society.8   -0.164567976  0.1821341074 0.00287979309 0.0034297298 1000.000000
  a_society.9    0.277066965  0.1758237250 0.00278001719 0.0055844175  991.286501
 a_society.10   -0.094149204  0.2846206232 0.00450024719 0.0080735022 1000.000000
sigma_society    0.310352849  0.1374834682 0.00217380450 0.0057325226  575.187461
&quot;;</code></pre><pre><code class="language-none">&quot;\nIterations = 1:1000\nThinning interval = 1\nChains = 1,2,3,4\nSamples per chain = 1000\n\nEmpirical Posterior Estimates:\n                            Mean                SD               Naive SE             MCSE            ESS\n            a          1.076167468  0.7704872560 0.01218247319 0.0210530022 1000.000000\n           bp         0.263056273  0.0823415805 0.00130193470 0.0022645077 1000.000000\n  a_society.1   -0.191723568  0.2421382537 0.00382854195 0.0060563054 1000.000000\n  a_society.2    0.054569029  0.2278506876 0.00360263570 0.0051693148 1000.000000\n  a_society.3   -0.035935050  0.1926364647 0.00304584994 0.0039948433 1000.000000\n  a_society.4    0.334355037  0.1929971201 0.00305155241 0.0063871707  913.029080\n  a_society.5    0.049747513  0.1801287716 0.00284808595 0.0043631095 1000.000000\n  a_society.6   -0.311903245  0.2096126337 0.00331426674 0.0053000536 1000.000000\n  a_society.7    0.148637507  0.1744680594 0.00275858223 0.0047660246 1000.000000\n  a_society.8   -0.164567976  0.1821341074 0.00287979309 0.0034297298 1000.000000\n  a_society.9    0.277066965  0.1758237250 0.00278001719 0.0055844175  991.286501\n a_society.10   -0.094149204  0.2846206232 0.00450024719 0.0080735022 1000.000000\nsigma_society    0.310352849  0.1374834682 0.00217380450 0.0057325226  575.187461\n&quot;</code></pre><p>Show means</p><pre><code class="language-julia">[posterior_β, posterior_α, [posterior_σ]]</code></pre><pre><code class="language-none">3-element Array{Array{Float64,1},1}:
 [1.100538679074201, 0.2607930215177328]                                                                                                                                                                                
 [-0.19075965472100273, 0.046222962735816074, -0.05052171370839433, 0.32235420411334037, 0.04554564459766545, -0.31521910845824863, 0.14574053305912882, -0.16625984018677933, 0.2701938447727243, -0.09537565905962682]
 [0.300104526742633]                                                                                                                                                                                                    </code></pre><p>End of m12.6d.jl</p><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p><footer><hr/><a class="previous" href="../../10/m10.04d2/"><span class="direction">Previous</span><span class="title">m10.04d2</span></a><a class="next" href="../m12.6d1/"><span class="direction">Next</span><span class="title">m12.6d1</span></a></footer></article></body></html>
