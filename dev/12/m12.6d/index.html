<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>m12.6d · DynamicHMCModels.jl</title><link href="https://cdnjs.cloudflare.com/ajax/libs/normalize/4.2.0/normalize.min.css" rel="stylesheet" type="text/css"/><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.2.0/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link href="../../assets/documenter.css" rel="stylesheet" type="text/css"/></head><body><nav class="toc"><h1>DynamicHMCModels.jl</h1><select id="version-selector" onChange="window.location.href=this.value" style="visibility: hidden"></select><form class="search" id="search-form" action="../../search/"><input id="search-query" name="q" type="text" placeholder="Search docs"/></form><ul><li><a class="toctext" href="../../intro/">Home</a></li><li><span class="toctext">Chapter 02</span><ul><li><a class="toctext" href="../../02/m2.1d/">m2.1d</a></li></ul></li><li><span class="toctext">Chapter 04</span><ul><li><a class="toctext" href="../../04/m4.1d/">m4.1d</a></li><li><a class="toctext" href="../../04/m4.2d/">m4.2d</a></li><li><a class="toctext" href="../../04/m4.5d/">m4.5d</a></li></ul></li><li><span class="toctext">Chapter 05</span><ul><li><a class="toctext" href="../../05/m5.1d/">m5.1d</a></li><li><a class="toctext" href="../../05/m5.1d1/">m5.1d1</a></li><li><a class="toctext" href="../../05/m5.3d/">m5.3d</a></li><li><a class="toctext" href="../../05/m5.6d/">m5.6d</a></li></ul></li><li><span class="toctext">Chapter 08</span><ul><li><a class="toctext" href="../../08/m8.1d/">m8.1d</a></li></ul></li><li><span class="toctext">Chapter 10</span><ul><li><a class="toctext" href="../../10/m10.02d/">m10.02d</a></li><li><a class="toctext" href="../../10/m10.02d1/">m10.02d1</a></li><li><a class="toctext" href="../../10/m10.04d/">m10.04d</a></li><li><a class="toctext" href="../../10/m10.04d1/">m10.04d1</a></li><li><a class="toctext" href="../../10/m10.04d2/">m10.04d2</a></li></ul></li><li><span class="toctext">Chapter 12</span><ul><li class="current"><a class="toctext" href>m12.6d</a><ul class="internal"></ul></li><li><a class="toctext" href="../m12.6d1/">m12.6d1</a></li><li><a class="toctext" href="../m12.6d2/">m12.6d2</a></li></ul></li><li><a class="toctext" href="../../">Functions</a></li></ul></nav><article id="docs"><header><nav><ul><li>Chapter 12</li><li><a href>m12.6d</a></li></ul><a class="edit-page" href="https://github.com/StatisticalRethinkingJulia/DynamicHMCModels.jl/blob/master/scripts/12/m12.6d.jl"><span class="fa"></span> Edit on GitHub</a></nav><hr/><div id="topbar"><span>m12.6d</span><a class="fa fa-bars" href="#"></a></div></header><div><pre><code class="language-julia">using DynamicHMCModels

ProjDir = rel_path_d(&quot;..&quot;, &quot;scripts&quot;, &quot;12&quot;)

df = CSV.read(rel_path( &quot;..&quot;, &quot;data&quot;,  &quot;Kline.csv&quot;), delim=&#39;;&#39;);
size(df) # Should be 10x5</code></pre><pre><code class="language-none">(10, 5)</code></pre></div><p>New col logpop, set log() for population data</p><div><pre><code class="language-julia">df[:logpop] = map((x) -&gt; log(x), df[:population]);
df[:society] = 1:10;

first(df[[:total_tools, :logpop, :society]], 5)

struct m_12_06d_model{TY &lt;: AbstractVector, TX &lt;: AbstractMatrix,
  TS &lt;: AbstractVector}
    &quot;Observations (total_tools).&quot;
    y::TY
    &quot;Covariates (logpop)&quot;
    X::TX
    &quot;Society&quot;
    S::TS
    &quot;Number of observations (10)&quot;
    N::Int
    &quot;Number of societies (also 10)&quot;
    N_societies::Int
end</code></pre></div><p>Make the type callable with the parameters <em>as a single argument</em>.</p><div><pre><code class="language-julia">function (problem::m_12_06d_model)(θ)
    @unpack y, X, S, N, N_societies = problem   # extract the data
    @unpack β, α, σ = θ  # β : a, bp, α : a_society
    ll = 0.0
    ll += logpdf(Cauchy(0, 1), σ)
    ll += sum(logpdf.(Normal(0, σ), α)) # α[1:10]
    ll += logpdf.(Normal(0, 10), β[1]) # a
    ll += logpdf.(Normal(0, 1), β[2]) # a
    ll += sum(
      [loglikelihood(Poisson(exp(α[S[i]] + dot(X[i, :], β))), [y[i]]) for i in 1:N]
    )
    ll
end</code></pre></div><p>Instantiate the model with data and inits.</p><div><pre><code class="language-julia">N = size(df, 1)
N_societies = length(unique(df[:society]))
X = hcat(ones(Int64, N), df[:logpop]);
S = df[:society]
y = df[:total_tools]
p = m_12_06d_model(y, X, S, N, N_societies);
θ = (β = [1.0, 0.25], α = rand(Normal(0, 1), N_societies), σ = 0.2)
p(θ)</code></pre><pre><code class="language-none">-172.84553121204345</code></pre></div><p>Write a function to return properly dimensioned transformation.</p><div><pre><code class="language-julia">problem_transformation(p::m_12_06d_model) =
    as( (β = as(Array, size(p.X, 2)), α = as(Array, p.N_societies), σ = asℝ₊) )</code></pre></div><p>Wrap the problem with a transformation, then use Flux for the gradient.</p><div><pre><code class="language-julia">P = TransformedLogDensity(problem_transformation(p), p)
∇P = LogDensityRejectErrors(ADgradient(:ForwardDiff, P));
#∇P = ADgradient(:ForwardDiff, P);</code></pre></div><p>Tune and sample.</p><div><pre><code class="language-julia">chain, NUTS_tuned = NUTS_init_tune_mcmc(∇P, 1000);</code></pre><pre><code class="language-none">MCMC, adapting ϵ (75 steps)
0.0033 s/step ...done
MCMC, adapting ϵ (25 steps)
0.0035 s/step ...done
MCMC, adapting ϵ (50 steps)
0.0044 s/step ...done
MCMC, adapting ϵ (100 steps)
0.0019 s/step ...done
MCMC, adapting ϵ (200 steps)
0.001 s/step ...done
MCMC, adapting ϵ (400 steps)
0.00074 s/step ...done
MCMC, adapting ϵ (50 steps)
0.00088 s/step ...done
MCMC (1000 steps)
0.00044 s/step ...done
(NUTS_Transition{Array{Float64,1},Float64}[NUTS_Transition{Array{Float64,1},Float64}([0.9497791414783584, 0.2749280103694748, -0.10560897595111175, 0.024466082341852137, -0.016986979721207534, 0.04287282532684239, 0.10487740015672563, -0.39381185601590085, 0.21201081036429534, -0.010719218542347439, 0.24652594765032762, 0.0018998343272542198, -1.7242597524907113], -42.75994765679204, 4, DynamicHMC.DoubledTurn, 0.9859131538904218, 15), NUTS_Transition{Array{Float64,1},Float64}([1.4206064713579742, 0.23423144851568062, -0.23921880282023433, -0.01722242068345277, -0.0024777440651639754, 0.2992931184067317, 0.05885364956354139, -0.12426176769501476, 0.007846092122566935, -0.36420574685764595, 0.030731124077495217, 0.024649999278719185, -1.894713033253799], -42.09296058577454, 3, DynamicHMC.DoubledTurn, 0.916559633956578, 7), NUTS_Transition{Array{Float64,1},Float64}([0.80676970300353, 0.2924324078816422, -0.18674003160787564, 0.11915024253314514, 0.18920112074359874, 0.314712116024399, 0.08892168792473545, -0.018791467123482848, 0.059036258237274236, -0.21721568391163804, 0.13946179110242932, 0.010278473088866872, -1.9074096075942841], -44.600620812668296, 4, DynamicHMC.DoubledTurn, 0.8882878976988361, 15), NUTS_Transition{Array{Float64,1},Float64}([1.3856630735898947, 0.23333221784019134, -0.11356787408900652, -0.1693329928823632, -0.4145898734562585, 0.42160245798831675, -0.18539638783360704, -0.41704500893271323, -0.07086699046195552, -0.10158809332886748, 0.27896535752421797, -0.11629557641446996, -0.9371900821091244], -43.632137375843804, 4, DynamicHMC.DoubledTurn, 0.9859936036242783, 15), NUTS_Transition{Array{Float64,1},Float64}([1.1164323320540517, 0.25649891645401063, -0.08153464960375836, 0.2305294256765664, 0.3088032122908887, 0.1339251730401847, -0.20243205747050896, -0.0916280017674691, 0.2471911363171652, -0.2334243056331549, 0.3127537535061673, 0.12091322017367742, -1.4730615992969225], -47.310030358970465, 4, DynamicHMC.DoubledTurn, 0.9908054145424674, 15), NUTS_Transition{Array{Float64,1},Float64}([0.9204259590827792, 0.2647166944367585, -0.4773576501435494, 0.455509916730645, 0.06517962913390381, 0.3893224855243726, -0.127767006631209, -0.06843395844951941, 0.38640271057078085, -0.1568644128576043, 0.6075731144840971, 0.18765940648928375, -0.5159702982452564], -48.750292126190615, 4, DynamicHMC.DoubledTurn, 0.9951563680552715, 15), NUTS_Transition{Array{Float64,1},Float64}([0.9821523257006246, 0.2508359182844513, -0.02389310064245915, 0.1656544292328872, 0.3011197855068138, 0.41541368826462693, 0.30160991770712636, 0.11396892959999046, 0.33987587649200485, -0.0449197947250725, 0.5763434603854733, 0.12773956985270052, -1.3574367671807566], -48.25259346367901, 4, DynamicHMC.DoubledTurn, 0.9246840676249704, 15), NUTS_Transition{Array{Float64,1},Float64}([2.72770970166337, 0.07386995827306639, -0.25116921485132426, -0.0015146421514543595, -0.38146453108514256, 0.4856986868123181, 0.13450679906422158, -0.40023937605904747, 0.21203679418850818, 0.08608226410698745, 0.47380969215481017, 0.6306734399461841, -0.6716840794148897], -43.25018097739059, 4, DynamicHMC.DoubledTurn, 0.9932302742913529, 15), NUTS_Transition{Array{Float64,1},Float64}([2.8779153904998, 0.06556242888542253, -0.4679104820413929, -0.2817700376109485, -0.49661242950045587, 0.2746400148198889, 0.005917646684201715, -0.5722756645866481, 0.13573721246636766, -0.029617315924134323, 0.2952505135734836, 0.5795286214380779, -0.7488358363404674], -45.556010750123114, 4, DynamicHMC.DoubledTurn, 0.986333507249326, 15), NUTS_Transition{Array{Float64,1},Float64}([3.1716344879639498, 0.05656259400867957, -0.34771973522551985, -0.3762341182291088, -0.34763412285339473, 0.06622635797667122, -0.37885163070575906, -0.5598365790514489, 0.12825563826343161, -0.1276658805846468, 0.09476164612417468, 0.33014442001339583, -1.0577359852731203], -48.4624905818597, 4, DynamicHMC.DoubledTurn, 0.9842588854387269, 15)  …  NUTS_Transition{Array{Float64,1},Float64}([0.1623933956950982, 0.32919757786372283, -0.023454001248243823, 0.36032386894366025, 0.5658596406307739, 0.5521149787745141, 0.30702926408265274, -0.03931897445243843, 0.5697116187187088, 0.12804350841336334, 0.44983805416817396, -0.11612818292163804, -1.0396257084524074], -48.890709321570256, 4, DynamicHMC.DoubledTurn, 0.98861512037937, 15), NUTS_Transition{Array{Float64,1},Float64}([0.23515093216804822, 0.3257531317675079, -0.23822548465261692, 0.25107069811746724, 0.5079502286581488, 0.6720035974010005, 0.39250844526550605, -0.1534825628724069, 0.6077801404941962, 0.17459520572192838, 0.7296996167179075, -0.013992230273000235, -1.0959796300317892], -49.96870016295115, 4, DynamicHMC.DoubledTurn, 0.9864111755167566, 15), NUTS_Transition{Array{Float64,1},Float64}([1.4502848663898842, 0.218329466584512, 0.10173416204876218, 0.3528114215701802, -0.042564670107769306, 0.3978445021844608, -0.051023556580790774, -0.3343057635710843, -0.019093038628421502, -0.005111163149474837, 0.13833957474518083, 0.18586250982438893, -1.1438401957211453], -48.00825107412492, 4, DynamicHMC.DoubledTurn, 0.9882861193790278, 15), NUTS_Transition{Array{Float64,1},Float64}([1.6735920286188446, 0.19974691927688829, -0.6670674785975853, 0.10830160602677032, -0.08869699728675358, 0.49431801894757577, -0.012025183800091299, 0.1060062811743146, -0.041133693928390586, -0.19469869337044401, 0.37492270007611217, -0.07728506217681647, -0.7164835033988143], -51.0820675724397, 4, DynamicHMC.DoubledTurn, 0.9439315356864507, 15), NUTS_Transition{Array{Float64,1},Float64}([1.5802678959757428, 0.2164976908414421, -0.37877079418631965, -0.04498624954720435, -0.026541436183148373, 0.4413071464288032, 0.015219403716474622, 0.01378816282988185, -0.06993150285215022, -0.20814224633926776, 0.3076992260044517, -0.10042982707535905, -1.2611737108181882], -46.433286305242774, 3, DynamicHMC.DoubledTurn, 0.9180950143897528, 7), NUTS_Transition{Array{Float64,1},Float64}([1.1713427087877328, 0.2660654842441167, -0.3615175587885874, 0.0065030323041969425, 0.035200687062722676, 0.11858658325462781, -0.19288490613686876, -0.1967296434413408, -0.020360151427745707, -0.29805450167435615, 0.23816065390065455, -0.25546080659058956, -1.6908611698608038], -43.81586542591179, 4, DynamicHMC.DoubledTurn, 0.9911008110476994, 15), NUTS_Transition{Array{Float64,1},Float64}([1.2927290599219514, 0.22754365075231964, 0.038890569519249595, -0.007628821216241682, -0.1494142401590289, 0.3112356565378932, 0.09321877303821095, -0.23255229264677965, 0.14490131955906113, -0.04520871970460346, 0.130887140061689, -0.053654600408185295, -1.7444580720868599], -42.80709556333844, 4, DynamicHMC.AdjacentTurn, 0.7641830421899145, 31), NUTS_Transition{Array{Float64,1},Float64}([0.9977688597760402, 0.26353343398207335, -0.15988164499249197, 0.5888211914469265, -0.13202202396460208, 0.30498050198556137, 0.19810008049568925, -0.42612997603624647, 0.1643411244221742, -0.09811718933933627, 0.5127007812306095, -0.05929016656220914, -1.0409292094275566], -46.488470381804525, 3, DynamicHMC.AdjacentTurn, 0.9784202835446032, 15), NUTS_Transition{Array{Float64,1},Float64}([0.6575030093848938, 0.2966942827659924, -0.42659932600600414, 0.07389413663126063, 0.20000458233073326, 0.49742942027176396, 0.2568489572209155, -0.20757525275567848, 0.3639267804712506, -0.0033826406787387294, 0.23217948725176207, -0.06991782607368112, -1.2595180818558651], -45.30771199617695, 4, DynamicHMC.DoubledTurn, 0.9760191579309383, 15), NUTS_Transition{Array{Float64,1},Float64}([-0.47033996577040527, 0.4224262627210035, 0.1003034622463456, 0.32317736479482817, 0.2488993978253058, 0.5888611263441144, 0.06099217644058503, -0.09608626651721339, 0.33918268864396817, -0.16378670846615326, 0.2323279886603695, -0.5280758123140982, -0.9337586599055828], -41.84222850726679, 4, DynamicHMC.DoubledTurn, 0.9812713056695083, 15)], NUTS sampler in 13 dimensions
  stepsize (ϵ) ≈ 0.23
  maximum depth = 10
  Gaussian kinetic energy, √diag(M⁻¹): [0.7245124021483266, 0.08044615553617612, 0.25464036888652025, 0.22745204139000033, 0.18455586140829727, 0.18939079871487804, 0.16745357391468849, 0.21759629160729868, 0.16376133367628123, 0.18265269961960406, 0.1705132852063207, 0.27942717093081293, 0.47137650819985877]
)</code></pre></div><p>We use the transformation to obtain the posterior from the chain.</p><div><pre><code class="language-julia">posterior = TransformVariables.transform.(Ref(problem_transformation(p)), get_position.(chain));
posterior[1:5]</code></pre><pre><code class="language-none">5-element Array{NamedTuple{(:β, :α, :σ),Tuple{Array{Float64,1},Array{Float64,1},Float64}},1}:
 (β = [0.9497791414783584, 0.2749280103694748], α = [-0.10560897595111175, 0.024466082341852137, -0.016986979721207534, 0.04287282532684239, 0.10487740015672563, -0.39381185601590085, 0.21201081036429534, -0.010719218542347439, 0.24652594765032762, 0.0018998343272542198], σ = 0.17830499275916398)
 (β = [1.4206064713579742, 0.23423144851568062], α = [-0.23921880282023433, -0.01722242068345277, -0.0024777440651639754, 0.2992931184067317, 0.05885364956354139, -0.12426176769501476, 0.007846092122566935, -0.36420574685764595, 0.030731124077495217, 0.024649999278719185], σ = 0.15036147759984597)
 (β = [0.80676970300353, 0.2924324078816422], α = [-0.18674003160787564, 0.11915024253314514, 0.18920112074359874, 0.314712116024399, 0.08892168792473545, -0.018791467123482848, 0.059036258237274236, -0.21721568391163804, 0.13946179110242932, 0.010278473088866872], σ = 0.14846447015312933)
 (β = [1.3856630735898947, 0.23333221784019134], α = [-0.11356787408900652, -0.1693329928823632, -0.4145898734562585, 0.42160245798831675, -0.18539638783360704, -0.41704500893271323, -0.07086699046195552, -0.10158809332886748, 0.27896535752421797, -0.11629557641446996], σ = 0.3917270110753005)
 (β = [1.1164323320540517, 0.25649891645401063], α = [-0.08153464960375836, 0.2305294256765664, 0.3088032122908887, 0.1339251730401847, -0.20243205747050896, -0.0916280017674691, 0.2471911363171652, -0.2334243056331549, 0.3127537535061673, 0.12091322017367742], σ = 0.229222621974707)</code></pre></div><p>Extract the parameter posterior means.</p><div><pre><code class="language-julia">posterior_β = mean(posterior[i].β for i in 1:length(posterior))
posterior_α = mean(posterior[i].α for i in 1:length(posterior))
posterior_σ = mean(posterior[i].σ for i in 1:length(posterior))</code></pre><pre><code class="language-none">0.31057643587589673</code></pre></div><p>Effective sample sizes (of untransformed draws)</p><div><pre><code class="language-julia">ess = mapslices(effective_sample_size, get_position_matrix(chain); dims = 1)
ess</code></pre><pre><code class="language-none">1×13 Array{Float64,2}:
 691.538  711.775  1000.0  931.313  …  1000.0  756.466  659.484  198.875</code></pre></div><p>NUTS-specific statistics</p><div><pre><code class="language-julia">NUTS_statistics(chain)</code></pre><pre><code class="language-none">Hamiltonian Monte Carlo sample of length 1000
  acceptance rate mean: 0.94, min/25%/median/75%/max: 0.52 0.92 0.97 0.99 1.0
  termination: AdjacentTurn =&gt; 6% DoubledTurn =&gt; 94%
  depth: 2 =&gt; 0% 3 =&gt; 7% 4 =&gt; 92% 5 =&gt; 1%</code></pre></div><p>CmdStan result</p><div><pre><code class="language-julia">m_12_6_result = &quot;
Iterations = 1:1000
Thinning interval = 1
Chains = 1,2,3,4
Samples per chain = 1000

Empirical Posterior Estimates:
                            Mean                SD               Naive SE             MCSE            ESS
            a          1.076167468  0.7704872560 0.01218247319 0.0210530022 1000.000000
           bp         0.263056273  0.0823415805 0.00130193470 0.0022645077 1000.000000
  a_society.1   -0.191723568  0.2421382537 0.00382854195 0.0060563054 1000.000000
  a_society.2    0.054569029  0.2278506876 0.00360263570 0.0051693148 1000.000000
  a_society.3   -0.035935050  0.1926364647 0.00304584994 0.0039948433 1000.000000
  a_society.4    0.334355037  0.1929971201 0.00305155241 0.0063871707  913.029080
  a_society.5    0.049747513  0.1801287716 0.00284808595 0.0043631095 1000.000000
  a_society.6   -0.311903245  0.2096126337 0.00331426674 0.0053000536 1000.000000
  a_society.7    0.148637507  0.1744680594 0.00275858223 0.0047660246 1000.000000
  a_society.8   -0.164567976  0.1821341074 0.00287979309 0.0034297298 1000.000000
  a_society.9    0.277066965  0.1758237250 0.00278001719 0.0055844175  991.286501
 a_society.10   -0.094149204  0.2846206232 0.00450024719 0.0080735022 1000.000000
sigma_society    0.310352849  0.1374834682 0.00217380450 0.0057325226  575.187461
&quot;;</code></pre><pre><code class="language-none">&quot;\nIterations = 1:1000\nThinning interval = 1\nChains = 1,2,3,4\nSamples per chain = 1000\n\nEmpirical Posterior Estimates:\n                            Mean                SD               Naive SE             MCSE            ESS\n            a          1.076167468  0.7704872560 0.01218247319 0.0210530022 1000.000000\n           bp         0.263056273  0.0823415805 0.00130193470 0.0022645077 1000.000000\n  a_society.1   -0.191723568  0.2421382537 0.00382854195 0.0060563054 1000.000000\n  a_society.2    0.054569029  0.2278506876 0.00360263570 0.0051693148 1000.000000\n  a_society.3   -0.035935050  0.1926364647 0.00304584994 0.0039948433 1000.000000\n  a_society.4    0.334355037  0.1929971201 0.00305155241 0.0063871707  913.029080\n  a_society.5    0.049747513  0.1801287716 0.00284808595 0.0043631095 1000.000000\n  a_society.6   -0.311903245  0.2096126337 0.00331426674 0.0053000536 1000.000000\n  a_society.7    0.148637507  0.1744680594 0.00275858223 0.0047660246 1000.000000\n  a_society.8   -0.164567976  0.1821341074 0.00287979309 0.0034297298 1000.000000\n  a_society.9    0.277066965  0.1758237250 0.00278001719 0.0055844175  991.286501\n a_society.10   -0.094149204  0.2846206232 0.00450024719 0.0080735022 1000.000000\nsigma_society    0.310352849  0.1374834682 0.00217380450 0.0057325226  575.187461\n&quot;</code></pre></div><p>Show means</p><div><pre><code class="language-julia">[posterior_β, posterior_α, [posterior_σ]]</code></pre><pre><code class="language-none">3-element Array{Array{Float64,1},1}:
 [1.0975213603572906, 0.2607915371274786]
 [-0.18991159384849254, 0.056954955980339304, -0.04623844178558179, 0.3306435600274941, 0.04871119309490904, -0.3115006230838352, 0.14883101239316343, -0.1699282053243191, 0.2853918241997353, -0.09082427667555928]
 [0.31057643587589673]</code></pre></div><p>End of m12.6d.jl</p><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p><footer><hr/><a class="previous" href="../../10/m10.04d2/"><span class="direction">Previous</span><span class="title">m10.04d2</span></a><a class="next" href="../m12.6d1/"><span class="direction">Next</span><span class="title">m12.6d1</span></a></footer></article></body></html>
