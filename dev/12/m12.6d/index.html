<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>m12.6d · DynamicHMCModels.jl</title><link href="https://cdnjs.cloudflare.com/ajax/libs/normalize/4.2.0/normalize.min.css" rel="stylesheet" type="text/css"/><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.2.0/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link href="../../assets/documenter.css" rel="stylesheet" type="text/css"/></head><body><nav class="toc"><h1>DynamicHMCModels.jl</h1><select id="version-selector" onChange="window.location.href=this.value" style="visibility: hidden"></select><form class="search" id="search-form" action="../../search/"><input id="search-query" name="q" type="text" placeholder="Search docs"/></form><ul><li><a class="toctext" href="../../intro/">Home</a></li><li><span class="toctext">Chapter 02</span><ul><li><a class="toctext" href="../../02/m2.1d/">m2.1d</a></li></ul></li><li><span class="toctext">Chapter 04</span><ul><li><a class="toctext" href="../../04/m4.1d/">m4.1d</a></li><li><a class="toctext" href="../../04/m4.2d/">m4.2d</a></li><li><a class="toctext" href="../../04/m4.5d/">m4.5d</a></li></ul></li><li><span class="toctext">Chapter 05</span><ul><li><a class="toctext" href="../../05/m5.1d/">m5.1d</a></li><li><a class="toctext" href="../../05/m5.1d1/">m5.1d1</a></li><li><a class="toctext" href="../../05/m5.3d/">m5.3d</a></li><li><a class="toctext" href="../../05/m5.6d/">m5.6d</a></li></ul></li><li><span class="toctext">Chapter 08</span><ul><li><a class="toctext" href="../../08/m8.1d/">m8.1d</a></li></ul></li><li><span class="toctext">Chapter 10</span><ul><li><a class="toctext" href="../../10/m10.02d/">m10.02d</a></li><li><a class="toctext" href="../../10/m10.02d1/">m10.02d1</a></li><li><a class="toctext" href="../../10/m10.04d/">m10.04d</a></li><li><a class="toctext" href="../../10/m10.04d1/">m10.04d1</a></li><li><a class="toctext" href="../../10/m10.04d2/">m10.04d2</a></li></ul></li><li><span class="toctext">Chapter 12</span><ul><li class="current"><a class="toctext" href>m12.6d</a><ul class="internal"></ul></li><li><a class="toctext" href="../m12.6d1/">m12.6d1</a></li><li><a class="toctext" href="../m12.6d2/">m12.6d2</a></li></ul></li><li><a class="toctext" href="../../">Functions</a></li></ul></nav><article id="docs"><header><nav><ul><li>Chapter 12</li><li><a href>m12.6d</a></li></ul><a class="edit-page" href="https://github.com/StatisticalRethinkingJulia/DynamicHMCModels.jl/blob/master/scripts/12/m12.6d.jl"><span class="fa"></span> Edit on GitHub</a></nav><hr/><div id="topbar"><span>m12.6d</span><a class="fa fa-bars" href="#"></a></div></header><div><pre><code class="language-julia">using DynamicHMCModels

ProjDir = rel_path_d(&quot;..&quot;, &quot;scripts&quot;, &quot;12&quot;)

df = CSV.read(rel_path( &quot;..&quot;, &quot;data&quot;,  &quot;Kline.csv&quot;), delim=&#39;;&#39;);
size(df) # Should be 10x5</code></pre><pre><code class="language-none">(10, 5)</code></pre></div><p>New col logpop, set log() for population data</p><div><pre><code class="language-julia">df[:logpop] = map((x) -&gt; log(x), df[:population]);
df[:society] = 1:10;

first(df[[:total_tools, :logpop, :society]], 5)

struct m_12_06d_model{TY &lt;: AbstractVector, TX &lt;: AbstractMatrix,
  TS &lt;: AbstractVector}
    &quot;Observations (total_tools).&quot;
    y::TY
    &quot;Covariates (logpop)&quot;
    X::TX
    &quot;Society&quot;
    S::TS
    &quot;Number of observations (10)&quot;
    N::Int
    &quot;Number of societies (also 10)&quot;
    N_societies::Int
end</code></pre></div><p>Make the type callable with the parameters <em>as a single argument</em>.</p><div><pre><code class="language-julia">function (problem::m_12_06d_model)(θ)
    @unpack y, X, S, N, N_societies = problem   # extract the data
    @unpack β, α, σ = θ  # β : a, bp, α : a_society
    ll = 0.0
    ll += logpdf(Cauchy(0, 1), σ)
    ll += sum(logpdf.(Normal(0, σ), α)) # α[1:10]
    ll += logpdf.(Normal(0, 10), β[1]) # a
    ll += logpdf.(Normal(0, 1), β[2]) # a
    ll += sum(
      [loglikelihood(Poisson(exp(α[S[i]] + dot(X[i, :], β))), [y[i]]) for i in 1:N]
    )
    ll
end</code></pre></div><p>Instantiate the model with data and inits.</p><div><pre><code class="language-julia">N = size(df, 1)
N_societies = length(unique(df[:society]))
X = hcat(ones(Int64, N), df[:logpop]);
S = df[:society]
y = df[:total_tools]
p = m_12_06d_model(y, X, S, N, N_societies);
θ = (β = [1.0, 0.25], α = rand(Normal(0, 1), N_societies), σ = 0.2)
p(θ)</code></pre><pre><code class="language-none">-369.63999298699406</code></pre></div><p>Write a function to return properly dimensioned transformation.</p><div><pre><code class="language-julia">problem_transformation(p::m_12_06d_model) =
    as( (β = as(Array, size(p.X, 2)), α = as(Array, p.N_societies), σ = asℝ₊) )</code></pre></div><p>Wrap the problem with a transformation, then use Flux for the gradient.</p><div><pre><code class="language-julia">P = TransformedLogDensity(problem_transformation(p), p)
∇P = LogDensityRejectErrors(ADgradient(:ForwardDiff, P));
#∇P = ADgradient(:ForwardDiff, P);</code></pre></div><p>Tune and sample.</p><div><pre><code class="language-julia">chain, NUTS_tuned = NUTS_init_tune_mcmc(∇P, 1000);</code></pre><pre><code class="language-none">MCMC, adapting ϵ (75 steps)
0.0025 s/step ...done
MCMC, adapting ϵ (25 steps)
0.0047 s/step ...done
MCMC, adapting ϵ (50 steps)
0.0036 s/step ...done
MCMC, adapting ϵ (100 steps)
0.002 s/step ...done
MCMC, adapting ϵ (200 steps)
0.001 s/step ...done
MCMC, adapting ϵ (400 steps)
0.00065 s/step ...done
MCMC, adapting ϵ (50 steps)
0.00056 s/step ...done
MCMC (1000 steps)
0.00051 s/step ...done
(NUTS_Transition{Array{Float64,1},Float64}[NUTS_Transition{Array{Float64,1},Float64}([1.2893994454717073, 0.2663196786861505, -0.13676293366212028, -0.08382550989891122, -0.20009129007714138, 0.23774805787179798, -0.30680950100078563, -0.26452053841830914, -0.1975187389758456, -0.4124953890393894, 0.1091145519858589, -0.448796667962551, -1.4226639792340103], -43.26707846278354, 4, DynamicHMC.DoubledTurn, 0.9287968104014339, 15), NUTS_Transition{Array{Float64,1},Float64}([0.9709573886845702, 0.2950448851085812, -0.22466509144749747, 0.00696908236164856, -0.24772126530037117, 0.291576282444512, -0.24073244847934444, -0.45508401751219285, -0.1315353380827456, -0.45112444888946074, 0.12611912344643594, -0.4497329991186524, -1.1823149602398788], -42.19663822358812, 4, DynamicHMC.DoubledTurn, 0.9997676971215648, 15), NUTS_Transition{Array{Float64,1},Float64}([1.7590953982488526, 0.17902150651566667, -0.13703612969024725, -0.23616171495504662, 0.014057000005083045, 0.19128828197002995, 0.41445578210035516, -0.25113635480734303, 0.32064757935363375, -0.1058768024522148, 0.40352586841497107, 0.2941776971890755, -1.1107424184351373], -44.13919456344722, 4, DynamicHMC.DoubledTurn, 0.9750260979379566, 15), NUTS_Transition{Array{Float64,1},Float64}([1.001809543867576, 0.26796509296273696, 0.14364755074699886, -0.24180500978391925, -0.2265865191775973, 0.3021171717380829, 0.37285580477144964, -0.5808379629166184, 0.3513996610504196, -0.14657391729347952, 0.4075585986733977, -0.16753785398163548, -1.0483517220621712], -48.954001572719775, 4, DynamicHMC.DoubledTurn, 0.9489830204093569, 15), NUTS_Transition{Array{Float64,1},Float64}([0.31788218015788, 0.344913785849589, -0.22261080217602164, 0.023997769215520107, -0.08771315734626797, 0.631372375754273, 0.16157460069893956, -0.12775195383436086, 0.23372418479717158, -0.263324998599432, 0.28410573952414997, -0.36826506647861373, -1.3438883215756963], -45.90862680143171, 4, DynamicHMC.DoubledTurn, 0.9991435329018309, 15), NUTS_Transition{Array{Float64,1},Float64}([1.615248944019415, 0.21073825823113565, -0.24060743340193835, -0.0009711238062592928, -0.12405340735163395, -0.006026921595284757, -0.22113881563315502, -0.7724727313378081, -0.03476972369914248, -0.11968215503149679, 0.16262884346021833, -0.04637835381053004, -0.9844088816069466], -45.105699802531234, 4, DynamicHMC.DoubledTurn, 0.7522053097911111, 15), NUTS_Transition{Array{Float64,1},Float64}([0.7684511971338374, 0.28428174903845527, -0.15029376010376194, 0.018686496577040426, -0.000511554229349287, 0.7256309618339533, 0.35827255965720195, 0.04504212807917045, 0.1056327908529522, -0.1483677970100998, 0.35765178001828746, -0.09840672827980988, -1.4247246768407877], -50.07520420285439, 4, DynamicHMC.DoubledTurn, 0.9812689180737268, 15), NUTS_Transition{Array{Float64,1},Float64}([1.3742998756191622, 0.23909893369914662, -0.08983284035156572, -0.12689267584511726, -0.07279321578041402, -0.055321866842708414, -0.1800001368560945, -0.6704051005881421, 0.13532630561386966, -0.15488318816478755, 0.1764447699868984, -0.13861449032143885, -1.334191759469226], -43.90595119678178, 4, DynamicHMC.DoubledTurn, 0.9451872179844212, 15), NUTS_Transition{Array{Float64,1},Float64}([1.379754256567259, 0.24376576166506256, -0.07998619066722831, -0.12573873947153358, -0.11875039196922411, 0.1743202545050196, -0.2462952611430405, -0.7410630681878515, 0.178170881975466, -0.16613245782161312, 0.3540574983218846, -0.19381841109825673, -1.1535644718079936], -43.84369227009941, 4, DynamicHMC.DoubledTurn, 0.8478245452413431, 15), NUTS_Transition{Array{Float64,1},Float64}([1.2995063530789883, 0.22211511531904643, -0.20455924286442084, -0.05659419489664406, -0.07599335738808305, 0.2535330736236028, 0.3416899129495927, -0.04086522465142946, 0.08190385858383444, 0.21083343269316113, 0.30521603412610254, 0.22871417896692944, -1.4789354969789978], -45.376147805383184, 4, DynamicHMC.DoubledTurn, 0.960651427653764, 15)  …  NUTS_Transition{Array{Float64,1},Float64}([0.7953031278190038, 0.2929812297670425, 0.018375106699482127, 0.22926253187502604, 0.42883199857775106, 0.3479083653279128, 0.03977329181538099, -0.5641938078040379, 0.35323801110707265, -0.31296188899058797, 0.17118188538706702, -0.21577815606644973, -1.3131988074433016], -46.05167275586899, 4, DynamicHMC.DoubledTurn, 0.9420805301376902, 15), NUTS_Transition{Array{Float64,1},Float64}([0.8365790374377279, 0.2791795071600737, 0.01956777083440152, 0.22543192563312336, 0.2691782838629469, 0.33647819098646503, -0.05177050098359169, -0.4865823902184702, 0.31623892327042225, -0.3254332651954968, 0.1032626128904151, -0.3088936963593839, -1.2636971892045206], -55.21952049570244, 4, DynamicHMC.DoubledTurn, 0.5017306853754872, 15), NUTS_Transition{Array{Float64,1},Float64}([1.5206086383632034, 0.20011693569650493, -0.34742069622652283, 0.021346115271763517, 0.035354814398099996, 0.32254225855681434, 0.02271945718333414, 0.03597595362222273, 0.170366459986169, 0.04017028670074897, 0.5709229909100287, 0.06709895468567449, -1.0155017493021132], -46.68088134524652, 4, DynamicHMC.DoubledTurn, 0.9845071991467493, 15), NUTS_Transition{Array{Float64,1},Float64}([0.8504090716397764, 0.2690445043270963, -0.01074941708730273, 0.12554847729208174, 0.03950199697509512, 0.7344276245079299, 0.2020495077205702, -0.6145667558096537, 0.31611563611271754, -0.24289593444062466, 0.29706738762395457, 0.15971779855386053, -1.0735586029871216], -47.814731970268866, 4, DynamicHMC.DoubledTurn, 0.9965289977504594, 15), NUTS_Transition{Array{Float64,1},Float64}([1.5476774363412427, 0.19324025599945935, -0.1285000575383537, -0.026053223109029543, 0.2638410465082665, 0.5759468774781296, 0.300606717116909, -0.13929944735452016, 0.3430757839184011, -0.2669376363719468, 0.447270821540018, 0.2727767458628699, -1.1997759631199787], -44.38442925057507, 4, DynamicHMC.DoubledTurn, 1.0, 15), NUTS_Transition{Array{Float64,1},Float64}([0.6076525138686133, 0.32282155454198425, 0.005932746245205754, 0.08223458793150251, -0.27710939003558455, 0.29026626321443966, -0.0009408040946179419, -0.6362360780370099, 0.12218049504972747, -0.03459837290702598, 0.12225533351410435, -0.4652601059690238, -1.2054398151117949], -43.169142304124556, 4, DynamicHMC.DoubledTurn, 0.8407098040180256, 15), NUTS_Transition{Array{Float64,1},Float64}([1.645758007324836, 0.1950274346088669, -0.20506985961010102, -0.10919178617596494, -0.08251580245258049, 0.4746676241312442, 0.23406551446258447, -0.6799491900847416, 0.5166053701087625, -0.242552057198506, 0.3343341335078661, 0.07587135756880167, -0.9688060813563326], -47.506840867113205, 4, DynamicHMC.DoubledTurn, 0.9614759611717694, 15), NUTS_Transition{Array{Float64,1},Float64}([0.6104019665343441, 0.3157207534286622, -0.10727322463873554, 0.0893420843539181, 0.05247696920534003, 0.18768865757305253, -0.08696692746865801, -0.10893568658537675, -0.15204242403142684, -0.03451351005187259, 0.22257547919033488, -0.11038772391711509, -1.739461564015097], -47.81339048759523, 4, DynamicHMC.DoubledTurn, 0.5752247139605537, 15), NUTS_Transition{Array{Float64,1},Float64}([1.7410871446745666, 0.19568849255678128, -0.21777509711418758, -6.1597860942525645e-6, -0.07340066678557665, 0.2264923021995221, 0.25227925934809475, -0.5120729027993923, 0.29505739087738975, -0.44270260070641704, 0.475420108570445, -0.10124007449733988, -0.9312657205721596], -46.740470132789994, 4, DynamicHMC.DoubledTurn, 0.937169149127635, 15), NUTS_Transition{Array{Float64,1},Float64}([0.3102087303993025, 0.3388934584520548, -0.22201981869655196, 0.31675785278520785, 0.07530614505179949, 0.29252164824546434, 0.08993614365756726, -0.07826129668451183, 0.19723350686921293, -0.24913954127807544, 0.12369237334170297, -0.16181522040619387, -1.5099544426529623], -45.32143152651557, 4, DynamicHMC.DoubledTurn, 0.9623705251379041, 15)], NUTS sampler in 13 dimensions
  stepsize (ϵ) ≈ 0.271
  maximum depth = 10
  Gaussian kinetic energy, √diag(M⁻¹): [0.7146904046488296, 0.08028363452044832, 0.22382350138511276, 0.1997849661924729, 0.1871384645945229, 0.1819959517442286, 0.17581597605880994, 0.21774143119427786, 0.15496170134718024, 0.17361722708069852, 0.17077388769816682, 0.2736183831941161, 0.38569914997773197]
)</code></pre></div><p>We use the transformation to obtain the posterior from the chain.</p><div><pre><code class="language-julia">posterior = TransformVariables.transform.(Ref(problem_transformation(p)), get_position.(chain));
posterior[1:5]</code></pre><pre><code class="language-none">5-element Array{NamedTuple{(:β, :α, :σ),Tuple{Array{Float64,1},Array{Float64,1},Float64}},1}:
 (β = [1.2893994454717073, 0.2663196786861505], α = [-0.13676293366212028, -0.08382550989891122, -0.20009129007714138, 0.23774805787179798, -0.30680950100078563, -0.26452053841830914, -0.1975187389758456, -0.4124953890393894, 0.1091145519858589, -0.448796667962551], σ = 0.24107095271058027)
 (β = [0.9709573886845702, 0.2950448851085812], α = [-0.22466509144749747, 0.00696908236164856, -0.24772126530037117, 0.291576282444512, -0.24073244847934444, -0.45508401751219285, -0.1315353380827456, -0.45112444888946074, 0.12611912344643594, -0.4497329991186524], σ = 0.30656822326339456)
 (β = [1.7590953982488526, 0.17902150651566667], α = [-0.13703612969024725, -0.23616171495504662, 0.014057000005083045, 0.19128828197002995, 0.41445578210035516, -0.25113635480734303, 0.32064757935363375, -0.1058768024522148, 0.40352586841497107, 0.2941776971890755], σ = 0.3293143812285497)
 (β = [1.001809543867576, 0.26796509296273696], α = [0.14364755074699886, -0.24180500978391925, -0.2265865191775973, 0.3021171717380829, 0.37285580477144964, -0.5808379629166184, 0.3513996610504196, -0.14657391729347952, 0.4075585986733977, -0.16753785398163548], σ = 0.35051501940287677)
 (β = [0.31788218015788, 0.344913785849589], α = [-0.22261080217602164, 0.023997769215520107, -0.08771315734626797, 0.631372375754273, 0.16157460069893956, -0.12775195383436086, 0.23372418479717158, -0.263324998599432, 0.28410573952414997, -0.36826506647861373], σ = 0.26082950528280413)</code></pre></div><p>Extract the parameter posterior means.</p><div><pre><code class="language-julia">posterior_β = mean(posterior[i].β for i in 1:length(posterior))
posterior_α = mean(posterior[i].α for i in 1:length(posterior))
posterior_σ = mean(posterior[i].σ for i in 1:length(posterior))</code></pre><pre><code class="language-none">0.30661805602770015</code></pre></div><p>Effective sample sizes (of untransformed draws)</p><div><pre><code class="language-julia">ess = mapslices(effective_sample_size, get_position_matrix(chain); dims = 1)
ess</code></pre><pre><code class="language-none">1×13 Array{Float64,2}:
 832.695  823.609  926.435  1000.0  …  986.493  865.406  831.193  403.862</code></pre></div><p>NUTS-specific statistics</p><div><pre><code class="language-julia">NUTS_statistics(chain)</code></pre><pre><code class="language-none">Hamiltonian Monte Carlo sample of length 1000
  acceptance rate mean: 0.92, min/25%/median/75%/max: 0.33 0.88 0.96 0.99 1.0
  termination: AdjacentTurn =&gt; 4% DoubledTurn =&gt; 96%
  depth: 2 =&gt; 0% 3 =&gt; 9% 4 =&gt; 91% 5 =&gt; 0%</code></pre></div><p>CmdStan result</p><div><pre><code class="language-julia">m_12_6_result = &quot;
Iterations = 1:1000
Thinning interval = 1
Chains = 1,2,3,4
Samples per chain = 1000

Empirical Posterior Estimates:
                            Mean                SD               Naive SE             MCSE            ESS
            a          1.076167468  0.7704872560 0.01218247319 0.0210530022 1000.000000
           bp         0.263056273  0.0823415805 0.00130193470 0.0022645077 1000.000000
  a_society.1   -0.191723568  0.2421382537 0.00382854195 0.0060563054 1000.000000
  a_society.2    0.054569029  0.2278506876 0.00360263570 0.0051693148 1000.000000
  a_society.3   -0.035935050  0.1926364647 0.00304584994 0.0039948433 1000.000000
  a_society.4    0.334355037  0.1929971201 0.00305155241 0.0063871707  913.029080
  a_society.5    0.049747513  0.1801287716 0.00284808595 0.0043631095 1000.000000
  a_society.6   -0.311903245  0.2096126337 0.00331426674 0.0053000536 1000.000000
  a_society.7    0.148637507  0.1744680594 0.00275858223 0.0047660246 1000.000000
  a_society.8   -0.164567976  0.1821341074 0.00287979309 0.0034297298 1000.000000
  a_society.9    0.277066965  0.1758237250 0.00278001719 0.0055844175  991.286501
 a_society.10   -0.094149204  0.2846206232 0.00450024719 0.0080735022 1000.000000
sigma_society    0.310352849  0.1374834682 0.00217380450 0.0057325226  575.187461
&quot;;</code></pre><pre><code class="language-none">&quot;\nIterations = 1:1000\nThinning interval = 1\nChains = 1,2,3,4\nSamples per chain = 1000\n\nEmpirical Posterior Estimates:\n                            Mean                SD               Naive SE             MCSE            ESS\n            a          1.076167468  0.7704872560 0.01218247319 0.0210530022 1000.000000\n           bp         0.263056273  0.0823415805 0.00130193470 0.0022645077 1000.000000\n  a_society.1   -0.191723568  0.2421382537 0.00382854195 0.0060563054 1000.000000\n  a_society.2    0.054569029  0.2278506876 0.00360263570 0.0051693148 1000.000000\n  a_society.3   -0.035935050  0.1926364647 0.00304584994 0.0039948433 1000.000000\n  a_society.4    0.334355037  0.1929971201 0.00305155241 0.0063871707  913.029080\n  a_society.5    0.049747513  0.1801287716 0.00284808595 0.0043631095 1000.000000\n  a_society.6   -0.311903245  0.2096126337 0.00331426674 0.0053000536 1000.000000\n  a_society.7    0.148637507  0.1744680594 0.00275858223 0.0047660246 1000.000000\n  a_society.8   -0.164567976  0.1821341074 0.00287979309 0.0034297298 1000.000000\n  a_society.9    0.277066965  0.1758237250 0.00278001719 0.0055844175  991.286501\n a_society.10   -0.094149204  0.2846206232 0.00450024719 0.0080735022 1000.000000\nsigma_society    0.310352849  0.1374834682 0.00217380450 0.0057325226  575.187461\n&quot;</code></pre></div><p>Show means</p><div><pre><code class="language-julia">[posterior_β, posterior_α, [posterior_σ]]</code></pre><pre><code class="language-none">3-element Array{Array{Float64,1},1}:
 [1.1126190058767356, 0.2596916815697934]
 [-0.20176241240959253, 0.035340738495989975, -0.04674818974663568, 0.3233002315462999, 0.04060872891308903, -0.32865818966221294, 0.14039572703897474, -0.1709309837350905, 0.274383596158056, -0.0944210458782242]
 [0.30661805602770015]</code></pre></div><p>End of m12.6d.jl</p><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p><footer><hr/><a class="previous" href="../../10/m10.04d2/"><span class="direction">Previous</span><span class="title">m10.04d2</span></a><a class="next" href="../m12.6d1/"><span class="direction">Next</span><span class="title">m12.6d1</span></a></footer></article></body></html>
