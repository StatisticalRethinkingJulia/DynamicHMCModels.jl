<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>m12.6d · DynamicHMCModels.jl</title><link href="https://cdnjs.cloudflare.com/ajax/libs/normalize/4.2.0/normalize.min.css" rel="stylesheet" type="text/css"/><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.2.0/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link href="../../assets/documenter.css" rel="stylesheet" type="text/css"/></head><body><nav class="toc"><h1>DynamicHMCModels.jl</h1><select id="version-selector" onChange="window.location.href=this.value" style="visibility: hidden"></select><form class="search" id="search-form" action="../../search/"><input id="search-query" name="q" type="text" placeholder="Search docs"/></form><ul><li><a class="toctext" href="../../intro/">Home</a></li><li><span class="toctext">Chapter 02</span><ul><li><a class="toctext" href="../../02/m2.1d/">m2.1d</a></li></ul></li><li><span class="toctext">Chapter 04</span><ul><li><a class="toctext" href="../../04/m4.1d/">m4.1d</a></li><li><a class="toctext" href="../../04/m4.2d/">m4.2d</a></li><li><a class="toctext" href="../../04/m4.5d/">m4.5d</a></li></ul></li><li><span class="toctext">Chapter 05</span><ul><li><a class="toctext" href="../../05/m5.1d/">m5.1d</a></li><li><a class="toctext" href="../../05/m5.1d1/">m5.1d1</a></li><li><a class="toctext" href="../../05/m5.3d/">m5.3d</a></li><li><a class="toctext" href="../../05/m5.6d/">m5.6d</a></li></ul></li><li><span class="toctext">Chapter 08</span><ul><li><a class="toctext" href="../../08/m8.1d/">m8.1d</a></li></ul></li><li><span class="toctext">Chapter 10</span><ul><li><a class="toctext" href="../../10/m10.02d/">m10.02d</a></li><li><a class="toctext" href="../../10/m10.02d1/">m10.02d1</a></li><li><a class="toctext" href="../../10/m10.04d/">m10.04d</a></li><li><a class="toctext" href="../../10/m10.04d1/">m10.04d1</a></li><li><a class="toctext" href="../../10/m10.04d2/">m10.04d2</a></li></ul></li><li><span class="toctext">Chapter 12</span><ul><li class="current"><a class="toctext" href>m12.6d</a><ul class="internal"></ul></li><li><a class="toctext" href="../m12.6d1/">m12.6d1</a></li><li><a class="toctext" href="../m12.6d2/">m12.6d2</a></li></ul></li><li><a class="toctext" href="../../">Functions</a></li></ul></nav><article id="docs"><header><nav><ul><li>Chapter 12</li><li><a href>m12.6d</a></li></ul><a class="edit-page" href="https://github.com/StatisticalRethinkingJulia/DynamicHMCModels.jl/blob/master/scripts/12/m12.6d.jl"><span class="fa"></span> Edit on GitHub</a></nav><hr/><div id="topbar"><span>m12.6d</span><a class="fa fa-bars" href="#"></a></div></header><pre><code class="language-julia">using DynamicHMCModels

ProjDir = rel_path_d(&quot;..&quot;, &quot;scripts&quot;, &quot;12&quot;)

df = CSV.read(rel_path( &quot;..&quot;, &quot;data&quot;,  &quot;Kline.csv&quot;), delim=&#39;;&#39;);
size(df) # Should be 10x5</code></pre><pre><code class="language-none">(10, 5)</code></pre><p>New col logpop, set log() for population data</p><pre><code class="language-julia">df[:logpop] = map((x) -&gt; log(x), df[:population]);
df[:society] = 1:10;

first(df[[:total_tools, :logpop, :society]], 5)

struct m_12_06d_model{TY &lt;: AbstractVector, TX &lt;: AbstractMatrix,
  TS &lt;: AbstractVector}
    &quot;Observations (total_tools).&quot;
    y::TY
    &quot;Covariates (logpop)&quot;
    X::TX
    &quot;Society&quot;
    S::TS
    &quot;Number of observations (10)&quot;
    N::Int
    &quot;Number of societies (also 10)&quot;
    N_societies::Int
end</code></pre><p>Make the type callable with the parameters <em>as a single argument</em>.</p><pre><code class="language-julia">function (problem::m_12_06d_model)(θ)
    @unpack y, X, S, N, N_societies = problem   # extract the data
    @unpack β, α, σ = θ  # β : a, bp, α : a_society
    ll = 0.0
    ll += logpdf(Cauchy(0, 1), σ)
    ll += sum(logpdf.(Normal(0, σ), α)) # α[1:10]
    ll += logpdf.(Normal(0, 10), β[1]) # a
    ll += logpdf.(Normal(0, 1), β[2]) # a
    ll += sum(
      [loglikelihood(Poisson(exp(α[S[i]] + dot(X[i, :], β))), [y[i]]) for i in 1:N]
    )
    ll
end</code></pre><p>Instantiate the model with data and inits.</p><pre><code class="language-julia">N = size(df, 1)
N_societies = length(unique(df[:society]))
X = hcat(ones(Int64, N), df[:logpop]);
S = df[:society]
y = df[:total_tools]
p = m_12_06d_model(y, X, S, N, N_societies);
θ = (β = [1.0, 0.25], α = rand(Normal(0, 1), N_societies), σ = 0.2)
p(θ)</code></pre><pre><code class="language-none">-276.97134329158985</code></pre><p>Write a function to return properly dimensioned transformation.</p><pre><code class="language-julia">problem_transformation(p::m_12_06d_model) =
    as( (β = as(Array, size(p.X, 2)), α = as(Array, p.N_societies), σ = asℝ₊) )</code></pre><p>Wrap the problem with a transformation, then use Flux for the gradient.</p><pre><code class="language-julia">P = TransformedLogDensity(problem_transformation(p), p)
∇P = LogDensityRejectErrors(ADgradient(:ForwardDiff, P));
#∇P = ADgradient(:ForwardDiff, P);</code></pre><p>Tune and sample.</p><pre><code class="language-julia">chain, NUTS_tuned = NUTS_init_tune_mcmc(∇P, 1000);</code></pre><pre><code class="language-none">(NUTS_Transition{Array{Float64,1},Float64}[NUTS_Transition{Array{Float64,1},Float64}([1.6493107814172603, 0.18045676577250055, -0.028130324741060912, 0.1564919691688197, 0.023989515158620075, 0.5002110149211656, 0.04462890532029447, -0.09335942888063084, 0.1854204528266768, -0.17215014648379684, 0.3863372286863662, 0.19489284016602407, -1.4161707581665701], -46.74255982523263, 4, DynamicHMC.DoubledTurn, 0.9002497170495367, 15), NUTS_Transition{Array{Float64,1},Float64}([0.44523254819856073, 0.33291567806400624, -0.24726088034574947, 0.10438610738401732, 0.029987918125740608, 0.2791340801060762, 0.04975409773016504, -0.47546129455785874, 0.27932229147109744, -0.2164087319641076, 0.14008793130100133, -0.3668967641318541, -1.3257680984868454], -44.018281812596456, 4, DynamicHMC.DoubledTurn, 0.8715095084758742, 15), NUTS_Transition{Array{Float64,1},Float64}([2.087179110585561, 0.15524677740547158, -0.17923237424189448, 0.03754690391129139, -0.008359999090705193, 0.3325172610952952, 0.09275079922688624, -0.3308010922241707, 0.014515355485996612, -0.2642977207410136, 0.37160395327944074, 0.27055783923112187, -1.440617902179592], -38.773161400258275, 4, DynamicHMC.DoubledTurn, 0.9958201176249365, 15), NUTS_Transition{Array{Float64,1},Float64}([0.8407736302889673, 0.28702345122789225, -0.21749764456555487, 0.043380946915243454, 0.014985870445713478, 0.5340333835604409, -0.005986108088194379, -0.2731955902303425, 0.2612391173537041, -0.09966140180668998, 0.1741817734133712, -0.29128379843272784, -1.308328900629052], -40.935747438783544, 4, DynamicHMC.DoubledTurn, 0.9912263704850732, 15), NUTS_Transition{Array{Float64,1},Float64}([0.5519918325268751, 0.31451921146488343, -0.0930732669473788, 0.02150836186574044, -0.02727262889433462, 0.25294188997573164, 0.06890992696371112, -0.31989057369871077, 0.040506861926021855, -0.2786578919855498, 0.5016992935706315, -0.22667011415909774, -1.3372728879029465], -40.659201838955426, 4, DynamicHMC.DoubledTurn, 0.9551012727333751, 15), NUTS_Transition{Array{Float64,1},Float64}([1.0049643763685248, 0.2779198554608465, 0.04692227129810206, 0.12256480377209769, 0.04454861664046477, 0.31839810026296184, 0.02345471946467883, -0.13063752456955563, 0.11727501860022818, 0.030891021647522117, 0.054650727281937206, -0.08484997216745138, -1.7955103400837131], -42.397056645075025, 4, DynamicHMC.DoubledTurn, 0.9322085187081147, 15), NUTS_Transition{Array{Float64,1},Float64}([0.8862390510869969, 0.28651773775601874, -0.03522937470343357, 0.3468557102177758, 0.04248492693240147, 0.382958126035375, -0.0973590038472214, -0.34432849746162547, 0.07180377139022005, -0.5417616027618941, 0.5747677771280166, -0.2194151369040771, -0.8995457667315314], -45.64955224826225, 4, DynamicHMC.DoubledTurn, 0.9622640799909247, 15), NUTS_Transition{Array{Float64,1},Float64}([0.16898579526880328, 0.3742879886969179, -0.150120032647371, 0.11057523590433288, 0.24789730471040705, 0.3954366153059455, -0.07498043784933933, -0.3265355815095268, 0.12766605628037925, -0.5007561683243037, 0.24328167964492733, -0.677624128451418, -1.3097815647378608], -46.529246099936245, 4, DynamicHMC.DoubledTurn, 0.8788171151217556, 15), NUTS_Transition{Array{Float64,1},Float64}([0.802092011884777, 0.30551333497116556, -0.14396506326068387, -0.034642455287159896, -0.10680022105538026, 0.5221937884804065, -0.07448659637280367, -0.19145141668740356, 0.07749799224271069, -0.5938818182371138, 0.29784504090899855, -0.13700627828079404, -1.054087780655214], -48.5500105537224, 4, DynamicHMC.DoubledTurn, 0.647736526966667, 15), NUTS_Transition{Array{Float64,1},Float64}([0.7544528927995018, 0.2848086560869405, -0.20794275799638082, 0.20031070609091006, 0.14462298364714163, 0.30278018682667107, 0.05153930827719323, -0.5352997105015918, 0.3223489433612848, 0.14524391148751364, 0.4544628295109721, -0.09710516727841602, -1.5843009323129584], -45.35522253250843, 4, DynamicHMC.DoubledTurn, 0.9983820452226754, 15)  …  NUTS_Transition{Array{Float64,1},Float64}([1.4016607362075786, 0.22388197517813965, -0.5554908188010652, 0.04036608381654009, 0.030810546403577926, 0.6025378432072639, 0.3556213484999155, 0.12099833246315758, 0.4809819235985276, -0.09226088997133818, 0.20152097698625315, 0.07866099587979127, -1.213189088825688], -49.45090363207945, 4, DynamicHMC.DoubledTurn, 0.778040543607447, 15), NUTS_Transition{Array{Float64,1},Float64}([0.8236858021044268, 0.2701278704158663, -0.5299234306567973, -0.1339151231154669, 0.08571954739432132, 0.8115663565645252, 0.46899679763910496, -0.038873178582345624, 0.6411551111574705, -0.114052738236851, 0.3549949552068112, -0.17631550384361777, -0.723677882844415], -52.42698528599946, 4, DynamicHMC.AdjacentTurn, 0.9969038957116341, 31), NUTS_Transition{Array{Float64,1},Float64}([1.060265777021435, 0.2724186189249393, -0.21578543286910326, 0.3550125305816935, -0.24696167841478306, -0.03334403543485821, -0.19207756113402188, -0.29672906019439066, -0.15739239087010654, -0.203345821289776, 0.3420569639974244, -0.14349184122359707, -1.6856711227303378], -51.38119420827814, 4, DynamicHMC.DoubledTurn, 0.9773178490095683, 15), NUTS_Transition{Array{Float64,1},Float64}([1.6591724742011413, 0.20287220998384997, -0.38569225638759486, 0.3694909207551877, -0.1324503881815685, 0.12571749817136513, -0.08547443287940229, -0.30380995816463746, -0.003207922644214517, -0.3308988528727915, 0.39303100582949013, 0.14175386036692494, -1.4681607929398126], -48.71002563173187, 4, DynamicHMC.DoubledTurn, 0.9696556320206772, 15), NUTS_Transition{Array{Float64,1},Float64}([0.4127990167149692, 0.3316429044219582, 0.2027717832415582, 0.12682471140280513, 0.10201136505882843, 0.40688694002931536, -0.04985241105260862, -0.3461186136267466, 0.1885398718740881, -0.3445626113817416, 0.2448661046810924, -0.3810271976040769, -1.113761750893732], -43.768999016937464, 4, DynamicHMC.DoubledTurn, 0.9432495088769898, 15), NUTS_Transition{Array{Float64,1},Float64}([1.793462066969527, 0.1919143538960973, -0.5791844910079919, -0.1680056614399502, -0.12515234485034912, 0.2254313301214466, 0.15475184558470495, -0.2063916718262482, 0.019838177284014144, 0.001182497572884654, 0.43362214496156753, 0.09521937258809349, -1.4978098476021569], -41.33457042662964, 4, DynamicHMC.DoubledTurn, 0.9984473057000559, 15), NUTS_Transition{Array{Float64,1},Float64}([1.0056684479506097, 0.2675584335902745, -0.43213297118214933, -0.05031530191173361, -0.03902683240530725, 0.4598310042220597, -0.13930664344775082, -0.21227531226549742, 0.12343082593008578, -0.2596021761227747, 0.1727943634999965, -0.040197173364022384, -0.5857699336741827], -43.29071248346933, 4, DynamicHMC.DoubledTurn, 0.994376837889193, 15), NUTS_Transition{Array{Float64,1},Float64}([0.8323963956710702, 0.2946326882266762, -0.29080112321080825, 0.12329603363196015, -0.07149004713664785, 0.2365788389983125, 0.15205701211813827, -0.1863155558244158, -0.021915393116200436, -0.3900889834122161, 0.13124202846663433, -0.26825012921513186, -1.7557590292488516], -43.64872533980904, 4, DynamicHMC.DoubledTurn, 0.9474660250621098, 15), NUTS_Transition{Array{Float64,1},Float64}([0.2400032314103414, 0.3662971914466525, -0.3417930281419983, 0.09025213823335809, 0.09349014423109828, 0.2831865104702617, 0.003067101073131122, -0.4022081764626965, 0.16778165266316047, -0.32657478952212465, 0.2392686670746597, -0.2977786207012799, -1.0647947358541519], -46.170528097293094, 4, DynamicHMC.DoubledTurn, 0.7120789815326402, 15), NUTS_Transition{Array{Float64,1},Float64}([1.5279774074720043, 0.19119762047459704, -0.09610209751615768, -0.3169550112397487, 0.057074683512078, 0.10485341476168447, 0.10303596752850801, -0.2571733480812204, 0.35331191961363984, -0.10819649863244912, 0.43554451725132826, 0.013324171906002283, -1.7319716455883305], -51.6616487073617, 4, DynamicHMC.DoubledTurn, 0.643395017879115, 15)], NUTS sampler in 13 dimensions
  stepsize (ϵ) ≈ 0.233
  maximum depth = 10
  Gaussian kinetic energy, √diag(M⁻¹): [0.7786988908797562, 0.08955799131190821, 0.2473816601442852, 0.22062196776359258, 0.1921485276520761, 0.1830432597802289, 0.19727691648389736, 0.2217227027143986, 0.16774960209336381, 0.1936357613324577, 0.1834161534511975, 0.3277716438098722, 0.41241322947483605]
)</code></pre><p>We use the transformation to obtain the posterior from the chain.</p><pre><code class="language-julia">posterior = TransformVariables.transform.(Ref(problem_transformation(p)), get_position.(chain));
posterior[1:5]</code></pre><pre><code class="language-none">5-element Array{NamedTuple{(:β, :α, :σ),Tuple{Array{Float64,1},Array{Float64,1},Float64}},1}:
 (β = [1.6493107814172603, 0.18045676577250055], α = [-0.028130324741060912, 0.1564919691688197, 0.023989515158620075, 0.5002110149211656, 0.04462890532029447, -0.09335942888063084, 0.1854204528266768, -0.17215014648379684, 0.3863372286863662, 0.19489284016602407], σ = 0.24264137272397)     
 (β = [0.44523254819856073, 0.33291567806400624], α = [-0.24726088034574947, 0.10438610738401732, 0.029987918125740608, 0.2791340801060762, 0.04975409773016504, -0.47546129455785874, 0.27932229147109744, -0.2164087319641076, 0.14008793130100133, -0.3668967641318541], σ = 0.2655988746267684) 
 (β = [2.087179110585561, 0.15524677740547158], α = [-0.17923237424189448, 0.03754690391129139, -0.008359999090705193, 0.3325172610952952, 0.09275079922688624, -0.3308010922241707, 0.014515355485996612, -0.2642977207410136, 0.37160395327944074, 0.27055783923112187], σ = 0.2367814057241886)  
 (β = [0.8407736302889673, 0.28702345122789225], α = [-0.21749764456555487, 0.043380946915243454, 0.014985870445713478, 0.5340333835604409, -0.005986108088194379, -0.2731955902303425, 0.2612391173537041, -0.09966140180668998, 0.1741817734133712, -0.29128379843272784], σ = 0.2702713294672449)
 (β = [0.5519918325268751, 0.31451921146488343], α = [-0.0930732669473788, 0.02150836186574044, -0.02727262889433462, 0.25294188997573164, 0.06890992696371112, -0.31989057369871077, 0.040506861926021855, -0.2786578919855498, 0.5016992935706315, -0.22667011415909774], σ = 0.26256072564789706)</code></pre><p>Extract the parameter posterior means.</p><pre><code class="language-julia">posterior_β = mean(posterior[i].β for i in 1:length(posterior))
posterior_α = mean(posterior[i].α for i in 1:length(posterior))
posterior_σ = mean(posterior[i].σ for i in 1:length(posterior))</code></pre><pre><code class="language-none">0.3155594721563082</code></pre><p>Effective sample sizes (of untransformed draws)</p><pre><code class="language-julia">ess = mapslices(effective_sample_size, get_position_matrix(chain); dims = 1)
ess</code></pre><pre><code class="language-none">1×13 Array{Float64,2}:
 530.835  545.364  526.685  684.074  …  1000.0  930.423  692.915  404.29</code></pre><p>NUTS-specific statistics</p><pre><code class="language-julia">NUTS_statistics(chain)</code></pre><pre><code class="language-none">Hamiltonian Monte Carlo sample of length 1000
  acceptance rate mean: 0.93, min/25%/median/75%/max: 0.35 0.91 0.96 0.99 1.0
  termination: AdjacentTurn =&gt; 4% DoubledTurn =&gt; 96%
  depth: 3 =&gt; 5% 4 =&gt; 95% 5 =&gt; 0%
</code></pre><p>CmdStan result</p><pre><code class="language-julia">m_12_6_result = &quot;
Iterations = 1:1000
Thinning interval = 1
Chains = 1,2,3,4
Samples per chain = 1000

Empirical Posterior Estimates:
                            Mean                SD               Naive SE             MCSE            ESS
            a          1.076167468  0.7704872560 0.01218247319 0.0210530022 1000.000000
           bp         0.263056273  0.0823415805 0.00130193470 0.0022645077 1000.000000
  a_society.1   -0.191723568  0.2421382537 0.00382854195 0.0060563054 1000.000000
  a_society.2    0.054569029  0.2278506876 0.00360263570 0.0051693148 1000.000000
  a_society.3   -0.035935050  0.1926364647 0.00304584994 0.0039948433 1000.000000
  a_society.4    0.334355037  0.1929971201 0.00305155241 0.0063871707  913.029080
  a_society.5    0.049747513  0.1801287716 0.00284808595 0.0043631095 1000.000000
  a_society.6   -0.311903245  0.2096126337 0.00331426674 0.0053000536 1000.000000
  a_society.7    0.148637507  0.1744680594 0.00275858223 0.0047660246 1000.000000
  a_society.8   -0.164567976  0.1821341074 0.00287979309 0.0034297298 1000.000000
  a_society.9    0.277066965  0.1758237250 0.00278001719 0.0055844175  991.286501
 a_society.10   -0.094149204  0.2846206232 0.00450024719 0.0080735022 1000.000000
sigma_society    0.310352849  0.1374834682 0.00217380450 0.0057325226  575.187461
&quot;;</code></pre><pre><code class="language-none">&quot;\nIterations = 1:1000\nThinning interval = 1\nChains = 1,2,3,4\nSamples per chain = 1000\n\nEmpirical Posterior Estimates:\n                            Mean                SD               Naive SE             MCSE            ESS\n            a          1.076167468  0.7704872560 0.01218247319 0.0210530022 1000.000000\n           bp         0.263056273  0.0823415805 0.00130193470 0.0022645077 1000.000000\n  a_society.1   -0.191723568  0.2421382537 0.00382854195 0.0060563054 1000.000000\n  a_society.2    0.054569029  0.2278506876 0.00360263570 0.0051693148 1000.000000\n  a_society.3   -0.035935050  0.1926364647 0.00304584994 0.0039948433 1000.000000\n  a_society.4    0.334355037  0.1929971201 0.00305155241 0.0063871707  913.029080\n  a_society.5    0.049747513  0.1801287716 0.00284808595 0.0043631095 1000.000000\n  a_society.6   -0.311903245  0.2096126337 0.00331426674 0.0053000536 1000.000000\n  a_society.7    0.148637507  0.1744680594 0.00275858223 0.0047660246 1000.000000\n  a_society.8   -0.164567976  0.1821341074 0.00287979309 0.0034297298 1000.000000\n  a_society.9    0.277066965  0.1758237250 0.00278001719 0.0055844175  991.286501\n a_society.10   -0.094149204  0.2846206232 0.00450024719 0.0080735022 1000.000000\nsigma_society    0.310352849  0.1374834682 0.00217380450 0.0057325226  575.187461\n&quot;</code></pre><p>Show means</p><pre><code class="language-julia">[posterior_β, posterior_α, [posterior_σ]]</code></pre><pre><code class="language-none">3-element Array{Array{Float64,1},1}:
 [1.155026673924052, 0.2553000807983095]                                                                                                                                                                               
 [-0.21928879937960186, 0.03775416128358666, -0.05461653999231526, 0.32852531258278556, 0.04311380136097542, -0.32487347738569244, 0.1412163406135868, -0.17215574435187195, 0.27978715221550265, -0.08415892686196479]
 [0.3155594721563082]                                                                                                                                                                                                  </code></pre><p>End of m12.6d.jl</p><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p><footer><hr/><a class="previous" href="../../10/m10.04d2/"><span class="direction">Previous</span><span class="title">m10.04d2</span></a><a class="next" href="../m12.6d1/"><span class="direction">Next</span><span class="title">m12.6d1</span></a></footer></article></body></html>
