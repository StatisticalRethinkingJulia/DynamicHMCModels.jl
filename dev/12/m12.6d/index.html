<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>m12.6d · DynamicHMCModels.jl</title><link href="https://cdnjs.cloudflare.com/ajax/libs/normalize/4.2.0/normalize.min.css" rel="stylesheet" type="text/css"/><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.2.0/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link href="../../assets/documenter.css" rel="stylesheet" type="text/css"/></head><body><nav class="toc"><h1>DynamicHMCModels.jl</h1><select id="version-selector" onChange="window.location.href=this.value" style="visibility: hidden"></select><form class="search" id="search-form" action="../../search/"><input id="search-query" name="q" type="text" placeholder="Search docs"/></form><ul><li><a class="toctext" href="../../intro/">Home</a></li><li><span class="toctext">Chapter 02</span><ul><li><a class="toctext" href="../../02/m2.1d/">m2.1d</a></li></ul></li><li><span class="toctext">Chapter 04</span><ul><li><a class="toctext" href="../../04/m4.1d/">m4.1d</a></li><li><a class="toctext" href="../../04/m4.2d/">m4.2d</a></li><li><a class="toctext" href="../../04/m4.5d/">m4.5d</a></li></ul></li><li><span class="toctext">Chapter 05</span><ul><li><a class="toctext" href="../../05/m5.1d/">m5.1d</a></li><li><a class="toctext" href="../../05/m5.1d1/">m5.1d1</a></li><li><a class="toctext" href="../../05/m5.3d/">m5.3d</a></li><li><a class="toctext" href="../../05/m5.6d/">m5.6d</a></li></ul></li><li><span class="toctext">Chapter 08</span><ul><li><a class="toctext" href="../../08/m8.1d/">m8.1d</a></li></ul></li><li><span class="toctext">Chapter 10</span><ul><li><a class="toctext" href="../../10/m10.02d/">m10.02d</a></li><li><a class="toctext" href="../../10/m10.02d1/">m10.02d1</a></li><li><a class="toctext" href="../../10/m10.04d/">m10.04d</a></li></ul></li><li><span class="toctext">Chapter 12</span><ul><li class="current"><a class="toctext" href>m12.6d</a><ul class="internal"></ul></li><li><a class="toctext" href="../m12.6d1/">m12.6d1</a></li></ul></li><li><a class="toctext" href="../../">Functions</a></li></ul></nav><article id="docs"><header><nav><ul><li>Chapter 12</li><li><a href>m12.6d</a></li></ul><a class="edit-page" href="https://github.com/StatisticalRethinkingJulia/DynamicHMCModels.jl/blob/master/scripts/12/m12.6d.jl"><span class="fa"></span> Edit on GitHub</a></nav><hr/><div id="topbar"><span>m12.6d</span><a class="fa fa-bars" href="#"></a></div></header><div><pre><code class="language-julia">using DynamicHMCModels

ProjDir = rel_path_d(&quot;..&quot;, &quot;scripts&quot;, &quot;12&quot;)

df = CSV.read(rel_path( &quot;..&quot;, &quot;data&quot;,  &quot;Kline.csv&quot;), delim=&#39;;&#39;);
size(df) # Should be 10x5</code></pre><pre><code class="language-none">(10, 5)</code></pre></div><p>New col logpop, set log() for population data</p><div><pre><code class="language-julia">df[:logpop] = map((x) -&gt; log(x), df[:population]);
df[:society] = 1:10;

first(df[[:total_tools, :logpop, :society]], 5)

struct m_12_06d_model{TY &lt;: AbstractVector, TX &lt;: AbstractMatrix,
  TS &lt;: AbstractVector}
    &quot;Observations (total_tools).&quot;
    y::TY
    &quot;Covariates (logpop)&quot;
    X::TX
    &quot;Society&quot;
    S::TS
    &quot;Number of observations (10)&quot;
    N::Int
    &quot;Number of societies (also 10)&quot;
    N_societies::Int
end</code></pre></div><p>Make the type callable with the parameters <em>as a single argument</em>.</p><div><pre><code class="language-julia">function (problem::m_12_06d_model)(θ)
    @unpack y, X, S, N, N_societies = problem   # extract the data
    @unpack β, α, σ = θ  # β : a, bp, α : a_society
    ll = 0.0
    ll += logpdf(Cauchy(0, 1), σ)
    ll += sum(logpdf.(Normal(0, σ), α)) # α[1:10]
    ll += logpdf.(Normal(0, 10), β[1]) # a
    ll += logpdf.(Normal(0, 1), β[2]) # a
    ll += sum(
      [loglikelihood(Poisson(exp(α[S[i]] + dot(X[i, :], β))), [y[i]]) for i in 1:N]
    )
    ll
end</code></pre></div><p>Instantiate the model with data and inits.</p><div><pre><code class="language-julia">N = size(df, 1)
N_societies = length(unique(df[:society]))
X = hcat(ones(Int64, N), df[:logpop]);
S = df[:society]
y = df[:total_tools]
p = m_12_06d_model(y, X, S, N, N_societies);
θ = (β = [1.0, 0.25], α = rand(Normal(0, 1), N_societies), σ = 0.2)
p(θ)</code></pre><pre><code class="language-none">-289.1995800727739</code></pre></div><p>Write a function to return properly dimensioned transformation.</p><div><pre><code class="language-julia">problem_transformation(p::m_12_06d_model) =
    as( (β = as(Array, size(p.X, 2)), α = as(Array, p.N_societies), σ = asℝ₊) )</code></pre></div><p>Wrap the problem with a transformation, then use Flux for the gradient.</p><div><pre><code class="language-julia">P = TransformedLogDensity(problem_transformation(p), p)
∇P = LogDensityRejectErrors(ADgradient(:ForwardDiff, P));
#∇P = ADgradient(:ForwardDiff, P);</code></pre></div><p>Tune and sample.</p><div><pre><code class="language-julia">chain, NUTS_tuned = NUTS_init_tune_mcmc(∇P, 1000);</code></pre><pre><code class="language-none">MCMC, adapting ϵ (75 steps)
0.0041 s/step ...done
MCMC, adapting ϵ (25 steps)
0.0032 s/step ...done
MCMC, adapting ϵ (50 steps)
0.006 s/step ...done
MCMC, adapting ϵ (100 steps)
0.0012 s/step ...done
MCMC, adapting ϵ (200 steps)
0.00081 s/step ...done
MCMC, adapting ϵ (400 steps)
0.00045 s/step ...done
MCMC, adapting ϵ (50 steps)
0.0006 s/step ...done
MCMC (1000 steps)
0.00037 s/step ...done
(NUTS_Transition{Array{Float64,1},Float64}[NUTS_Transition{Array{Float64,1},Float64}([1.53081, 0.21235, -0.483321, -0.13102, 0.0364765, 0.379269, 0.205363, -0.439797, 0.123398, -0.164088, 0.278428, 0.23139, -1.53713], -47.0258, 4, DoubledTurn, 0.973266, 15), NUTS_Transition{Array{Float64,1},Float64}([-1.45295, 0.546221, 0.267054, 0.348238, 0.2683, 0.463589, 0.0151524, -0.302207, 0.113371, -0.280853, 0.0476991, -1.19711, -0.732793], -46.2545, 4, AdjacentTurn, 0.882177, 31), NUTS_Transition{Array{Float64,1},Float64}([0.401658, 0.352321, -0.219255, 0.169643, 0.0182879, 0.0612008, 0.034333, -0.292179, 0.0166749, -0.179387, 0.19232, -0.509865, -1.10177], -47.5238, 4, AdjacentTurn, 0.841438, 31), NUTS_Transition{Array{Float64,1},Float64}([1.24923, 0.254993, -0.188457, 0.0121494, -0.0192852, 0.521246, 0.0158764, -0.476989, 0.196899, -0.264817, 0.130604, -0.0312603, -1.42954], -47.0293, 4, DoubledTurn, 0.839994, 15), NUTS_Transition{Array{Float64,1},Float64}([1.47422, 0.219567, -0.474673, 0.113476, 0.0843014, 0.155975, 0.208678, -0.342429, 0.0630527, -0.0187034, 0.342286, 0.0239619, -1.7529], -44.924, 4, DoubledTurn, 0.89571, 15), NUTS_Transition{Array{Float64,1},Float64}([0.339592, 0.347414, 0.217175, 0.0753383, -0.331504, 0.505872, -0.166382, -0.103743, 0.197472, -0.322787, 0.129749, -0.291213, -1.13988], -42.3371, 4, DoubledTurn, 0.965099, 15), NUTS_Transition{Array{Float64,1},Float64}([-0.237348, 0.384724, 0.127222, 0.539692, 0.349296, 0.586591, 0.013932, 0.141348, 0.428343, -0.439563, 0.388622, -0.191146, -0.541156], -53.3703, 5, DoubledTurn, 0.964789, 31), NUTS_Transition{Array{Float64,1},Float64}([-0.467618, 0.429287, -0.0316298, -0.0734461, -0.0850309, 0.477799, 0.151382, -0.34703, 0.107849, -0.0731605, 0.209138, -0.757429, -1.02159], -50.0016, 4, DoubledTurn, 0.877772, 15), NUTS_Transition{Array{Float64,1},Float64}([-0.434044, 0.439768, 0.0418059, 0.0932275, 0.0734992, 0.374788, -0.0765379, -0.46093, 0.204582, -0.30663, 0.271538, -0.530758, -0.836725], -47.2895, 4, DoubledTurn, 0.93429, 15), NUTS_Transition{Array{Float64,1},Float64}([1.2792, 0.212129, -0.137593, 0.366874, 0.176022, 0.500234, 0.299062, -0.0454213, 0.208878, 0.108428, 0.494011, 0.159798, -1.19329], -45.3347, 4, DoubledTurn, 0.998758, 15)  …  NUTS_Transition{Array{Float64,1},Float64}([0.14046, 0.375139, -0.0306299, 0.104325, -0.0553435, 0.388782, -0.312209, -0.225713, 0.101982, -0.293505, 0.129053, -0.596286, -0.973626], -44.7597, 4, DoubledTurn, 0.960709, 15), NUTS_Transition{Array{Float64,1},Float64}([1.01581, 0.260555, -0.0813107, 0.0646186, 0.0828283, 0.449043, 0.0822435, -0.16927, 0.169263, -0.0738673, 0.406711, 0.138841, -1.48499], -40.6179, 4, DoubledTurn, 0.992991, 15), NUTS_Transition{Array{Float64,1},Float64}([0.968965, 0.277399, -0.16846, 0.0538872, 0.145464, 0.321678, -0.00193365, -0.424947, 0.185829, -0.153648, 0.484038, -0.0312025, -1.20053], -38.4194, 4, DoubledTurn, 0.901085, 15), NUTS_Transition{Array{Float64,1},Float64}([1.3045, 0.219519, -0.296081, 0.0204185, 0.0921014, 0.443574, 0.0555782, -0.420556, 0.280443, -0.157422, 0.467024, -0.0216142, -1.34888], -41.4033, 4, DoubledTurn, 0.83271, 15), NUTS_Transition{Array{Float64,1},Float64}([0.29318, 0.350546, -0.197561, 0.109405, -0.112287, 0.418465, -0.120055, -0.330192, -0.0467004, -0.224876, 0.212975, -0.639512, -1.26259], -45.8742, 4, DoubledTurn, 0.92162, 15), NUTS_Transition{Array{Float64,1},Float64}([1.11097, 0.252665, 0.0155257, -0.126513, 0.0447239, 0.313782, -0.142024, -0.684331, 0.114152, -0.147585, 0.242081, -0.0594355, -1.19678], -43.7945, 4, DoubledTurn, 0.978654, 15), NUTS_Transition{Array{Float64,1},Float64}([1.12621, 0.260966, -0.37441, 0.00136397, -0.0868383, 0.354208, -0.00773283, -0.424176, 0.394772, -0.0179533, 0.290201, -0.113622, -1.13861], -43.6852, 3, AdjacentTurn, 0.995074, 15), NUTS_Transition{Array{Float64,1},Float64}([1.72231, 0.187937, -0.234484, -0.26735, -0.127219, 0.611275, 0.294423, -0.0308107, 0.0824036, -0.162673, 0.462717, 0.187331, -1.2043], -42.5642, 4, DoubledTurn, 0.937851, 15), NUTS_Transition{Array{Float64,1},Float64}([0.398193, 0.338261, 0.00597793, 0.425036, 0.125067, 0.0938449, -0.152274, -0.510599, 0.269632, -0.110895, 0.13939, -0.387564, -1.35446], -45.6803, 4, DoubledTurn, 0.997085, 15), NUTS_Transition{Array{Float64,1},Float64}([0.293288, 0.351951, -0.0075499, 0.438463, 0.04493, 0.0992758, -0.181878, -0.54894, 0.299332, -0.18007, 0.0788131, -0.43065, -1.27259], -47.7972, 4, DoubledTurn, 0.998374, 15)], NUTS sampler in 13 dimensions
  stepsize (ϵ) ≈ 0.226
  maximum depth = 10
  Gaussian kinetic energy, √diag(M⁻¹): [0.697143, 0.078842, 0.229856, 0.210603, 0.176192, 0.187177, 0.170614, 0.212637, 0.176803, 0.180747, 0.179441, 0.290873, 0.376427]
)</code></pre></div><p>We use the transformation to obtain the posterior from the chain.</p><div><pre><code class="language-julia">posterior = TransformVariables.transform.(Ref(problem_transformation(p)), get_position.(chain));
posterior[1:5]</code></pre><pre><code class="language-none">5-element Array{NamedTuple{(:β, :α, :σ),Tuple{Array{Float64,1},Array{Float64,1},Float64}},1}:
 (β = [1.53081, 0.21235], α = [-0.483321, -0.13102, 0.0364765, 0.379269, 0.205363, -0.439797, 0.123398, -0.164088, 0.278428, 0.23139], σ = 0.21499620936435315)
 (β = [-1.45295, 0.546221], α = [0.267054, 0.348238, 0.2683, 0.463589, 0.0151524, -0.302207, 0.113371, -0.280853, 0.0476991, -1.19711], σ = 0.48056477661861635)
 (β = [0.401658, 0.352321], α = [-0.219255, 0.169643, 0.0182879, 0.0612008, 0.034333, -0.292179, 0.0166749, -0.179387, 0.19232, -0.509865], σ = 0.33228169963287074)
 (β = [1.24923, 0.254993], α = [-0.188457, 0.0121494, -0.0192852, 0.521246, 0.0158764, -0.476989, 0.196899, -0.264817, 0.130604, -0.0312603], σ = 0.23941883648942971)
 (β = [1.47422, 0.219567], α = [-0.474673, 0.113476, 0.0843014, 0.155975, 0.208678, -0.342429, 0.0630527, -0.0187034, 0.342286, 0.0239619], σ = 0.17326994873761825)</code></pre></div><p>Extract the parameter posterior means.</p><div><pre><code class="language-julia">posterior_β = mean(posterior[i].β for i in 1:length(posterior))
posterior_α = mean(posterior[i].α for i in 1:length(posterior))
posterior_σ = mean(posterior[i].σ for i in 1:length(posterior))</code></pre><pre><code class="language-none">0.30314330099922143</code></pre></div><p>Effective sample sizes (of untransformed draws)</p><div><pre><code class="language-julia">ess = mapslices(effective_sample_size, get_position_matrix(chain); dims = 1)
ess</code></pre><pre><code class="language-none">1×13 Array{Float64,2}:
 677.101  621.992  908.727  1000.0  …  825.857  531.96  460.131  234.149</code></pre></div><p>NUTS-specific statistics</p><div><pre><code class="language-julia">NUTS_statistics(chain)</code></pre><pre><code class="language-none">Hamiltonian Monte Carlo sample of length 1000
  acceptance rate mean: 0.94, min/25%/median/75%/max: 0.0 0.92 0.97 0.99 1.0
  termination: AdjacentTurn =&gt; 6% DoubledTurn =&gt; 94%
  depth: 2 =&gt; 0% 3 =&gt; 5% 4 =&gt; 93% 5 =&gt; 2%</code></pre></div><p>CmdStan result</p><div><pre><code class="language-julia">m_12_6_result = &quot;
Iterations = 1:1000
Thinning interval = 1
Chains = 1,2,3,4
Samples per chain = 1000

Empirical Posterior Estimates:
                            Mean                SD               Naive SE             MCSE            ESS
            a          1.076167468  0.7704872560 0.01218247319 0.0210530022 1000.000000
           bp         0.263056273  0.0823415805 0.00130193470 0.0022645077 1000.000000
  a_society.1   -0.191723568  0.2421382537 0.00382854195 0.0060563054 1000.000000
  a_society.2    0.054569029  0.2278506876 0.00360263570 0.0051693148 1000.000000
  a_society.3   -0.035935050  0.1926364647 0.00304584994 0.0039948433 1000.000000
  a_society.4    0.334355037  0.1929971201 0.00305155241 0.0063871707  913.029080
  a_society.5    0.049747513  0.1801287716 0.00284808595 0.0043631095 1000.000000
  a_society.6   -0.311903245  0.2096126337 0.00331426674 0.0053000536 1000.000000
  a_society.7    0.148637507  0.1744680594 0.00275858223 0.0047660246 1000.000000
  a_society.8   -0.164567976  0.1821341074 0.00287979309 0.0034297298 1000.000000
  a_society.9    0.277066965  0.1758237250 0.00278001719 0.0055844175  991.286501
 a_society.10   -0.094149204  0.2846206232 0.00450024719 0.0080735022 1000.000000
sigma_society    0.310352849  0.1374834682 0.00217380450 0.0057325226  575.187461
&quot;;</code></pre><pre><code class="language-none">&quot;\nIterations = 1:1000\nThinning interval = 1\nChains = 1,2,3,4\nSamples per chain = 1000\n\nEmpirical Posterior Estimates:\n                            Mean                SD               Naive SE             MCSE            ESS\n            a          1.076167468  0.7704872560 0.01218247319 0.0210530022 1000.000000\n           bp         0.263056273  0.0823415805 0.00130193470 0.0022645077 1000.000000\n  a_society.1   -0.191723568  0.2421382537 0.00382854195 0.0060563054 1000.000000\n  a_society.2    0.054569029  0.2278506876 0.00360263570 0.0051693148 1000.000000\n  a_society.3   -0.035935050  0.1926364647 0.00304584994 0.0039948433 1000.000000\n  a_society.4    0.334355037  0.1929971201 0.00305155241 0.0063871707  913.029080\n  a_society.5    0.049747513  0.1801287716 0.00284808595 0.0043631095 1000.000000\n  a_society.6   -0.311903245  0.2096126337 0.00331426674 0.0053000536 1000.000000\n  a_society.7    0.148637507  0.1744680594 0.00275858223 0.0047660246 1000.000000\n  a_society.8   -0.164567976  0.1821341074 0.00287979309 0.0034297298 1000.000000\n  a_society.9    0.277066965  0.1758237250 0.00278001719 0.0055844175  991.286501\n a_society.10   -0.094149204  0.2846206232 0.00450024719 0.0080735022 1000.000000\nsigma_society    0.310352849  0.1374834682 0.00217380450 0.0057325226  575.187461\n&quot;</code></pre></div><p>Show means</p><div><pre><code class="language-julia">[posterior_β, posterior_α, posterior_σ]</code></pre><pre><code class="language-none">3-element Array{Any,1}:
  [1.07688, 0.263589]
  [-0.190607, 0.0402635, -0.0380391, 0.317228, 0.0439081, -0.313437, 0.145877, -0.170231, 0.269604, -0.0965257]
 0.30314330099922143</code></pre></div><p>End of m12.6d.jl</p><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p><footer><hr/><a class="previous" href="../../10/m10.04d/"><span class="direction">Previous</span><span class="title">m10.04d</span></a><a class="next" href="../m12.6d1/"><span class="direction">Next</span><span class="title">m12.6d1</span></a></footer></article></body></html>
