<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>m12.6d · DynamicHMCModels.jl</title><link href="https://cdnjs.cloudflare.com/ajax/libs/normalize/4.2.0/normalize.min.css" rel="stylesheet" type="text/css"/><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.2.0/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link href="../../assets/documenter.css" rel="stylesheet" type="text/css"/></head><body><nav class="toc"><h1>DynamicHMCModels.jl</h1><select id="version-selector" onChange="window.location.href=this.value" style="visibility: hidden"></select><form class="search" id="search-form" action="../../search/"><input id="search-query" name="q" type="text" placeholder="Search docs"/></form><ul><li><a class="toctext" href="../../intro/">Home</a></li><li><span class="toctext">Chapter 02</span><ul><li><a class="toctext" href="../../02/m2.1d/">m2.1d</a></li></ul></li><li><span class="toctext">Chapter 04</span><ul><li><a class="toctext" href="../../04/m4.1d/">m4.1d</a></li><li><a class="toctext" href="../../04/m4.2d/">m4.2d</a></li><li><a class="toctext" href="../../04/m4.5d/">m4.5d</a></li></ul></li><li><span class="toctext">Chapter 05</span><ul><li><a class="toctext" href="../../05/m5.1d/">m5.1d</a></li><li><a class="toctext" href="../../05/m5.1d1/">m5.1d1</a></li><li><a class="toctext" href="../../05/m5.3d/">m5.3d</a></li><li><a class="toctext" href="../../05/m5.6d/">m5.6d</a></li></ul></li><li><span class="toctext">Chapter 08</span><ul><li><a class="toctext" href="../../08/m8.1d/">m8.1d</a></li></ul></li><li><span class="toctext">Chapter 10</span><ul><li><a class="toctext" href="../../10/m10.02d/">m10.02d</a></li><li><a class="toctext" href="../../10/m10.02d1/">m10.02d1</a></li><li><a class="toctext" href="../../10/m10.04d/">m10.04d</a></li></ul></li><li><span class="toctext">Chapter 12</span><ul><li class="current"><a class="toctext" href>m12.6d</a><ul class="internal"></ul></li><li><a class="toctext" href="../m12.6d1/">m12.6d1</a></li></ul></li><li><a class="toctext" href="../../">Functions</a></li></ul></nav><article id="docs"><header><nav><ul><li>Chapter 12</li><li><a href>m12.6d</a></li></ul><a class="edit-page" href="https://github.com/StatisticalRethinkingJulia/DynamicHMCModels.jl/blob/master/scripts/12/m12.6d.jl"><span class="fa"></span> Edit on GitHub</a></nav><hr/><div id="topbar"><span>m12.6d</span><a class="fa fa-bars" href="#"></a></div></header><div><pre><code class="language-julia">using DynamicHMCModels

ProjDir = rel_path_d(&quot;..&quot;, &quot;scripts&quot;, &quot;12&quot;)

df = CSV.read(rel_path( &quot;..&quot;, &quot;data&quot;,  &quot;Kline.csv&quot;), delim=&#39;;&#39;);
size(df) # Should be 10x5</code></pre><pre><code class="language-none">(10, 5)</code></pre></div><p>New col logpop, set log() for population data</p><div><pre><code class="language-julia">df[:logpop] = map((x) -&gt; log(x), df[:population]);
df[:society] = 1:10;

first(df[[:total_tools, :logpop, :society]], 5)

struct m_12_06d_model{TY &lt;: AbstractVector, TX &lt;: AbstractMatrix,
  TS &lt;: AbstractVector}
    &quot;Observations (total_tools).&quot;
    y::TY
    &quot;Covariates (logpop)&quot;
    X::TX
    &quot;Society&quot;
    S::TS
    &quot;Number of observations (10)&quot;
    N::Int
    &quot;Number of societies (also 10)&quot;
    N_societies::Int
end</code></pre></div><p>Make the type callable with the parameters <em>as a single argument</em>.</p><div><pre><code class="language-julia">function (problem::m_12_06d_model)(θ)
    @unpack y, X, S, N, N_societies = problem   # extract the data
    @unpack β, α, σ = θ  # β : a, bp, α : a_society
    ll = 0.0
    ll += logpdf(Cauchy(0, 1), σ)
    ll += sum(logpdf.(Normal(0, σ), α)) # α[1:10]
    ll += logpdf.(Normal(0, 10), β[1]) # a
    ll += logpdf.(Normal(0, 1), β[2]) # a
    ll += sum(
      [loglikelihood(Poisson(exp(α[S[i]] + dot(X[i, :], β))), [y[i]]) for i in 1:N]
    )
    ll
end</code></pre></div><p>Instantiate the model with data and inits.</p><div><pre><code class="language-julia">N = size(df, 1)
N_societies = length(unique(df[:society]))
X = hcat(ones(Int64, N), df[:logpop]);
S = df[:society]
y = df[:total_tools]
p = m_12_06d_model(y, X, S, N, N_societies);
θ = (β = [1.0, 0.25], α = rand(Normal(0, 1), N_societies), σ = 0.2)
p(θ)</code></pre><pre><code class="language-none">-164.34611259181807</code></pre></div><p>Write a function to return properly dimensioned transformation.</p><div><pre><code class="language-julia">problem_transformation(p::m_12_06d_model) =
    as( (β = as(Array, size(p.X, 2)), α = as(Array, p.N_societies), σ = asℝ₊) )</code></pre></div><p>Wrap the problem with a transformation, then use Flux for the gradient.</p><div><pre><code class="language-julia">P = TransformedLogDensity(problem_transformation(p), p)
∇P = LogDensityRejectErrors(ADgradient(:ForwardDiff, P));
#∇P = ADgradient(:ForwardDiff, P);</code></pre></div><p>Tune and sample.</p><div><pre><code class="language-julia">chain, NUTS_tuned = NUTS_init_tune_mcmc(∇P, 1000);</code></pre><pre><code class="language-none">MCMC, adapting ϵ (75 steps)
0.0047 s/step ...done
MCMC, adapting ϵ (25 steps)
0.0039 s/step ...done
MCMC, adapting ϵ (50 steps)
0.0068 s/step ...done
MCMC, adapting ϵ (100 steps)
0.0016 s/step ...done
MCMC, adapting ϵ (200 steps)
0.00097 s/step ...done
MCMC, adapting ϵ (400 steps)
0.00066 s/step ...done
MCMC, adapting ϵ (50 steps)
0.00073 s/step ...done
MCMC (1000 steps)
0.00047 s/step ...done
(NUTS_Transition{Array{Float64,1},Float64}[NUTS_Transition{Array{Float64,1},Float64}([0.0479709, 0.391882, -0.031563, 0.0885541, -0.268544, 0.0955804, 0.178457, -0.407574, 0.305722, -0.448469, 0.198294, -0.596531, -0.871458], -49.8606, 4, DoubledTurn, 0.997409, 15), NUTS_Transition{Array{Float64,1},Float64}([1.75696, 0.174512, -0.403396, 0.0136777, 0.111195, 0.462153, -0.0150794, -0.310815, 0.0140026, -0.00664019, 0.281481, 0.0820073, -1.65368], -47.7161, 4, AdjacentTurn, 0.809223, 31), NUTS_Transition{Array{Float64,1},Float64}([0.92187, 0.299803, 0.157583, 0.0167089, -0.0656419, 0.31153, 0.055927, -0.360765, 0.188034, -0.599995, 0.304204, -0.27465, -1.05659], -47.4697, 4, DoubledTurn, 0.995304, 15), NUTS_Transition{Array{Float64,1},Float64}([1.96505, 0.150016, -0.382183, -0.220073, -0.0699375, 0.2984, 0.0244208, -0.23209, 0.0204126, 0.124451, 0.389367, 0.249805, -1.42867], -47.3279, 5, DoubledTurn, 0.928203, 31), NUTS_Transition{Array{Float64,1},Float64}([1.2913, 0.227865, 0.0704722, 0.0663519, -0.0400074, 0.4102, 0.154485, -0.023197, 0.161164, -0.0805859, 0.579762, 0.153423, -1.30463], -44.4638, 4, DoubledTurn, 0.999452, 15), NUTS_Transition{Array{Float64,1},Float64}([1.12596, 0.270203, -0.447233, 0.106899, -0.221434, 0.138457, 0.00249294, -0.727579, 0.156967, -0.615837, 0.0830987, -0.35044, -1.24659], -45.5625, 4, DoubledTurn, 0.900579, 15), NUTS_Transition{Array{Float64,1},Float64}([1.27243, 0.227685, -0.453738, 0.0187518, -0.188796, 0.400884, -0.282077, -0.317292, 0.301284, -0.070565, 0.48738, 0.103344, -0.822161], -47.3702, 4, DoubledTurn, 0.992649, 15), NUTS_Transition{Array{Float64,1},Float64}([0.98857, 0.251278, 0.0440236, 0.330292, -0.0233078, 0.297814, -0.0741991, -0.21729, 0.343695, -0.119917, 0.439993, 0.0587787, -1.501], -44.3003, 4, DoubledTurn, 0.974382, 15), NUTS_Transition{Array{Float64,1},Float64}([1.60912, 0.201397, -0.329933, -0.0128525, -0.0674452, 0.570543, -0.0568934, -0.556927, 0.0801421, -0.388405, 0.367021, 0.0934349, -0.979057], -42.7492, 4, DoubledTurn, 1.0, 15), NUTS_Transition{Array{Float64,1},Float64}([-0.149047, 0.382797, -0.076905, 0.38477, 0.576062, 0.554545, 0.120205, -0.35378, 0.277024, -0.215113, 0.407563, -0.462876, -1.28115], -44.4385, 4, DoubledTurn, 0.995307, 15)  …  NUTS_Transition{Array{Float64,1},Float64}([0.897194, 0.298376, -0.122271, -0.105789, -0.175664, 0.123452, 0.125859, -0.405654, 0.155455, -0.275978, 0.16235, -0.229274, -1.4993], -40.9231, 4, DoubledTurn, 0.944834, 15), NUTS_Transition{Array{Float64,1},Float64}([1.99986, 0.179632, -0.449981, -0.372596, -0.476894, 0.146239, 0.126742, -0.503204, 0.0421978, -0.187255, 0.204823, 0.0625255, -1.16237], -42.3086, 4, DoubledTurn, 0.980236, 15), NUTS_Transition{Array{Float64,1},Float64}([1.44716, 0.220155, -0.146479, -0.286645, -0.186167, 0.323269, 0.222058, -0.51245, 0.047984, -0.0453725, 0.238155, 0.139567, -1.1579], -43.3952, 4, AdjacentTurn, 0.998833, 31), NUTS_Transition{Array{Float64,1},Float64}([0.577179, 0.297531, -0.448911, 0.638289, 0.265632, 0.647466, 0.101048, -0.347172, 0.399904, -0.133815, 0.519011, -0.135672, -0.677723], -44.6569, 4, DoubledTurn, 0.983181, 15), NUTS_Transition{Array{Float64,1},Float64}([-0.666384, 0.441961, -0.207825, 0.334581, 0.214795, 0.0173478, 0.181473, -0.466362, 0.367552, -0.334187, 0.410019, -0.439835, -1.24928], -53.0493, 4, DoubledTurn, 0.961777, 15), NUTS_Transition{Array{Float64,1},Float64}([1.53929, 0.212181, -0.672607, -0.0353892, -0.541583, 0.714458, 0.104037, -0.0833502, 0.0076622, 0.0830885, 0.109581, -0.0752891, -1.0066], -57.768, 4, DoubledTurn, 0.982439, 15), NUTS_Transition{Array{Float64,1},Float64}([-0.409177, 0.442679, -0.0516175, 0.142843, -0.12595, 0.108864, -0.027988, -0.422336, 0.110958, -0.41207, 0.0292101, -0.764468, -1.10735], -50.9606, 4, DoubledTurn, 0.999014, 15), NUTS_Transition{Array{Float64,1},Float64}([2.27778, 0.120378, -0.0952303, 0.00723752, -0.0899239, 0.54715, 0.16258, -0.249107, 0.308226, 0.0310283, 0.222385, 0.392406, -1.60805], -46.0729, 4, DoubledTurn, 0.964254, 15), NUTS_Transition{Array{Float64,1},Float64}([2.40831, 0.142353, -0.753779, -0.161016, -0.190261, -0.033379, -0.0666814, -0.600431, -0.229001, -0.441568, 0.210757, -0.0241617, -0.772863], -49.567, 4, DoubledTurn, 0.971262, 15), NUTS_Transition{Array{Float64,1},Float64}([1.72715, 0.219725, -0.474793, -0.270514, -0.223328, -0.0462537, -0.00921182, -0.507037, -0.16411, -0.329244, 0.188306, -0.229984, -1.12806], -45.7397, 4, DoubledTurn, 0.98163, 15)], NUTS sampler in 13 dimensions
  stepsize (ϵ) ≈ 0.205
  maximum depth = 10
  Gaussian kinetic energy, √diag(M⁻¹): [0.729711, 0.0833905, 0.252175, 0.213841, 0.201007, 0.182388, 0.168804, 0.210525, 0.181768, 0.182721, 0.183988, 0.299992, 0.379619]
)</code></pre></div><p>We use the transformation to obtain the posterior from the chain.</p><div><pre><code class="language-julia">posterior = TransformVariables.transform.(Ref(problem_transformation(p)), get_position.(chain));
posterior[1:5]</code></pre><pre><code class="language-none">5-element Array{NamedTuple{(:β, :α, :σ),Tuple{Array{Float64,1},Array{Float64,1},Float64}},1}:
 (β = [0.0479709, 0.391882], α = [-0.031563, 0.0885541, -0.268544, 0.0955804, 0.178457, -0.407574, 0.305722, -0.448469, 0.198294, -0.596531], σ = 0.4183411232018557)
 (β = [1.75696, 0.174512], α = [-0.403396, 0.0136777, 0.111195, 0.462153, -0.0150794, -0.310815, 0.0140026, -0.00664019, 0.281481, 0.0820073], σ = 0.19134383038499314)
 (β = [0.92187, 0.299803], α = [0.157583, 0.0167089, -0.0656419, 0.31153, 0.055927, -0.360765, 0.188034, -0.599995, 0.304204, -0.27465], σ = 0.347639532910328)
 (β = [1.96505, 0.150016], α = [-0.382183, -0.220073, -0.0699375, 0.2984, 0.0244208, -0.23209, 0.0204126, 0.124451, 0.389367, 0.249805], σ = 0.23962798456503887)
 (β = [1.2913, 0.227865], α = [0.0704722, 0.0663519, -0.0400074, 0.4102, 0.154485, -0.023197, 0.161164, -0.0805859, 0.579762, 0.153423], σ = 0.27127162202337146)</code></pre></div><p>Extract the parameter posterior means.</p><div><pre><code class="language-julia">posterior_β = mean(posterior[i].β for i in 1:length(posterior))
posterior_α = mean(posterior[i].α for i in 1:length(posterior))
posterior_σ = mean(posterior[i].σ for i in 1:length(posterior))</code></pre><pre><code class="language-none">0.3206880532289202</code></pre></div><p>Effective sample sizes (of untransformed draws)</p><div><pre><code class="language-julia">ess = mapslices(effective_sample_size, get_position_matrix(chain); dims = 1)
ess</code></pre><pre><code class="language-none">1×13 Array{Float64,2}:
 718.395  733.686  560.348  610.097  …  667.802  517.201  729.5  358.458</code></pre></div><p>NUTS-specific statistics</p><div><pre><code class="language-julia">NUTS_statistics(chain)</code></pre><pre><code class="language-none">Hamiltonian Monte Carlo sample of length 1000
  acceptance rate mean: 0.95, min/25%/median/75%/max: 0.29 0.93 0.97 0.99 1.0
  termination: AdjacentTurn =&gt; 16% DoubledTurn =&gt; 84%
  depth: 3 =&gt; 3% 4 =&gt; 90% 5 =&gt; 7% 6 =&gt; 0%</code></pre></div><p>CmdStan result</p><div><pre><code class="language-julia">m_12_6_result = &quot;
Iterations = 1:1000
Thinning interval = 1
Chains = 1,2,3,4
Samples per chain = 1000

Empirical Posterior Estimates:
                            Mean                SD               Naive SE             MCSE            ESS
            a          1.076167468  0.7704872560 0.01218247319 0.0210530022 1000.000000
           bp         0.263056273  0.0823415805 0.00130193470 0.0022645077 1000.000000
  a_society.1   -0.191723568  0.2421382537 0.00382854195 0.0060563054 1000.000000
  a_society.2    0.054569029  0.2278506876 0.00360263570 0.0051693148 1000.000000
  a_society.3   -0.035935050  0.1926364647 0.00304584994 0.0039948433 1000.000000
  a_society.4    0.334355037  0.1929971201 0.00305155241 0.0063871707  913.029080
  a_society.5    0.049747513  0.1801287716 0.00284808595 0.0043631095 1000.000000
  a_society.6   -0.311903245  0.2096126337 0.00331426674 0.0053000536 1000.000000
  a_society.7    0.148637507  0.1744680594 0.00275858223 0.0047660246 1000.000000
  a_society.8   -0.164567976  0.1821341074 0.00287979309 0.0034297298 1000.000000
  a_society.9    0.277066965  0.1758237250 0.00278001719 0.0055844175  991.286501
 a_society.10   -0.094149204  0.2846206232 0.00450024719 0.0080735022 1000.000000
sigma_society    0.310352849  0.1374834682 0.00217380450 0.0057325226  575.187461
&quot;;</code></pre><pre><code class="language-none">&quot;\nIterations = 1:1000\nThinning interval = 1\nChains = 1,2,3,4\nSamples per chain = 1000\n\nEmpirical Posterior Estimates:\n                            Mean                SD               Naive SE             MCSE            ESS\n            a          1.076167468  0.7704872560 0.01218247319 0.0210530022 1000.000000\n           bp         0.263056273  0.0823415805 0.00130193470 0.0022645077 1000.000000\n  a_society.1   -0.191723568  0.2421382537 0.00382854195 0.0060563054 1000.000000\n  a_society.2    0.054569029  0.2278506876 0.00360263570 0.0051693148 1000.000000\n  a_society.3   -0.035935050  0.1926364647 0.00304584994 0.0039948433 1000.000000\n  a_society.4    0.334355037  0.1929971201 0.00305155241 0.0063871707  913.029080\n  a_society.5    0.049747513  0.1801287716 0.00284808595 0.0043631095 1000.000000\n  a_society.6   -0.311903245  0.2096126337 0.00331426674 0.0053000536 1000.000000\n  a_society.7    0.148637507  0.1744680594 0.00275858223 0.0047660246 1000.000000\n  a_society.8   -0.164567976  0.1821341074 0.00287979309 0.0034297298 1000.000000\n  a_society.9    0.277066965  0.1758237250 0.00278001719 0.0055844175  991.286501\n a_society.10   -0.094149204  0.2846206232 0.00450024719 0.0080735022 1000.000000\nsigma_society    0.310352849  0.1374834682 0.00217380450 0.0057325226  575.187461\n&quot;</code></pre></div><p>Show means</p><div><pre><code class="language-julia">[posterior_β, posterior_α, posterior_σ]</code></pre><pre><code class="language-none">3-element Array{Any,1}:
  [1.09938, 0.261095]
  [-0.215299, 0.0430164, -0.0588949, 0.331702, 0.0473712, -0.322242, 0.141289, -0.174006, 0.278506, -0.0940224]
 0.3206880532289202</code></pre></div><p>End of m12.6d.jl</p><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p><footer><hr/><a class="previous" href="../../10/m10.04d/"><span class="direction">Previous</span><span class="title">m10.04d</span></a><a class="next" href="../m12.6d1/"><span class="direction">Next</span><span class="title">m12.6d1</span></a></footer></article></body></html>
