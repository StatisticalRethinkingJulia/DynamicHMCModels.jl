<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>m12.6d · DynamicHMCModels.jl</title><link href="https://cdnjs.cloudflare.com/ajax/libs/normalize/4.2.0/normalize.min.css" rel="stylesheet" type="text/css"/><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.2.0/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link href="../../assets/documenter.css" rel="stylesheet" type="text/css"/></head><body><nav class="toc"><h1>DynamicHMCModels.jl</h1><select id="version-selector" onChange="window.location.href=this.value" style="visibility: hidden"></select><form class="search" id="search-form" action="../../search/"><input id="search-query" name="q" type="text" placeholder="Search docs"/></form><ul><li><a class="toctext" href="../../intro/">Home</a></li><li><span class="toctext">Chapter 02</span><ul><li><a class="toctext" href="../../02/m2.1d/">m2.1d</a></li></ul></li><li><span class="toctext">Chapter 04</span><ul><li><a class="toctext" href="../../04/m4.1d/">m4.1d</a></li><li><a class="toctext" href="../../04/m4.2d/">m4.2d</a></li><li><a class="toctext" href="../../04/m4.5d/">m4.5d</a></li></ul></li><li><span class="toctext">Chapter 05</span><ul><li><a class="toctext" href="../../05/m5.1d/">m5.1d</a></li><li><a class="toctext" href="../../05/m5.1d1/">m5.1d1</a></li><li><a class="toctext" href="../../05/m5.3d/">m5.3d</a></li><li><a class="toctext" href="../../05/m5.6d/">m5.6d</a></li></ul></li><li><span class="toctext">Chapter 08</span><ul><li><a class="toctext" href="../../08/m8.1d/">m8.1d</a></li></ul></li><li><span class="toctext">Chapter 10</span><ul><li><a class="toctext" href="../../10/m10.02d/">m10.02d</a></li><li><a class="toctext" href="../../10/m10.02d1/">m10.02d1</a></li><li><a class="toctext" href="../../10/m10.04d/">m10.04d</a></li><li><a class="toctext" href="../../10/m10.04d1/">m10.04d1</a></li><li><a class="toctext" href="../../10/m10.04d2/">m10.04d2</a></li></ul></li><li><span class="toctext">Chapter 12</span><ul><li class="current"><a class="toctext" href>m12.6d</a><ul class="internal"></ul></li><li><a class="toctext" href="../m12.6d1/">m12.6d1</a></li><li><a class="toctext" href="../m12.6d2/">m12.6d2</a></li></ul></li><li><a class="toctext" href="../../">Functions</a></li></ul></nav><article id="docs"><header><nav><ul><li>Chapter 12</li><li><a href>m12.6d</a></li></ul><a class="edit-page" href="https://github.com/StatisticalRethinkingJulia/DynamicHMCModels.jl/blob/master/scripts/12/m12.6d.jl"><span class="fa"></span> Edit on GitHub</a></nav><hr/><div id="topbar"><span>m12.6d</span><a class="fa fa-bars" href="#"></a></div></header><pre><code class="language-julia">using DynamicHMCModels

ProjDir = rel_path_d(&quot;..&quot;, &quot;scripts&quot;, &quot;12&quot;)

df = CSV.read(rel_path( &quot;..&quot;, &quot;data&quot;,  &quot;Kline.csv&quot;), delim=&#39;;&#39;);
size(df) # Should be 10x5</code></pre><pre><code class="language-none">(10, 5)</code></pre><p>New col logpop, set log() for population data</p><pre><code class="language-julia">df[:logpop] = map((x) -&gt; log(x), df[:population]);
df[:society] = 1:10;

first(df[[:total_tools, :logpop, :society]], 5)

struct m_12_06d_model{TY &lt;: AbstractVector, TX &lt;: AbstractMatrix,
  TS &lt;: AbstractVector}
    &quot;Observations (total_tools).&quot;
    y::TY
    &quot;Covariates (logpop)&quot;
    X::TX
    &quot;Society&quot;
    S::TS
    &quot;Number of observations (10)&quot;
    N::Int
    &quot;Number of societies (also 10)&quot;
    N_societies::Int
end</code></pre><p>Make the type callable with the parameters <em>as a single argument</em>.</p><pre><code class="language-julia">function (problem::m_12_06d_model)(θ)
    @unpack y, X, S, N, N_societies = problem   # extract the data
    @unpack β, α, σ = θ  # β : a, bp, α : a_society
    ll = 0.0
    ll += logpdf(Cauchy(0, 1), σ)
    ll += sum(logpdf.(Normal(0, σ), α)) # α[1:10]
    ll += logpdf.(Normal(0, 10), β[1]) # a
    ll += logpdf.(Normal(0, 1), β[2]) # a
    ll += sum(
      [loglikelihood(Poisson(exp(α[S[i]] + dot(X[i, :], β))), [y[i]]) for i in 1:N]
    )
    ll
end</code></pre><p>Instantiate the model with data and inits.</p><pre><code class="language-julia">N = size(df, 1)
N_societies = length(unique(df[:society]))
X = hcat(ones(Int64, N), df[:logpop]);
S = df[:society]
y = df[:total_tools]
p = m_12_06d_model(y, X, S, N, N_societies);
θ = (β = [1.0, 0.25], α = rand(Normal(0, 1), N_societies), σ = 0.2)
p(θ)</code></pre><pre><code class="language-none">-515.2375628526732</code></pre><p>Write a function to return properly dimensioned transformation.</p><pre><code class="language-julia">problem_transformation(p::m_12_06d_model) =
    as( (β = as(Array, size(p.X, 2)), α = as(Array, p.N_societies), σ = asℝ₊) )</code></pre><p>Wrap the problem with a transformation, then use Flux for the gradient.</p><pre><code class="language-julia">P = TransformedLogDensity(problem_transformation(p), p)
∇P = LogDensityRejectErrors(ADgradient(:ForwardDiff, P));
#∇P = ADgradient(:ForwardDiff, P);</code></pre><p>Tune and sample.</p><pre><code class="language-julia">chain, NUTS_tuned = NUTS_init_tune_mcmc(∇P, 1000);</code></pre><pre><code class="language-none">(NUTS_Transition{Array{Float64,1},Float64}[NUTS_Transition{Array{Float64,1},Float64}([1.6910010967299536, 0.20687688491257225, -0.3784163661897955, -0.19399034384475256, -0.21900350392123882, 0.3458541119996011, 0.07839206149877657, -0.7411664549768043, 0.0599043564416372, -0.6210389962260826, 0.16965035462259875, 0.05496158185096631, -0.6606918796744781], -46.467890100283455, 4, DynamicHMC.DoubledTurn, 0.9395044250028234, 15), NUTS_Transition{Array{Float64,1},Float64}([2.1361466445268507, 0.13858711645914015, -0.6439989763485956, 0.025825546561143053, -0.203080113363389, 0.40715163338621874, 0.12710517309091937, -0.3726806518269913, 0.23860631166879145, -0.5610382442466776, 0.5266931463035271, 0.09501332136623432, -1.0415796730918176], -51.04157603384146, 4, DynamicHMC.DoubledTurn, 0.615682370711324, 15), NUTS_Transition{Array{Float64,1},Float64}([1.9729471629990396, 0.17548775038967768, -0.36469730564555536, -0.10281854601036156, -0.010147717585716677, 0.41473807165719645, 0.038329226242662676, -0.12974298283622626, 0.08315528827276986, -0.3186046253214152, 0.3757735708133605, 0.13148703158773467, -1.4228720204141672], -47.35420415327857, 4, DynamicHMC.DoubledTurn, 0.979215243013827, 15), NUTS_Transition{Array{Float64,1},Float64}([-0.09071432929000572, 0.40927151851932475, -0.11127890332532822, 0.29802143160983574, -0.0072852993176704475, 0.28215810968164784, -0.08093721362114756, -0.40890808992626576, 0.01898327266559962, -0.5214310615951743, 0.1914536768998145, -0.5698512088881454, -1.412651018472572], -45.50977722640688, 4, DynamicHMC.DoubledTurn, 0.9838441677213973, 15), NUTS_Transition{Array{Float64,1},Float64}([2.988370816595089, 0.037927916917942645, -0.33043435861352544, -0.5236255549872454, -0.1593202416362, 0.4977988826858978, 0.2924696899473142, -0.3389983159924173, 0.5972805951401544, 0.23153356131503688, 0.6471820449689225, 0.8412669112503419, -0.7039577302771038], -49.49289805731357, 4, DynamicHMC.DoubledTurn, 0.9469160835498315, 15), NUTS_Transition{Array{Float64,1},Float64}([2.866440162871701, 0.046831257786819826, -0.4563480540770321, -0.18159034400755436, -0.1312185762617667, 0.3105805962989942, 0.22005524900843174, -0.35608888018881335, 0.03113903033290008, -0.10708168854950902, 0.662249258603243, 0.7306734525387277, -0.8163885498781887], -48.943968567248646, 4, DynamicHMC.DoubledTurn, 0.9744057813489991, 15), NUTS_Transition{Array{Float64,1},Float64}([1.2240301322735654, 0.2309514281489693, -0.3702906515116954, 0.3730871673440951, 0.20533282085997043, 0.6076741787116877, 0.21053118347935734, 0.11772537320173283, 0.2770287578104767, -0.09570619881362358, 0.28113037210290875, 0.12880660073643188, -0.9704141731133568], -45.74881869350246, 4, DynamicHMC.DoubledTurn, 0.9955938278453018, 15), NUTS_Transition{Array{Float64,1},Float64}([1.436841952288782, 0.19819071836982094, -0.2474651446303636, 0.17346497011008127, 0.30528043452629144, 0.4925311849050915, 0.12118268259616301, -0.5467874150993365, 0.31141962414119445, 0.1648700517393661, 0.6378039134782637, 0.46979455387507296, -0.7600529457917587], -44.704926080856566, 4, DynamicHMC.DoubledTurn, 0.990013197592652, 15), NUTS_Transition{Array{Float64,1},Float64}([0.853958866855454, 0.2828628880812409, -0.18023097281845094, 0.16686111577950266, -0.19507679425093744, 0.5025516974364492, 0.1562355093156494, 0.08700313273690383, 0.1618427481973091, -0.04524550766642947, 0.1378158372659749, -0.27918479728193674, -1.359406077631341], -50.47653629373057, 4, DynamicHMC.DoubledTurn, 0.751966369732335, 15), NUTS_Transition{Array{Float64,1},Float64}([1.6972726062161787, 0.19616473097957565, -0.4024204365542564, -0.12160805724670887, -0.051569168232725754, 0.28149773079015167, 0.13512771422633457, -0.3936421942806485, -0.09228668609391817, -0.1727905935405091, 0.3773913077313115, -0.00331095292655631, -1.6429019662060749], -46.08012063366695, 4, DynamicHMC.DoubledTurn, 0.9261033531856894, 15)  …  NUTS_Transition{Array{Float64,1},Float64}([1.9253140226096235, 0.17359634825324766, -0.646347753234451, -0.10036893203355893, 0.047755686113229286, 0.24925793847780364, 0.17538564424117362, -0.18309077544249883, 0.3438387343664098, -0.4079193218539274, 0.3508135021775561, 0.20487760110975842, -0.8347101330551063], -45.37664549026992, 4, DynamicHMC.DoubledTurn, 0.972077584443466, 15), NUTS_Transition{Array{Float64,1},Float64}([1.0188043359062235, 0.27457219779989006, 0.12052721765941973, 0.13333404534506155, -0.15565245596403637, 0.39291989749278006, -0.19860585981605977, -0.4519916838761016, -0.0032665863085210483, -0.08454997109022738, 0.3332169624137003, -0.12546709050342897, -1.4712653254767663], -46.187418926767265, 4, DynamicHMC.DoubledTurn, 0.9824181239954719, 15), NUTS_Transition{Array{Float64,1},Float64}([1.6129529088506978, 0.19031099770791768, -0.2855857154379571, 0.21058280619778103, -0.086301607611127, 0.35797221901999116, 0.2097856908788398, -0.14949584297180304, 0.40461883042577756, -0.2112579930751155, 0.41796954573847434, 0.2755878242721655, -1.1117110497009282], -43.595023503340116, 4, DynamicHMC.DoubledTurn, 0.970219781078142, 15), NUTS_Transition{Array{Float64,1},Float64}([0.7248426361909234, 0.3053300234930181, -0.10817891857502912, -0.03725689074583603, 0.029971390361384177, 0.32473764020305174, -0.27848705910463045, -0.395978828845766, 0.029677819700575647, -0.17642417733024623, 0.322345373355684, -0.2848228148751811, -1.4241691093677669], -41.92818847203977, 4, DynamicHMC.DoubledTurn, 0.9838887312320177, 15), NUTS_Transition{Array{Float64,1},Float64}([1.5631694653493293, 0.208237039942337, -0.19465852697589603, 0.0563529745770532, -0.012725959561615284, 0.18756380056220723, 0.21081157497286948, -0.10842479420863489, 0.18387479975842705, -0.10598017133073695, 0.1457097848872288, 0.05644054708579695, -1.7791445314726093], -39.63970800112515, 4, DynamicHMC.DoubledTurn, 0.995128554315334, 15), NUTS_Transition{Array{Float64,1},Float64}([0.8743489231819603, 0.28266288411202456, -0.24719833400194968, 0.20387075646271452, -0.06365905879387723, 0.47048445309104525, -0.06579104582094976, -0.5102770351264043, 0.0670925675310515, -0.2827827431015418, 0.20524211682967877, -0.023815192235373334, -1.2734296987113005], -41.43666868611963, 4, DynamicHMC.DoubledTurn, 0.9120494833766843, 15), NUTS_Transition{Array{Float64,1},Float64}([0.836235727272336, 0.2861914609880421, 0.008309866872648883, 0.15675937417546534, -0.14714390023900925, 0.5306632705739966, -0.03029450106556955, -0.7177866973435791, 0.1991095495034909, -0.11923927391967043, 0.22017311679016646, -0.012098588907292582, -1.3239461992059964], -41.67525640788037, 4, DynamicHMC.DoubledTurn, 0.9661695731103898, 15), NUTS_Transition{Array{Float64,1},Float64}([0.5823327798333647, 0.3136749172883985, 0.13242379112159758, 0.009044080647672294, 0.21186322800798973, 0.4215734382981383, 0.10144480209423426, -0.5569783395045975, 0.15167440985700878, 0.025922490113574295, 0.13764632558095644, -0.046342652254064545, -1.256501552946901], -44.45583986857406, 4, DynamicHMC.DoubledTurn, 0.9439239299416734, 15), NUTS_Transition{Array{Float64,1},Float64}([0.06802313956558634, 0.37499544398823936, -0.20153492748643448, 0.2799629171309097, 0.23668447751703725, 0.44230599932356596, 0.09910845852901937, 0.03989856965805658, 0.21396556456793644, -0.44089567871007523, 0.08871977879429942, -0.2501877211066905, -1.2412876032962121], -49.08681810041535, 4, DynamicHMC.DoubledTurn, 0.7550182049005892, 15), NUTS_Transition{Array{Float64,1},Float64}([2.7347194631819303, 0.08598121046227941, -0.26330924785319954, 0.05586961680521586, -0.32253759091569856, 0.2631143334887324, -0.31291975318521353, -0.5097216238792915, -0.2576993628335254, -0.008328220962806103, 0.4905468510713885, 0.28202278587014934, -1.1470306515041673], -52.05502140523933, 4, DynamicHMC.DoubledTurn, 0.9708619892611924, 15)], NUTS sampler in 13 dimensions
  stepsize (ϵ) ≈ 0.239
  maximum depth = 10
  Gaussian kinetic energy, √diag(M⁻¹): [0.7592232594049177, 0.08589500824361222, 0.2449836269274611, 0.2202793163155007, 0.20980611194905022, 0.20234249035338533, 0.16341155342722571, 0.21626541963515636, 0.1789452770470277, 0.1875448523368339, 0.1863886850183725, 0.30264322768927093, 0.40707003661955404]
)</code></pre><p>We use the transformation to obtain the posterior from the chain.</p><pre><code class="language-julia">posterior = TransformVariables.transform.(Ref(problem_transformation(p)), get_position.(chain));
posterior[1:5]</code></pre><pre><code class="language-none">5-element Array{NamedTuple{(:β, :α, :σ),Tuple{Array{Float64,1},Array{Float64,1},Float64}},1}:
 (β = [1.6910010967299536, 0.20687688491257225], α = [-0.3784163661897955, -0.19399034384475256, -0.21900350392123882, 0.3458541119996011, 0.07839206149877657, -0.7411664549768043, 0.0599043564416372, -0.6210389962260826, 0.16965035462259875, 0.05496158185096631], σ = 0.5164938592378289)        
 (β = [2.1361466445268507, 0.13858711645914015], α = [-0.6439989763485956, 0.025825546561143053, -0.203080113363389, 0.40715163338621874, 0.12710517309091937, -0.3726806518269913, 0.23860631166879145, -0.5610382442466776, 0.5266931463035271, 0.09501332136623432], σ = 0.3528967798759811)         
 (β = [1.9729471629990396, 0.17548775038967768], α = [-0.36469730564555536, -0.10281854601036156, -0.010147717585716677, 0.41473807165719645, 0.038329226242662676, -0.12974298283622626, 0.08315528827276986, -0.3186046253214152, 0.3757735708133605, 0.13148703158773467], σ = 0.24102080524162703)  
 (β = [-0.09071432929000572, 0.40927151851932475], α = [-0.11127890332532822, 0.29802143160983574, -0.0072852993176704475, 0.28215810968164784, -0.08093721362114756, -0.40890808992626576, 0.01898327266559962, -0.5214310615951743, 0.1914536768998145, -0.5698512088881454], σ = 0.24349691194939654)
 (β = [2.988370816595089, 0.037927916917942645], α = [-0.33043435861352544, -0.5236255549872454, -0.1593202416362, 0.4977988826858978, 0.2924696899473142, -0.3389983159924173, 0.5972805951401544, 0.23153356131503688, 0.6471820449689225, 0.8412669112503419], σ = 0.49462383713771735)              </code></pre><p>Extract the parameter posterior means.</p><pre><code class="language-julia">posterior_β = mean(posterior[i].β for i in 1:length(posterior))
posterior_α = mean(posterior[i].α for i in 1:length(posterior))
posterior_σ = mean(posterior[i].σ for i in 1:length(posterior))</code></pre><pre><code class="language-none">0.3050806844773033</code></pre><p>Effective sample sizes (of untransformed draws)</p><pre><code class="language-julia">ess = mapslices(effective_sample_size, get_position_matrix(chain); dims = 1)
ess</code></pre><pre><code class="language-none">1×13 Array{Float64,2}:
 791.65  711.606  858.483  1000.0  …  777.864  703.16  832.934  588.335</code></pre><p>NUTS-specific statistics</p><pre><code class="language-julia">NUTS_statistics(chain)</code></pre><pre><code class="language-none">Hamiltonian Monte Carlo sample of length 1000
  acceptance rate mean: 0.92, min/25%/median/75%/max: 0.36 0.89 0.96 0.99 1.0
  termination: AdjacentTurn =&gt; 4% DoubledTurn =&gt; 96%
  depth: 3 =&gt; 6% 4 =&gt; 93% 5 =&gt; 0%
</code></pre><p>CmdStan result</p><pre><code class="language-julia">m_12_6_result = &quot;
Iterations = 1:1000
Thinning interval = 1
Chains = 1,2,3,4
Samples per chain = 1000

Empirical Posterior Estimates:
                            Mean                SD               Naive SE             MCSE            ESS
            a          1.076167468  0.7704872560 0.01218247319 0.0210530022 1000.000000
           bp         0.263056273  0.0823415805 0.00130193470 0.0022645077 1000.000000
  a_society.1   -0.191723568  0.2421382537 0.00382854195 0.0060563054 1000.000000
  a_society.2    0.054569029  0.2278506876 0.00360263570 0.0051693148 1000.000000
  a_society.3   -0.035935050  0.1926364647 0.00304584994 0.0039948433 1000.000000
  a_society.4    0.334355037  0.1929971201 0.00305155241 0.0063871707  913.029080
  a_society.5    0.049747513  0.1801287716 0.00284808595 0.0043631095 1000.000000
  a_society.6   -0.311903245  0.2096126337 0.00331426674 0.0053000536 1000.000000
  a_society.7    0.148637507  0.1744680594 0.00275858223 0.0047660246 1000.000000
  a_society.8   -0.164567976  0.1821341074 0.00287979309 0.0034297298 1000.000000
  a_society.9    0.277066965  0.1758237250 0.00278001719 0.0055844175  991.286501
 a_society.10   -0.094149204  0.2846206232 0.00450024719 0.0080735022 1000.000000
sigma_society    0.310352849  0.1374834682 0.00217380450 0.0057325226  575.187461
&quot;;</code></pre><pre><code class="language-none">&quot;\nIterations = 1:1000\nThinning interval = 1\nChains = 1,2,3,4\nSamples per chain = 1000\n\nEmpirical Posterior Estimates:\n                            Mean                SD               Naive SE             MCSE            ESS\n            a          1.076167468  0.7704872560 0.01218247319 0.0210530022 1000.000000\n           bp         0.263056273  0.0823415805 0.00130193470 0.0022645077 1000.000000\n  a_society.1   -0.191723568  0.2421382537 0.00382854195 0.0060563054 1000.000000\n  a_society.2    0.054569029  0.2278506876 0.00360263570 0.0051693148 1000.000000\n  a_society.3   -0.035935050  0.1926364647 0.00304584994 0.0039948433 1000.000000\n  a_society.4    0.334355037  0.1929971201 0.00305155241 0.0063871707  913.029080\n  a_society.5    0.049747513  0.1801287716 0.00284808595 0.0043631095 1000.000000\n  a_society.6   -0.311903245  0.2096126337 0.00331426674 0.0053000536 1000.000000\n  a_society.7    0.148637507  0.1744680594 0.00275858223 0.0047660246 1000.000000\n  a_society.8   -0.164567976  0.1821341074 0.00287979309 0.0034297298 1000.000000\n  a_society.9    0.277066965  0.1758237250 0.00278001719 0.0055844175  991.286501\n a_society.10   -0.094149204  0.2846206232 0.00450024719 0.0080735022 1000.000000\nsigma_society    0.310352849  0.1374834682 0.00217380450 0.0057325226  575.187461\n&quot;</code></pre><p>Show means</p><pre><code class="language-julia">[posterior_β, posterior_α, [posterior_σ]]</code></pre><pre><code class="language-none">3-element Array{Array{Float64,1},1}:
 [1.1184157373383254, 0.25938721888685373]                                                                                                                                                                           
 [-0.21407671836337291, 0.03881256386545734, -0.04733984346786398, 0.3214974916474239, 0.04040580247465518, -0.3223912330044177, 0.15000837224188066, -0.18212368853200064, 0.2812423455395181, -0.09387766682758894]
 [0.3050806844773033]                                                                                                                                                                                                </code></pre><p>End of m12.6d.jl</p><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p><footer><hr/><a class="previous" href="../../10/m10.04d2/"><span class="direction">Previous</span><span class="title">m10.04d2</span></a><a class="next" href="../m12.6d1/"><span class="direction">Next</span><span class="title">m12.6d1</span></a></footer></article></body></html>
