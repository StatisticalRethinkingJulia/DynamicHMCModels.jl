<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>m12.6d · DynamicHMCModels.jl</title><link href="https://cdnjs.cloudflare.com/ajax/libs/normalize/4.2.0/normalize.min.css" rel="stylesheet" type="text/css"/><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.2.0/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link href="../../assets/documenter.css" rel="stylesheet" type="text/css"/></head><body><nav class="toc"><h1>DynamicHMCModels.jl</h1><select id="version-selector" onChange="window.location.href=this.value" style="visibility: hidden"></select><form class="search" id="search-form" action="../../search/"><input id="search-query" name="q" type="text" placeholder="Search docs"/></form><ul><li><a class="toctext" href="../../intro/">Home</a></li><li><span class="toctext">Chapter 02</span><ul><li><a class="toctext" href="../../02/m2.1d/">m2.1d</a></li></ul></li><li><span class="toctext">Chapter 04</span><ul><li><a class="toctext" href="../../04/m4.1d/">m4.1d</a></li><li><a class="toctext" href="../../04/m4.2d/">m4.2d</a></li><li><a class="toctext" href="../../04/m4.5d/">m4.5d</a></li></ul></li><li><span class="toctext">Chapter 05</span><ul><li><a class="toctext" href="../../05/m5.1d/">m5.1d</a></li><li><a class="toctext" href="../../05/m5.1d1/">m5.1d1</a></li><li><a class="toctext" href="../../05/m5.3d/">m5.3d</a></li><li><a class="toctext" href="../../05/m5.6d/">m5.6d</a></li></ul></li><li><span class="toctext">Chapter 08</span><ul><li><a class="toctext" href="../../08/m8.1d/">m8.1d</a></li></ul></li><li><span class="toctext">Chapter 10</span><ul><li><a class="toctext" href="../../10/m10.02d/">m10.02d</a></li><li><a class="toctext" href="../../10/m10.02d1/">m10.02d1</a></li><li><a class="toctext" href="../../10/m10.04d/">m10.04d</a></li></ul></li><li><span class="toctext">Chapter 12</span><ul><li class="current"><a class="toctext" href>m12.6d</a><ul class="internal"></ul></li><li><a class="toctext" href="../m12.6d1/">m12.6d1</a></li></ul></li><li><a class="toctext" href="../../">Functions</a></li></ul></nav><article id="docs"><header><nav><ul><li>Chapter 12</li><li><a href>m12.6d</a></li></ul><a class="edit-page" href="https://github.com/StatisticalRethinkingJulia/DynamicHMCModels.jl/blob/master/scripts/12/m12.6d.jl"><span class="fa"></span> Edit on GitHub</a></nav><hr/><div id="topbar"><span>m12.6d</span><a class="fa fa-bars" href="#"></a></div></header><div><pre><code class="language-julia">using DynamicHMCModels

ProjDir = rel_path_d(&quot;..&quot;, &quot;scripts&quot;, &quot;12&quot;)

df = CSV.read(rel_path( &quot;..&quot;, &quot;data&quot;,  &quot;Kline.csv&quot;), delim=&#39;;&#39;);
size(df) # Should be 10x5</code></pre><pre><code class="language-none">(10, 5)</code></pre></div><p>New col logpop, set log() for population data</p><div><pre><code class="language-julia">df[:logpop] = map((x) -&gt; log(x), df[:population]);
df[:society] = 1:10;

first(df[[:total_tools, :logpop, :society]], 5)

struct m_12_06d_model{TY &lt;: AbstractVector, TX &lt;: AbstractMatrix,
  TS &lt;: AbstractVector}
    &quot;Observations (total_tools).&quot;
    y::TY
    &quot;Covariates (logpop)&quot;
    X::TX
    &quot;Society&quot;
    S::TS
    &quot;Number of observations (10)&quot;
    N::Int
    &quot;Number of societies (also 10)&quot;
    N_societies::Int
end</code></pre></div><p>Make the type callable with the parameters <em>as a single argument</em>.</p><div><pre><code class="language-julia">function (problem::m_12_06d_model)(θ)
    @unpack y, X, S, N, N_societies = problem   # extract the data
    @unpack β, α, σ = θ  # β : a, bp, α : a_society
    ll = 0.0
    ll += logpdf(Cauchy(0, 1), σ)
    ll += sum(logpdf.(Normal(0, σ), α)) # α[1:10]
    ll += logpdf.(Normal(0, 10), β[1]) # a
    ll += logpdf.(Normal(0, 1), β[2]) # a
    ll += sum(
      [loglikelihood(Poisson(exp(α[S[i]] + dot(X[i, :], β))), [y[i]]) for i in 1:N]
    )
    ll
end</code></pre></div><p>Instantiate the model with data and inits.</p><div><pre><code class="language-julia">N = size(df, 1)
N_societies = length(unique(df[:society]))
X = hcat(ones(Int64, N), df[:logpop]);
S = df[:society]
y = df[:total_tools]
p = m_12_06d_model(y, X, S, N, N_societies);
θ = (β = [1.0, 0.25], α = rand(Normal(0, 1), N_societies), σ = 0.2)
p(θ)</code></pre><pre><code class="language-none">-134.5412182348821</code></pre></div><p>Write a function to return properly dimensioned transformation.</p><div><pre><code class="language-julia">problem_transformation(p::m_12_06d_model) =
    as( (β = as(Array, size(p.X, 2)), α = as(Array, p.N_societies), σ = asℝ₊) )</code></pre></div><p>Wrap the problem with a transformation, then use Flux for the gradient.</p><div><pre><code class="language-julia">P = TransformedLogDensity(problem_transformation(p), p)
∇P = LogDensityRejectErrors(ADgradient(:ForwardDiff, P));
#∇P = ADgradient(:ForwardDiff, P);</code></pre></div><p>Tune and sample.</p><div><pre><code class="language-julia">chain, NUTS_tuned = NUTS_init_tune_mcmc(∇P, 1000);</code></pre><pre><code class="language-none">MCMC, adapting ϵ (75 steps)
0.0044 s/step ...done
MCMC, adapting ϵ (25 steps)
0.003 s/step ...done
MCMC, adapting ϵ (50 steps)
0.0057 s/step ...done
MCMC, adapting ϵ (100 steps)
0.0013 s/step ...done
MCMC, adapting ϵ (200 steps)
0.00087 s/step ...done
MCMC, adapting ϵ (400 steps)
0.00049 s/step ...done
MCMC, adapting ϵ (50 steps)
0.00068 s/step ...done
MCMC (1000 steps)
0.00043 s/step ...done
(NUTS_Transition{Array{Float64,1},Float64}[NUTS_Transition{Array{Float64,1},Float64}([1.18749, 0.242916, 0.185505, -0.200652, 0.142125, 0.422052, 0.15216, -0.11828, -0.13417, -0.232209, 0.485895, 0.100698, -1.69446], -46.0218, 3, DoubledTurn, 0.775622, 7), NUTS_Transition{Array{Float64,1},Float64}([1.29972, 0.235202, -0.102192, -0.240308, -0.0911024, 0.464003, 0.121844, -0.25867, -0.0374197, -0.236454, 0.2991, 0.0698324, -1.05965], -46.1692, 4, DoubledTurn, 0.985823, 15), NUTS_Transition{Array{Float64,1},Float64}([0.894628, 0.289306, -0.164631, 0.304988, 0.00564909, 0.179053, -0.0364818, -0.141571, 0.192923, -0.0581008, 0.201433, -0.159127, -1.92707], -41.5212, 4, DoubledTurn, 0.930551, 15), NUTS_Transition{Array{Float64,1},Float64}([0.563942, 0.311235, -0.0892046, -0.203379, -0.102549, 0.144838, 0.187237, -0.110733, 0.100801, -0.173022, 0.106616, 0.060562, -1.85188], -43.8406, 4, DoubledTurn, 0.936913, 15), NUTS_Transition{Array{Float64,1},Float64}([0.691371, 0.317267, -0.250748, 0.277317, 0.0264398, 0.29343, -0.1722, -0.381294, -0.0404962, -0.230168, 0.10419, -0.279161, -1.43166], -46.0097, 4, DoubledTurn, 0.950139, 15), NUTS_Transition{Array{Float64,1},Float64}([1.55287, 0.194013, 0.0879854, 0.126395, -0.00123296, 0.325031, 0.0372036, -0.208763, 0.0278147, -0.0179862, 0.209733, 0.207339, -1.83619], -45.3457, 4, DoubledTurn, 0.721187, 15), NUTS_Transition{Array{Float64,1},Float64}([0.959614, 0.281552, -0.415123, -0.146729, 0.224053, 0.436901, 0.132388, -0.18367, 0.358955, -0.117853, 0.470048, -0.111656, -1.14871], -43.2156, 4, DoubledTurn, 0.945258, 15), NUTS_Transition{Array{Float64,1},Float64}([1.33633, 0.249313, -0.268075, 0.313518, -0.367255, 0.290137, 0.022658, -0.357855, 0.0832265, -0.186834, 0.179967, 0.0570403, -1.34274], -45.2192, 4, DoubledTurn, 1.0, 15), NUTS_Transition{Array{Float64,1},Float64}([-0.124306, 0.385785, 0.134278, 0.222918, 0.420797, 0.662746, 0.271116, -0.115512, 0.391857, -0.160349, 0.483545, -0.362255, -0.776325], -51.7004, 4, DoubledTurn, 0.825373, 15), NUTS_Transition{Array{Float64,1},Float64}([0.239639, 0.324274, -0.0510582, 0.504601, 0.452603, 0.307096, 0.547094, -0.232068, 0.306565, -0.0442552, 0.577561, -0.149679, -0.689638], -48.7298, 4, DoubledTurn, 0.984216, 15)  …  NUTS_Transition{Array{Float64,1},Float64}([1.40559, 0.22305, -0.0504201, 0.425494, -0.21226, 0.409977, 0.0213487, -0.0807504, 0.407778, -0.218392, 0.385025, 0.106216, -1.19547], -43.5203, 4, DoubledTurn, 0.983623, 15), NUTS_Transition{Array{Float64,1},Float64}([0.404871, 0.328674, -0.206194, -0.234801, 0.159072, 0.249315, 0.229762, -0.304101, -0.0615798, 0.0252894, 0.174281, -0.23987, -1.55668], -46.0351, 4, DoubledTurn, 0.976998, 15), NUTS_Transition{Array{Float64,1},Float64}([2.23192, 0.139864, -0.329044, 0.134474, -0.135762, 0.371151, -0.197853, -0.233646, 0.273838, -0.375092, 0.436105, 0.257456, -1.09772], -43.7276, 4, DoubledTurn, 0.960681, 15), NUTS_Transition{Array{Float64,1},Float64}([2.14268, 0.14338, -0.265287, -0.0177097, -0.0889771, 0.361161, -0.079099, -0.183424, 0.264089, -0.186683, 0.494071, 0.308077, -1.29697], -40.785, 3, DoubledTurn, 0.940086, 7), NUTS_Transition{Array{Float64,1},Float64}([1.78704, 0.173998, -0.004018, 0.0670184, 0.215209, 0.636715, 0.10258, -0.247328, 0.375548, -0.055098, 0.349242, 0.263213, -1.20959], -43.5743, 4, DoubledTurn, 0.903951, 15), NUTS_Transition{Array{Float64,1},Float64}([1.34002, 0.248377, -0.353221, -0.0338459, 0.0569796, 0.338632, 0.119422, -0.425623, 0.0859548, -0.237394, 0.232438, -0.330275, -1.10974], -44.9025, 4, DoubledTurn, 0.922029, 15), NUTS_Transition{Array{Float64,1},Float64}([0.764916, 0.296974, -0.377226, 0.0435349, 0.017047, 0.194274, -0.121981, -0.101978, 0.0788744, -0.0417081, 0.172385, -0.0240718, -2.05769], -42.1371, 4, DoubledTurn, 0.982365, 15), NUTS_Transition{Array{Float64,1},Float64}([1.04104, 0.277549, 0.198887, -0.046119, -0.15106, 0.214352, 0.173763, -0.288911, 0.0581353, -0.167821, 0.0668692, -0.200432, -1.58634], -41.9794, 4, DoubledTurn, 0.944164, 15), NUTS_Transition{Array{Float64,1},Float64}([1.29781, 0.236132, -0.067515, -0.0270231, -0.291524, 0.421994, -0.0373218, -0.242677, 0.372724, -0.116145, 0.0428609, -0.204293, -1.15124], -45.4872, 4, DoubledTurn, 0.799437, 15), NUTS_Transition{Array{Float64,1},Float64}([0.191027, 0.368236, 0.181143, 0.0776398, 0.0244454, 0.235387, 0.0334431, -0.324003, 0.176269, 0.0633675, 0.0587265, -0.415891, -1.72214], -47.0832, 4, DoubledTurn, 0.993786, 15)], NUTS sampler in 13 dimensions
  stepsize (ϵ) ≈ 0.243
  maximum depth = 10
  Gaussian kinetic energy, √diag(M⁻¹): [0.576885, 0.0655499, 0.221606, 0.19136, 0.198768, 0.181124, 0.160194, 0.214123, 0.156718, 0.163917, 0.175103, 0.231449, 0.55512]
)</code></pre></div><p>We use the transformation to obtain the posterior from the chain.</p><div><pre><code class="language-julia">posterior = TransformVariables.transform.(Ref(problem_transformation(p)), get_position.(chain));
posterior[1:5]</code></pre><pre><code class="language-none">5-element Array{NamedTuple{(:β, :α, :σ),Tuple{Array{Float64,1},Array{Float64,1},Float64}},1}:
 (β = [1.18749, 0.242916], α = [0.185505, -0.200652, 0.142125, 0.422052, 0.15216, -0.11828, -0.13417, -0.232209, 0.485895, 0.100698], σ = 0.18369813034213953)
 (β = [1.29972, 0.235202], α = [-0.102192, -0.240308, -0.0911024, 0.464003, 0.121844, -0.25867, -0.0374197, -0.236454, 0.2991, 0.0698324], σ = 0.3465768540085124)
 (β = [0.894628, 0.289306], α = [-0.164631, 0.304988, 0.00564909, 0.179053, -0.0364818, -0.141571, 0.192923, -0.0581008, 0.201433, -0.159127], σ = 0.1455748031464636)
 (β = [0.563942, 0.311235], α = [-0.0892046, -0.203379, -0.102549, 0.144838, 0.187237, -0.110733, 0.100801, -0.173022, 0.106616, 0.060562], σ = 0.1569418508399326)
 (β = [0.691371, 0.317267], α = [-0.250748, 0.277317, 0.0264398, 0.29343, -0.1722, -0.381294, -0.0404962, -0.230168, 0.10419, -0.279161], σ = 0.23891163315541655)</code></pre></div><p>Extract the parameter posterior means.</p><div><pre><code class="language-julia">posterior_β = mean(posterior[i].β for i in 1:length(posterior))
posterior_α = mean(posterior[i].α for i in 1:length(posterior))
posterior_σ = mean(posterior[i].σ for i in 1:length(posterior))</code></pre><pre><code class="language-none">0.2988214290287631</code></pre></div><p>Effective sample sizes (of untransformed draws)</p><div><pre><code class="language-julia">ess = mapslices(effective_sample_size, get_position_matrix(chain); dims = 1)
ess</code></pre><pre><code class="language-none">1×13 Array{Float64,2}:
 604.592  591.814  858.223  697.585  …  799.562  901.897  660.036  331.213</code></pre></div><p>NUTS-specific statistics</p><div><pre><code class="language-julia">NUTS_statistics(chain)</code></pre><pre><code class="language-none">Hamiltonian Monte Carlo sample of length 1000
  acceptance rate mean: 0.93, min/25%/median/75%/max: 0.12 0.91 0.97 0.99 1.0
  termination: AdjacentTurn =&gt; 10% DoubledTurn =&gt; 90%
  depth: 2 =&gt; 0% 3 =&gt; 4% 4 =&gt; 95% 5 =&gt; 2% 6 =&gt; 0%</code></pre></div><p>CmdStan result</p><div><pre><code class="language-julia">m_12_6_result = &quot;
Iterations = 1:1000
Thinning interval = 1
Chains = 1,2,3,4
Samples per chain = 1000

Empirical Posterior Estimates:
                            Mean                SD               Naive SE             MCSE            ESS
            a          1.076167468  0.7704872560 0.01218247319 0.0210530022 1000.000000
           bp         0.263056273  0.0823415805 0.00130193470 0.0022645077 1000.000000
  a_society.1   -0.191723568  0.2421382537 0.00382854195 0.0060563054 1000.000000
  a_society.2    0.054569029  0.2278506876 0.00360263570 0.0051693148 1000.000000
  a_society.3   -0.035935050  0.1926364647 0.00304584994 0.0039948433 1000.000000
  a_society.4    0.334355037  0.1929971201 0.00305155241 0.0063871707  913.029080
  a_society.5    0.049747513  0.1801287716 0.00284808595 0.0043631095 1000.000000
  a_society.6   -0.311903245  0.2096126337 0.00331426674 0.0053000536 1000.000000
  a_society.7    0.148637507  0.1744680594 0.00275858223 0.0047660246 1000.000000
  a_society.8   -0.164567976  0.1821341074 0.00287979309 0.0034297298 1000.000000
  a_society.9    0.277066965  0.1758237250 0.00278001719 0.0055844175  991.286501
 a_society.10   -0.094149204  0.2846206232 0.00450024719 0.0080735022 1000.000000
sigma_society    0.310352849  0.1374834682 0.00217380450 0.0057325226  575.187461
&quot;;</code></pre><pre><code class="language-none">&quot;\nIterations = 1:1000\nThinning interval = 1\nChains = 1,2,3,4\nSamples per chain = 1000\n\nEmpirical Posterior Estimates:\n                            Mean                SD               Naive SE             MCSE            ESS\n            a          1.076167468  0.7704872560 0.01218247319 0.0210530022 1000.000000\n           bp         0.263056273  0.0823415805 0.00130193470 0.0022645077 1000.000000\n  a_society.1   -0.191723568  0.2421382537 0.00382854195 0.0060563054 1000.000000\n  a_society.2    0.054569029  0.2278506876 0.00360263570 0.0051693148 1000.000000\n  a_society.3   -0.035935050  0.1926364647 0.00304584994 0.0039948433 1000.000000\n  a_society.4    0.334355037  0.1929971201 0.00305155241 0.0063871707  913.029080\n  a_society.5    0.049747513  0.1801287716 0.00284808595 0.0043631095 1000.000000\n  a_society.6   -0.311903245  0.2096126337 0.00331426674 0.0053000536 1000.000000\n  a_society.7    0.148637507  0.1744680594 0.00275858223 0.0047660246 1000.000000\n  a_society.8   -0.164567976  0.1821341074 0.00287979309 0.0034297298 1000.000000\n  a_society.9    0.277066965  0.1758237250 0.00278001719 0.0055844175  991.286501\n a_society.10   -0.094149204  0.2846206232 0.00450024719 0.0080735022 1000.000000\nsigma_society    0.310352849  0.1374834682 0.00217380450 0.0057325226  575.187461\n&quot;</code></pre></div><p>Show means</p><div><pre><code class="language-julia">[posterior_β, posterior_α, posterior_σ]</code></pre><pre><code class="language-none">3-element Array{Any,1}:
  [1.09152, 0.262364]
  [-0.202372, 0.0374519, -0.0473419, 0.318812, 0.0466672, -0.312639, 0.142629, -0.171452, 0.25669, -0.0999744]
 0.2988214290287631</code></pre></div><p>End of m12.6d.jl</p><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p><footer><hr/><a class="previous" href="../../10/m10.04d/"><span class="direction">Previous</span><span class="title">m10.04d</span></a><a class="next" href="../m12.6d1/"><span class="direction">Next</span><span class="title">m12.6d1</span></a></footer></article></body></html>
