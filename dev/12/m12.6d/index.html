<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>m12.6d · DynamicHMCModels.jl</title><link href="https://cdnjs.cloudflare.com/ajax/libs/normalize/4.2.0/normalize.min.css" rel="stylesheet" type="text/css"/><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.2.0/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link href="../../assets/documenter.css" rel="stylesheet" type="text/css"/></head><body><nav class="toc"><h1>DynamicHMCModels.jl</h1><select id="version-selector" onChange="window.location.href=this.value" style="visibility: hidden"></select><form class="search" id="search-form" action="../../search/"><input id="search-query" name="q" type="text" placeholder="Search docs"/></form><ul><li><a class="toctext" href="../../intro/">Home</a></li><li><span class="toctext">Chapter 02</span><ul><li><a class="toctext" href="../../02/m2.1d/">m2.1d</a></li></ul></li><li><span class="toctext">Chapter 04</span><ul><li><a class="toctext" href="../../04/m4.1d/">m4.1d</a></li><li><a class="toctext" href="../../04/m4.2d/">m4.2d</a></li><li><a class="toctext" href="../../04/m4.5d/">m4.5d</a></li></ul></li><li><span class="toctext">Chapter 05</span><ul><li><a class="toctext" href="../../05/m5.1d/">m5.1d</a></li><li><a class="toctext" href="../../05/m5.1d1/">m5.1d1</a></li><li><a class="toctext" href="../../05/m5.3d/">m5.3d</a></li><li><a class="toctext" href="../../05/m5.6d/">m5.6d</a></li></ul></li><li><span class="toctext">Chapter 08</span><ul><li><a class="toctext" href="../../08/m8.1d/">m8.1d</a></li></ul></li><li><span class="toctext">Chapter 10</span><ul><li><a class="toctext" href="../../10/m10.02d/">m10.02d</a></li><li><a class="toctext" href="../../10/m10.02d1/">m10.02d1</a></li><li><a class="toctext" href="../../10/m10.04d/">m10.04d</a></li><li><a class="toctext" href="../../10/m10.04d1/">m10.04d1</a></li><li><a class="toctext" href="../../10/m10.04d2/">m10.04d2</a></li></ul></li><li><span class="toctext">Chapter 12</span><ul><li class="current"><a class="toctext" href>m12.6d</a><ul class="internal"></ul></li><li><a class="toctext" href="../m12.6d1/">m12.6d1</a></li><li><a class="toctext" href="../m12.6d2/">m12.6d2</a></li></ul></li><li><a class="toctext" href="../../">Functions</a></li></ul></nav><article id="docs"><header><nav><ul><li>Chapter 12</li><li><a href>m12.6d</a></li></ul><a class="edit-page" href="https://github.com/StatisticalRethinkingJulia/DynamicHMCModels.jl/blob/master/scripts/12/m12.6d.jl"><span class="fa"></span> Edit on GitHub</a></nav><hr/><div id="topbar"><span>m12.6d</span><a class="fa fa-bars" href="#"></a></div></header><pre><code class="language-julia">using DynamicHMCModels

ProjDir = rel_path_d(&quot;..&quot;, &quot;scripts&quot;, &quot;12&quot;)

df = CSV.read(rel_path( &quot;..&quot;, &quot;data&quot;,  &quot;Kline.csv&quot;), delim=&#39;;&#39;);
size(df) # Should be 10x5</code></pre><pre><code class="language-none">(10, 5)</code></pre><p>New col logpop, set log() for population data</p><pre><code class="language-julia">df[:logpop] = map((x) -&gt; log(x), df[:population]);
df[:society] = 1:10;

first(df[[:total_tools, :logpop, :society]], 5)

struct m_12_06d_model{TY &lt;: AbstractVector, TX &lt;: AbstractMatrix,
  TS &lt;: AbstractVector}
    &quot;Observations (total_tools).&quot;
    y::TY
    &quot;Covariates (logpop)&quot;
    X::TX
    &quot;Society&quot;
    S::TS
    &quot;Number of observations (10)&quot;
    N::Int
    &quot;Number of societies (also 10)&quot;
    N_societies::Int
end</code></pre><p>Make the type callable with the parameters <em>as a single argument</em>.</p><pre><code class="language-julia">function (problem::m_12_06d_model)(θ)
    @unpack y, X, S, N, N_societies = problem   # extract the data
    @unpack β, α, σ = θ  # β : a, bp, α : a_society
    ll = 0.0
    ll += logpdf(Cauchy(0, 1), σ)
    ll += sum(logpdf.(Normal(0, σ), α)) # α[1:10]
    ll += logpdf.(Normal(0, 10), β[1]) # a
    ll += logpdf.(Normal(0, 1), β[2]) # a
    ll += sum(
      [loglikelihood(Poisson(exp(α[S[i]] + dot(X[i, :], β))), [y[i]]) for i in 1:N]
    )
    ll
end</code></pre><p>Instantiate the model with data and inits.</p><pre><code class="language-julia">N = size(df, 1)
N_societies = length(unique(df[:society]))
X = hcat(ones(Int64, N), df[:logpop]);
S = df[:society]
y = df[:total_tools]
p = m_12_06d_model(y, X, S, N, N_societies);
θ = (β = [1.0, 0.25], α = rand(Normal(0, 1), N_societies), σ = 0.2)
p(θ)</code></pre><pre><code class="language-none">-242.3717315818267</code></pre><p>Write a function to return properly dimensioned transformation.</p><pre><code class="language-julia">problem_transformation(p::m_12_06d_model) =
    as( (β = as(Array, size(p.X, 2)), α = as(Array, p.N_societies), σ = asℝ₊) )</code></pre><p>Wrap the problem with a transformation, then use Flux for the gradient.</p><pre><code class="language-julia">P = TransformedLogDensity(problem_transformation(p), p)
∇P = LogDensityRejectErrors(ADgradient(:ForwardDiff, P));
#∇P = ADgradient(:ForwardDiff, P);</code></pre><p>Tune and sample.</p><pre><code class="language-julia">chain, NUTS_tuned = NUTS_init_tune_mcmc(∇P, 1000);</code></pre><pre><code class="language-none">(NUTS_Transition{Array{Float64,1},Float64}[NUTS_Transition{Array{Float64,1},Float64}([1.0287025214642376, 0.2751720682836875, -0.15093146296481147, 0.1320273240287418, 0.06158483828619782, 0.19544719781325204, 0.03205755648518656, -0.1367464908924346, 0.20529314793153713, -0.0611701046009309, 0.21748486479508594, -0.03972811185657149, -2.0933876743997177], -40.019056552352254, 4, DynamicHMC.DoubledTurn, 0.8410099632873295, 15), NUTS_Transition{Array{Float64,1},Float64}([1.1698726213586537, 0.26869426930596696, -0.13780285343847706, -0.32581323465274864, 0.00609317057720922, 0.08714503513809355, 0.14104431010673887, -0.20484197618886144, -0.09893773945324437, -0.23645766383653402, 0.18366039701146938, -0.16287496516360617, -1.399658437448372], -41.66097156402589, 4, DynamicHMC.DoubledTurn, 0.9427985301257569, 15), NUTS_Transition{Array{Float64,1},Float64}([0.7874927426892618, 0.2907209050656522, -0.1778665018215526, -0.18440368945043215, 0.10074323941452949, 0.6284068192425422, 0.21639276246552516, -0.14003623492705414, 0.05060610866043557, -0.2485585060232582, 0.22143758534133792, -0.07110984107960001, -1.2837410818901325], -45.92528249261507, 4, DynamicHMC.DoubledTurn, 0.8623498934382643, 15), NUTS_Transition{Array{Float64,1},Float64}([0.6607675462393555, 0.31316169104260505, -0.10075612254584153, 0.15247439888551856, -0.11129529152330239, 0.37520145654336035, 0.16886633285984393, -0.4720230828071963, -0.047831746839842336, -0.32407997608430356, 0.05895437438795826, -0.21910567838885148, -1.4308579375397383], -44.91750045423225, 4, DynamicHMC.DoubledTurn, 0.9896854034423274, 15), NUTS_Transition{Array{Float64,1},Float64}([0.5023162025691175, 0.3159579398440465, 0.1434662217628369, 0.1495026472469529, -0.1409846744380453, 0.45559544273356145, 0.07990363137648282, -0.41888038889703416, -0.11290662389293946, -0.23168123853199946, 0.10142191120474453, -0.19886599735743582, -1.468458404115594], -43.29742305816946, 4, DynamicHMC.DoubledTurn, 0.7625916610994113, 15), NUTS_Transition{Array{Float64,1},Float64}([0.9733927611915091, 0.29653058109191893, 0.057450818211373135, -0.1214783290064723, -0.183944993864949, 0.18725465923716944, -0.01563056095899806, -0.43420872858530474, -0.043856724752596284, -0.29036730522352716, 0.12249735343158694, -0.12409618138492969, -1.746477434540224], -46.29139769217722, 4, DynamicHMC.DoubledTurn, 0.9954841160821084, 15), NUTS_Transition{Array{Float64,1},Float64}([1.1105567535712557, 0.2580670256296322, -0.4089742804042876, 0.13018267750401594, -0.07980936875116118, 0.40554498661929445, 0.17184321754633283, -0.25840101341200394, 0.20714211801830332, -0.16029344632896528, 0.4268410063704796, -0.022895160294444106, -1.2374072342354454], -44.00314314882181, 4, DynamicHMC.DoubledTurn, 0.9946604415466801, 15), NUTS_Transition{Array{Float64,1},Float64}([1.1305472410521409, 0.2688916052128689, -0.027171165308875814, -0.060301464141617175, -0.009483516765908886, 0.11439224858678047, -0.1392563332036959, -0.37243280677325197, 0.15123869444103288, -0.16835053309061898, 0.08293219768736959, -0.22230956387178372, -1.5480553655743392], -39.514661311474, 4, DynamicHMC.DoubledTurn, 0.9750448886299807, 15), NUTS_Transition{Array{Float64,1},Float64}([0.7066521383982005, 0.31025678420495484, -0.24006315042574186, 0.08015582542158503, 0.04333981876149013, 0.5352336958028984, -0.19245560221724903, -0.3151168973858065, 0.20351832785555002, 0.14682665142873913, 0.2283155432485252, -0.4122300312471221, -1.344700306778448], -44.29881523428918, 4, DynamicHMC.DoubledTurn, 0.8190976584386789, 15), NUTS_Transition{Array{Float64,1},Float64}([1.6747945406929399, 0.19601597600283197, -0.20107605580319216, 0.10194760987998726, -0.01571953931932782, 0.04867808095220427, 0.187646588867514, -0.3960940751938843, -0.03945490219605841, -0.4948934706304813, 0.3061455270059133, 0.07891013695272525, -1.373040851630063], -44.50629326082655, 4, DynamicHMC.DoubledTurn, 0.9523301806387406, 15)  …  NUTS_Transition{Array{Float64,1},Float64}([0.17182773586511144, 0.36334597399774954, -0.17315246691247194, 0.1995008545055927, -0.11566272440854147, 0.3130455552617757, 0.262090392262927, -0.04984007131263999, 0.2089450754582375, -0.49985821664048, 0.4334518361284106, -0.30192666264867196, -1.3803934378813794], -51.94422294120126, 4, DynamicHMC.AdjacentTurn, 0.8621615302383889, 31), NUTS_Transition{Array{Float64,1},Float64}([2.0473690333806682, 0.16062569962997655, -0.20280036614690983, -0.22491040061147535, -0.3094553780923047, 0.09178478198910574, 0.08674061388385812, -0.29211485762686284, 0.1254619838423723, -0.15766218799996556, 0.37930501588407, 0.19142396435737985, -1.4655883824501954], -47.489340204145414, 4, DynamicHMC.DoubledTurn, 0.6882862234339773, 15), NUTS_Transition{Array{Float64,1},Float64}([0.39441285792642744, 0.3404392876676639, -0.2597475205915689, 0.2357304962816571, 0.07137304234472988, 0.6429031539666457, -0.12340740512761746, -0.21071969939950994, 0.19589765141876467, -0.26489752164365105, 0.22968548010977596, -0.37131223245945716, -1.4156807494516412], -41.1086679381594, 4, DynamicHMC.DoubledTurn, 0.9761905278044851, 15), NUTS_Transition{Array{Float64,1},Float64}([2.350643057714192, 0.12957791405059418, -0.554167997274212, -0.34497438178886447, -0.43144448287832643, 0.17933614078195878, -0.11583124972367044, -0.5672373549409401, 0.1517472326387781, -0.516090319036212, 0.40940415559174964, 0.26213218849063247, -0.7303692809815779], -47.004012093871644, 4, DynamicHMC.DoubledTurn, 0.9175177092962128, 15), NUTS_Transition{Array{Float64,1},Float64}([3.559958038197538, -0.010694442297947367, -0.6257502774856635, -0.2427786134002856, -0.42451291315605416, 0.27561232701279464, -0.08401819149160784, -0.575508683824572, 0.303831214993277, -0.1346697331255203, 0.6924096444647774, 0.6172810278883502, -0.8396259022622952], -47.95031033081892, 4, DynamicHMC.AdjacentTurn, 0.9508365469388261, 31), NUTS_Transition{Array{Float64,1},Float64}([3.2896801948307886, 0.016897423522126066, -0.5682006716486653, -0.08838044108361698, -0.31903643173861845, 0.3017897270095074, -0.050455009161219255, -0.5679005221613243, 0.35983162250643225, -0.1721485444797552, 0.7130789192758142, 0.56476288511969, -0.8041671916817812], -52.13787316375404, 5, DynamicHMC.DoubledTurn, 0.9871126261009443, 31), NUTS_Transition{Array{Float64,1},Float64}([3.6107731048384135, -0.0253125675765807, -0.6148939731710702, -0.1428410648394301, -0.06438337460752713, 0.4010675031751262, 0.015058572464133238, -0.3510908525452629, 0.47657016932827256, -0.022821687966181656, 0.8141885649185895, 0.8183772232160818, -0.6176836531820754], -46.99514473919272, 4, DynamicHMC.AdjacentTurn, 0.9538897298425175, 31), NUTS_Transition{Array{Float64,1},Float64}([-0.4847892485788145, 0.451671966738674, -0.05094083110602342, 0.05205772629384616, -0.08545353026690164, 0.20211359235199822, 0.05065714391836263, -0.708711093598135, -0.14828488587038133, -0.37643299832822413, -0.05352435047304658, -0.7790243008774898, -0.5468777061561444], -49.68185703781062, 4, DynamicHMC.AdjacentTurn, 0.9930773060189274, 31), NUTS_Transition{Array{Float64,1},Float64}([-0.6037872392110145, 0.4969927724197809, -0.4559525030599755, -0.6679622841928136, 0.04151394331678074, 0.33222418512248386, -0.32662221289872306, -0.9906783062042043, -0.17474787145830264, -0.5364875150324281, -0.436213432478745, -1.3533096182779203, -0.48568082431350995], -54.438940042769765, 4, DynamicHMC.DoubledTurn, 0.9808421537367358, 15), NUTS_Transition{Array{Float64,1},Float64}([-0.8798744636792252, 0.515931886652427, -0.30066994025970906, 0.4615721849888229, -0.15286044342393645, 0.2683288947354658, -0.032396522965408556, -0.6687952258958146, -0.1840631319799126, -0.4766770805860452, -0.20911546051387386, -1.0579916902406314, -0.6191144848076344], -57.376493522785644, 4, DynamicHMC.AdjacentTurn, 0.8220649671337277, 31)], NUTS sampler in 13 dimensions
  stepsize (ϵ) ≈ 0.215
  maximum depth = 10
  Gaussian kinetic energy, √diag(M⁻¹): [0.7556790512753773, 0.08412310578845988, 0.23725913489239336, 0.23020952848449358, 0.19434841574108935, 0.20707246434827298, 0.17520475193258483, 0.20836035994749574, 0.1814400226392812, 0.1949741677757153, 0.16319958599360593, 0.3001486806736601, 0.41224630608648105]
)</code></pre><p>We use the transformation to obtain the posterior from the chain.</p><pre><code class="language-julia">posterior = TransformVariables.transform.(Ref(problem_transformation(p)), get_position.(chain));
posterior[1:5]</code></pre><pre><code class="language-none">5-element Array{NamedTuple{(:β, :α, :σ),Tuple{Array{Float64,1},Array{Float64,1},Float64}},1}:
 (β = [1.0287025214642376, 0.2751720682836875], α = [-0.15093146296481147, 0.1320273240287418, 0.06158483828619782, 0.19544719781325204, 0.03205755648518656, -0.1367464908924346, 0.20529314793153713, -0.0611701046009309, 0.21748486479508594, -0.03972811185657149], σ = 0.12326883301077499)     
 (β = [1.1698726213586537, 0.26869426930596696], α = [-0.13780285343847706, -0.32581323465274864, 0.00609317057720922, 0.08714503513809355, 0.14104431010673887, -0.20484197618886144, -0.09893773945324437, -0.23645766383653402, 0.18366039701146938, -0.16287496516360617], σ = 0.2466812066160865)
 (β = [0.7874927426892618, 0.2907209050656522], α = [-0.1778665018215526, -0.18440368945043215, 0.10074323941452949, 0.6284068192425422, 0.21639276246552516, -0.14003623492705414, 0.05060610866043557, -0.2485585060232582, 0.22143758534133792, -0.07110984107960001], σ = 0.2769990833821091)     
 (β = [0.6607675462393555, 0.31316169104260505], α = [-0.10075612254584153, 0.15247439888551856, -0.11129529152330239, 0.37520145654336035, 0.16886633285984393, -0.4720230828071963, -0.047831746839842336, -0.32407997608430356, 0.05895437438795826, -0.21910567838885148], σ = 0.2391036981830682)
 (β = [0.5023162025691175, 0.3159579398440465], α = [0.1434662217628369, 0.1495026472469529, -0.1409846744380453, 0.45559544273356145, 0.07990363137648282, -0.41888038889703416, -0.11290662389293946, -0.23168123853199946, 0.10142191120474453, -0.19886599735743582], σ = 0.2302802107198678)     </code></pre><p>Extract the parameter posterior means.</p><pre><code class="language-julia">posterior_β = mean(posterior[i].β for i in 1:length(posterior))
posterior_α = mean(posterior[i].α for i in 1:length(posterior))
posterior_σ = mean(posterior[i].σ for i in 1:length(posterior))</code></pre><pre><code class="language-none">0.31189001940823713</code></pre><p>Effective sample sizes (of untransformed draws)</p><pre><code class="language-julia">ess = mapslices(effective_sample_size, get_position_matrix(chain); dims = 1)
ess</code></pre><pre><code class="language-none">1×13 Array{Float64,2}:
 862.744  834.5  643.501  739.431  …  732.816  444.209  883.573  37.585</code></pre><p>NUTS-specific statistics</p><pre><code class="language-julia">NUTS_statistics(chain)</code></pre><pre><code class="language-none">Hamiltonian Monte Carlo sample of length 1000
  acceptance rate mean: 0.94, min/25%/median/75%/max: 0.0 0.92 0.97 0.99 1.0
  termination: AdjacentTurn =&gt; 11% DoubledTurn =&gt; 89%
  depth: 3 =&gt; 3% 4 =&gt; 93% 5 =&gt; 4%
</code></pre><p>CmdStan result</p><pre><code class="language-julia">m_12_6_result = &quot;
Iterations = 1:1000
Thinning interval = 1
Chains = 1,2,3,4
Samples per chain = 1000

Empirical Posterior Estimates:
                            Mean                SD               Naive SE             MCSE            ESS
            a          1.076167468  0.7704872560 0.01218247319 0.0210530022 1000.000000
           bp         0.263056273  0.0823415805 0.00130193470 0.0022645077 1000.000000
  a_society.1   -0.191723568  0.2421382537 0.00382854195 0.0060563054 1000.000000
  a_society.2    0.054569029  0.2278506876 0.00360263570 0.0051693148 1000.000000
  a_society.3   -0.035935050  0.1926364647 0.00304584994 0.0039948433 1000.000000
  a_society.4    0.334355037  0.1929971201 0.00305155241 0.0063871707  913.029080
  a_society.5    0.049747513  0.1801287716 0.00284808595 0.0043631095 1000.000000
  a_society.6   -0.311903245  0.2096126337 0.00331426674 0.0053000536 1000.000000
  a_society.7    0.148637507  0.1744680594 0.00275858223 0.0047660246 1000.000000
  a_society.8   -0.164567976  0.1821341074 0.00287979309 0.0034297298 1000.000000
  a_society.9    0.277066965  0.1758237250 0.00278001719 0.0055844175  991.286501
 a_society.10   -0.094149204  0.2846206232 0.00450024719 0.0080735022 1000.000000
sigma_society    0.310352849  0.1374834682 0.00217380450 0.0057325226  575.187461
&quot;;</code></pre><pre><code class="language-none">&quot;\nIterations = 1:1000\nThinning interval = 1\nChains = 1,2,3,4\nSamples per chain = 1000\n\nEmpirical Posterior Estimates:\n                            Mean                SD               Naive SE             MCSE            ESS\n            a          1.076167468  0.7704872560 0.01218247319 0.0210530022 1000.000000\n           bp         0.263056273  0.0823415805 0.00130193470 0.0022645077 1000.000000\n  a_society.1   -0.191723568  0.2421382537 0.00382854195 0.0060563054 1000.000000\n  a_society.2    0.054569029  0.2278506876 0.00360263570 0.0051693148 1000.000000\n  a_society.3   -0.035935050  0.1926364647 0.00304584994 0.0039948433 1000.000000\n  a_society.4    0.334355037  0.1929971201 0.00305155241 0.0063871707  913.029080\n  a_society.5    0.049747513  0.1801287716 0.00284808595 0.0043631095 1000.000000\n  a_society.6   -0.311903245  0.2096126337 0.00331426674 0.0053000536 1000.000000\n  a_society.7    0.148637507  0.1744680594 0.00275858223 0.0047660246 1000.000000\n  a_society.8   -0.164567976  0.1821341074 0.00287979309 0.0034297298 1000.000000\n  a_society.9    0.277066965  0.1758237250 0.00278001719 0.0055844175  991.286501\n a_society.10   -0.094149204  0.2846206232 0.00450024719 0.0080735022 1000.000000\nsigma_society    0.310352849  0.1374834682 0.00217380450 0.0057325226  575.187461\n&quot;</code></pre><p>Show means</p><pre><code class="language-julia">[posterior_β, posterior_α, [posterior_σ]]</code></pre><pre><code class="language-none">3-element Array{Array{Float64,1},1}:
 [1.0802654636501172, 0.26346117898120036]                                                                                                                                                                          
 [-0.2027307458447039, 0.0433540172680859, -0.04165683959946963, 0.3283469192215731, 0.039228435912808966, -0.3121129292652724, 0.13729084611153017, -0.18320433110017828, 0.2707641745172183, -0.10355574621112869]
 [0.31189001940823713]                                                                                                                                                                                              </code></pre><p>End of m12.6d.jl</p><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p><footer><hr/><a class="previous" href="../../10/m10.04d2/"><span class="direction">Previous</span><span class="title">m10.04d2</span></a><a class="next" href="../m12.6d1/"><span class="direction">Next</span><span class="title">m12.6d1</span></a></footer></article></body></html>
