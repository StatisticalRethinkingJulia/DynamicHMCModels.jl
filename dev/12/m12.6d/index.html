<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>m12.6d · DynamicHMCModels.jl</title><link href="https://cdnjs.cloudflare.com/ajax/libs/normalize/4.2.0/normalize.min.css" rel="stylesheet" type="text/css"/><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.2.0/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link href="../../assets/documenter.css" rel="stylesheet" type="text/css"/></head><body><nav class="toc"><h1>DynamicHMCModels.jl</h1><select id="version-selector" onChange="window.location.href=this.value" style="visibility: hidden"></select><form class="search" id="search-form" action="../../search/"><input id="search-query" name="q" type="text" placeholder="Search docs"/></form><ul><li><a class="toctext" href="../../intro/">Home</a></li><li><span class="toctext">Chapter 02</span><ul><li><a class="toctext" href="../../02/m2.1d/">m2.1d</a></li></ul></li><li><span class="toctext">Chapter 04</span><ul><li><a class="toctext" href="../../04/m4.1d/">m4.1d</a></li><li><a class="toctext" href="../../04/m4.2d/">m4.2d</a></li><li><a class="toctext" href="../../04/m4.5d/">m4.5d</a></li></ul></li><li><span class="toctext">Chapter 05</span><ul><li><a class="toctext" href="../../05/m5.1d/">m5.1d</a></li><li><a class="toctext" href="../../05/m5.1d1/">m5.1d1</a></li><li><a class="toctext" href="../../05/m5.3d/">m5.3d</a></li><li><a class="toctext" href="../../05/m5.6d/">m5.6d</a></li></ul></li><li><span class="toctext">Chapter 08</span><ul><li><a class="toctext" href="../../08/m8.1d/">m8.1d</a></li></ul></li><li><span class="toctext">Chapter 10</span><ul><li><a class="toctext" href="../../10/m10.02d/">m10.02d</a></li><li><a class="toctext" href="../../10/m10.02d1/">m10.02d1</a></li><li><a class="toctext" href="../../10/m10.04d/">m10.04d</a></li><li><a class="toctext" href="../../10/m10.04d1/">m10.04d1</a></li><li><a class="toctext" href="../../10/m10.04d2/">m10.04d2</a></li></ul></li><li><span class="toctext">Chapter 12</span><ul><li class="current"><a class="toctext" href>m12.6d</a><ul class="internal"></ul></li><li><a class="toctext" href="../m12.6d1/">m12.6d1</a></li><li><a class="toctext" href="../m12.6d2/">m12.6d2</a></li></ul></li><li><a class="toctext" href="../../">Functions</a></li></ul></nav><article id="docs"><header><nav><ul><li>Chapter 12</li><li><a href>m12.6d</a></li></ul><a class="edit-page" href="https://github.com/StatisticalRethinkingJulia/DynamicHMCModels.jl/blob/master/scripts/12/m12.6d.jl"><span class="fa"></span> Edit on GitHub</a></nav><hr/><div id="topbar"><span>m12.6d</span><a class="fa fa-bars" href="#"></a></div></header><pre><code class="language-julia">using DynamicHMCModels

ProjDir = rel_path_d(&quot;..&quot;, &quot;scripts&quot;, &quot;12&quot;)

df = CSV.read(rel_path( &quot;..&quot;, &quot;data&quot;,  &quot;Kline.csv&quot;), delim=&#39;;&#39;);
size(df) # Should be 10x5</code></pre><pre><code class="language-none">(10, 5)</code></pre><p>New col logpop, set log() for population data</p><pre><code class="language-julia">df[:logpop] = map((x) -&gt; log(x), df[:population]);
df[:society] = 1:10;

first(df[[:total_tools, :logpop, :society]], 5)

struct m_12_06d_model{TY &lt;: AbstractVector, TX &lt;: AbstractMatrix,
  TS &lt;: AbstractVector}
    &quot;Observations (total_tools).&quot;
    y::TY
    &quot;Covariates (logpop)&quot;
    X::TX
    &quot;Society&quot;
    S::TS
    &quot;Number of observations (10)&quot;
    N::Int
    &quot;Number of societies (also 10)&quot;
    N_societies::Int
end</code></pre><p>Make the type callable with the parameters <em>as a single argument</em>.</p><pre><code class="language-julia">function (problem::m_12_06d_model)(θ)
    @unpack y, X, S, N, N_societies = problem   # extract the data
    @unpack β, α, σ = θ  # β : a, bp, α : a_society
    ll = 0.0
    ll += logpdf(Cauchy(0, 1), σ)
    ll += sum(logpdf.(Normal(0, σ), α)) # α[1:10]
    ll += logpdf.(Normal(0, 10), β[1]) # a
    ll += logpdf.(Normal(0, 1), β[2]) # a
    ll += sum(
      [loglikelihood(Poisson(exp(α[S[i]] + dot(X[i, :], β))), [y[i]]) for i in 1:N]
    )
    ll
end</code></pre><p>Instantiate the model with data and inits.</p><pre><code class="language-julia">N = size(df, 1)
N_societies = length(unique(df[:society]))
X = hcat(ones(Int64, N), df[:logpop]);
S = df[:society]
y = df[:total_tools]
p = m_12_06d_model(y, X, S, N, N_societies);
θ = (β = [1.0, 0.25], α = rand(Normal(0, 1), N_societies), σ = 0.2)
p(θ)</code></pre><pre><code class="language-none">-211.50187185125515</code></pre><p>Write a function to return properly dimensioned transformation.</p><pre><code class="language-julia">problem_transformation(p::m_12_06d_model) =
    as( (β = as(Array, size(p.X, 2)), α = as(Array, p.N_societies), σ = asℝ₊) )</code></pre><p>Wrap the problem with a transformation, then use Flux for the gradient.</p><pre><code class="language-julia">P = TransformedLogDensity(problem_transformation(p), p)
∇P = LogDensityRejectErrors(ADgradient(:ForwardDiff, P));
#∇P = ADgradient(:ForwardDiff, P);</code></pre><p>Tune and sample.</p><pre><code class="language-julia">chain, NUTS_tuned = NUTS_init_tune_mcmc(∇P, 1000);</code></pre><pre><code class="language-none">(NUTS_Transition{Array{Float64,1},Float64}[NUTS_Transition{Array{Float64,1},Float64}([0.4344571276099576, 0.3270170037670651, -0.24147224694274141, -0.05598680297587513, 0.11745180994504296, 0.2986422832929327, 0.07582618544944784, -0.02475574898462539, 0.14613233315732066, 0.0668887832601375, 0.23352957523499304, -0.2515658447003062, -1.4822762728220118], -39.42964159765724, 3, DynamicHMC.AdjacentTurn, 0.9206807248919778, 15), NUTS_Transition{Array{Float64,1},Float64}([0.869963182196095, 0.2837622651425248, -0.02836632490302666, 0.1252211988100245, -0.09839921076827368, 0.32204367861694794, 0.07846761091697299, -0.07123088650491433, 0.08902320657059719, -0.31599041719864374, 0.3197824514844056, -0.1038573368885331, -1.1849996375439307], -41.29718841500617, 4, DynamicHMC.DoubledTurn, 0.8314520582861796, 15), NUTS_Transition{Array{Float64,1},Float64}([1.3672406634101342, 0.23258532879732305, -0.2946171285848037, -0.0675032395684878, 0.024207834969931587, 0.21111769577099646, -0.13146367917897706, -0.37311018566035675, 0.2846106479941573, -0.05152040638599665, 0.22987912422451984, -0.05164110864381971, -1.78134725165301], -38.70388593569173, 4, DynamicHMC.DoubledTurn, 0.9844021904826914, 15), NUTS_Transition{Array{Float64,1},Float64}([0.73905785627589, 0.305798725182723, 0.07859526111114427, 0.14459202941274077, 0.0670159210135236, 0.03848644891021465, 0.1617337541667798, -0.3085215801856503, 0.2198551410655445, -0.18197905319489485, 0.1518728791052893, -0.27157998255831434, -1.8167745032234934], -41.09312514323992, 4, DynamicHMC.DoubledTurn, 0.9455420209543334, 15), NUTS_Transition{Array{Float64,1},Float64}([2.3540444694800082, 0.10370752854855683, -0.8031946127739021, -0.2507766025707305, -0.23976102306260685, 0.49645463486973784, 0.11255557941633643, -0.04483437612945995, 0.10053733258406775, -0.29408658997898895, 0.4454940517244182, 0.7216016187566533, -0.49199067490583986], -49.442403583227524, 4, DynamicHMC.DoubledTurn, 0.7103696727658764, 15), NUTS_Transition{Array{Float64,1},Float64}([2.4798868130518392, 0.09506558420679909, -0.5227829401211551, -0.06048296455342217, 0.21405945142904925, 0.15463808867279105, 0.24970439146229917, -0.4409773153829635, 0.4622785505187313, 0.16174460125972084, 0.42978073613846896, 0.45865241525118056, -1.0719776015403508], -51.65681547569008, 4, DynamicHMC.DoubledTurn, 0.9867058154908067, 15), NUTS_Transition{Array{Float64,1},Float64}([0.17490522987394766, 0.37575058700799174, 0.0869084258834784, 0.29539254134714743, -0.1536568346475257, 0.5634042090996917, -0.14044788286340457, -1.030333977401384, -0.14434263639048403, -0.6051653096590962, 0.0986146938783213, -0.7364175375456582, -0.906658429430566], -50.26408071550532, 4, DynamicHMC.DoubledTurn, 0.8604032823591974, 15), NUTS_Transition{Array{Float64,1},Float64}([1.0194031329696924, 0.28250552287281466, -0.2617405287899941, -0.08794276322848697, -0.15153989097737988, 0.01468094648166153, -0.06346539712040172, -0.3296243731054995, 0.01988108891050684, 0.04061673468779631, 0.24904448472164278, -0.23130166404387806, -1.4743381988502395], -50.58134243509482, 4, DynamicHMC.DoubledTurn, 0.9865020131762319, 15), NUTS_Transition{Array{Float64,1},Float64}([0.8408377100821917, 0.2840470334151901, -0.023677371622789226, -0.181327889202744, -0.06386954856441884, 0.2907298543769915, -0.0005313768456598894, -0.13590365411145874, 0.0531122978848155, -0.11372290261672256, 0.34278660774611425, -0.20882541579091943, -1.8640691528667628], -42.02252009856124, 4, DynamicHMC.DoubledTurn, 0.8822623097771992, 15), NUTS_Transition{Array{Float64,1},Float64}([1.1981668574521998, 0.25783083314058525, -0.2442308445541467, 0.3395027938131407, -0.07741851428247164, 0.3163432583823669, 0.08298785264144404, -0.481606150857741, 0.19047160897478602, -0.16374535512725474, 0.20394421867048468, -0.14121999481053096, -1.0880482295583562], -41.364066796983124, 4, DynamicHMC.DoubledTurn, 0.9756235455924558, 15)  …  NUTS_Transition{Array{Float64,1},Float64}([1.415561490929021, 0.23321103806036214, -0.3088780480373091, -0.06661862740539365, -0.06845776834722242, 0.27964275757580687, -0.14309616459340443, -0.3692024527186616, 0.19903852937593391, -0.21918191885575986, 0.3061769729966346, -0.03960579280605457, -1.512892461242103], -42.132558401091316, 4, DynamicHMC.DoubledTurn, 0.9835849865487992, 15), NUTS_Transition{Array{Float64,1},Float64}([0.6841241639708353, 0.3090949510733255, 0.005662782332590675, 0.06283777317677866, -0.061654649827300984, 0.30088692087205426, 0.11342309616320123, -0.1802113798426116, 0.20953665616179856, -0.19454699422393051, 0.1631863933969157, -0.21496286646278653, -1.7379889508652056], -36.87316164994941, 4, DynamicHMC.DoubledTurn, 0.9548221850371855, 15), NUTS_Transition{Array{Float64,1},Float64}([1.0426299126072407, 0.2726181477397735, -0.19704016625486698, -0.13416603939448785, -0.1940833503597361, 0.3331208195670653, -0.005238357571992938, -0.23163129229317658, 0.015939323858306265, -0.0350827732215255, 0.20222963087940415, -0.12793955040500862, -1.5745377789664332], -36.4307039196342, 3, DynamicHMC.AdjacentTurn, 0.9451873062789358, 15), NUTS_Transition{Array{Float64,1},Float64}([1.1650802815959866, 0.24997124697978146, -0.07953608768626143, 0.23947611462180496, -0.008744636482052558, 0.1353198417418775, 0.008112561899426565, -0.3784099016440452, 0.28407115260912813, -0.1522145229978405, 0.3702112612175068, -0.04553273147590584, -1.4446508772335895], -37.50930537269006, 4, DynamicHMC.DoubledTurn, 0.975687522871412, 15), NUTS_Transition{Array{Float64,1},Float64}([1.2071146285880068, 0.25294565973100475, -0.3679692974197357, -0.21371487417875223, -0.0840229033154881, 0.46697875786150533, 0.03778315963630963, -0.1720596252774897, 0.008466290520577034, -0.11823564162447688, 0.10561648166972633, -0.0696963781279856, -1.6132502076296062], -39.11835822379466, 4, DynamicHMC.DoubledTurn, 0.9721534182002949, 15), NUTS_Transition{Array{Float64,1},Float64}([-0.14534853580952983, 0.39604973604904437, -0.24364329558686965, -0.04176603965903232, -0.04413611969752009, 0.6220736489696619, 0.013310598368272537, 0.11274961958480076, 0.025225557739965557, -0.15016272547064988, 0.10876239235031382, -0.5048508926771865, -1.6317662133729436], -47.365869181015086, 3, DynamicHMC.DoubledTurn, 0.8805000719503343, 7), NUTS_Transition{Array{Float64,1},Float64}([2.2430347813947553, 0.11094016642758694, 0.010004090691287972, 0.3591997685151574, 0.2930552674524384, 0.4540002628818249, 0.5010240912880456, -0.5392860801272267, 0.25847990075503974, -0.23242476281176647, 0.7575626684598434, 0.583871471589877, -0.5942862136763797], -52.36461556309976, 4, DynamicHMC.DoubledTurn, 0.802615356618754, 15), NUTS_Transition{Array{Float64,1},Float64}([0.8725440690306345, 0.3003020820264103, -0.46588520419696317, -0.4069391017743057, -0.3441077409910433, 0.298196913476922, -0.23313999984102207, -0.19133657621631556, 0.22910826532667553, -0.2290057480925169, 0.09565542036418608, -0.16793501510001718, -1.1861923515240786], -52.18971001631512, 4, DynamicHMC.DoubledTurn, 0.931948076020362, 15), NUTS_Transition{Array{Float64,1},Float64}([0.09439263089754035, 0.38273056833369823, 0.28768568166900343, 0.6860158949749965, 0.015285025665660562, 0.2528724152559527, -0.02291367254073319, -0.6981793843636493, -0.08931497674844241, -0.31206537748685453, 0.3545930236950956, -0.6563998433353725, -1.0737580820680712], -51.57277741651931, 4, DynamicHMC.DoubledTurn, 1.0, 15), NUTS_Transition{Array{Float64,1},Float64}([1.3208103335055255, 0.21350219127626005, -0.9283415246934938, -0.22394645155134613, 0.05767026282434997, 0.8362778391489908, 0.07215461635126047, -0.2573677042589876, 0.4293697231179065, 0.037285132639169404, 0.36545709931642206, 0.27170379899701996, -0.9975083450892608], -56.990868300758294, 4, DynamicHMC.DoubledTurn, 0.9682365989809487, 15)], NUTS sampler in 13 dimensions
  stepsize (ϵ) ≈ 0.282
  maximum depth = 10
  Gaussian kinetic energy, √diag(M⁻¹): [0.7750758225823488, 0.085663109553867, 0.252016932114796, 0.2325094024792496, 0.18676503207624665, 0.19014560073108874, 0.1815565097807279, 0.2121193445738521, 0.1707399878809346, 0.17757471774862543, 0.1740306421164313, 0.27619059307362664, 0.3698677062265671]
)</code></pre><p>We use the transformation to obtain the posterior from the chain.</p><pre><code class="language-julia">posterior = TransformVariables.transform.(Ref(problem_transformation(p)), get_position.(chain));
posterior[1:5]</code></pre><pre><code class="language-none">5-element Array{NamedTuple{(:β, :α, :σ),Tuple{Array{Float64,1},Array{Float64,1},Float64}},1}:
 (β = [0.4344571276099576, 0.3270170037670651], α = [-0.24147224694274141, -0.05598680297587513, 0.11745180994504296, 0.2986422832929327, 0.07582618544944784, -0.02475574898462539, 0.14613233315732066, 0.0668887832601375, 0.23352957523499304, -0.2515658447003062], σ = 0.22712011219626513)   
 (β = [0.869963182196095, 0.2837622651425248], α = [-0.02836632490302666, 0.1252211988100245, -0.09839921076827368, 0.32204367861694794, 0.07846761091697299, -0.07123088650491433, 0.08902320657059719, -0.31599041719864374, 0.3197824514844056, -0.1038573368885331], σ = 0.30574629031829026)   
 (β = [1.3672406634101342, 0.23258532879732305], α = [-0.2946171285848037, -0.0675032395684878, 0.024207834969931587, 0.21111769577099646, -0.13146367917897706, -0.37311018566035675, 0.2846106479941573, -0.05152040638599665, 0.22987912422451984, -0.05164110864381971], σ = 0.1684111022236756)
 (β = [0.73905785627589, 0.305798725182723], α = [0.07859526111114427, 0.14459202941274077, 0.0670159210135236, 0.03848644891021465, 0.1617337541667798, -0.3085215801856503, 0.2198551410655445, -0.18197905319489485, 0.1518728791052893, -0.27157998255831434], σ = 0.16254920822229732)         
 (β = [2.3540444694800082, 0.10370752854855683], α = [-0.8031946127739021, -0.2507766025707305, -0.23976102306260685, 0.49645463486973784, 0.11255557941633643, -0.04483437612945995, 0.10053733258406775, -0.29408658997898895, 0.4454940517244182, 0.7216016187566533], σ = 0.6114080672436228)   </code></pre><p>Extract the parameter posterior means.</p><pre><code class="language-julia">posterior_β = mean(posterior[i].β for i in 1:length(posterior))
posterior_α = mean(posterior[i].α for i in 1:length(posterior))
posterior_σ = mean(posterior[i].σ for i in 1:length(posterior))</code></pre><pre><code class="language-none">0.31970536663536614</code></pre><p>Effective sample sizes (of untransformed draws)</p><pre><code class="language-julia">ess = mapslices(effective_sample_size, get_position_matrix(chain); dims = 1)
ess</code></pre><pre><code class="language-none">1×13 Array{Float64,2}:
 1000.0  1000.0  1000.0  1000.0  1000.0  …  1000.0  658.354  716.84  278.071</code></pre><p>NUTS-specific statistics</p><pre><code class="language-julia">NUTS_statistics(chain)</code></pre><pre><code class="language-none">Hamiltonian Monte Carlo sample of length 1000
  acceptance rate mean: 0.9, min/25%/median/75%/max: 0.14 0.86 0.95 0.99 1.0
  termination: AdjacentTurn =&gt; 8% DoubledTurn =&gt; 92%
  depth: 2 =&gt; 0% 3 =&gt; 17% 4 =&gt; 83% 5 =&gt; 0%
</code></pre><p>CmdStan result</p><pre><code class="language-julia">m_12_6_result = &quot;
Iterations = 1:1000
Thinning interval = 1
Chains = 1,2,3,4
Samples per chain = 1000

Empirical Posterior Estimates:
                            Mean                SD               Naive SE             MCSE            ESS
            a          1.076167468  0.7704872560 0.01218247319 0.0210530022 1000.000000
           bp         0.263056273  0.0823415805 0.00130193470 0.0022645077 1000.000000
  a_society.1   -0.191723568  0.2421382537 0.00382854195 0.0060563054 1000.000000
  a_society.2    0.054569029  0.2278506876 0.00360263570 0.0051693148 1000.000000
  a_society.3   -0.035935050  0.1926364647 0.00304584994 0.0039948433 1000.000000
  a_society.4    0.334355037  0.1929971201 0.00305155241 0.0063871707  913.029080
  a_society.5    0.049747513  0.1801287716 0.00284808595 0.0043631095 1000.000000
  a_society.6   -0.311903245  0.2096126337 0.00331426674 0.0053000536 1000.000000
  a_society.7    0.148637507  0.1744680594 0.00275858223 0.0047660246 1000.000000
  a_society.8   -0.164567976  0.1821341074 0.00287979309 0.0034297298 1000.000000
  a_society.9    0.277066965  0.1758237250 0.00278001719 0.0055844175  991.286501
 a_society.10   -0.094149204  0.2846206232 0.00450024719 0.0080735022 1000.000000
sigma_society    0.310352849  0.1374834682 0.00217380450 0.0057325226  575.187461
&quot;;</code></pre><pre><code class="language-none">&quot;\nIterations = 1:1000\nThinning interval = 1\nChains = 1,2,3,4\nSamples per chain = 1000\n\nEmpirical Posterior Estimates:\n                            Mean                SD               Naive SE             MCSE            ESS\n            a          1.076167468  0.7704872560 0.01218247319 0.0210530022 1000.000000\n           bp         0.263056273  0.0823415805 0.00130193470 0.0022645077 1000.000000\n  a_society.1   -0.191723568  0.2421382537 0.00382854195 0.0060563054 1000.000000\n  a_society.2    0.054569029  0.2278506876 0.00360263570 0.0051693148 1000.000000\n  a_society.3   -0.035935050  0.1926364647 0.00304584994 0.0039948433 1000.000000\n  a_society.4    0.334355037  0.1929971201 0.00305155241 0.0063871707  913.029080\n  a_society.5    0.049747513  0.1801287716 0.00284808595 0.0043631095 1000.000000\n  a_society.6   -0.311903245  0.2096126337 0.00331426674 0.0053000536 1000.000000\n  a_society.7    0.148637507  0.1744680594 0.00275858223 0.0047660246 1000.000000\n  a_society.8   -0.164567976  0.1821341074 0.00287979309 0.0034297298 1000.000000\n  a_society.9    0.277066965  0.1758237250 0.00278001719 0.0055844175  991.286501\n a_society.10   -0.094149204  0.2846206232 0.00450024719 0.0080735022 1000.000000\nsigma_society    0.310352849  0.1374834682 0.00217380450 0.0057325226  575.187461\n&quot;</code></pre><p>Show means</p><pre><code class="language-julia">[posterior_β, posterior_α, [posterior_σ]]</code></pre><pre><code class="language-none">3-element Array{Array{Float64,1},1}:
 [1.09439932492089, 0.26085922365773995]                                                                                                                                                                               
 [-0.20486583668818076, 0.054312468013551565, -0.03317865855590306, 0.33831821574132703, 0.04869381901996752, -0.3176680779949754, 0.15859275418944013, -0.1619619220015525, 0.28230459433877386, -0.08136778942113637]
 [0.31970536663536614]                                                                                                                                                                                                 </code></pre><p>End of m12.6d.jl</p><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p><footer><hr/><a class="previous" href="../../10/m10.04d2/"><span class="direction">Previous</span><span class="title">m10.04d2</span></a><a class="next" href="../m12.6d1/"><span class="direction">Next</span><span class="title">m12.6d1</span></a></footer></article></body></html>
