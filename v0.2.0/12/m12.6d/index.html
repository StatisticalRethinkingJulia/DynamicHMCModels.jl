<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>m12.6d · DynamicHMCModels.jl</title><link href="https://cdnjs.cloudflare.com/ajax/libs/normalize/4.2.0/normalize.min.css" rel="stylesheet" type="text/css"/><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.2.0/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link href="../../assets/documenter.css" rel="stylesheet" type="text/css"/></head><body><nav class="toc"><h1>DynamicHMCModels.jl</h1><select id="version-selector" onChange="window.location.href=this.value" style="visibility: hidden"></select><form class="search" id="search-form" action="../../search/"><input id="search-query" name="q" type="text" placeholder="Search docs"/></form><ul><li><a class="toctext" href="../../intro/">Home</a></li><li><span class="toctext">Chapter 02</span><ul><li><a class="toctext" href="../../02/m2.1d/">m2.1d</a></li></ul></li><li><span class="toctext">Chapter 04</span><ul><li><a class="toctext" href="../../04/m4.1d/">m4.1d</a></li><li><a class="toctext" href="../../04/m4.2d/">m4.2d</a></li><li><a class="toctext" href="../../04/m4.5d/">m4.5d</a></li></ul></li><li><span class="toctext">Chapter 05</span><ul><li><a class="toctext" href="../../05/m5.1d/">m5.1d</a></li><li><a class="toctext" href="../../05/m5.1d1/">m5.1d1</a></li><li><a class="toctext" href="../../05/m5.3d/">m5.3d</a></li><li><a class="toctext" href="../../05/m5.6d/">m5.6d</a></li></ul></li><li><span class="toctext">Chapter 08</span><ul><li><a class="toctext" href="../../08/m8.1d/">m8.1d</a></li></ul></li><li><span class="toctext">Chapter 10</span><ul><li><a class="toctext" href="../../10/m10.02d/">m10.02d</a></li><li><a class="toctext" href="../../10/m10.02d1/">m10.02d1</a></li><li><a class="toctext" href="../../10/m10.04d/">m10.04d</a></li><li><a class="toctext" href="../../10/m10.04d1/">m10.04d1</a></li></ul></li><li><span class="toctext">Chapter 12</span><ul><li class="current"><a class="toctext" href>m12.6d</a><ul class="internal"></ul></li><li><a class="toctext" href="../m12.6d1/">m12.6d1</a></li></ul></li><li><a class="toctext" href="../../">Functions</a></li></ul></nav><article id="docs"><header><nav><ul><li>Chapter 12</li><li><a href>m12.6d</a></li></ul><a class="edit-page" href="https://github.com/StatisticalRethinkingJulia/DynamicHMCModels.jl/blob/master/scripts/12/m12.6d.jl"><span class="fa"></span> Edit on GitHub</a></nav><hr/><div id="topbar"><span>m12.6d</span><a class="fa fa-bars" href="#"></a></div></header><div><pre><code class="language-julia">using DynamicHMCModels

ProjDir = rel_path_d(&quot;..&quot;, &quot;scripts&quot;, &quot;12&quot;)

df = CSV.read(rel_path( &quot;..&quot;, &quot;data&quot;,  &quot;Kline.csv&quot;), delim=&#39;;&#39;);
size(df) # Should be 10x5</code></pre><pre><code class="language-none">(10, 5)</code></pre></div><p>New col logpop, set log() for population data</p><div><pre><code class="language-julia">df[:logpop] = map((x) -&gt; log(x), df[:population]);
df[:society] = 1:10;

first(df[[:total_tools, :logpop, :society]], 5)

struct m_12_06d_model{TY &lt;: AbstractVector, TX &lt;: AbstractMatrix,
  TS &lt;: AbstractVector}
    &quot;Observations (total_tools).&quot;
    y::TY
    &quot;Covariates (logpop)&quot;
    X::TX
    &quot;Society&quot;
    S::TS
    &quot;Number of observations (10)&quot;
    N::Int
    &quot;Number of societies (also 10)&quot;
    N_societies::Int
end</code></pre></div><p>Make the type callable with the parameters <em>as a single argument</em>.</p><div><pre><code class="language-julia">function (problem::m_12_06d_model)(θ)
    @unpack y, X, S, N, N_societies = problem   # extract the data
    @unpack β, α, σ = θ  # β : a, bp, α : a_society
    ll = 0.0
    ll += logpdf(Cauchy(0, 1), σ)
    ll += sum(logpdf.(Normal(0, σ), α)) # α[1:10]
    ll += logpdf.(Normal(0, 10), β[1]) # a
    ll += logpdf.(Normal(0, 1), β[2]) # a
    ll += sum(
      [loglikelihood(Poisson(exp(α[S[i]] + dot(X[i, :], β))), [y[i]]) for i in 1:N]
    )
    ll
end</code></pre></div><p>Instantiate the model with data and inits.</p><div><pre><code class="language-julia">N = size(df, 1)
N_societies = length(unique(df[:society]))
X = hcat(ones(Int64, N), df[:logpop]);
S = df[:society]
y = df[:total_tools]
p = m_12_06d_model(y, X, S, N, N_societies);
θ = (β = [1.0, 0.25], α = rand(Normal(0, 1), N_societies), σ = 0.2)
p(θ)</code></pre><pre><code class="language-none">-851.8403295541232</code></pre></div><p>Write a function to return properly dimensioned transformation.</p><div><pre><code class="language-julia">problem_transformation(p::m_12_06d_model) =
    as( (β = as(Array, size(p.X, 2)), α = as(Array, p.N_societies), σ = asℝ₊) )</code></pre></div><p>Wrap the problem with a transformation, then use Flux for the gradient.</p><div><pre><code class="language-julia">P = TransformedLogDensity(problem_transformation(p), p)
∇P = LogDensityRejectErrors(ADgradient(:ForwardDiff, P));
#∇P = ADgradient(:ForwardDiff, P);</code></pre></div><p>Tune and sample.</p><div><pre><code class="language-julia">chain, NUTS_tuned = NUTS_init_tune_mcmc(∇P, 1000);</code></pre><pre><code class="language-none">MCMC, adapting ϵ (75 steps)
0.003 s/step ...done
MCMC, adapting ϵ (25 steps)
0.0044 s/step ...done
MCMC, adapting ϵ (50 steps)
0.004 s/step ...done
MCMC, adapting ϵ (100 steps)
0.0014 s/step ...done
MCMC, adapting ϵ (200 steps)
0.00088 s/step ...done
MCMC, adapting ϵ (400 steps)
0.00053 s/step ...done
MCMC, adapting ϵ (50 steps)
0.00087 s/step ...done
MCMC (1000 steps)
0.00048 s/step ...done
(NUTS_Transition{Array{Float64,1},Float64}[NUTS_Transition{Array{Float64,1},Float64}([-0.8632646884603121, 0.4376349254449229, 0.1545302519338158, 0.5676608203737257, 0.5210323878899701, 0.7672318128778668, 0.4932944709363166, -0.06343084509259198, 0.30658591741713936, 0.06363033523425574, 0.716246402523027, -0.38477317526853394, -0.9248361599875432], -47.290926911976605, 4, DynamicHMC.DoubledTurn, 0.9886475249708297, 15), NUTS_Transition{Array{Float64,1},Float64}([2.3539251243030574, 0.13593133801051388, -0.2900598199035822, -0.2688153312614502, -0.15314244432661286, 0.19258007345336076, 0.08655289355456737, -0.5091237141050936, 0.020988905436598797, -0.2888522844826314, 0.12790868134144023, 0.2950980422331265, -1.1339455621716894], -45.470660615415895, 4, DynamicHMC.DoubledTurn, 1.0, 15), NUTS_Transition{Array{Float64,1},Float64}([1.7940391115529204, 0.18823365977772136, -0.5081895472975111, -0.05492124056805891, -0.26470430087156527, 0.06897167129223253, -0.1464855818732576, -0.3171353496444966, 0.06629847585843235, -0.1542894100261457, 0.4545248484267397, 0.09789189240729251, -1.2539337367001895], -45.05442744861409, 4, DynamicHMC.DoubledTurn, 0.8533418885313161, 15), NUTS_Transition{Array{Float64,1},Float64}([2.546107163737469, 0.11226092441742337, -0.5632459458106968, -0.2020097798401711, -0.3608409841282009, 0.20839635035026732, -0.04617106104383768, -0.5242243309871054, 0.2808571883154489, -0.39548996444872286, 0.3137840717613801, 0.40884747894383083, -1.0199869675955957], -44.33257325841302, 4, DynamicHMC.DoubledTurn, 0.8300818656160511, 15), NUTS_Transition{Array{Float64,1},Float64}([1.666280225346963, 0.20113605746999574, -0.4236468967419516, -0.2885210396127925, -0.2490229952402838, 0.29656698587104807, -0.10665971589276425, -0.7697687473284839, 0.365297744973432, -0.35786035631335805, 0.27876331359679923, 0.28199385732093263, -0.47389039456196], -45.539524847208085, 4, DynamicHMC.DoubledTurn, 0.9793194569176779, 15), NUTS_Transition{Array{Float64,1},Float64}([2.107019696952213, 0.16387180696221093, -0.392641383584218, -0.1807997364440861, -0.20356140748208434, 0.24535917115052472, 0.06562960259203729, -0.43586714834015045, -0.18960766095213807, 0.17042117478744404, 0.166114114978952, 0.2043054798384158, -1.3053678296149276], -48.02747596694362, 4, DynamicHMC.DoubledTurn, 0.9194652302577533, 15), NUTS_Transition{Array{Float64,1},Float64}([0.6564566654042869, 0.30338293866154514, -0.22323846235029435, 0.09214922285409154, 0.07922370968117598, 0.6152638349798327, 0.17359695438639133, -0.25206684750696207, 0.04939428398450245, -0.46081159055948573, 0.1816456988557037, -0.3001841366342766, -1.003083022394156], -46.165900925923566, 4, DynamicHMC.DoubledTurn, 0.9880369876958269, 15), NUTS_Transition{Array{Float64,1},Float64}([2.4678497455912787, 0.10301979497847819, 0.04651938957587331, -0.22136062293785033, -0.047623886798268136, 0.3222871668066011, 0.0898745146548437, -0.1582539450219849, 0.111328658962207, 0.02942036221791297, 0.4673416547514785, 0.5529250254726435, -1.3858872727686724], -44.5442801389346, 4, DynamicHMC.DoubledTurn, 0.9874857034536404, 15), NUTS_Transition{Array{Float64,1},Float64}([0.868541193184277, 0.3186394215836441, -0.3717198038249859, 0.025437220877098682, -0.61022803038469, 0.18729104543882422, -0.0952445726556691, -0.31237538033779666, -0.016134301133442212, -0.49598558712423463, 0.04903062329031861, -0.7648823604119905, -0.6215071101636936], -52.845658464292484, 4, DynamicHMC.AdjacentTurn, 0.7901699473666962, 31), NUTS_Transition{Array{Float64,1},Float64}([0.7057718164562962, 0.2857727953294388, 0.028570028730966344, 0.12997527078053872, 0.3296719788786415, 0.37668541381517057, 0.11456124615212758, -0.333028029638673, 0.1712445773489551, -0.004708465470165007, 0.3563883788501222, 0.11641002204005335, -1.7500827659519858], -45.829872163193, 4, DynamicHMC.DoubledTurn, 0.9682420705822655, 15)  …  NUTS_Transition{Array{Float64,1},Float64}([1.0780283380138467, 0.25738794487350913, -0.04903416880452306, 0.2118585200599837, -0.13459563702151867, 0.6646749762482196, 0.01519635055404446, -0.2954964576594053, -0.037732108827437535, -0.22012949123983344, 0.2576517635136937, -0.19577678875900917, -1.0894379113010864], -48.39076064196498, 4, DynamicHMC.DoubledTurn, 0.8653481082528025, 15), NUTS_Transition{Array{Float64,1},Float64}([0.557648470670318, 0.30976831737468874, -0.09800516703145434, 0.0376653245820166, 0.06775839759280917, 0.025008722984831026, 0.10804890910676396, 0.14333341318860504, 0.2348713606670203, -0.012057925324797433, 0.25433276043874115, -0.17749874657949005, -1.8737824514473416], -44.45733593216712, 4, DynamicHMC.DoubledTurn, 0.987678982826672, 15), NUTS_Transition{Array{Float64,1},Float64}([0.5704568018020967, 0.32425006947365337, -0.28530091123947826, 0.03906265437276252, -0.10550556315190819, 0.08307218996771026, -0.04923507648681837, -0.39189055465274614, 0.2714755762997864, -0.2161110376290422, 0.21454547327897364, -0.22941631695058678, -1.3867797014892107], -48.24663148512529, 3, DynamicHMC.DoubledTurn, 0.6520824552286918, 7), NUTS_Transition{Array{Float64,1},Float64}([0.43564945555177975, 0.3320570528787738, -0.316809450496969, 0.0540991607243447, -0.09333241989457415, 0.14718984237991356, -0.0969506937883028, -0.4285791392527972, 0.2927494584484238, -0.2520031085793877, 0.21398871475890013, -0.21492613610404956, -1.3664362823523968], -43.13130375093648, 4, DynamicHMC.DoubledTurn, 0.9188694625369339, 15), NUTS_Transition{Array{Float64,1},Float64}([1.581785117597493, 0.2126178352441953, -0.26034115564753674, 0.02635493183479025, 0.12428442843070872, 0.04121968492909976, -0.047515632722254474, -0.32872750084072333, 0.04935105992282153, 0.0012836227843533235, 0.13922169122047331, -0.03795650099424745, -1.5044732294487255], -42.00116978349786, 4, DynamicHMC.DoubledTurn, 0.9934976476336577, 15), NUTS_Transition{Array{Float64,1},Float64}([0.7981172909826348, 0.29006698284943744, -0.28349646516113697, 0.006827899451913835, -0.18154941038639064, 0.5919956653041495, 0.07569910173819268, -0.2875909708872374, 0.16921061070434187, -0.33867193098700793, 0.3282683246772399, -0.14946440924802407, -1.3740280765237438], -40.3843055573702, 4, DynamicHMC.DoubledTurn, 0.9948542664317895, 15), NUTS_Transition{Array{Float64,1},Float64}([1.6082063711560417, 0.20364379164315735, -0.2809553779863438, 0.07851002803100529, -0.129297701820216, 0.020898505263095946, -0.015066450919145286, -0.12401400805225411, 0.02810458244351224, -0.052710088417051854, 0.20587914792595713, 0.007516493610489451, -1.2207117221228414], -43.445065644558504, 4, DynamicHMC.DoubledTurn, 0.8605951379972422, 15), NUTS_Transition{Array{Float64,1},Float64}([0.6501975840807614, 0.3055166648970294, -0.5769003894675881, 0.10944149134979791, 0.22029863750918005, 0.5433371880908615, 0.360139294557158, -0.2928265925897458, 0.35433478086134024, -0.42511601466020077, 0.5636123385706303, -0.23545102524932912, -1.0812211433322456], -48.301716355484814, 4, DynamicHMC.DoubledTurn, 0.9865682320227002, 15), NUTS_Transition{Array{Float64,1},Float64}([1.257767020257951, 0.25921752959313166, 0.27443951622211443, -0.03580939234535527, -0.3072770232028876, 0.17068233908184752, -0.3257249570996611, -0.41578875002313753, -0.03789013821346374, 0.04501785802248645, 0.011355907626243576, -0.05754317774149139, -1.3021489782034903], -49.14271770572586, 4, DynamicHMC.DoubledTurn, 0.9866776797057407, 15), NUTS_Transition{Array{Float64,1},Float64}([-0.393982261476588, 0.41243834905635485, 0.09081967993471342, 0.5183422503126237, 0.19835100488725615, 0.4733801242261794, 0.15954120842069636, -0.01366989568315552, 0.19928557267390945, -0.10879072965912275, 0.38427866902339414, -0.3064426991893994, -1.4779013978739763], -52.139177370797256, 4, DynamicHMC.DoubledTurn, 1.0, 15)], NUTS sampler in 13 dimensions
  stepsize (ϵ) ≈ 0.251
  maximum depth = 10
  Gaussian kinetic energy, √diag(M⁻¹): [0.6751138762287813, 0.07591048050992358, 0.20873025061714476, 0.2267965954209221, 0.19770404170969658, 0.18314045608386242, 0.17827450833885478, 0.20040687308328187, 0.16497544775138545, 0.1858143198497355, 0.16487718679747979, 0.2596460406392985, 0.367512578607011]
)</code></pre></div><p>We use the transformation to obtain the posterior from the chain.</p><div><pre><code class="language-julia">posterior = TransformVariables.transform.(Ref(problem_transformation(p)), get_position.(chain));
posterior[1:5]</code></pre><pre><code class="language-none">5-element Array{NamedTuple{(:β, :α, :σ),Tuple{Array{Float64,1},Array{Float64,1},Float64}},1}:
 (β = [-0.8632646884603121, 0.4376349254449229], α = [0.1545302519338158, 0.5676608203737257, 0.5210323878899701, 0.7672318128778668, 0.4932944709363166, -0.06343084509259198, 0.30658591741713936, 0.06363033523425574, 0.716246402523027, -0.38477317526853394], σ = 0.3965963921100797)
 (β = [2.3539251243030574, 0.13593133801051388], α = [-0.2900598199035822, -0.2688153312614502, -0.15314244432661286, 0.19258007345336076, 0.08655289355456737, -0.5091237141050936, 0.020988905436598797, -0.2888522844826314, 0.12790868134144023, 0.2950980422331265], σ = 0.32176121972564925)
 (β = [1.7940391115529204, 0.18823365977772136], α = [-0.5081895472975111, -0.05492124056805891, -0.26470430087156527, 0.06897167129223253, -0.1464855818732576, -0.3171353496444966, 0.06629847585843235, -0.1542894100261457, 0.4545248484267397, 0.09789189240729251], σ = 0.28537997625053996)
 (β = [2.546107163737469, 0.11226092441742337], α = [-0.5632459458106968, -0.2020097798401711, -0.3608409841282009, 0.20839635035026732, -0.04617106104383768, -0.5242243309871054, 0.2808571883154489, -0.39548996444872286, 0.3137840717613801, 0.40884747894383083], σ = 0.3605996396227873)
 (β = [1.666280225346963, 0.20113605746999574], α = [-0.4236468967419516, -0.2885210396127925, -0.2490229952402838, 0.29656698587104807, -0.10665971589276425, -0.7697687473284839, 0.365297744973432, -0.35786035631335805, 0.27876331359679923, 0.28199385732093263], σ = 0.6225754864871235)</code></pre></div><p>Extract the parameter posterior means.</p><div><pre><code class="language-julia">posterior_β = mean(posterior[i].β for i in 1:length(posterior))
posterior_α = mean(posterior[i].α for i in 1:length(posterior))
posterior_σ = mean(posterior[i].σ for i in 1:length(posterior))</code></pre><pre><code class="language-none">0.3053243117088973</code></pre></div><p>Effective sample sizes (of untransformed draws)</p><div><pre><code class="language-julia">ess = mapslices(effective_sample_size, get_position_matrix(chain); dims = 1)
ess</code></pre><pre><code class="language-none">1×13 Array{Float64,2}:
 691.629  711.217  615.688  717.167  …  989.801  782.951  869.705  516.101</code></pre></div><p>NUTS-specific statistics</p><div><pre><code class="language-julia">NUTS_statistics(chain)</code></pre><pre><code class="language-none">Hamiltonian Monte Carlo sample of length 1000
  acceptance rate mean: 0.92, min/25%/median/75%/max: 0.23 0.89 0.96 0.99 1.0
  termination: AdjacentTurn =&gt; 5% DoubledTurn =&gt; 95%
  depth: 3 =&gt; 8% 4 =&gt; 92% 5 =&gt; 0%</code></pre></div><p>CmdStan result</p><div><pre><code class="language-julia">m_12_6_result = &quot;
Iterations = 1:1000
Thinning interval = 1
Chains = 1,2,3,4
Samples per chain = 1000

Empirical Posterior Estimates:
                            Mean                SD               Naive SE             MCSE            ESS
            a          1.076167468  0.7704872560 0.01218247319 0.0210530022 1000.000000
           bp         0.263056273  0.0823415805 0.00130193470 0.0022645077 1000.000000
  a_society.1   -0.191723568  0.2421382537 0.00382854195 0.0060563054 1000.000000
  a_society.2    0.054569029  0.2278506876 0.00360263570 0.0051693148 1000.000000
  a_society.3   -0.035935050  0.1926364647 0.00304584994 0.0039948433 1000.000000
  a_society.4    0.334355037  0.1929971201 0.00305155241 0.0063871707  913.029080
  a_society.5    0.049747513  0.1801287716 0.00284808595 0.0043631095 1000.000000
  a_society.6   -0.311903245  0.2096126337 0.00331426674 0.0053000536 1000.000000
  a_society.7    0.148637507  0.1744680594 0.00275858223 0.0047660246 1000.000000
  a_society.8   -0.164567976  0.1821341074 0.00287979309 0.0034297298 1000.000000
  a_society.9    0.277066965  0.1758237250 0.00278001719 0.0055844175  991.286501
 a_society.10   -0.094149204  0.2846206232 0.00450024719 0.0080735022 1000.000000
sigma_society    0.310352849  0.1374834682 0.00217380450 0.0057325226  575.187461
&quot;;</code></pre><pre><code class="language-none">&quot;\nIterations = 1:1000\nThinning interval = 1\nChains = 1,2,3,4\nSamples per chain = 1000\n\nEmpirical Posterior Estimates:\n                            Mean                SD               Naive SE             MCSE            ESS\n            a          1.076167468  0.7704872560 0.01218247319 0.0210530022 1000.000000\n           bp         0.263056273  0.0823415805 0.00130193470 0.0022645077 1000.000000\n  a_society.1   -0.191723568  0.2421382537 0.00382854195 0.0060563054 1000.000000\n  a_society.2    0.054569029  0.2278506876 0.00360263570 0.0051693148 1000.000000\n  a_society.3   -0.035935050  0.1926364647 0.00304584994 0.0039948433 1000.000000\n  a_society.4    0.334355037  0.1929971201 0.00305155241 0.0063871707  913.029080\n  a_society.5    0.049747513  0.1801287716 0.00284808595 0.0043631095 1000.000000\n  a_society.6   -0.311903245  0.2096126337 0.00331426674 0.0053000536 1000.000000\n  a_society.7    0.148637507  0.1744680594 0.00275858223 0.0047660246 1000.000000\n  a_society.8   -0.164567976  0.1821341074 0.00287979309 0.0034297298 1000.000000\n  a_society.9    0.277066965  0.1758237250 0.00278001719 0.0055844175  991.286501\n a_society.10   -0.094149204  0.2846206232 0.00450024719 0.0080735022 1000.000000\nsigma_society    0.310352849  0.1374834682 0.00217380450 0.0057325226  575.187461\n&quot;</code></pre></div><p>Show means</p><div><pre><code class="language-julia">[posterior_β, posterior_α, [posterior_σ]]</code></pre><pre><code class="language-none">3-element Array{Array{Float64,1},1}:
 [1.1486134050714154, 0.2561866286308051]
 [-0.21146078518302905, 0.026464446043322737, -0.0543397439535521, 0.3234468532711939, 0.04705204804571863, -0.3199788315707105, 0.14192104696077565, -0.16890761837278984, 0.2785767130217563, -0.08482806584482122]
 [0.3053243117088973]</code></pre></div><p>End of m12.6d.jl</p><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p><footer><hr/><a class="previous" href="../../10/m10.04d1/"><span class="direction">Previous</span><span class="title">m10.04d1</span></a><a class="next" href="../m12.6d1/"><span class="direction">Next</span><span class="title">m12.6d1</span></a></footer></article></body></html>
